<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Aladin Lite v3</title>
    <link rel="stylesheet" href="https://aladin.u-strasbg.fr/AladinLite/api/v3/latest/aladin.min.css" />
</head>
<body>
    <div id="aladin-lite-div" style="width:100%;height:550px;"></div>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="https://aladin.u-strasbg.fr/AladinLite/api/v3/latest/aladin.js" charset="utf-8"></script>
    <script type="text/javascript">
        document.addEventListener("DOMContentLoaded", function(event) {
            try {
                // Initialize Aladin v3
                let aladin = A.aladin('#aladin-lite-div', {
                    target: '{{ ra_center }} {{ dec_center }}',
                    fov: {{ fov }},
                    survey: '{{ survey }}',
                    reticleSize: 0,
                    showZoomControl: true,
                    showFullscreenControl: true,
                    showLayersControl: true,
                    showGotoControl: true,
                    showSimbadPointerControl: true
                });

                // Create catalog overlay
                let cat = A.catalog({
                    name: 'Photometry Results',
                    sourceSize: 12,
                    shape: 'circle',
                    color: '#00ff88',
                    onClick: 'showPopup'
                });
                aladin.addCatalog(cat);
                
                // Decode and parse the base64 encoded JSON data
                let sourcesData = JSON.parse(atob("{{ sources_json_b64 }}"));
                let aladinSources = [];

                sourcesData.forEach(function(source) {
                    // Build comprehensive popup content
                    let popupContent = '<div style="padding:8px; max-width:300px; font-family:Arial,sans-serif;">';
                    
                    // Header with catalog ID if available, otherwise source number
                    if(source.catalog_id) {
                        popupContent += '<h4 style="margin:0 0 8px 0; color:#2c5282;">Source ID: ' + source.catalog_id + '</h4>';
                    } else if(source.source_number) {
                        popupContent += '<h4 style="margin:0 0 8px 0; color:#2c5282;">Source #' + source.source_number + '</h4>';
                    }
                    
                    // Coordinates section
                    popupContent += '<div style="background:#f7fafc; padding:6px; margin:4px 0; border-radius:4px;">';
                    popupContent += '<strong>Coordinates:</strong><br/>';
                    popupContent += 'RA: ' + (typeof source.ra === 'number' ? source.ra.toFixed(6) : source.ra) + '°<br/>';
                    popupContent += 'Dec: ' + (typeof source.dec === 'number' ? source.dec.toFixed(6) : source.dec) + '°';
                    popupContent += '</div>';

                    // Photometry section - handle both PSF and aperture magnitudes
                    if(source.psf_mag || source.aperture_mag) {
                        popupContent += '<div style="background:#edf2f7; padding:6px; margin:4px 0; border-radius:4px;">';
                        popupContent += '<strong>Photometry:</strong><br/>';
                        
                        // Show PSF magnitude if available
                        if(source.psf_mag && source.psf_mag !== null && source.psf_mag !== undefined) {
                            popupContent += 'PSF Mag: ' + (typeof source.psf_mag === 'number' ? source.psf_mag.toFixed(2) : source.psf_mag) + '<br/>';
                        }
                        
                        // Show aperture magnitude if available
                        if(source.aperture_mag && source.aperture_mag !== null && source.aperture_mag !== undefined) {
                            popupContent += 'Aperture Mag: ' + (typeof source.aperture_mag === 'number' ? source.aperture_mag.toFixed(2) : source.aperture_mag) + '<br/>';
                        }
                        
                        // If only aperture_mag is available and psf_mag is not, show it prominently
                        if(!source.psf_mag && source.aperture_mag) {
                            popupContent += '<em style="color:#2d3748;">Primary magnitude: Aperture</em><br/>';
                        }
                        
                        // Signal-to-noise ratio if available
                        if(source.snr) {
                            popupContent += 'S/N: ' + (typeof source.snr === 'number' ? source.snr.toFixed(1) : source.snr);
                        }
                        popupContent += '</div>';
                    }
                    
                    // Catalog matches section
                    if(source.catalog_matches && 
                       Object.keys(source.catalog_matches).length > 0) {
                        popupContent += '<div style="background:#e6fffa; ' +
                                       'padding:6px; margin:4px 0; border-radius:4px;">';
                        popupContent += '<strong>Catalog Matches:</strong><br/>';
                        for(let catalog in source.catalog_matches) {
                            let catalogValue = source.catalog_matches[catalog];
                            if(catalogValue && catalogValue !== '' && 
                               catalogValue !== 'nan') {
                                let escapedCatalogValue = catalogValue.toString()
                                    .replace(/[<>&"']/g, function(m) {
                                    return {'<':'&lt;', '>':'&gt;', '&':'&amp;', 
                                            '"':'&quot;', "'":"&#39;"}[m];
                                });
                                popupContent += '<span style="display:inline-block; ' +
                                               'background:#81e6d9; color:#234e52; ' +
                                               'padding:2px 6px; margin:1px; ' +
                                               'border-radius:3px; font-size:11px;">';
                                popupContent += catalog + ': ' + escapedCatalogValue + 
                                               '</span><br/>';
                            }
                        }
                        popupContent += '</div>';
                    }

                    // Create source with v3 properties
                    let aladinSource = A.source(
                        source.ra,
                        source.dec,
                        { 
                            data: popupContent,
                        }
                    );
                    aladinSources.push(aladinSource);
                });

                // Add sources to catalog
                if (aladinSources.length > 0) {
                    cat.addSources(aladinSources);
                    cat.updateShape();
                }
            } catch (error) {
                console.error("Error initializing Aladin Lite v3 or adding sources:", error);
                document.getElementById('aladin-lite-div').innerHTML = '<p style="color:red;">Error loading Aladin v3 viewer. Try refreshing the page or use a modern browser.</p>';
            }
        });
    </script>
</body>
</html>
