

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>src.pipeline &mdash; RAPAS Photometry Pipeline (RPP) v0.9.8 Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=1a282f62"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980b9" >

          
          
          <a href="../../index.html" class="icon icon-home">
            RAPAS Photometry Pipeline (RPP)
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user_guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advanced_features.html">Advanced Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html#id1">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html#id1">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advanced_features.html">Advanced Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference.html">Core Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference.html#usage-examples">Usage Examples</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980b9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">RAPAS Photometry Pipeline (RPP)</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">src.pipeline</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for src.pipeline</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">streamlit</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">st</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">quote</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">astroscrappy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">join</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.wcs</span><span class="w"> </span><span class="kn">import</span> <span class="n">WCS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">sigma_clip</span><span class="p">,</span> <span class="n">SigmaClip</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">sigma_clipped_stats</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">SkyCoord</span><span class="p">,</span> <span class="n">EarthLocation</span><span class="p">,</span> <span class="n">AltAz</span><span class="p">,</span> <span class="n">get_sun</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.time</span><span class="w"> </span><span class="kn">import</span> <span class="n">Time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.background</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalBackground</span><span class="p">,</span> <span class="n">MMMBackground</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.psf</span><span class="w"> </span><span class="kn">import</span> <span class="n">fit_fwhm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.nddata</span><span class="w"> </span><span class="kn">import</span> <span class="n">NDData</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">ZScaleInterval</span><span class="p">,</span> <span class="n">simple_norm</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.units</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">u</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astroquery.gaia</span><span class="w"> </span><span class="kn">import</span> <span class="n">Gaia</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astroquery.simbad</span><span class="w"> </span><span class="kn">import</span> <span class="n">Simbad</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astroquery.vizier</span><span class="w"> </span><span class="kn">import</span> <span class="n">Vizier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">calc_total_error</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.detection</span><span class="w"> </span><span class="kn">import</span> <span class="n">DAOStarFinder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.aperture</span><span class="w"> </span><span class="kn">import</span> <span class="n">CircularAperture</span><span class="p">,</span> <span class="n">CircularAnnulus</span><span class="p">,</span> <span class="n">aperture_photometry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.background</span><span class="w"> </span><span class="kn">import</span> <span class="n">Background2D</span><span class="p">,</span> <span class="n">SExtractorBackground</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.psf</span><span class="w"> </span><span class="kn">import</span> <span class="n">EPSFBuilder</span><span class="p">,</span> <span class="n">extract_stars</span><span class="p">,</span> <span class="n">PSFPhotometry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.psf</span><span class="w"> </span><span class="kn">import</span> <span class="n">SourceGrouper</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">stdpipe</span><span class="w"> </span><span class="kn">import</span> <span class="n">photometry</span><span class="p">,</span> <span class="n">astrometry</span><span class="p">,</span> <span class="n">catalogs</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">src.tools</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">FIGURE_SIZES</span><span class="p">,</span>
    <span class="n">URL</span><span class="p">,</span>
    <span class="n">safe_catalog_query</span><span class="p">,</span>
    <span class="n">safe_wcs_create</span><span class="p">,</span>
    <span class="n">ensure_output_directory</span><span class="p">,</span>
    <span class="n">write_to_log</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span>


<div class="viewcode-block" id="solve_with_astrometrynet">
<a class="viewcode-back" href="../../api.html#src.pipeline.solve_with_astrometrynet">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">solve_with_astrometrynet</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Solve astrometric plate using local Astrometry.Net installation via stdpipe.</span>
<span class="sd">    This function loads a FITS image, detects objects using photutils, and uses stdpipe&#39;s</span>
<span class="sd">    blind_match_objects wrapper around Astrometry.Net to determine accurate WCS information.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file_path : str</span>
<span class="sd">        Path to the FITS image file that needs astrometric solving</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (wcs_object, updated_header) where:</span>
<span class="sd">        - wcs_object: astropy.wcs.WCS object containing the WCS solution</span>
<span class="sd">        - updated_header: Original header updated with WCS keywords</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This function requires:</span>
<span class="sd">    - Local Astrometry.Net installation with solve-field binary</span>
<span class="sd">    - Appropriate index files for the field scale</span>
<span class="sd">    - The image should contain enough stars for plate solving (typically &gt;10)</span>

<span class="sd">    Uses stdpipe.astrometry.blind_match_objects for cleaner interface.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># Load the FITS file</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Loading FITS file for local plate solving...&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
            <span class="n">image_data</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">image_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No image data found in FITS file&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># Ensure data is float32 for better compatibility</span>
        <span class="k">if</span> <span class="n">image_data</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span>
            <span class="n">image_data</span> <span class="o">=</span> <span class="n">image_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># Check if WCS already exists</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">existing_wcs</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">existing_wcs</span><span class="o">.</span><span class="n">is_celestial</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Valid WCS already exists in header. Proceeding with blind solve anyway...&quot;</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No valid WCS found in header. Proceeding with blind solve...&quot;</span><span class="p">)</span>

        <span class="c1"># Estimate background</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Detecting objects for plate solving using photutils...&quot;</span><span class="p">)</span>
        <span class="n">bkg</span><span class="p">,</span> <span class="n">bkg_error</span> <span class="o">=</span> <span class="n">estimate_background</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bkg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to estimate background: </span><span class="si">{</span><span class="n">bkg_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">image_sub</span> <span class="o">=</span> <span class="n">image_data</span> <span class="o">-</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background</span>

        <span class="c1"># Helper function to try different detection parameters</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_try_source_detection</span><span class="p">(</span>
            <span class="n">image_sub</span><span class="p">,</span> <span class="n">fwhm_estimates</span><span class="p">,</span> <span class="n">threshold_multipliers</span><span class="p">,</span> <span class="n">min_sources</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Helper function to try different detection parameters.&quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">fwhm_est</span> <span class="ow">in</span> <span class="n">fwhm_estimates</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">thresh_mult</span> <span class="ow">in</span> <span class="n">threshold_multipliers</span><span class="p">:</span>
                    <span class="n">threshold</span> <span class="o">=</span> <span class="n">thresh_mult</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">image_sub</span><span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Trying FWHM=</span><span class="si">{</span><span class="n">fwhm_est</span><span class="si">}</span><span class="s2">, threshold=</span><span class="si">{</span><span class="n">threshold</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">...&quot;</span>
                        <span class="p">)</span>
                        <span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">fwhm</span><span class="o">=</span><span class="n">fwhm_est</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">)</span>
                        <span class="n">temp_sources</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">image_sub</span><span class="p">)</span>

                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">temp_sources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp_sources</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_sources</span>
                        <span class="p">):</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Photutils found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">temp_sources</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources with &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;FWHM=</span><span class="si">{</span><span class="n">fwhm_est</span><span class="si">}</span><span class="s2">, threshold=</span><span class="si">{</span><span class="n">threshold</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="k">return</span> <span class="n">temp_sources</span>
                        <span class="k">elif</span> <span class="n">temp_sources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">temp_sources</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources (need at least </span><span class="si">{</span><span class="n">min_sources</span><span class="si">}</span><span class="s2">)&quot;</span>
                            <span class="p">)</span>

                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Detection failed with FWHM=</span><span class="si">{</span><span class="n">fwhm_est</span><span class="si">}</span><span class="s2">, threshold=</span><span class="si">{</span><span class="n">threshold</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="k">continue</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Try standard detection parameters first</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="n">_try_source_detection</span><span class="p">(</span>
            <span class="n">image_sub</span><span class="p">,</span>
            <span class="n">fwhm_estimates</span><span class="o">=</span><span class="p">[</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">],</span>
            <span class="n">threshold_multipliers</span><span class="o">=</span><span class="p">[</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">],</span>
            <span class="n">min_sources</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># If that fails, try more aggressive parameters</span>
        <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Standard detection failed. Trying more aggressive parameters...&quot;</span>
            <span class="p">)</span>
            <span class="n">sources</span> <span class="o">=</span> <span class="n">_try_source_detection</span><span class="p">(</span>
                <span class="n">image_sub</span><span class="p">,</span>
                <span class="n">fwhm_estimates</span><span class="o">=</span><span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">],</span>
                <span class="n">threshold_multipliers</span><span class="o">=</span><span class="p">[</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">],</span>
                <span class="n">min_sources</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to detect sufficient sources for plate solving.&quot;</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Possible solutions:&quot;</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;1. Check if the image contains stars (not empty field)&quot;</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;2. Verify image is not severely over/under-exposed&quot;</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;3. Try adjusting the detection threshold manually&quot;</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;4. Consider pre-processing the image (cosmic ray removal, etc.)&quot;</span><span class="p">)</span>

            <span class="c1"># Show a small region of the image for inspection</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">center_y</span><span class="p">,</span> <span class="n">center_x</span> <span class="o">=</span> <span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
                <span class="n">sample_region</span> <span class="o">=</span> <span class="n">image_data</span><span class="p">[</span>
                    <span class="n">center_y</span> <span class="o">-</span> <span class="mi">50</span> <span class="p">:</span> <span class="n">center_y</span> <span class="o">+</span> <span class="mi">50</span><span class="p">,</span> <span class="n">center_x</span> <span class="o">-</span> <span class="mi">50</span> <span class="p">:</span> <span class="n">center_x</span> <span class="o">+</span> <span class="mi">50</span>
                <span class="p">]</span>

                <span class="n">fig_sample</span><span class="p">,</span> <span class="n">ax_sample</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">ax_sample</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sample_region</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
                <span class="n">ax_sample</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Central 100x100 pixel region&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_sample</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="n">fig_sample</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">plot_error</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not display sample region: </span><span class="si">{</span><span class="n">plot_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># Prepare sources for astrometry solving</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully detected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources&quot;</span><span class="p">)</span>

        <span class="c1"># Filter for best sources if too many</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
            <span class="n">sources</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;flux&quot;</span><span class="p">)</span>
            <span class="n">sources</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using brightest </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources for plate solving&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ready for plate solving with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources&quot;</span><span class="p">)</span>

        <span class="c1"># Convert sources to the format expected by stdpipe</span>
        <span class="n">obj_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
        <span class="n">obj_table</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s2">&quot;xcentroid&quot;</span><span class="p">]</span>
        <span class="n">obj_table</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s2">&quot;ycentroid&quot;</span><span class="p">]</span>
        <span class="n">obj_table</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span>

        <span class="c1"># Add signal-to-noise ratio if available</span>
        <span class="k">if</span> <span class="s2">&quot;peak&quot;</span> <span class="ow">in</span> <span class="n">sources</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
            <span class="c1"># Estimate SNR from peak/background ratio</span>
            <span class="n">background_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">image_sub</span><span class="p">)</span>
            <span class="n">obj_table</span><span class="p">[</span><span class="s2">&quot;sn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s2">&quot;peak&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">background_std</span>
            <span class="n">obj_table</span><span class="p">[</span><span class="s2">&quot;fluxerr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">obj_table</span><span class="p">[</span><span class="s2">&quot;sn&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use flux as proxy for SNR</span>
            <span class="n">obj_table</span><span class="p">[</span><span class="s2">&quot;sn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">])</span>
            <span class="n">obj_table</span><span class="p">[</span><span class="s2">&quot;fluxerr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">]))</span>

        <span class="c1"># Ensure fluxerr is positive and finite</span>
        <span class="n">obj_table</span><span class="p">[</span><span class="s2">&quot;fluxerr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">obj_table</span><span class="p">[</span><span class="s2">&quot;fluxerr&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">obj_table</span><span class="p">[</span><span class="s2">&quot;fluxerr&quot;</span><span class="p">]),</span>
            <span class="n">sources</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="n">obj_table</span><span class="p">[</span><span class="s2">&quot;fluxerr&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Get pixel scale estimate</span>
        <span class="n">pixel_scale_estimate</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">:</span>
            <span class="c1"># Try to get pixel scale from various header keywords</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;PIXSCALE&quot;</span><span class="p">,</span> <span class="s2">&quot;PIXSIZE&quot;</span><span class="p">,</span> <span class="s2">&quot;SECPIX&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found pixel scale in header: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">pixel_scale_estimate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="k">break</span>

            <span class="c1"># If still not found, try FOCALLEN + pixel size calculation</span>
            <span class="k">if</span> <span class="n">pixel_scale_estimate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">focal_length</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">pixel_size</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="c1"># Check for focal length keywords</span>
                    <span class="k">for</span> <span class="n">focal_key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;FOCALLEN&quot;</span><span class="p">,</span> <span class="s2">&quot;FOCAL&quot;</span><span class="p">,</span> <span class="s2">&quot;FOCLEN&quot;</span><span class="p">,</span> <span class="s2">&quot;FL&quot;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">focal_key</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                            <span class="n">focal_length</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="n">focal_key</span><span class="p">])</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Found focal length: </span><span class="si">{</span><span class="n">focal_length</span><span class="si">}</span><span class="s2"> mm from </span><span class="si">{</span><span class="n">focal_key</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="k">break</span>

                    <span class="c1"># Check for pixel size keywords (in microns)</span>
                    <span class="k">for</span> <span class="n">pixel_key</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="s2">&quot;PIXELSIZE&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;PIXSIZE&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;XPIXSZ&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;YPIXSZ&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;PIXELMICRONS&quot;</span><span class="p">,</span>
                    <span class="p">]:</span>
                        <span class="k">if</span> <span class="n">pixel_key</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                            <span class="n">pixel_size</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="n">pixel_key</span><span class="p">])</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Found pixel size: </span><span class="si">{</span><span class="n">pixel_size</span><span class="si">}</span><span class="s2"> microns from </span><span class="si">{</span><span class="n">pixel_key</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="k">break</span>

                    <span class="c1"># Calculate pixel scale using the formula from the guide scope reference</span>
                    <span class="k">if</span> <span class="n">focal_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">pixel_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">pixel_scale_estimate</span> <span class="o">=</span> <span class="mi">206</span> <span class="o">*</span> <span class="n">pixel_size</span> <span class="o">/</span> <span class="n">focal_length</span>

                        <span class="c1"># Sanity check - typical astronomical pixel scales</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mf">0.1</span> <span class="o">&lt;=</span> <span class="n">pixel_scale_estimate</span> <span class="o">&lt;=</span> <span class="mf">30.0</span><span class="p">):</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Unusual pixel scale calculated: </span><span class="si">{</span><span class="n">pixel_scale_estimate</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> arcsec/pixel&quot;</span>
                            <span class="p">)</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="s2">&quot;Please verify focal length and pixel size values in header&quot;</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Pixel scale calculated from focal length and pixel size: </span><span class="si">{</span><span class="n">pixel_scale_estimate</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> arcsec/pixel&quot;</span>
                            <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">focal_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Found focal length (</span><span class="si">{</span><span class="n">focal_length</span><span class="si">}</span><span class="s2"> mm) but no pixel size in header&quot;</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">pixel_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Found pixel size (</span><span class="si">{</span><span class="n">pixel_size</span><span class="si">}</span><span class="s2"> Âµm) but no focal length in header&quot;</span>
                        <span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Error calculating pixel scale from focal length/pixel size: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">pass</span>

            <span class="c1"># If not found, try to calculate from CD matrix</span>
            <span class="k">if</span> <span class="n">pixel_scale_estimate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cd_values</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CD</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
                    <span class="p">]</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cd_values</span><span class="p">):</span>
                        <span class="n">cd11</span><span class="p">,</span> <span class="n">cd12</span><span class="p">,</span> <span class="n">cd21</span><span class="p">,</span> <span class="n">cd22</span> <span class="o">=</span> <span class="n">cd_values</span>
                        <span class="n">det</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cd11</span> <span class="o">*</span> <span class="n">cd22</span> <span class="o">-</span> <span class="n">cd12</span> <span class="o">*</span> <span class="n">cd21</span><span class="p">)</span>
                        <span class="n">pixel_scale_estimate</span> <span class="o">=</span> <span class="mi">3600</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Calculated pixel scale from CD matrix&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="c1"># Prepare parameters for stdpipe blind_match_objects</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># SIP distortion order</span>
            <span class="s2">&quot;update&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># Don&#39;t update object list in place</span>
            <span class="s2">&quot;sn&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s2">&quot;get_header&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># Return WCS object, not header</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;verbose&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Add pixel scale constraints if available</span>
        <span class="k">if</span> <span class="n">pixel_scale_estimate</span> <span class="ow">and</span> <span class="n">pixel_scale_estimate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">scale_low</span> <span class="o">=</span> <span class="n">pixel_scale_estimate</span> <span class="o">*</span> <span class="mf">0.8</span>
            <span class="n">scale_high</span> <span class="o">=</span> <span class="n">pixel_scale_estimate</span> <span class="o">*</span> <span class="mf">1.2</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;scale_lower&quot;</span><span class="p">:</span> <span class="n">scale_low</span><span class="p">,</span>
                    <span class="s2">&quot;scale_upper&quot;</span><span class="p">:</span> <span class="n">scale_high</span><span class="p">,</span>
                    <span class="s2">&quot;scale_units&quot;</span><span class="p">:</span> <span class="s2">&quot;arcsecperpix&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Using pixel scale estimate: </span><span class="si">{</span><span class="n">pixel_scale_estimate</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> arcsec/pixel&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use broad scale range if no estimate available</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;scale_lower&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;scale_upper&quot;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span> <span class="s2">&quot;scale_units&quot;</span><span class="p">:</span> <span class="s2">&quot;arcsecperpix&quot;</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No pixel scale estimate available, using broad range&quot;</span><span class="p">)</span>

        <span class="c1"># Add RA/DEC hint if available</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">and</span> <span class="s2">&quot;RA&quot;</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="s2">&quot;DEC&quot;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ra_hint</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;RA&quot;</span><span class="p">])</span>
                <span class="n">dec_hint</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;DEC&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">ra_hint</span> <span class="o">&lt;=</span> <span class="mi">360</span> <span class="ow">and</span> <span class="o">-</span><span class="mi">90</span> <span class="o">&lt;=</span> <span class="n">dec_hint</span> <span class="o">&lt;=</span> <span class="mi">90</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;center_ra&quot;</span><span class="p">:</span> <span class="n">ra_hint</span><span class="p">,</span>
                            <span class="s2">&quot;center_dec&quot;</span><span class="p">:</span> <span class="n">dec_hint</span><span class="p">,</span>
                            <span class="s2">&quot;radius&quot;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>  <span class="c1"># 5 degree search radius</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using RA/DEC hint: </span><span class="si">{</span><span class="n">ra_hint</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">dec_hint</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Could not parse RA/DEC from header&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Running blind_match_objects...&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">obj_table</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources for plate solving&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Call stdpipe&#39;s blind_match_objects function</span>
            <span class="n">solved_wcs</span> <span class="o">=</span> <span class="n">astrometry</span><span class="o">.</span><span class="n">blind_match_objects</span><span class="p">(</span><span class="n">obj_table</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">solved_wcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;Plate solving successful!&quot;</span><span class="p">)</span>

                <span class="c1"># Update original header with WCS solution</span>
                <span class="n">updated_header</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="c1"># Clear any existing WCS keywords to avoid conflicts</span>
                <span class="n">astrometry</span><span class="o">.</span><span class="n">clear_wcs</span><span class="p">(</span>
                    <span class="n">updated_header</span><span class="p">,</span>
                    <span class="n">remove_comments</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">remove_underscored</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">remove_history</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Add new WCS keywords from solution</span>
                <span class="n">wcs_header</span> <span class="o">=</span> <span class="n">solved_wcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">(</span><span class="n">relax</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">updated_header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">wcs_header</span><span class="p">)</span>

                <span class="c1"># Add solution metadata</span>
                <span class="n">updated_header</span><span class="p">[</span><span class="s2">&quot;COMMENT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;WCS solution from stdpipe/astrometry.net&quot;</span>
                <span class="n">updated_header</span><span class="p">[</span><span class="s2">&quot;STDPIPE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;Solved with stdpipe.astrometry.blind_match_objects&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Display solution information</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">center_ra</span><span class="p">,</span> <span class="n">center_dec</span> <span class="o">=</span> <span class="n">solved_wcs</span><span class="o">.</span><span class="n">pixel_to_world_values</span><span class="p">(</span>
                        <span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="p">)</span>
                    <span class="n">pixel_scale</span> <span class="o">=</span> <span class="n">astrometry</span><span class="o">.</span><span class="n">get_pixscale</span><span class="p">(</span><span class="n">wcs</span><span class="o">=</span><span class="n">solved_wcs</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3600</span>

                    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Solution center: RA=</span><span class="si">{</span><span class="n">center_ra</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">Â°, DEC=</span><span class="si">{</span><span class="n">center_dec</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">Â°&quot;</span>
                    <span class="p">)</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pixel scale: </span><span class="si">{</span><span class="n">pixel_scale</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> arcsec/pixel&quot;</span><span class="p">)</span>

                    <span class="c1"># Validate solution makes sense</span>
                    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">center_ra</span> <span class="o">&lt;=</span> <span class="mi">360</span> <span class="ow">and</span> <span class="o">-</span><span class="mi">90</span> <span class="o">&lt;=</span> <span class="n">center_dec</span> <span class="o">&lt;=</span> <span class="mi">90</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;Solution coordinates are valid&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Solution coordinates seem invalid!&quot;</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">coord_error</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not extract solution coordinates: </span><span class="si">{</span><span class="n">coord_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">solved_wcs</span><span class="p">,</span> <span class="n">updated_header</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Plate solving failed!&quot;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Possible issues:&quot;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;- Not enough stars detected&quot;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;- Incorrect pixel scale estimate&quot;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;- Field not in astrometry.net index files&quot;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;- solve-field not found in PATH&quot;</span><span class="p">)</span>

                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">solve_error</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during stdpipe plate solving: </span><span class="si">{</span><span class="n">solve_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Requirements:&quot;</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;- solve-field binary must be in PATH&quot;</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;- Appropriate astrometry.net index files must be installed&quot;</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;- Sufficient sources with good S/N ratio&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in plate solving setup: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="detect_remove_cosmic_rays">
<a class="viewcode-back" href="../../api.html#src.pipeline.detect_remove_cosmic_rays">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">detect_remove_cosmic_rays</span><span class="p">(</span>
    <span class="n">image_data</span><span class="p">,</span>
    <span class="n">gain</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">readnoise</span><span class="o">=</span><span class="mf">6.5</span><span class="p">,</span>
    <span class="n">sigclip</span><span class="o">=</span><span class="mf">4.5</span><span class="p">,</span>
    <span class="n">sigfrac</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
    <span class="n">objlim</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detect and remove cosmic rays from an astronomical image using</span>
<span class="sd">    astroscrappy.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image_data : numpy.ndarray</span>
<span class="sd">        The 2D image array</span>
<span class="sd">    gain : float, optional</span>
<span class="sd">        CCD gain (electrons/ADU), default=1.0</span>
<span class="sd">    readnoise : float, optional</span>
<span class="sd">        CCD read noise (electrons), default=6.5</span>
<span class="sd">    sigclip : float, optional</span>
<span class="sd">        Detection sigma threshold, default=4.5</span>
<span class="sd">    sigfrac : float, optional</span>
<span class="sd">        Fractional detection threshold, default=0.3</span>
<span class="sd">    objlim : float, optional</span>
<span class="sd">        Minimum contrast between cosmic ray and underlying object, default=5.0</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Whether to print verbose output, default=False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (cleaned_image, mask, num_cosmic_rays) where:</span>
<span class="sd">        - cleaned_image: numpy.ndarray with cosmic rays removed</span>
<span class="sd">        - mask: boolean numpy.ndarray showing cosmic ray locations (True where cosmic rays were detected)</span>
<span class="sd">        - num_cosmic_rays: int, number of cosmic rays detected</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Uses the L.A.Cosmic algorithm implemented in astroscrappy.</span>
<span class="sd">    The algorithm detects cosmic rays using Laplacian edge detection.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Ensure the image is in the correct format</span>
        <span class="n">image_data</span> <span class="o">=</span> <span class="n">image_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># Detect and remove cosmic rays using astroscrappy&#39;s implementation of L.A.Cosmic</span>
        <span class="n">mask</span><span class="p">,</span> <span class="n">cleaned_image</span> <span class="o">=</span> <span class="n">astroscrappy</span><span class="o">.</span><span class="n">detect_cosmics</span><span class="p">(</span>
            <span class="n">image_data</span><span class="p">,</span>
            <span class="n">gain</span><span class="o">=</span><span class="n">gain</span><span class="p">,</span>
            <span class="n">readnoise</span><span class="o">=</span><span class="n">readnoise</span><span class="p">,</span>
            <span class="n">sigclip</span><span class="o">=</span><span class="n">sigclip</span><span class="p">,</span>
            <span class="n">sigfrac</span><span class="o">=</span><span class="n">sigfrac</span><span class="p">,</span>
            <span class="n">objlim</span><span class="o">=</span><span class="n">objlim</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cleaned_image</span><span class="p">,</span> <span class="n">mask</span>

    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;astroscrappy package is not installed. Cannot remove cosmic rays.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image_data</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during cosmic ray removal: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image_data</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span></div>



<div class="viewcode-block" id="make_border_mask">
<a class="viewcode-back" href="../../api.html#src.pipeline.make_border_mask">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_border_mask</span><span class="p">(</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">border</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
    <span class="n">invert</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a binary mask for an image excluding one or more border regions.</span>

<span class="sd">    This function creates a mask that can be used to exclude border pixels</span>
<span class="sd">    from analysis, which is useful for operations that might be affected</span>
<span class="sd">    by edge artifacts.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image : numpy.ndarray</span>
<span class="sd">        The input image as a NumPy array</span>
<span class="sd">    border : int or tuple of int, default=50</span>
<span class="sd">        Border size(s) to exclude from the mask:</span>
<span class="sd">        - If int: same border size on all sides</span>
<span class="sd">        - If tuple of 2 elements: (vertical, horizontal) borders</span>
<span class="sd">        - If tuple of 4 elements: (top, bottom, left, right) borders</span>
<span class="sd">    invert : bool, default=True</span>
<span class="sd">        If True, the mask will be inverted (False for border regions)</span>
<span class="sd">        If False, the mask will be True for non-border regions</span>
<span class="sd">    dtype : numpy.dtype, default=bool</span>
<span class="sd">        Data type of the output mask</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        Binary mask with the same height and width as the input image</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    TypeError</span>
<span class="sd">        If image is not a NumPy array or border is not of the correct type</span>
<span class="sd">    ValueError</span>
<span class="sd">        If image is empty, borders are negative, borders are larger than the image,</span>
<span class="sd">        or border tuple has an invalid length</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; img = np.ones((100, 100))</span>
<span class="sd">    &gt;&gt;&gt; # Create a mask with 10px border on all sides</span>
<span class="sd">    &gt;&gt;&gt; mask = make_border_mask(img, 10)</span>
<span class="sd">    &gt;&gt;&gt; # Create a mask with different vertical/horizontal borders</span>
<span class="sd">    &gt;&gt;&gt; mask = make_border_mask(img, (20, 30))</span>
<span class="sd">    &gt;&gt;&gt; # Create a mask with custom borders for each side</span>
<span class="sd">    &gt;&gt;&gt; mask = make_border_mask(img, (10, 20, 30, 40), invert=False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Image cannot be None&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Image must be a numpy.ndarray&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Image cannot be empty&quot;</span><span class="p">)</span>

    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">border</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">border</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">border</span><span class="p">)</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">left</span> <span class="o">=</span> <span class="n">right</span> <span class="o">=</span> <span class="n">border</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">border</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">border</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">vert</span><span class="p">,</span> <span class="n">horiz</span> <span class="o">=</span> <span class="n">border</span>
            <span class="n">top</span> <span class="o">=</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">vert</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">right</span> <span class="o">=</span> <span class="n">horiz</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">border</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">top</span> <span class="o">=</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">border</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">right</span> <span class="o">=</span> <span class="n">border</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;border must be an int&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;border must be an int&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">b</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Borders cannot be negative&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">top</span> <span class="o">+</span> <span class="n">bottom</span> <span class="o">&gt;=</span> <span class="n">height</span> <span class="ow">or</span> <span class="n">left</span> <span class="o">+</span> <span class="n">right</span> <span class="o">&gt;=</span> <span class="n">width</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Borders are larger than the image&quot;</span><span class="p">)</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">mask</span><span class="p">[</span><span class="n">top</span> <span class="p">:</span> <span class="n">height</span> <span class="o">-</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">left</span> <span class="p">:</span> <span class="n">width</span> <span class="o">-</span> <span class="n">right</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="o">~</span><span class="n">mask</span> <span class="k">if</span> <span class="n">invert</span> <span class="k">else</span> <span class="n">mask</span></div>



<div class="viewcode-block" id="estimate_background">
<a class="viewcode-back" href="../../api.html#src.pipeline.estimate_background">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">estimate_background</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">box_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">filter_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimate the background and background RMS of an astronomical image.</span>

<span class="sd">    Uses photutils.Background2D to create a 2D background model with sigma-clipping</span>
<span class="sd">    and the SExtractor background estimation algorithm. Includes error handling</span>
<span class="sd">    and automatic adjustment for small images.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image_data : numpy.ndarray</span>
<span class="sd">        The 2D image array</span>
<span class="sd">    box_size : int, optional</span>
<span class="sd">        The box size in pixels for the local background estimation.</span>
<span class="sd">        Will be automatically adjusted if the image is small.</span>
<span class="sd">    filter_size : int, optional</span>
<span class="sd">        Size of the filter for smoothing the background.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (background_2d_object, error_message) where:</span>
<span class="sd">        - background_2d_object: photutils.Background2D object if successful, None if failed</span>
<span class="sd">        - error_message: None if successful, string describing the error if failed</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function automatically adjusts the box_size and filter_size parameters</span>
<span class="sd">    if the image is too small, and handles various edge cases to ensure robust</span>
<span class="sd">    background estimation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">image_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;No image data provided&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Image data must be a numpy array, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Image must be 2D, got shape </span><span class="si">{</span><span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">image_data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">adjusted_box_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">box_size</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">height</span> <span class="o">//</span> <span class="mi">10</span><span class="p">,</span> <span class="n">width</span> <span class="o">//</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">128</span><span class="p">))</span>
    <span class="n">adjusted_filter_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">filter_size</span><span class="p">,</span> <span class="n">adjusted_box_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">adjusted_box_size</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Image too small (</span><span class="si">{</span><span class="n">height</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s2">) for background estimation&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">sigma_clip</span> <span class="o">=</span> <span class="n">SigmaClip</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">bkg_estimator</span> <span class="o">=</span> <span class="n">SExtractorBackground</span><span class="p">()</span>

        <span class="n">bkg</span> <span class="o">=</span> <span class="n">Background2D</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">image_data</span><span class="p">,</span>
            <span class="n">box_size</span><span class="o">=</span><span class="n">adjusted_box_size</span><span class="p">,</span>
            <span class="n">filter_size</span><span class="o">=</span><span class="n">adjusted_filter_size</span><span class="p">,</span>
            <span class="n">sigma_clip</span><span class="o">=</span><span class="n">sigma_clip</span><span class="p">,</span>
            <span class="n">bkg_estimator</span><span class="o">=</span><span class="n">bkg_estimator</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Plot the background model with ZScale and save as FITS</span>
        <span class="k">if</span> <span class="n">figure</span><span class="p">:</span>
            <span class="n">fig_bkg</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Create a figure with two subplots side by side for background/RMS</span>
                <span class="n">fig_bkg</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

                <span class="c1"># Use ZScaleInterval for better visualization</span>
                <span class="n">zscale</span> <span class="o">=</span> <span class="n">ZScaleInterval</span><span class="p">()</span>
                <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">zscale</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">bkg</span><span class="o">.</span><span class="n">background</span><span class="p">)</span>

                <span class="c1"># Plot the background model</span>
                <span class="n">im1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                    <span class="n">bkg</span><span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span>
                <span class="p">)</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Estimated Background&quot;</span><span class="p">)</span>
                <span class="n">fig_bkg</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Flux&quot;</span><span class="p">)</span>

                <span class="c1"># Plot the background RMS</span>
                <span class="n">vmin_rms</span><span class="p">,</span> <span class="n">vmax_rms</span> <span class="o">=</span> <span class="n">zscale</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">bkg</span><span class="o">.</span><span class="n">background_rms</span><span class="p">)</span>
                <span class="n">im2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                    <span class="n">bkg</span><span class="o">.</span><span class="n">background_rms</span><span class="p">,</span>
                    <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
                    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
                    <span class="n">vmin</span><span class="o">=</span><span class="n">vmin_rms</span><span class="p">,</span>
                    <span class="n">vmax</span><span class="o">=</span><span class="n">vmax_rms</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Background RMS&quot;</span><span class="p">)</span>
                <span class="n">fig_bkg</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Flux&quot;</span><span class="p">)</span>

                <span class="n">fig_bkg</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">st</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="n">fig_bkg</span><span class="p">)</span>

                <span class="c1"># Save background as FITS file</span>
                <span class="n">base_filename</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;base_filename&quot;</span><span class="p">,</span> <span class="s2">&quot;photometry&quot;</span><span class="p">)</span>
                <span class="n">username</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;anonymous&quot;</span><span class="p">)</span>
                <span class="n">output_dir</span> <span class="o">=</span> <span class="n">ensure_output_directory</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">_rpp_results&quot;</span><span class="p">)</span>
                <span class="n">bkg_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_filename</span><span class="si">}</span><span class="s2">_bkg.fits&quot;</span>
                <span class="n">bkg_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">bkg_filename</span><span class="p">)</span>

                <span class="c1"># Create FITS HDU and save background model</span>
                <span class="n">hdu_bkg</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">bkg</span><span class="o">.</span><span class="n">background</span><span class="p">)</span>
                <span class="n">hdu_bkg</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;COMMENT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Background model created with photutils.Background2D&quot;</span>
                <span class="p">)</span>
                <span class="n">hdu_bkg</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BOXSIZE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">adjusted_box_size</span><span class="p">,</span>
                    <span class="s2">&quot;Box size for background estimation&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">hdu_bkg</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FILTSIZE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">adjusted_filter_size</span><span class="p">,</span>
                    <span class="s2">&quot;Filter size for background smoothing&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Add RMS as extension</span>
                <span class="n">hdu_rms</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">bkg</span><span class="o">.</span><span class="n">background_rms</span><span class="p">)</span>
                <span class="n">hdu_rms</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;EXTNAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;BACKGROUND_RMS&quot;</span>

                <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span><span class="n">hdu_bkg</span><span class="p">,</span> <span class="n">hdu_rms</span><span class="p">])</span>
                <span class="n">hdul</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">bkg_filepath</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Write to log if available</span>
                <span class="n">log_buffer</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;log_buffer&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">log_buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">write_to_log</span><span class="p">(</span>
                        <span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Background model saved to </span><span class="si">{</span><span class="n">bkg_filename</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating or saving background plot: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># Clean up matplotlib figure to prevent memory leaks</span>
                <span class="k">if</span> <span class="n">fig_bkg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig_bkg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bkg</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Background estimation error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span></div>



<div class="viewcode-block" id="airmass">
<a class="viewcode-back" href="../../api.html#src.pipeline.airmass">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">airmass</span><span class="p">(</span>
    <span class="n">_header</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">observatory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">return_details</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the airmass for a celestial object from observation parameters.</span>

<span class="sd">    Airmass is a measure of the optical path length through Earth&#39;s atmosphere.</span>
<span class="sd">    This function calculates it from header information and observatory location,</span>
<span class="sd">    handling multiple coordinate formats and performing physical validity checks.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    _header : Dict</span>
<span class="sd">        FITS header or dictionary containing observation information.</span>
<span class="sd">        Must include:</span>
<span class="sd">        - Coordinates (RA/DEC or OBJRA/OBJDEC)</span>
<span class="sd">        - Observation date (DATE-OBS)</span>
<span class="sd">    observatory : Dict, optional</span>
<span class="sd">        Information about the observatory. If not provided, uses the default.</span>
<span class="sd">        Format: {</span>
<span class="sd">            &#39;name&#39;: str,           # Observatory name</span>
<span class="sd">            &#39;latitude&#39;: float,     # Latitude in degrees</span>
<span class="sd">            &#39;longitude&#39;: float,    # Longitude in degrees</span>
<span class="sd">            &#39;elevation&#39;: float     # Elevation in meters</span>
<span class="sd">        }</span>
<span class="sd">    return_details : bool, optional</span>
<span class="sd">        If True, returns additional information about the observation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Union[float, Tuple[float, Dict]]</span>
<span class="sd">        - If return_details=False: airmass (float)</span>
<span class="sd">        - If return_details=True: (airmass, observation_details)</span>
<span class="sd">          where observation_details is a dictionary with:</span>
<span class="sd">          - observatory name</span>
<span class="sd">          - datetime</span>
<span class="sd">          - target coordinates</span>
<span class="sd">          - altitude/azimuth</span>
<span class="sd">          - sun altitude</span>
<span class="sd">          - observation type (night/twilight/day)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Airmass is approximately sec(z) where z is the zenith angle.</span>
<span class="sd">    The function enforces physical constraints (airmass â¥ 1.0) and</span>
<span class="sd">    displays warnings for extreme values. It also determines whether</span>
<span class="sd">    the observation was taken during night, twilight or day.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check if airmass already exists in header</span>
    <span class="n">airmass_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;AIRMASS&quot;</span><span class="p">,</span> <span class="s2">&quot;SECZ&quot;</span><span class="p">,</span> <span class="s2">&quot;AIRMASS_START&quot;</span><span class="p">,</span> <span class="s2">&quot;AIRMASS_END&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">airmass_keywords</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">_header</span> <span class="ow">and</span> <span class="n">_header</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">existing_airmass</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">_header</span><span class="p">[</span><span class="n">keyword</span><span class="p">])</span>
                <span class="c1"># Validate the existing airmass value</span>
                <span class="k">if</span> <span class="mf">1.0</span> <span class="o">&lt;=</span> <span class="n">existing_airmass</span> <span class="o">&lt;=</span> <span class="mf">30.0</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Using existing airmass from header...&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">return_details</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">existing_airmass</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;airmass_source&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;header_</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
                    <span class="k">return</span> <span class="n">existing_airmass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Invalid airmass value in header (</span><span class="si">{</span><span class="n">existing_airmass</span><span class="si">}</span><span class="s2">), calculating from coordinates&quot;</span>
                    <span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Could not parse airmass value from header keyword </span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">continue</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_observation_type</span><span class="p">(</span><span class="n">sun_alt</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sun_alt</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">18</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;night&quot;</span>
        <span class="k">if</span> <span class="n">sun_alt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;twilight&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;day&quot;</span>

    <span class="n">obs_data</span> <span class="o">=</span> <span class="n">observatory</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="n">_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;RA&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OBJRA&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CRVAL1&quot;</span><span class="p">)</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DEC&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OBJDEC&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CRVAL2&quot;</span><span class="p">)</span>

        <span class="c1"># Check for various date keywords in order of preference</span>
        <span class="n">date_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;DATE-OBS&quot;</span><span class="p">,</span> <span class="s2">&quot;DATE&quot;</span><span class="p">,</span> <span class="s2">&quot;DATE_OBS&quot;</span><span class="p">,</span> <span class="s2">&quot;DATEOBS&quot;</span><span class="p">,</span> <span class="s2">&quot;MJD-OBS&quot;</span><span class="p">]</span>
        <span class="n">obstime_str</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">date_keywords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">_header</span> <span class="ow">and</span> <span class="n">_header</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">obstime_str</span> <span class="o">=</span> <span class="n">_header</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">obstime_str</span><span class="p">]):</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">ra</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;RA/OBJRA/CRVAL1&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;DEC/OBJDEC/CRVAL2&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obstime_str</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;DATE-OBS/DATE&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required header keywords: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;icrs&quot;</span><span class="p">)</span>

        <span class="c1"># Try to parse the observation time with different formats</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># First, try direct parsing</span>
            <span class="n">obstime</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">obstime_str</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># If that fails, try different parsing strategies</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Handle common FITS date formats</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obstime_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="c1"># Remove any timezone info and try to parse</span>
                    <span class="n">clean_date</span> <span class="o">=</span> <span class="n">obstime_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                    <span class="c1"># Try ISO format</span>
                    <span class="n">obstime</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">clean_date</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;iso&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If it&#39;s not a string, convert it</span>
                    <span class="n">obstime</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">obstime_str</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># Last resort: try as MJD if it&#39;s a number</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mjd_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">obstime_str</span><span class="p">)</span>
                    <span class="n">obstime</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">mjd_value</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;mjd&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Could not parse observation time &#39;</span><span class="si">{</span><span class="n">obstime_str</span><span class="si">}</span><span class="s2">&#39; in any recognized format&quot;</span>
                    <span class="p">)</span>

        <span class="n">location</span> <span class="o">=</span> <span class="n">EarthLocation</span><span class="p">(</span>
            <span class="n">lat</span><span class="o">=</span><span class="n">obs_data</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
            <span class="n">lon</span><span class="o">=</span><span class="n">obs_data</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="n">obs_data</span><span class="p">[</span><span class="s2">&quot;elevation&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">altaz_frame</span> <span class="o">=</span> <span class="n">AltAz</span><span class="p">(</span><span class="n">obstime</span><span class="o">=</span><span class="n">obstime</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">)</span>
        <span class="n">altaz</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">altaz_frame</span><span class="p">)</span>
        <span class="n">airmass_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">altaz</span><span class="o">.</span><span class="n">secz</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">airmass_value</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Calculated airmass is less than 1 (impossible)&quot;</span><span class="p">)</span>
            <span class="n">airmass_value</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">elif</span> <span class="n">airmass_value</span> <span class="o">&gt;</span> <span class="mf">30.0</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Extremely high airmass (&gt;30), object near horizon&quot;</span><span class="p">)</span>

        <span class="n">sun_altaz</span> <span class="o">=</span> <span class="n">get_sun</span><span class="p">(</span><span class="n">obstime</span><span class="p">)</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">altaz_frame</span><span class="p">)</span>
        <span class="n">sun_alt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sun_altaz</span><span class="o">.</span><span class="n">alt</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>

        <span class="n">details</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;observatory&quot;</span><span class="p">:</span> <span class="n">obs_data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
            <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">obstime</span><span class="o">.</span><span class="n">iso</span><span class="p">,</span>
            <span class="s2">&quot;target_coords&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;ra&quot;</span><span class="p">:</span> <span class="n">coord</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">),</span>
                <span class="s2">&quot;observation_type&quot;</span><span class="p">:</span> <span class="n">get_observation_type</span><span class="p">(</span><span class="n">sun_alt</span><span class="p">),</span>
            <span class="p">},</span>
            <span class="s2">&quot;sun_altitude&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">sun_alt</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s2">&quot;observation_type&quot;</span><span class="p">:</span> <span class="n">get_observation_type</span><span class="p">(</span><span class="n">sun_alt</span><span class="p">),</span>
            <span class="s2">&quot;altaz&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;altitude&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">altaz</span><span class="o">.</span><span class="n">alt</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s2">&quot;azimuth&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">altaz</span><span class="o">.</span><span class="n">az</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">},</span>
        <span class="p">}</span>

        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Date &amp; UTC-Time: </span><span class="si">{</span><span class="n">obstime</span><span class="o">.</span><span class="n">iso</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Altitude: </span><span class="si">{</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;altaz&#39;</span><span class="p">][</span><span class="s1">&#39;altitude&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">Â°, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot; Azimuth: </span><span class="si">{</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;altaz&#39;</span><span class="p">][</span><span class="s1">&#39;azimuth&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">Â°&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">return_details</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">airmass_value</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">details</span>
        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">airmass_value</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calculating airmass: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_details</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="mf">0.0</span></div>



<div class="viewcode-block" id="fwhm_fit">
<a class="viewcode-back" href="../../api.html#src.pipeline.fwhm_fit">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fwhm_fit</span><span class="p">(</span>
    <span class="n">_img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">std_lo</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">std_hi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimate the Full Width at Half Maximum (FWHM) of stars in an astronomical image.</span>

<span class="sd">    This function detects sources in the image using DAOStarFinder, filters them based on</span>
<span class="sd">    flux values, and fits 1D Gaussian models to the marginal distributions of each source</span>
<span class="sd">    to calculate FWHM values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : numpy.ndarray</span>
<span class="sd">        The 2D image array containing astronomical sources</span>
<span class="sd">    fwhm : float</span>
<span class="sd">        Initial FWHM estimate in pixels, used for source detection</span>
<span class="sd">    pixel_scale : float</span>
<span class="sd">        The pixel scale of the image in arcseconds per pixel</span>
<span class="sd">    mask : numpy.ndarray, optional</span>
<span class="sd">        Boolean mask array where True indicates pixels to ignore during source detection</span>
<span class="sd">    std_lo : float, default=0.5</span>
<span class="sd">        Lower bound for flux filtering, in standard deviations below median flux</span>
<span class="sd">    std_hi : float, default=0.5</span>
<span class="sd">        Upper bound for flux filtering, in standard deviations above median flux</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float or None</span>
<span class="sd">        The median FWHM value in pixels (rounded to nearest integer) if successful,</span>
<span class="sd">        or None if no valid sources could be measured</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function uses marginal sums along the x and y dimensions and fits 1D Gaussian</span>
<span class="sd">    profiles to estimate FWHM. For each source, a box of size ~6ÃFWHM is extracted,</span>
<span class="sd">    and profiles are fit independently in both dimensions, with the results averaged.</span>

<span class="sd">    Progress updates and error messages are displayed using Streamlit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">_img</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">clipped_std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">_img</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>

        <span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span>
            <span class="n">fwhm</span><span class="o">=</span><span class="mf">1.6</span> <span class="o">*</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">8</span> <span class="o">*</span> <span class="n">clipped_std</span><span class="p">,</span> <span class="n">peakmax</span><span class="o">=</span><span class="n">peak</span>
        <span class="p">)</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">_img</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No sources found !&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">flux</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span>
        <span class="n">median_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
        <span class="n">std_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
        <span class="n">mask_flux</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux</span> <span class="o">&gt;</span> <span class="n">median_flux</span> <span class="o">-</span> <span class="n">std_lo</span> <span class="o">*</span> <span class="n">std_flux</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">flux</span> <span class="o">&lt;</span> <span class="n">median_flux</span> <span class="o">+</span> <span class="n">std_hi</span> <span class="o">*</span> <span class="n">std_flux</span>
        <span class="p">)</span>
        <span class="n">filtered_sources</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="n">mask_flux</span><span class="p">]</span>

        <span class="n">filtered_sources</span> <span class="o">=</span> <span class="n">filtered_sources</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">filtered_sources</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">])]</span>

        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sources after flux filtering: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_sources</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_sources</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No valid sources for fitting found after filtering.&quot;</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">box_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="nb">round</span><span class="p">(</span><span class="n">fwhm</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">box_size</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">box_size</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">xypos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">filtered_sources</span><span class="p">[</span><span class="s2">&quot;xcentroid&quot;</span><span class="p">],</span> <span class="n">filtered_sources</span><span class="p">[</span><span class="s2">&quot;ycentroid&quot;</span><span class="p">]))</span>
        <span class="n">fwhms</span> <span class="o">=</span> <span class="n">fit_fwhm</span><span class="p">(</span><span class="n">_img</span><span class="p">,</span> <span class="n">xypos</span><span class="o">=</span><span class="n">xypos</span><span class="p">,</span> <span class="n">fit_shape</span><span class="o">=</span><span class="n">box_size</span><span class="p">)</span>

        <span class="n">mean_fwhm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">fwhms</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FWHM based on Gaussian model: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">mean_fwhm</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> pixels&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">mean_fwhm</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">clipped_std</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error in fwhm_fit: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error in fwhm_fit: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="perform_psf_photometry">
<a class="viewcode-back" href="../../api.html#src.pipeline.perform_psf_photometry">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">perform_psf_photometry</span><span class="p">(</span>
    <span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">photo_table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span>
    <span class="n">fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">daostarfind</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">error</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Table</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform PSF (Point Spread Function) photometry using an empirically-constructed PSF model.</span>

<span class="sd">    This function builds an empirical PSF (EPSF) from bright stars in the image</span>
<span class="sd">    and then uses this model to perform PSF photometry on all detected sources.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : numpy.ndarray</span>
<span class="sd">        Image with sky background subtracted</span>
<span class="sd">    photo_table : astropy.table.Table</span>
<span class="sd">        Table containing source positions</span>
<span class="sd">    fwhm : float</span>
<span class="sd">        Full Width at Half Maximum in pixels, used to define extraction and fitting sizes</span>
<span class="sd">    daostarfind : callable</span>
<span class="sd">        Star detection function used as &quot;finder&quot; in PSF photometry</span>
<span class="sd">    mask : numpy.ndarray, optional</span>
<span class="sd">        Mask to exclude certain image areas from analysis</span>
<span class="sd">    error : numpy.ndarray, optional</span>
<span class="sd">        Error array for the image</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tuple[astropy.table.Table, photutils.psf.EPSFModel]</span>
<span class="sd">        - phot_epsf_result : Table containing PSF photometry results, including fitted fluxes and positions</span>
<span class="sd">        - epsf : The fitted EPSF model used for photometry</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initial validation</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid image data provided. Ensure the image is a non-empty numpy array.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid mask provided. Ensure the mask is a numpy array with the same shape as the image.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">daostarfind</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The &#39;finder&#39; parameter must be a callable star finder, such as DAOStarFinder.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># build NDData including mask/uncertainty when available (improves extract_stars)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">astropy.nddata</span><span class="w"> </span><span class="kn">import</span> <span class="n">StdDevUncertainty</span>

            <span class="n">nd_unc</span> <span class="o">=</span> <span class="n">StdDevUncertainty</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">nd_unc</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">nddata</span> <span class="o">=</span> <span class="n">NDData</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">img</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span> <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="n">uncertainty</span><span class="o">=</span><span class="n">nd_unc</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in initial validation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="c1"># Filter photo_table to select only the best stars for PSF model</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Filtering stars for PSF model construction...&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure table-like behavior for astropy Table / QTable (no .get)</span>
        <span class="n">n_sources</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">photo_table</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_sources</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;photo_table is empty&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_col_arr</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tbl</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># return default repeated to match table length</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">default</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">n_sources</span><span class="p">,)</span>
                    <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_sources</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_sources</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1"># Required columns (raise helpful error if missing)</span>
        <span class="k">if</span> <span class="s2">&quot;flux&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">photo_table</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;photo_table missing required column &#39;flux&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;xcentroid&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">photo_table</span><span class="o">.</span><span class="n">colnames</span>
            <span class="ow">or</span> <span class="s2">&quot;ycentroid&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">photo_table</span><span class="o">.</span><span class="n">colnames</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;photo_table must contain &#39;xcentroid&#39; and &#39;ycentroid&#39; columns&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Get arrays safely</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">_col_arr</span><span class="p">(</span><span class="n">photo_table</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">)</span>
        <span class="n">roundness1</span> <span class="o">=</span> <span class="n">_col_arr</span><span class="p">(</span><span class="n">photo_table</span><span class="p">,</span> <span class="s2">&quot;roundness1&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">sharpness</span> <span class="o">=</span> <span class="n">_col_arr</span><span class="p">(</span><span class="n">photo_table</span><span class="p">,</span> <span class="s2">&quot;sharpness&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">xcentroid</span> <span class="o">=</span> <span class="n">_col_arr</span><span class="p">(</span><span class="n">photo_table</span><span class="p">,</span> <span class="s2">&quot;xcentroid&quot;</span><span class="p">)</span>
        <span class="n">ycentroid</span> <span class="o">=</span> <span class="n">_col_arr</span><span class="p">(</span><span class="n">photo_table</span><span class="p">,</span> <span class="s2">&quot;ycentroid&quot;</span><span class="p">)</span>

        <span class="c1"># Get flux statistics with NaN handling</span>
        <span class="n">flux_finite</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">flux</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flux_finite</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No sources with finite flux values found&quot;</span><span class="p">)</span>

        <span class="n">flux_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flux_finite</span><span class="p">)</span>
        <span class="n">flux_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">flux_finite</span><span class="p">)</span>

        <span class="c1"># Define flux filtering criteria</span>
        <span class="n">flux_min</span> <span class="o">=</span> <span class="n">flux_median</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">flux_std</span>
        <span class="n">flux_max</span> <span class="o">=</span> <span class="n">flux_median</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">flux_std</span>

        <span class="c1"># Create individual boolean masks with explicit NaN handling</span>
        <span class="n">valid_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
        <span class="n">valid_roundness</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">roundness1</span><span class="p">)</span>
        <span class="n">valid_sharpness</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">sharpness</span><span class="p">)</span>
        <span class="n">valid_xcentroid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">xcentroid</span><span class="p">)</span>
        <span class="n">valid_ycentroid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">ycentroid</span><span class="p">)</span>

        <span class="c1"># Combine validity checks</span>
        <span class="n">valid_all</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">valid_flux</span>
            <span class="o">&amp;</span> <span class="n">valid_roundness</span>
            <span class="o">&amp;</span> <span class="n">valid_sharpness</span>
            <span class="o">&amp;</span> <span class="n">valid_xcentroid</span>
            <span class="o">&amp;</span> <span class="n">valid_ycentroid</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">valid_all</span><span class="p">):</span>
            <span class="c1"># relax: accept stars where position and flux are valid at least</span>
            <span class="n">valid_all</span> <span class="o">=</span> <span class="n">valid_flux</span> <span class="o">&amp;</span> <span class="n">valid_xcentroid</span> <span class="o">&amp;</span> <span class="n">valid_ycentroid</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">valid_all</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No sources with required valid parameters found&quot;</span><span class="p">)</span>

        <span class="n">flux_criteria</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">valid_flux</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">flux_criteria</span><span class="p">[</span><span class="n">valid_flux</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">valid_flux</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">flux_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">flux</span><span class="p">[</span><span class="n">valid_flux</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">flux_max</span>
        <span class="p">)</span>

        <span class="n">roundness_criteria</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">valid_roundness</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">roundness_criteria</span><span class="p">[</span><span class="n">valid_roundness</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">roundness1</span><span class="p">[</span><span class="n">valid_roundness</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.25</span>

        <span class="n">sharpness_criteria</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">valid_sharpness</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">sharpness_criteria</span><span class="p">[</span><span class="n">valid_sharpness</span><span class="p">]</span> <span class="o">=</span> <span class="n">sharpness</span><span class="p">[</span><span class="n">valid_sharpness</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span>

        <span class="c1"># Edge criteria</span>
        <span class="n">edge_criteria</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">valid_xcentroid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">valid_coords</span> <span class="o">=</span> <span class="n">valid_xcentroid</span> <span class="o">&amp;</span> <span class="n">valid_ycentroid</span>
        <span class="n">edge_criteria</span><span class="p">[</span><span class="n">valid_coords</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">xcentroid</span><span class="p">[</span><span class="n">valid_coords</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">fwhm</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">xcentroid</span><span class="p">[</span><span class="n">valid_coords</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">fwhm</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">ycentroid</span><span class="p">[</span><span class="n">valid_coords</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">fwhm</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">ycentroid</span><span class="p">[</span><span class="n">valid_coords</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">fwhm</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Combine all criteria with validity checks</span>
        <span class="n">good_stars_mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">valid_all</span>
            <span class="o">&amp;</span> <span class="n">flux_criteria</span>
            <span class="o">&amp;</span> <span class="n">roundness_criteria</span>
            <span class="o">&amp;</span> <span class="n">sharpness_criteria</span>
            <span class="o">&amp;</span> <span class="n">edge_criteria</span>
        <span class="p">)</span>

        <span class="c1"># Apply filters</span>
        <span class="n">filtered_photo_table</span> <span class="o">=</span> <span class="n">photo_table</span><span class="p">[</span><span class="n">good_stars_mask</span><span class="p">]</span>

        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original sources: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">photo_table</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtered sources for PSF model: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_photo_table</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Flux range for PSF stars: </span><span class="si">{</span><span class="n">flux_min</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">flux_max</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Check if we have enough stars for PSF construction</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_photo_table</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Only </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_photo_table</span><span class="p">)</span><span class="si">}</span><span class="s2"> stars available for PSF model. Relaxing criteria...&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Relax criteria</span>
            <span class="n">roundness_criteria_relaxed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">valid_roundness</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">roundness_criteria_relaxed</span><span class="p">[</span><span class="n">valid_roundness</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">roundness1</span><span class="p">[</span><span class="n">valid_roundness</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.5</span>
            <span class="p">)</span>

            <span class="n">sharpness_criteria_relaxed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">valid_sharpness</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">sharpness_criteria_relaxed</span><span class="p">[</span><span class="n">valid_sharpness</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sharpness</span><span class="p">[</span><span class="n">valid_sharpness</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1.0</span>
            <span class="p">)</span>

            <span class="n">flux_criteria_relaxed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">valid_flux</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">flux_criteria_relaxed</span><span class="p">[</span><span class="n">valid_flux</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">flux</span><span class="p">[</span><span class="n">valid_flux</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">flux_median</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">flux_std</span>
            <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">valid_flux</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">flux_median</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">flux_std</span><span class="p">)</span>

            <span class="n">good_stars_mask</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">valid_flux</span> <span class="o">&amp;</span> <span class="n">valid_xcentroid</span> <span class="o">&amp;</span> <span class="n">valid_ycentroid</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="n">flux_criteria_relaxed</span>
                <span class="o">&amp;</span> <span class="n">roundness_criteria_relaxed</span>
                <span class="o">&amp;</span> <span class="n">sharpness_criteria_relaxed</span>
                <span class="o">&amp;</span> <span class="n">edge_criteria</span>
            <span class="p">)</span>

            <span class="n">filtered_photo_table</span> <span class="o">=</span> <span class="n">photo_table</span><span class="p">[</span><span class="n">good_stars_mask</span><span class="p">]</span>

            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After relaxing criteria: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_photo_table</span><span class="p">)</span><span class="si">}</span><span class="s2"> stars&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_photo_table</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Too few good stars for PSF model construction. Need at least 5 stars.&quot;</span>
            <span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error filtering stars for PSF model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">stars_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
        <span class="c1"># extract_stars expects &#39;x&#39; and &#39;y&#39; column names</span>
        <span class="n">stars_table</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_photo_table</span><span class="p">[</span><span class="s2">&quot;xcentroid&quot;</span><span class="p">]</span>
        <span class="n">stars_table</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_photo_table</span><span class="p">[</span><span class="s2">&quot;ycentroid&quot;</span><span class="p">]</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Star positions table prepared from filtered sources.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error preparing star positions table: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># ensure fit_shape is odd and reasonably large (small FWHM can produce too small boxes)</span>
        <span class="n">fit_shape</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">fwhm</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fit_shape</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fit_shape</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fitting shape: </span><span class="si">{</span><span class="n">fit_shape</span><span class="si">}</span><span class="s2"> pixels.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calculating fitting shape: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">stars</span> <span class="o">=</span> <span class="n">extract_stars</span><span class="p">(</span><span class="n">nddata</span><span class="p">,</span> <span class="n">stars_table</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fit_shape</span><span class="p">)</span>

        <span class="c1"># If extract_stars returns list or EPSFStars; ensure a consistent EPSFStars object</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">photutils.psf</span><span class="w"> </span><span class="kn">import</span> <span class="n">EPSFStars</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;No stars extracted for PSF model. Check your selection criteria.&quot;</span>
                <span class="p">)</span>
            <span class="n">stars</span> <span class="o">=</span> <span class="n">EPSFStars</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span>
        <span class="n">n_stars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n_stars</span><span class="si">}</span><span class="s2"> stars extracted for PSF model.&quot;</span><span class="p">)</span>

        <span class="c1"># basic inspection of cutouts for NaN/all-zero</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">stars</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stars</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">stars</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">has_nan</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">star_data</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">for</span> <span class="n">star_data</span> <span class="ow">in</span> <span class="n">stars</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NaN in star data: </span><span class="si">{</span><span class="n">has_nan</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Stars data is empty or not a list&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Stars object has no data attribute&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n_stars</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No stars extracted for PSF model. Check your selection criteria.&quot;</span>
            <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error extracting stars: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Remove stars with NaN or all-zero data</span>
        <span class="n">mask_valid</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stars</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">star_data</span> <span class="ow">in</span> <span class="n">stars</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">star_data</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">mask_valid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">star_data</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">mask_valid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mask_valid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stars</span><span class="p">)):</span>
                    <span class="n">star</span> <span class="o">=</span> <span class="n">stars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">star</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="n">mask_valid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">star</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">mask_valid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mask_valid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">iter_error</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Could not iterate through stars for validation: </span><span class="si">{</span><span class="n">iter_error</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">mask_valid</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span>

        <span class="n">mask_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask_valid</span><span class="p">)</span>

        <span class="c1"># Only filter if we have any invalid stars</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">mask_valid</span><span class="p">):</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">photutils.psf</span><span class="w"> </span><span class="kn">import</span> <span class="n">EPSFStars</span>

            <span class="n">filtered_stars</span> <span class="o">=</span> <span class="n">stars</span><span class="p">[</span><span class="n">mask_valid</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filtered_stars</span><span class="p">,</span> <span class="n">EPSFStars</span><span class="p">):</span>
                <span class="n">filtered_stars</span> <span class="o">=</span> <span class="n">EPSFStars</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">filtered_stars</span><span class="p">))</span>
            <span class="n">stars</span> <span class="o">=</span> <span class="n">filtered_stars</span>
            <span class="n">n_stars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n_stars</span><span class="si">}</span><span class="s2"> valid stars remain for PSF model after filtering invalid data.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span><span class="si">}</span><span class="s2"> stars are valid for PSF model.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No valid stars for PSF model after filtering.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error filtering stars for PSF model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">epsf_builder</span> <span class="o">=</span> <span class="n">EPSFBuilder</span><span class="p">(</span><span class="n">oversampling</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">progress_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">epsf</span><span class="p">,</span> <span class="n">fitted_stars</span> <span class="o">=</span> <span class="n">epsf_builder</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">build_error</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;EPSFBuilder failed: </span><span class="si">{</span><span class="n">build_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Retrying with more conservative EPSFBuilder parameters...&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">epsf_builder_conservative</span> <span class="o">=</span> <span class="n">EPSFBuilder</span><span class="p">(</span>
                    <span class="n">oversampling</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">progress_bar</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
                <span class="n">epsf</span><span class="p">,</span> <span class="n">fitted_stars</span> <span class="o">=</span> <span class="n">epsf_builder_conservative</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">conservative_error</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Conservative EPSFBuilder also failed: </span><span class="si">{</span><span class="n">conservative_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span>

        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;EPSF building completed successfully&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">epsf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;EPSFBuilder returned None&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">epsf</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">epsf</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">epsf</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;EPSF data is invalid or empty&quot;</span><span class="p">)</span>

        <span class="c1"># check for NaNs but continue (could still be usable)</span>
        <span class="n">epsf_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">epsf</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">epsf_array</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">epsf_array</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;EPSF data contains NaN values&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shape of epsf.data: </span><span class="si">{</span><span class="n">epsf_array</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;epsf_model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsf</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fitting PSF model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="c1"># Ensure we have a usable PSF model for PSFPhotometry</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Try to wrap the EPSF into an ImagePSF (preferred for PSFPhotometry compatibility)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">photutils.psf</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImagePSF</span>

            <span class="n">psf_for_phot</span> <span class="o">=</span> <span class="n">ImagePSF</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">epsf</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># fallback to epsf object (works on newer photutils versions)</span>
            <span class="n">psf_for_phot</span> <span class="o">=</span> <span class="n">epsf</span>

        <span class="c1"># Save / display epsf as FITS and figure (best-effort)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">epsf</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;COMMENT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PSF model created with photutils.EPSFBuilder&quot;</span>
            <span class="c1"># Ensure FWHM written as a scalar</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="nb">hasattr</span><span class="p">(</span><span class="n">fwhm</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">fwhm</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">fwhm_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">fwhm</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fwhm_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fwhm</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">fwhm_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">epsf</span><span class="p">,</span> <span class="s2">&quot;fwhm&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FWHMPIX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fwhm_val</span><span class="p">,</span> <span class="s2">&quot;FWHM in pixels used for extraction&quot;</span><span class="p">)</span>

            <span class="c1"># OVERSAMP may be tuple/list/array; convert to safe FITS-friendly value</span>
            <span class="n">oversamp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">epsf</span><span class="p">,</span> <span class="s2">&quot;oversampling&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oversamp</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                    <span class="c1"># store as comma-separated string to avoid illegal array header values</span>
                    <span class="n">oversamp_val</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">oversamp</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">oversamp_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">oversamp</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">oversamp_val</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;OVERSAMP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">oversamp_val</span><span class="p">),</span> <span class="s2">&quot;Oversampling factor(s)&quot;</span><span class="p">)</span>

            <span class="c1"># Number of stars used - ensure scalar int</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">nstars_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_photo_table</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">nstars_val</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NSTARS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nstars_val</span><span class="p">,</span> <span class="s2">&quot;Number of stars used for PSF model&quot;</span><span class="p">)</span>

            <span class="n">psf_filename</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;base_filename&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;psf_model&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_psf.fits&quot;</span>
            <span class="p">)</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;anonymous&quot;</span><span class="p">)</span>
            <span class="n">psf_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">ensure_output_directory</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">_rpp_results&quot;</span><span class="p">),</span> <span class="n">psf_filename</span>
            <span class="p">)</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">psf_filepath</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;PSF model saved as FITS file&quot;</span><span class="p">)</span>

            <span class="n">norm_epsf</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">epsf</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.0</span><span class="p">)</span>
            <span class="n">fig_epsf_model</span><span class="p">,</span> <span class="n">ax_epsf_model</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                <span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZES</span><span class="p">[</span><span class="s2">&quot;medium&quot;</span><span class="p">],</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">120</span>
            <span class="p">)</span>
            <span class="n">ax_epsf_model</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                <span class="n">epsf</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="n">norm</span><span class="o">=</span><span class="n">norm_epsf</span><span class="p">,</span>
                <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
                <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax_epsf_model</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fitted PSF Model (</span><span class="si">{</span><span class="n">nstars_val</span><span class="si">}</span><span class="s2"> stars)&quot;</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="n">fig_epsf_model</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error working with PSF model display/save: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error preparing PSF model for photometry: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="c1"># Create PSF photometry object and perform photometry</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Invalid error array provided, proceeding without error estimation&quot;</span>
            <span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">error</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Error array shape mismatch, proceeding without error estimation&quot;</span>
            <span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Create a SourceGrouper</span>
        <span class="n">min_separation</span> <span class="o">=</span> <span class="mf">1.9</span> <span class="o">*</span> <span class="n">fwhm</span>
        <span class="n">grouper</span> <span class="o">=</span> <span class="n">SourceGrouper</span><span class="p">(</span><span class="n">min_separation</span><span class="o">=</span><span class="n">min_separation</span><span class="p">)</span>
        <span class="n">bkgstat</span> <span class="o">=</span> <span class="n">MMMBackground</span><span class="p">()</span>
        <span class="n">localbkg_estimator</span> <span class="o">=</span> <span class="n">LocalBackground</span><span class="p">(</span><span class="mf">2.1</span> <span class="o">*</span> <span class="n">fwhm</span><span class="p">,</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">bkgstat</span><span class="p">)</span>

        <span class="n">psfphot</span> <span class="o">=</span> <span class="n">PSFPhotometry</span><span class="p">(</span>
            <span class="n">psf_model</span><span class="o">=</span><span class="n">psf_for_phot</span><span class="p">,</span>
            <span class="n">fit_shape</span><span class="o">=</span><span class="n">fit_shape</span><span class="p">,</span>
            <span class="n">finder</span><span class="o">=</span><span class="n">daostarfind</span><span class="p">,</span>
            <span class="n">aperture_radius</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">fit_shape</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
            <span class="n">grouper</span><span class="o">=</span><span class="n">grouper</span><span class="p">,</span>
            <span class="n">localbkg_estimator</span><span class="o">=</span><span class="n">localbkg_estimator</span><span class="p">,</span>
            <span class="n">progress_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Prepare initial parameters (use &#39;x&#39; and &#39;y&#39; to be compatible with PSFPhotometry)</span>
        <span class="n">initial_params</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
        <span class="n">initial_params</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">photo_table</span><span class="p">[</span><span class="s2">&quot;xcentroid&quot;</span><span class="p">]</span>
        <span class="n">initial_params</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">photo_table</span><span class="p">[</span><span class="s2">&quot;ycentroid&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;flux&quot;</span> <span class="ow">in</span> <span class="n">photo_table</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
            <span class="n">initial_params</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">photo_table</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span>
        <span class="c1"># also provide legacy names for compatibility</span>
        <span class="n">initial_params</span><span class="p">[</span><span class="s2">&quot;x_0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_params</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
        <span class="n">initial_params</span><span class="p">[</span><span class="s2">&quot;y_0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_params</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>

        <span class="c1"># Filter out sources that fall in masked regions (robust)</span>
        <span class="n">mask_bool</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask_bool</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask_bool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># compute rounded indices with clipping</span>
            <span class="n">x_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">initial_params</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">)</span>
            <span class="n">y_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">initial_params</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">)</span>

            <span class="n">valid_bounds</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">initial_params</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">initial_params</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">initial_params</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">initial_params</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="p">)</span>

            <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">initial_params</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">valid_mask</span><span class="p">[</span><span class="n">valid_bounds</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">mask_bool</span><span class="p">[</span>
                <span class="n">y_int</span><span class="p">[</span><span class="n">valid_bounds</span><span class="p">],</span> <span class="n">x_int</span><span class="p">[</span><span class="n">valid_bounds</span><span class="p">]</span>
            <span class="p">]</span>

            <span class="n">initial_params_filtered</span> <span class="o">=</span> <span class="n">initial_params</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>

            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Filtered out </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">initial_params</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">initial_params_filtered</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources that fall in masked regions&quot;</span>
            <span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Proceeding with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">initial_params_filtered</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources for PSF photometry&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">initial_params_filtered</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;All sources fall in masked regions. Cannot perform PSF photometry.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">epsf</span>

            <span class="n">initial_params</span> <span class="o">=</span> <span class="n">initial_params_filtered</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No mask provided, using all sources for PSF photometry&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Performing PSF photometry on sources...&quot;</span><span class="p">)</span>
        <span class="c1"># call PSFPhotometry: data first</span>
        <span class="n">phot_epsf_result</span> <span class="o">=</span> <span class="n">psfphot</span><span class="p">(</span>
            <span class="n">img</span><span class="p">,</span> <span class="n">init_params</span><span class="o">=</span><span class="n">initial_params</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask_bool</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">error</span>
        <span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;epsf_photometry_result&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot_epsf_result</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;PSF photometry completed successfully.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">phot_epsf_result</span><span class="p">,</span> <span class="n">epsf</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error executing PSF photometry: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span></div>



<div class="viewcode-block" id="refine_astrometry_with_stdpipe">
<a class="viewcode-back" href="../../api.html#src.pipeline.refine_astrometry_with_stdpipe">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">refine_astrometry_with_stdpipe</span><span class="p">(</span>
    <span class="n">image_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">science_header</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">wcs</span><span class="p">:</span> <span class="n">WCS</span><span class="p">,</span>
    <span class="n">fwhm_estimate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">pixel_scale</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">filter_band</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">WCS</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform astrometry refinement using stdpipe SCAMP and GAIA DR3 catalog.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image_data : numpy.ndarray</span>
<span class="sd">        The 2D image array</span>
<span class="sd">    science_header : dict</span>
<span class="sd">        FITS header with WCS information</span>
<span class="sd">    wcs : astropy.wcs.WCS</span>
<span class="sd">        Initial WCS object</span>
<span class="sd">    fwhm_estimate : float</span>
<span class="sd">        FWHM estimate in pixels</span>
<span class="sd">    pixel_scale : float</span>
<span class="sd">        Pixel scale in arcseconds per pixel</span>
<span class="sd">    filter_band : str</span>
<span class="sd">        Gaia magnitude band to use for catalog matching</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    astropy.wcs.WCS or None</span>
<span class="sd">        Refined WCS object if successful, None otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log_buffer</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;log_buffer&quot;</span><span class="p">)</span>
    <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="s2">&quot;Starting astrometry refinement&quot;</span><span class="p">,</span> <span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Doing astrometry refinement using SCAMP...&quot;</span><span class="p">)</span>

        <span class="c1"># Convert image data to float32 for stdpipe compatibility</span>
        <span class="k">if</span> <span class="n">image_data</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Converting image from </span><span class="si">{</span><span class="n">image_data</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2"> to float32 for stdpipe compatibility&quot;</span>
            <span class="p">)</span>
            <span class="n">image_data</span> <span class="o">=</span> <span class="n">image_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># Clean and prepare header for stdpipe</span>
        <span class="n">clean_header</span> <span class="o">=</span> <span class="n">science_header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Remove known problematic keywords</span>
        <span class="c1"># These keywords, especially distortion-related ones, can cause issues with WCS validation</span>
        <span class="c1"># when headers are combined from different sources.</span>
        <span class="n">keys_to_remove</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;HISTORY&quot;</span><span class="p">,</span> <span class="s2">&quot;COMMENT&quot;</span><span class="p">,</span> <span class="s2">&quot;CONTINUE&quot;</span><span class="p">,</span>  <span class="c1"># General metadata</span>
            <span class="s2">&quot;XPIXELSZ&quot;</span><span class="p">,</span> <span class="s2">&quot;YPIXELSZ&quot;</span><span class="p">,</span> <span class="s2">&quot;CDELTM1&quot;</span><span class="p">,</span> <span class="s2">&quot;CDELTM2&quot;</span><span class="p">,</span>  <span class="c1"># Can conflict with CD matrix</span>
        <span class="p">]</span>
        
        <span class="c1"># Add distortion-related keywords to the removal list</span>
        <span class="c1"># This is a more targeted way to handle the &quot;coefficient scale is zero&quot; error</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">clean_header</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">pattern</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;DSS&quot;</span><span class="p">,</span> <span class="s2">&quot;SIP&quot;</span><span class="p">,</span> <span class="s2">&quot;PV&quot;</span><span class="p">,</span> <span class="s2">&quot;DISTORT&quot;</span><span class="p">,</span> <span class="s2">&quot;A_&quot;</span><span class="p">,</span> <span class="s2">&quot;B_&quot;</span><span class="p">,</span> <span class="s2">&quot;AP_&quot;</span><span class="p">,</span> <span class="s2">&quot;BP_&quot;</span><span class="p">]):</span>
                <span class="n">keys_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="n">removed_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">keys_to_remove</span><span class="p">):</span> <span class="c1"># Use set to avoid duplicates</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">clean_header</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">clean_header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">removed_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">removed_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed </span><span class="si">{</span><span class="n">removed_count</span><span class="si">}</span><span class="s2"> problematic or distortion-related keywords from header.&quot;</span><span class="p">)</span>

        <span class="c1"># Validate and, if necessary, fix the core WCS parameters</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Ensure CTYPEs are present and valid</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">clean_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CTYPE1&quot;</span><span class="p">):</span>
                <span class="n">clean_header</span><span class="p">[</span><span class="s2">&quot;CTYPE1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;RA---TAN&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">clean_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CTYPE2&quot;</span><span class="p">):</span>
                <span class="n">clean_header</span><span class="p">[</span><span class="s2">&quot;CTYPE2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;DEC--TAN&quot;</span>

            <span class="c1"># Ensure reference pixels are valid</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">clean_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)):</span>
                <span class="n">clean_header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">clean_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)):</span>
                <span class="n">clean_header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span>

            <span class="c1"># Check for a valid CD matrix, if it exists</span>
            <span class="n">cd_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CD1_1&quot;</span><span class="p">,</span> <span class="s2">&quot;CD1_2&quot;</span><span class="p">,</span> <span class="s2">&quot;CD2_1&quot;</span><span class="p">,</span> <span class="s2">&quot;CD2_2&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">clean_header</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cd_keys</span><span class="p">):</span>
                <span class="n">cd_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">clean_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cd_keys</span><span class="p">]</span>
                <span class="c1"># Check for non-finite or zero values in the matrix</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">or</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cd_values</span><span class="p">):</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Invalid CD matrix detected. It will be ignored.&quot;</span><span class="p">)</span>
                    <span class="c1"># Remove the invalid CD matrix so astropy can build a new one if possible</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cd_keys</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">clean_header</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">clean_header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            
            <span class="c1"># If no CD matrix, ensure CDELT is present for WCS creation</span>
            <span class="k">if</span> <span class="s2">&quot;CD1_1&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clean_header</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;CDELT1&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clean_header</span><span class="p">:</span>
                    <span class="n">clean_header</span><span class="p">[</span><span class="s2">&quot;CDELT1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">pixel_scale</span> <span class="o">/</span> <span class="mf">3600.0</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CDELT1 not found. Setting from pixel scale.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;CDELT2&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clean_header</span><span class="p">:</span>
                    <span class="n">clean_header</span><span class="p">[</span><span class="s2">&quot;CDELT2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixel_scale</span> <span class="o">/</span> <span class="mf">3600.0</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CDELT2 not found. Setting from pixel scale.&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">header_fix_error</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An error occurred while fixing the header: </span><span class="si">{</span><span class="n">header_fix_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Test the cleaned WCS before proceeding</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">test_wcs</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">clean_header</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaned WCS passes basic validation&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">wcs_test_error</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cleaned WCS still has issues: </span><span class="si">{</span><span class="n">wcs_test_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_native_byteorder</span><span class="p">(</span><span class="n">arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="c1"># SEP requires native byteorder arrays (see SEP docs)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">isnative</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">arr</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span><span class="o">.</span><span class="n">newbyteorder</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">newbyteorder</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">arr</span>

        <span class="n">image_for_det</span> <span class="o">=</span> <span class="n">image_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># make float32 for detection routines (many expect float32)</span>
        <span class="k">if</span> <span class="n">image_for_det</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span>
            <span class="n">image_for_det</span> <span class="o">=</span> <span class="n">image_for_det</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">image_for_det</span> <span class="o">=</span> <span class="n">_ensure_native_byteorder</span><span class="p">(</span><span class="n">image_for_det</span><span class="p">)</span>

        <span class="c1"># Use SExtractor-only detection strategy (remove SEP attempts)</span>
        <span class="n">detection_candidates</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tried_methods</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using SExtractor-only detection strategy&quot;</span><span class="p">)</span>
        <span class="n">sex_param_grid</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;thresh&quot;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span> <span class="s2">&quot;minarea&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;r0&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;thresh&quot;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span> <span class="s2">&quot;minarea&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;r0&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;thresh&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s2">&quot;minarea&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;r0&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">},</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">sex_param_grid</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Attempting SExtractor detection: DETECT_THRESH=</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;thresh&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;DETECT_MINAREA=</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;minarea&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, smoothing=</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;r0&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">obj_try</span> <span class="o">=</span> <span class="n">photometry</span><span class="o">.</span><span class="n">get_objects_sextractor</span><span class="p">(</span>
                    <span class="n">image_for_det</span><span class="p">,</span>
                    <span class="n">header</span><span class="o">=</span><span class="n">clean_header</span><span class="p">,</span>
                    <span class="n">thresh</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;thresh&quot;</span><span class="p">],</span>
                    <span class="n">r0</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;r0&quot;</span><span class="p">],</span>
                    <span class="n">minarea</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;minarea&quot;</span><span class="p">],</span>
                    <span class="n">aper</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">fwhm_estimate</span><span class="p">),</span>
                    <span class="n">bg_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                    <span class="n">edge</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                    <span class="n">gain</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                    <span class="n">mask_to_nans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">tried_methods</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;sex&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>
                <span class="c1"># get_objects_sextractor may return (table, checkimages...). Accept table</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj_try</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="n">obj_try</span> <span class="o">=</span> <span class="n">obj_try</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">obj_try</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj_try</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">detection_candidates</span> <span class="o">=</span> <span class="n">obj_try</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Detected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">detection_candidates</span><span class="p">)</span><span class="si">}</span><span class="s2"> objects with SExtractor&quot;</span>
                    <span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e_sex</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SExtractor attempt failed: </span><span class="si">{</span><span class="n">e_sex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="n">detection_candidates</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No objects detected. Tried methods:&quot;</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tried_methods</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># end detection multi-strategy</span>

        <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="si">}</span><span class="s2"> objects for astrometry refinement&quot;</span><span class="p">)</span>

        <span class="c1"># Get frame center using the cleaned header and test WCS</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use the cleaned header instead of original</span>
            <span class="n">center_ra</span><span class="p">,</span> <span class="n">center_dec</span><span class="p">,</span> <span class="n">radius</span> <span class="o">=</span> <span class="n">astrometry</span><span class="o">.</span><span class="n">get_frame_center</span><span class="p">(</span>
                <span class="n">header</span><span class="o">=</span><span class="n">clean_header</span><span class="p">,</span>
                <span class="n">wcs</span><span class="o">=</span><span class="n">test_wcs</span><span class="p">,</span>  <span class="c1"># Use the validated test WCS</span>
                <span class="n">width</span><span class="o">=</span><span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">height</span><span class="o">=</span><span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">center_error</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get frame center: </span><span class="si">{</span><span class="n">center_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Try fallback method using header coordinates</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">center_ra</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">clean_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CRVAL1&quot;</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="n">clean_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;RA&quot;</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="n">clean_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OBJRA&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">center_dec</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">clean_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CRVAL2&quot;</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="n">clean_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DEC&quot;</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="n">clean_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OBJDEC&quot;</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">center_ra</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">center_dec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not determine field center coordinates&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>

                <span class="c1"># Calculate radius from image dimensions</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">pixel_scale</span> <span class="o">/</span> <span class="mf">3600.0</span> <span class="o">/</span> <span class="mf">2.0</span>
                <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Using fallback field center: RA=</span><span class="si">{</span><span class="n">center_ra</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;DEC=</span><span class="se">{{</span><span class="s2">center_dec:.3f</span><span class="se">}}</span><span class="s2">, radius=</span><span class="se">{{</span><span class="s2">radius:.3f</span><span class="se">}}</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;&quot;</span>
                <span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">fallback_error</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fallback coordinate extraction failed: </span><span class="si">{</span><span class="n">fallback_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Map filter band to correct GAIA EDR3 column names</span>
        <span class="n">gaia_band_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;phot_bp_mean_mag&quot;</span><span class="p">:</span> <span class="s2">&quot;BPmag&quot;</span><span class="p">,</span>
            <span class="s2">&quot;phot_rp_mean_mag&quot;</span><span class="p">:</span> <span class="s2">&quot;RPmag&quot;</span><span class="p">,</span>
            <span class="s2">&quot;phot_g_mean_mag&quot;</span><span class="p">:</span> <span class="s2">&quot;Gmag&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">gaia_band</span> <span class="o">=</span> <span class="n">gaia_band_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">filter_band</span><span class="p">,</span> <span class="s2">&quot;Gmag&quot;</span><span class="p">)</span>

        <span class="c1"># Get GAIA catalog with correct parameters and error handling</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use correct catalog name and filters</span>
            <span class="n">cat</span> <span class="o">=</span> <span class="n">catalogs</span><span class="o">.</span><span class="n">get_cat_vizier</span><span class="p">(</span>
                <span class="n">center_ra</span><span class="p">,</span>
                <span class="n">center_dec</span><span class="p">,</span>
                <span class="n">radius</span><span class="p">,</span>
                <span class="s2">&quot;I/350/gaiaedr3&quot;</span><span class="p">,</span>  <span class="c1"># Correct GAIA EDR3 catalog identifier</span>
                <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="n">gaia_band</span><span class="p">:</span> <span class="s2">&quot;&lt; 20.0&quot;</span><span class="p">},</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">cat</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No GAIA catalog sources found in field&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">cat_error</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get GAIA catalog: </span><span class="si">{</span><span class="n">cat_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Try with a smaller search radius</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">smaller_radius</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># Limit to 0.5 degrees</span>
                <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Retrying GAIA query with smaller radius: </span><span class="si">{</span><span class="n">smaller_radius</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">Â°&quot;</span>
                <span class="p">)</span>
                <span class="n">cat</span> <span class="o">=</span> <span class="n">catalogs</span><span class="o">.</span><span class="n">get_cat_vizier</span><span class="p">(</span>
                    <span class="n">center_ra</span><span class="p">,</span>
                    <span class="n">center_dec</span><span class="p">,</span>
                    <span class="n">smaller_radius</span><span class="p">,</span>
                    <span class="s2">&quot;I/350/gaiaedr3&quot;</span><span class="p">,</span>
                    <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="n">gaia_band</span><span class="p">:</span> <span class="s2">&quot;&lt; 19.0&quot;</span><span class="p">},</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">cat</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;No GAIA catalog sources found even with reduced search radius&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">retry_error</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GAIA catalog query retry failed: </span><span class="si">{</span><span class="n">retry_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrieved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span><span class="si">}</span><span class="s2"> GAIA catalog sources&quot;</span><span class="p">)</span>

        <span class="c1"># Apply additional filtering after retrieval if needed</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Filter out sources with poor parallax measurements if the column exists</span>
            <span class="k">if</span> <span class="s2">&quot;parallax&quot;</span> <span class="ow">in</span> <span class="n">cat</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                <span class="c1"># Keep sources with reasonable parallax values (not extreme negative values)</span>
                <span class="n">parallax_filter</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s2">&quot;parallax&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">100</span>  <span class="c1"># Basic parallax filter</span>
                <span class="n">cat</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="n">parallax_filter</span><span class="p">]</span>
                <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After parallax filtering: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span><span class="si">}</span><span class="s2"> GAIA catalog sources&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">filter_error</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not apply additional filtering: </span><span class="si">{</span><span class="n">filter_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure we still have enough sources for refinement</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Too few GAIA sources (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span><span class="si">}</span><span class="s2">) for reliable astrometry refinement&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Calculate matching radius in degrees</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">match_radius_deg</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">fwhm_estimate</span> <span class="o">*</span> <span class="n">pixel_scale</span> <span class="o">/</span> <span class="mf">3600.0</span>

            <span class="c1"># Try SCAMP refinement with conservative parameters</span>
            <span class="n">wcs_result</span> <span class="o">=</span> <span class="n">astrometry</span><span class="o">.</span><span class="n">refine_wcs_scamp</span><span class="p">(</span>
                <span class="n">obj</span><span class="p">,</span>
                <span class="n">cat</span><span class="p">,</span>
                <span class="n">wcs</span><span class="o">=</span><span class="n">test_wcs</span><span class="p">,</span>  <span class="c1"># Use the validated test WCS</span>
                <span class="n">sr</span><span class="o">=</span><span class="n">match_radius_deg</span><span class="p">,</span>
                <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">cat_col_ra</span><span class="o">=</span><span class="s2">&quot;RA_ICRS&quot;</span><span class="p">,</span>
                <span class="n">cat_col_dec</span><span class="o">=</span><span class="s2">&quot;DE_ICRS&quot;</span><span class="p">,</span>
                <span class="n">cat_col_mag</span><span class="o">=</span><span class="n">gaia_band</span><span class="p">,</span>
                <span class="n">cat_mag_lim</span><span class="o">=</span><span class="mi">19</span><span class="p">,</span>  <span class="c1"># Conservative magnitude limit</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">refine_error</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SCAMP astrometry refinement failed: </span><span class="si">{</span><span class="n">refine_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Try with even more conservative parameters</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Retrying with ultra-conservative SCAMP parameters...&quot;</span><span class="p">)</span>
                <span class="n">wcs_result</span> <span class="o">=</span> <span class="n">astrometry</span><span class="o">.</span><span class="n">refine_wcs_scamp</span><span class="p">(</span>
                    <span class="n">obj</span><span class="p">,</span>
                    <span class="n">cat</span><span class="p">,</span>
                    <span class="n">wcs</span><span class="o">=</span><span class="n">test_wcs</span><span class="p">,</span>
                    <span class="n">sr</span><span class="o">=</span><span class="n">match_radius_deg</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">,</span>  <span class="c1"># Double the search radius</span>
                    <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">cat_col_ra</span><span class="o">=</span><span class="s2">&quot;RA_ICRS&quot;</span><span class="p">,</span>
                    <span class="n">cat_col_dec</span><span class="o">=</span><span class="s2">&quot;DE_ICRS&quot;</span><span class="p">,</span>
                    <span class="n">cat_col_mag</span><span class="o">=</span><span class="n">gaia_band</span><span class="p">,</span>
                    <span class="n">cat_mag_lim</span><span class="o">=</span><span class="mf">19.0</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">final_refine_error</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final SCAMP attempt failed: </span><span class="si">{</span><span class="n">final_refine_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Validate and return the refined WCS</span>
        <span class="k">if</span> <span class="n">wcs_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;WCS refinement successful using SCAMP&quot;</span><span class="p">)</span>

            <span class="c1"># Update the science header with refined WCS if validation passes</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Clear old WCS and add new keywords</span>
                <span class="n">astrometry</span><span class="o">.</span><span class="n">clear_wcs</span><span class="p">(</span><span class="n">science_header</span><span class="p">)</span>
                <span class="n">wcs_header</span> <span class="o">=</span> <span class="n">wcs_result</span><span class="o">.</span><span class="n">to_header</span><span class="p">(</span><span class="n">relax</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">science_header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">wcs_header</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updated header with refined WCS keywords&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">header_error</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not update header: </span><span class="si">{</span><span class="n">header_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Return WCS anyway as it&#39;s still usable</span>

            <span class="k">return</span> <span class="n">wcs_result</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;SCAMP did not return a valid WCS solution&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">import_error</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;stdpipe import error: </span><span class="si">{</span><span class="n">import_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Make sure stdpipe is properly installed: pip install stdpipe&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WCS refinement failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="detection_and_photometry">
<a class="viewcode-back" href="../../api.html#src.pipeline.detection_and_photometry">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">detection_and_photometry</span><span class="p">(</span>
    <span class="n">image_data</span><span class="p">,</span>
    <span class="n">science_header</span><span class="p">,</span>
    <span class="n">mean_fwhm_pixel</span><span class="p">,</span>
    <span class="n">threshold_sigma</span><span class="p">,</span>
    <span class="n">detection_mask</span><span class="p">,</span>
    <span class="n">filter_band</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform a complete photometry workflow on an astronomical image.</span>

<span class="sd">    This function executes the following steps:</span>
<span class="sd">      1. Estimate the sky background and its RMS.</span>
<span class="sd">      2. Detect sources using DAOStarFinder.</span>
<span class="sd">      3. Optionally refine the WCS using GAIA DR3 and stdpipe.</span>
<span class="sd">      4. Perform aperture photometry on detected sources.</span>
<span class="sd">      5. Perform PSF photometry using an empirical PSF model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image_data : numpy.ndarray</span>
<span class="sd">        2D array of the image data.</span>
<span class="sd">    _science_header : dict or astropy.io.fits.Header</span>
<span class="sd">        FITS header or dictionary with image metadata.</span>
<span class="sd">    mean_fwhm_pixel : float</span>
<span class="sd">        Estimated FWHM in pixels, used for aperture and PSF sizing</span>
<span class="sd">    threshold_sigma : float</span>
<span class="sd">        Detection threshold in sigma above background.</span>
<span class="sd">    detection_mask : int</span>
<span class="sd">        Border size in pixels to mask during detection.</span>
<span class="sd">    filter_band : str</span>
<span class="sd">        Photometric band for catalog matching and calibration.</span>
<span class="sd">    gb : str, optional</span>
<span class="sd">        Gaia band name for catalog queries (default: &quot;Gmag&quot;).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (phot_table, epsf_table, daofind, bkg), where:</span>
<span class="sd">        phot_table : astropy.table.Table</span>
<span class="sd">            Results of aperture photometry.</span>
<span class="sd">        epsf_table : astropy.table.Table or None</span>
<span class="sd">            Results of PSF photometry, or None if PSF fitting failed.</span>
<span class="sd">        daofind : photutils.detection.DAOStarFinder</span>
<span class="sd">            DAOStarFinder object used for source detection.</span>
<span class="sd">        bkg : photutils.background.Background2D</span>
<span class="sd">            Background2D object containing the background model.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - WCS refinement uses stdpipe and GAIA DR3 if enabled in session state.</span>
<span class="sd">    - Adds RA/Dec coordinates to photometry tables if WCS is available.</span>
<span class="sd">    - Computes instrumental magnitudes for both aperture and PSF photometry.</span>
<span class="sd">    - Displays progress and results in the Streamlit interface.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">daofind</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">wcs_error</span> <span class="o">=</span> <span class="n">safe_wcs_create</span><span class="p">(</span><span class="n">science_header</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating WCS: </span><span class="si">{</span><span class="n">wcs_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">daofind</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating WCS: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">daofind</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">pixel_scale</span> <span class="o">=</span> <span class="n">science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;PIXSCALE&quot;</span><span class="p">,</span>
        <span class="n">science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PIXSIZE&quot;</span><span class="p">,</span> <span class="n">science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PIXELSCAL&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
    <span class="p">)</span>

    <span class="n">bkg</span><span class="p">,</span> <span class="n">bkg_error</span> <span class="o">=</span> <span class="n">estimate_background</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">box_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">filter_size</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bkg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error estimating background: </span><span class="si">{</span><span class="n">bkg_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">daofind</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">make_border_mask</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="n">detection_mask</span><span class="p">)</span>

    <span class="c1"># Ensure image_sub is float64 to avoid casting errors</span>
    <span class="n">image_sub</span> <span class="o">=</span> <span class="n">image_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="o">-</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="n">show_subtracted_image</span><span class="p">(</span><span class="n">image_sub</span><span class="p">)</span>

    <span class="c1"># Ensure bkg_error is also float64</span>
    <span class="n">bkg_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span>
        <span class="n">image_sub</span><span class="p">,</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background_rms</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span>
    <span class="p">)</span>

    <span class="n">exposure_time</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">image_data</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">exposure_time</span> <span class="o">=</span> <span class="n">science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;EXPTIME&quot;</span><span class="p">,</span>
            <span class="n">science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;EXPOSURE&quot;</span><span class="p">,</span> <span class="n">science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;EXP_TIME&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
        <span class="p">)</span>

    <span class="c1"># Ensure effective_gain is float64</span>
    <span class="n">effective_gain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="mf">2.5</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span> <span class="o">*</span> <span class="n">exposure_time</span><span class="p">)</span>

    <span class="c1"># Convert to float64 to ensure compatibility with calc_total_error</span>
    <span class="n">total_error</span> <span class="o">=</span> <span class="n">calc_total_error</span><span class="p">(</span>
        <span class="n">image_sub</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">bkg_error</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">effective_gain</span>
    <span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Estimating FWHM...&quot;</span><span class="p">)</span>
    <span class="n">fwhm_estimate</span><span class="p">,</span> <span class="n">clipped_std</span> <span class="o">=</span> <span class="n">fwhm_fit</span><span class="p">(</span><span class="n">image_sub</span><span class="p">,</span> <span class="n">mean_fwhm_pixel</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fwhm_estimate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to estimate FWHM. Using the initial estimate.&quot;</span><span class="p">)</span>
        <span class="n">fwhm_estimate</span> <span class="o">=</span> <span class="n">mean_fwhm_pixel</span>

    <span class="n">peak_max</span> <span class="o">=</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">image_sub</span><span class="p">)</span>
    <span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span>
        <span class="n">fwhm</span><span class="o">=</span><span class="mf">1.5</span> <span class="o">*</span> <span class="n">fwhm_estimate</span><span class="p">,</span>
        <span class="n">threshold</span><span class="o">=</span><span class="p">(</span><span class="n">threshold_sigma</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">clipped_std</span><span class="p">,</span>
        <span class="n">peakmax</span><span class="o">=</span><span class="n">peak_max</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">sources</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">image_sub</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No sources found!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">daofind</span><span class="p">,</span> <span class="n">bkg</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="n">sources</span><span class="p">[</span><span class="s2">&quot;xcentroid&quot;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s2">&quot;ycentroid&quot;</span><span class="p">]))</span>

    <span class="c1"># Check Astrometry option before refinement</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s2">&quot;session_state&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;astrometry_check&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">refined_wcs</span> <span class="o">=</span> <span class="n">refine_astrometry_with_stdpipe</span><span class="p">(</span>
            <span class="n">image_data</span><span class="o">=</span><span class="n">image_sub</span><span class="p">,</span>
            <span class="n">science_header</span><span class="o">=</span><span class="n">science_header</span><span class="p">,</span>
            <span class="n">wcs</span><span class="o">=</span><span class="n">w</span><span class="p">,</span>
            <span class="n">fwhm_estimate</span><span class="o">=</span><span class="n">fwhm_estimate</span><span class="p">,</span>
            <span class="n">pixel_scale</span><span class="o">=</span><span class="n">pixel_scale</span><span class="p">,</span>
            <span class="n">filter_band</span><span class="o">=</span><span class="n">filter_band</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Validate WCS after refinement</span>
        <span class="k">if</span> <span class="n">refined_wcs</span><span class="p">:</span>
            <span class="c1"># Test a few source positions to ensure coordinates make sense</span>
            <span class="n">test_coords</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[:</span> <span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">))]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">validate_wcs_orientation</span><span class="p">(</span>
                <span class="n">science_header</span><span class="p">,</span> <span class="n">science_header</span><span class="p">,</span> <span class="n">test_coords</span>
            <span class="p">):</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;WCS refinement may have introduced coordinate issues&quot;</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">refined_wcs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Refine Astrometry is disabled. Skipping astrometry refinement.&quot;</span><span class="p">)</span>

    <span class="c1"># Create multiple circular apertures with different radii</span>
    <span class="n">aperture_radii</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">]</span>
    <span class="n">apertures</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">CircularAperture</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">radius</span> <span class="o">*</span> <span class="n">fwhm_estimate</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">radius</span> <span class="ow">in</span> <span class="n">aperture_radii</span>
    <span class="p">]</span>

    <span class="c1"># Create circular annulus apertures for background estimation</span>
    <span class="n">annulus_apertures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">radius</span> <span class="ow">in</span> <span class="n">aperture_radii</span><span class="p">:</span>
        <span class="n">r_in</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">fwhm_estimate</span>
        <span class="n">r_out</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">fwhm_estimate</span>
        <span class="n">annulus_apertures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CircularAnnulus</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r_in</span><span class="o">=</span><span class="n">r_in</span><span class="p">,</span> <span class="n">r_out</span><span class="o">=</span><span class="n">r_out</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">wcs_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Use the refined WCS object instead of recreating from header</span>
                <span class="n">wcs_obj</span> <span class="o">=</span> <span class="n">w</span>
                <span class="k">if</span> <span class="n">wcs_obj</span><span class="o">.</span><span class="n">pixel_n_dim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">wcs_obj</span> <span class="o">=</span> <span class="n">wcs_obj</span><span class="o">.</span><span class="n">celestial</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reduced WCS to 2D celestial coordinates for photometry&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating WCS object: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">wcs_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="s2">&quot;CTYPE1&quot;</span> <span class="ow">in</span> <span class="n">science_header</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Fallback to header WCS if no refined WCS available</span>
                <span class="n">wcs_obj</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">science_header</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">wcs_obj</span><span class="o">.</span><span class="n">pixel_n_dim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">wcs_obj</span> <span class="o">=</span> <span class="n">wcs_obj</span><span class="o">.</span><span class="n">celestial</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reduced WCS to 2D celestial coordinates for photometry&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating WCS object: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">wcs_obj</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Perform photometry for all apertures</span>
        <span class="n">phot_tables</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">aperture</span><span class="p">,</span> <span class="n">annulus</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">apertures</span><span class="p">,</span> <span class="n">annulus_apertures</span><span class="p">)):</span>
            <span class="c1"># Aperture photometry</span>
            <span class="n">phot_result</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span>
                <span class="n">image_sub</span><span class="p">,</span> <span class="n">aperture</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">total_error</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="n">wcs_obj</span>
            <span class="p">)</span>

            <span class="c1"># Background estimation from annulus with robust outlier rejection</span>
            <span class="n">bkg_result</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span>
                <span class="n">image_sub</span><span class="p">,</span> <span class="n">annulus</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">total_error</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="n">wcs_obj</span>
            <span class="p">)</span>

            <span class="c1"># Process each source in this aperture size</span>
            <span class="n">n_sources</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bkg_result</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">source_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sources</span><span class="p">):</span>
                <span class="c1"># Get individual apertures for this source</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">annulus</span><span class="p">,</span> <span class="s2">&quot;__getitem__&quot;</span><span class="p">):</span>  <span class="c1"># Multiple sources</span>
                    <span class="n">single_annulus</span> <span class="o">=</span> <span class="n">annulus</span><span class="p">[</span><span class="n">source_idx</span><span class="p">]</span>
                    <span class="n">single_aperture</span> <span class="o">=</span> <span class="n">aperture</span><span class="p">[</span><span class="n">source_idx</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># Single source</span>
                    <span class="n">single_annulus</span> <span class="o">=</span> <span class="n">annulus</span>
                    <span class="n">single_aperture</span> <span class="o">=</span> <span class="n">aperture</span>

                <span class="c1"># Get the annulus mask for this specific source</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">annulus_mask</span> <span class="o">=</span> <span class="n">single_annulus</span><span class="o">.</span><span class="n">to_mask</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">annulus_mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">annulus_data</span> <span class="o">=</span> <span class="n">annulus_mask</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">image_sub</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">annulus_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">annulus_data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># Extract only the non-zero pixels (pixels within the annulus)</span>
                    <span class="n">annulus_pixels</span> <span class="o">=</span> <span class="n">annulus_data</span><span class="p">[</span><span class="n">annulus_data</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">annulus_pixels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span>
                    <span class="p">):</span>  <span class="c1"># Need sufficient pixels for statistics</span>
                        <span class="c1"># Remove saturated pixels</span>
                        <span class="n">saturation_level</span> <span class="o">=</span> <span class="n">science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;SATURATE&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.95</span>
                        <span class="p">)</span>
                        <span class="n">valid_pixels</span> <span class="o">=</span> <span class="n">annulus_pixels</span><span class="p">[</span>
                            <span class="n">annulus_pixels</span> <span class="o">&lt;</span> <span class="n">saturation_level</span> <span class="o">*</span> <span class="mf">0.8</span>
                        <span class="p">]</span>

                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_pixels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="c1"># Iterative sigma clipping</span>
                        <span class="n">clipped_pixels</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span>
                            <span class="n">valid_pixels</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">False</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clipped_pixels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                            <span class="n">median_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">clipped_pixels</span><span class="p">)</span>
                            <span class="n">mad_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">clipped_pixels</span> <span class="o">-</span> <span class="n">median_val</span><span class="p">))</span>
                            <span class="n">threshold</span> <span class="o">=</span> <span class="n">median_val</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">mad_val</span>

                            <span class="n">final_pixels</span> <span class="o">=</span> <span class="n">clipped_pixels</span><span class="p">[</span><span class="n">clipped_pixels</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">]</span>

                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_pixels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="n">robust_bkg_per_pixel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">final_pixels</span><span class="p">)</span>
                                <span class="n">robust_bkg_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">final_pixels</span><span class="p">)</span>

                                <span class="c1"># Calculate total background for this aperture</span>
                                <span class="n">aperture_area</span> <span class="o">=</span> <span class="n">single_aperture</span><span class="o">.</span><span class="n">area</span>
                                <span class="n">robust_total_bkg</span> <span class="o">=</span> <span class="n">robust_bkg_per_pixel</span> <span class="o">*</span> <span class="n">aperture_area</span>

                                <span class="c1"># Update the background result for this source</span>
                                <span class="n">bkg_result</span><span class="p">[</span><span class="s2">&quot;aperture_sum&quot;</span><span class="p">][</span><span class="n">source_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="n">robust_total_bkg</span>
                                <span class="p">)</span>

                                <span class="k">if</span> <span class="s2">&quot;aperture_sum_err&quot;</span> <span class="ow">in</span> <span class="n">bkg_result</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                                    <span class="n">bkg_uncertainty</span> <span class="o">=</span> <span class="n">robust_bkg_std</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                                        <span class="n">aperture_area</span>
                                    <span class="p">)</span>
                                    <span class="n">bkg_result</span><span class="p">[</span><span class="s2">&quot;aperture_sum_err&quot;</span><span class="p">][</span><span class="n">source_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">bkg_uncertainty</span>
                                    <span class="p">)</span>
                            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">clipped_pixels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="c1"># Fallback to sigma-clipped mean</span>
                                <span class="n">robust_bkg_per_pixel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">clipped_pixels</span><span class="p">)</span>
                                <span class="n">robust_total_bkg</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="n">robust_bkg_per_pixel</span> <span class="o">*</span> <span class="n">single_aperture</span><span class="o">.</span><span class="n">area</span>
                                <span class="p">)</span>
                                <span class="n">bkg_result</span><span class="p">[</span><span class="s2">&quot;aperture_sum&quot;</span><span class="p">][</span><span class="n">source_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="n">robust_total_bkg</span>
                                <span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Warning: Background estimation failed for source </span><span class="si">{</span><span class="n">source_idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>

            <span class="c1"># Add radius information and process results</span>
            <span class="n">radius_suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_r</span><span class="si">{</span><span class="n">aperture_radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="c1"># Rename aperture columns</span>
            <span class="k">if</span> <span class="s2">&quot;aperture_sum&quot;</span> <span class="ow">in</span> <span class="n">phot_result</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                <span class="n">phot_result</span><span class="o">.</span><span class="n">rename_column</span><span class="p">(</span>
                    <span class="s2">&quot;aperture_sum&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;aperture_sum</span><span class="si">{</span><span class="n">radius_suffix</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;aperture_sum_err&quot;</span> <span class="ow">in</span> <span class="n">phot_result</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                <span class="n">phot_result</span><span class="o">.</span><span class="n">rename_column</span><span class="p">(</span>
                    <span class="s2">&quot;aperture_sum_err&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;aperture_sum_err</span><span class="si">{</span><span class="n">radius_suffix</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Calculate background-corrected photometry</span>
            <span class="k">if</span> <span class="s2">&quot;aperture_sum&quot;</span> <span class="ow">in</span> <span class="n">bkg_result</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                <span class="c1"># Ensure we handle both scalar and array cases</span>
                <span class="n">annulus_area</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">annulus</span><span class="p">,</span> <span class="s2">&quot;area&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">area</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">annulus</span><span class="p">])</span>
                <span class="n">aperture_area</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">aperture</span><span class="p">,</span> <span class="s2">&quot;area&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">area</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">aperture</span><span class="p">])</span>

                <span class="c1"># Avoid division by zero</span>
                <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">):</span>
                    <span class="n">bkg_per_pixel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span>
                        <span class="n">bkg_result</span><span class="p">[</span><span class="s2">&quot;aperture_sum&quot;</span><span class="p">],</span>
                        <span class="n">annulus_area</span><span class="p">,</span>
                        <span class="n">out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">bkg_result</span><span class="p">[</span><span class="s2">&quot;aperture_sum&quot;</span><span class="p">]),</span>
                        <span class="n">where</span><span class="o">=</span><span class="n">annulus_area</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="n">total_bkg</span> <span class="o">=</span> <span class="n">bkg_per_pixel</span> <span class="o">*</span> <span class="n">aperture_area</span>

                <span class="c1"># Store background-corrected flux</span>
                <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;aperture_sum</span><span class="si">{</span><span class="n">radius_suffix</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">phot_result</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                    <span class="n">phot_result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;aperture_sum_bkg_corr</span><span class="si">{</span><span class="n">radius_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">phot_result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;aperture_sum</span><span class="si">{</span><span class="n">radius_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">total_bkg</span>
                    <span class="p">)</span>

                <span class="c1"># Store background information</span>
                <span class="n">phot_result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;background</span><span class="si">{</span><span class="n">radius_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_bkg</span>
                <span class="n">phot_result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;background_per_pixel</span><span class="si">{</span><span class="n">radius_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bkg_per_pixel</span>

            <span class="n">phot_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phot_result</span><span class="p">)</span>

        <span class="c1"># Combine all photometry results</span>
        <span class="n">phot_table</span> <span class="o">=</span> <span class="n">phot_tables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">phot_tables</span><span class="p">)):</span>
            <span class="c1"># Add columns from additional apertures</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">phot_tables</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">phot_table</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                    <span class="n">phot_table</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot_tables</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>

        <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;xcenter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s2">&quot;xcentroid&quot;</span><span class="p">]</span>
        <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;ycenter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s2">&quot;ycentroid&quot;</span><span class="p">]</span>

        <span class="c1"># Calculate SNR and magnitudes for each aperture</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">radius</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">aperture_radii</span><span class="p">):</span>
            <span class="n">radius_suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_r</span><span class="si">{</span><span class="n">radius</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">aperture_sum_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;aperture_sum</span><span class="si">{</span><span class="n">radius_suffix</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">aperture_err_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;aperture_sum_err</span><span class="si">{</span><span class="n">radius_suffix</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">bkg_corr_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;aperture_sum_bkg_corr</span><span class="si">{</span><span class="n">radius_suffix</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">aperture_sum_col</span> <span class="ow">in</span> <span class="n">phot_table</span><span class="o">.</span><span class="n">colnames</span>
                <span class="ow">and</span> <span class="n">aperture_err_col</span> <span class="ow">in</span> <span class="n">phot_table</span><span class="o">.</span><span class="n">colnames</span>
            <span class="p">):</span>
                <span class="c1"># SNR for raw aperture sum</span>
                <span class="n">phot_table</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;snr</span><span class="si">{</span><span class="n">radius_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
                    <span class="n">phot_table</span><span class="p">[</span><span class="n">aperture_sum_col</span><span class="p">]</span> <span class="o">/</span> <span class="n">phot_table</span><span class="p">[</span><span class="n">aperture_err_col</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">m_err</span> <span class="o">=</span> <span class="mf">1.0857</span> <span class="o">/</span> <span class="n">phot_table</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;snr</span><span class="si">{</span><span class="n">radius_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                <span class="n">phot_table</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;aperture_mag_err</span><span class="si">{</span><span class="n">radius_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_err</span>

                <span class="c1"># Instrumental magnitude for raw aperture sum</span>
                <span class="n">instrumental_mags</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span>
                    <span class="n">phot_table</span><span class="p">[</span><span class="n">aperture_sum_col</span><span class="p">]</span> <span class="o">/</span> <span class="n">exposure_time</span>
                <span class="p">)</span>
                <span class="n">phot_table</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;instrumental_mag</span><span class="si">{</span><span class="n">radius_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instrumental_mags</span>

                <span class="c1"># If background-corrected flux is available, calculate its magnitude too</span>
                <span class="k">if</span> <span class="n">bkg_corr_col</span> <span class="ow">in</span> <span class="n">phot_table</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                    <span class="c1"># Handle negative or zero background-corrected fluxes</span>
                    <span class="n">valid_flux</span> <span class="o">=</span> <span class="n">phot_table</span><span class="p">[</span><span class="n">bkg_corr_col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="n">phot_table</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;instrumental_mag_bkg_corr</span><span class="si">{</span><span class="n">radius_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">phot_table</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;instrumental_mag_bkg_corr</span><span class="si">{</span><span class="n">radius_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span>
                        <span class="n">valid_flux</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span>
                        <span class="n">phot_table</span><span class="p">[</span><span class="n">bkg_corr_col</span><span class="p">][</span><span class="n">valid_flux</span><span class="p">]</span> <span class="o">/</span> <span class="n">exposure_time</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">phot_table</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;snr</span><span class="si">{</span><span class="n">radius_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">phot_table</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;aperture_mag_err</span><span class="si">{</span><span class="n">radius_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">phot_table</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;instrumental_mag</span><span class="si">{</span><span class="n">radius_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Keep the original columns for backward compatibility (using 1.5*FWHM aperture)</span>
        <span class="k">if</span> <span class="s2">&quot;aperture_sum_r1.5&quot;</span> <span class="ow">in</span> <span class="n">phot_table</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
            <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;aperture_sum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;aperture_sum_r1.5&quot;</span><span class="p">]</span>
            <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;aperture_sum_err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;aperture_sum_err_r1.5&quot;</span><span class="p">]</span>
            <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;snr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;snr_r1.5&quot;</span><span class="p">]</span>
            <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;aperture_mag_err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;aperture_mag_err_r1.5&quot;</span><span class="p">]</span>
            <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;instrumental_mag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;instrumental_mag_r1.5&quot;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">epsf_table</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">perform_psf_photometry</span><span class="p">(</span>
                <span class="n">image_sub</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">fwhm_estimate</span><span class="p">,</span> <span class="n">daofind</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">total_error</span>
            <span class="p">)</span>

            <span class="n">epsf_table</span><span class="p">[</span><span class="s2">&quot;snr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
                <span class="n">epsf_table</span><span class="p">[</span><span class="s2">&quot;flux_fit&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">epsf_table</span><span class="p">[</span><span class="s2">&quot;flux_err&quot;</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="n">m_err</span> <span class="o">=</span> <span class="mf">1.0857</span> <span class="o">/</span> <span class="n">epsf_table</span><span class="p">[</span><span class="s2">&quot;snr&quot;</span><span class="p">]</span>
            <span class="n">epsf_table</span><span class="p">[</span><span class="s2">&quot;psf_mag_err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_err</span>

            <span class="n">epsf_instrumental_mags</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span>
                <span class="n">epsf_table</span><span class="p">[</span><span class="s2">&quot;flux_fit&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">exposure_time</span>
            <span class="p">)</span>
            <span class="n">epsf_table</span><span class="p">[</span><span class="s2">&quot;instrumental_mag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsf_instrumental_mags</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error performing EPSF photometry: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">epsf_table</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">valid_sources</span> <span class="o">=</span> <span class="p">(</span><span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;aperture_sum&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span>
            <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;instrumental_mag&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">phot_table</span> <span class="o">=</span> <span class="n">phot_table</span><span class="p">[</span><span class="n">valid_sources</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">epsf_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">epsf_valid_sources</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">epsf_table</span><span class="p">[</span><span class="s2">&quot;instrumental_mag&quot;</span><span class="p">])</span>
            <span class="n">epsf_table</span> <span class="o">=</span> <span class="n">epsf_table</span><span class="p">[</span><span class="n">epsf_valid_sources</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">wcs_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">wcs_obj</span><span class="o">.</span><span class="n">pixel_to_world_values</span><span class="p">(</span>
                    <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;xcenter&quot;</span><span class="p">],</span> <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;ycenter&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ra</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
                <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dec</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>

                <span class="k">if</span> <span class="n">epsf_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">epsf_ra</span><span class="p">,</span> <span class="n">epsf_dec</span> <span class="o">=</span> <span class="n">wcs_obj</span><span class="o">.</span><span class="n">pixel_to_world_values</span><span class="p">(</span>
                            <span class="n">epsf_table</span><span class="p">[</span><span class="s2">&quot;x_fit&quot;</span><span class="p">],</span> <span class="n">epsf_table</span><span class="p">[</span><span class="s2">&quot;y_fit&quot;</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">epsf_table</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsf_ra</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
                        <span class="n">epsf_table</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsf_dec</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not add coordinates to EPSF table: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
                    <span class="n">key</span> <span class="ow">in</span> <span class="n">science_header</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;RA&quot;</span><span class="p">,</span> <span class="s2">&quot;DEC&quot;</span><span class="p">,</span> <span class="s2">&quot;NAXIS1&quot;</span><span class="p">,</span> <span class="s2">&quot;NAXIS2&quot;</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using simple linear approximation for RA/DEC coordinates&quot;</span><span class="p">)</span>
                    <span class="n">center_ra</span> <span class="o">=</span> <span class="n">science_header</span><span class="p">[</span><span class="s2">&quot;RA&quot;</span><span class="p">]</span>
                    <span class="n">center_dec</span> <span class="o">=</span> <span class="n">science_header</span><span class="p">[</span><span class="s2">&quot;DEC&quot;</span><span class="p">]</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="n">science_header</span><span class="p">[</span><span class="s2">&quot;NAXIS1&quot;</span><span class="p">]</span>
                    <span class="n">height</span> <span class="o">=</span> <span class="n">science_header</span><span class="p">[</span><span class="s2">&quot;NAXIS2&quot;</span><span class="p">]</span>

                    <span class="n">pix_scale</span> <span class="o">=</span> <span class="n">pixel_scale</span> <span class="ow">or</span> <span class="mf">1.0</span>

                    <span class="n">center_x</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="n">center_y</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span>

                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phot_table</span><span class="p">):</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;xcenter&quot;</span><span class="p">]</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;ycenter&quot;</span><span class="p">]</span>
                        <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">center_x</span><span class="p">)</span> <span class="o">*</span> <span class="n">pix_scale</span> <span class="o">/</span> <span class="mf">3600.0</span>
                        <span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">center_y</span><span class="p">)</span> <span class="o">*</span> <span class="n">pix_scale</span> <span class="o">/</span> <span class="mf">3600.0</span>
                        <span class="n">phot_table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">center_ra</span> <span class="o">+</span> <span class="n">dx</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">center_dec</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">phot_table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">center_dec</span> <span class="o">+</span> <span class="n">dy</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;WCS transformation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. RA and Dec not added to tables.&quot;</span>
            <span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">phot_table</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources and performed photometry.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">phot_table</span><span class="p">,</span> <span class="n">epsf_table</span><span class="p">,</span> <span class="n">daofind</span><span class="p">,</span> <span class="n">bkg</span><span class="p">,</span> <span class="n">wcs_obj</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error performing aperture photometry: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">daofind</span><span class="p">,</span> <span class="n">bkg</span><span class="p">,</span> <span class="n">wcs_obj</span></div>



<span class="c1"># Visual check of the background-subtracted image</span>
<span class="k">def</span><span class="w"> </span><span class="nf">show_subtracted_image</span><span class="p">(</span><span class="n">image_sub</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
    <span class="n">zscale</span> <span class="o">=</span> <span class="n">ZScaleInterval</span><span class="p">()</span>
    <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">zscale</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">image_sub</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image_sub</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Background-subtracted image&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Flux&quot;</span><span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>


<div class="viewcode-block" id="cross_match_with_gaia">
<a class="viewcode-back" href="../../api.html#src.pipeline.cross_match_with_gaia">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cross_match_with_gaia</span><span class="p">(</span>
    <span class="n">_phot_table</span><span class="p">,</span>
    <span class="n">science_header</span><span class="p">,</span>
    <span class="n">pixel_size_arcsec</span><span class="p">,</span>
    <span class="n">mean_fwhm_pixel</span><span class="p">,</span>
    <span class="n">filter_band</span><span class="p">,</span>
    <span class="n">filter_max_mag</span><span class="p">,</span>
    <span class="n">refined_wcs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cross-match detected sources with the GAIA DR3 star catalog.</span>
<span class="sd">    This function queries the GAIA catalog for a region matching the image field of view,</span>
<span class="sd">    applies filtering based on magnitude range, and matches GAIA sources to the detected sources.</span>
<span class="sd">    It also applies quality filters including variability, color index, and astrometric quality</span>
<span class="sd">    to ensure reliable photometric calibration stars.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    _phot_table : astropy.table.Table</span>

<span class="sd">        Table containing detected source positions (underscore prevents caching issues)</span>
<span class="sd">    _science_header : dict or astropy.io.fits.Header</span>
<span class="sd">        FITS header with WCS information (underscore prevents caching issues)</span>
<span class="sd">    pixel_size_arcsec : float</span>

<span class="sd">        Pixel scale in arcseconds per pixel</span>
<span class="sd">    mean_fwhm_pixel : float</span>
<span class="sd">        FWHM in pixels, used to determine matching radius</span>
<span class="sd">    filter_band : str</span>
<span class="sd">        GAIA magnitude band to use for filtering (e.g., &#39;phot_g_mean_mag&#39;, &#39;phot_bp_mean_mag&#39;,</span>
<span class="sd">        &#39;phot_rp_mean_mag&#39; or other synthetic photometry bands)</span>
<span class="sd">    filter_max_mag : float</span>
<span class="sd">        Maximum magnitude for GAIA source filtering</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame or None</span>
<span class="sd">        DataFrame containing matched sources with both measured and GAIA catalog data,</span>
<span class="sd">        or None if the cross-match failed or found no matches</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - The maximum separation for matching is set to twice the FWHM in arcseconds</span>
<span class="sd">    - Applies a simple atmospheric extinction correction of 0.1*airmass</span>
<span class="sd">    - Stores the calibrated photometry table in session state as &#39;final_phot_table&#39;</span>
<span class="sd">    - Creates and saves a plot showing the relation between GAIA and calibrated magnitudes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Cross-matching with Gaia DR3...&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">science_header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No header information available. Cannot cross-match with Gaia.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Use refined WCS if available, otherwise fallback to header WCS</span>
        <span class="k">if</span> <span class="n">refined_wcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">refined_wcs</span>
            <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using refined WCS for Gaia cross-matching, if possible.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">science_header</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using header WCS for Gaia cross-matching&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating WCS: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">source_positions_pixel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
            <span class="p">(</span><span class="n">_phot_table</span><span class="p">[</span><span class="s2">&quot;xcenter&quot;</span><span class="p">],</span> <span class="n">_phot_table</span><span class="p">[</span><span class="s2">&quot;ycenter&quot;</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="n">source_positions_sky</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">pixel_to_world</span><span class="p">(</span>
            <span class="n">source_positions_pixel</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">source_positions_pixel</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error converting pixel positions to sky coordinates: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Validate RA/DEC coordinates before using them</span>
        <span class="k">if</span> <span class="s2">&quot;RA&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">science_header</span> <span class="ow">or</span> <span class="s2">&quot;DEC&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">science_header</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Missing RA/DEC coordinates in header&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">image_center_ra_dec</span> <span class="o">=</span> <span class="p">[</span><span class="n">science_header</span><span class="p">[</span><span class="s2">&quot;RA&quot;</span><span class="p">],</span> <span class="n">science_header</span><span class="p">[</span><span class="s2">&quot;DEC&quot;</span><span class="p">]]</span>

        <span class="c1"># Validate coordinate values</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">image_center_ra_dec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">360</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="o">-</span><span class="mi">90</span> <span class="o">&lt;=</span> <span class="n">image_center_ra_dec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">90</span>
        <span class="p">):</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid coordinates: RA=</span><span class="si">{</span><span class="n">image_center_ra_dec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, DEC=</span><span class="si">{</span><span class="n">image_center_ra_dec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Calculate search radius (divided by 1.5 to avoid field edge effects)</span>
        <span class="n">gaia_search_radius_arcsec</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">max</span><span class="p">(</span><span class="n">science_header</span><span class="p">[</span><span class="s2">&quot;NAXIS1&quot;</span><span class="p">],</span> <span class="n">science_header</span><span class="p">[</span><span class="s2">&quot;NAXIS2&quot;</span><span class="p">])</span>
            <span class="o">*</span> <span class="n">pixel_size_arcsec</span>
            <span class="o">/</span> <span class="mf">1.5</span>
        <span class="p">)</span>
        <span class="n">radius_query</span> <span class="o">=</span> <span class="n">gaia_search_radius_arcsec</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span>

        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Querying Gaia in a radius of </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">radius_query</span><span class="o">.</span><span class="n">value</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">60.0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> arcmin.&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Set Gaia data release</span>
        <span class="n">Gaia</span><span class="o">.</span><span class="n">MAIN_GAIA_TABLE</span> <span class="o">=</span> <span class="s2">&quot;gaiadr3.gaia_source&quot;</span>

        <span class="c1"># Create a SkyCoord object for more reliable coordinate handling</span>
        <span class="n">center_coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
            <span class="n">ra</span><span class="o">=</span><span class="n">image_center_ra_dec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">image_center_ra_dec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use the SkyCoord object for cone search</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">Gaia</span><span class="o">.</span><span class="n">cone_search</span><span class="p">(</span><span class="n">center_coord</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius_query</span><span class="p">)</span>
            <span class="n">gaia_table</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span>

            <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Retrieved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gaia_table</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">gaia_table</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mi">0</span><span class="si">}</span><span class="s2"> sources from Gaia&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Different query strategies based on filter band</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">filter_band</span>
                <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;phot_g_mean_mag&quot;</span><span class="p">,</span> <span class="s2">&quot;phot_bp_mean_mag&quot;</span><span class="p">,</span> <span class="s2">&quot;phot_rp_mean_mag&quot;</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">gaia_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">gaia_table</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="c1"># Create a comma-separated list of source_ids (limit to 1000)</span>
                <span class="n">max_sources</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gaia_table</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>
                <span class="n">source_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">gaia_table</span><span class="p">[</span><span class="s2">&quot;source_id&quot;</span><span class="p">][:</span><span class="n">max_sources</span><span class="p">])</span>
                <span class="n">source_ids_str</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">source_ids</span><span class="p">)</span>
                <span class="c1"># Query synthetic photometry just for these specific sources</span>
                <span class="n">synth_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT source_id, c_star, u_jkc_mag, v_jkc_mag, b_jkc_mag,</span>
<span class="s2">                r_jkc_mag, i_jkc_mag, u_sdss_mag, g_sdss_mag, r_sdss_mag,</span>
<span class="s2">                i_sdss_mag, z_sdss_mag</span>
<span class="s2">                FROM gaiadr3.synthetic_photometry_gspc</span>
<span class="s2">                WHERE source_id IN (</span><span class="si">{</span><span class="n">source_ids_str</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">                &quot;&quot;&quot;</span>
                <span class="n">synth_job</span> <span class="o">=</span> <span class="n">Gaia</span><span class="o">.</span><span class="n">launch_job</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">synth_query</span><span class="p">)</span>
                <span class="n">synth_table</span> <span class="o">=</span> <span class="n">synth_job</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span>

                <span class="c1"># Join the two tables</span>
                <span class="k">if</span> <span class="n">synth_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">synth_table</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Retrieved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">synth_table</span><span class="p">)</span><span class="si">}</span><span class="s2"> synthetic photometry entries&quot;</span>
                    <span class="p">)</span>
                    <span class="n">gaia_table</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span>
                        <span class="n">gaia_table</span><span class="p">,</span> <span class="n">synth_table</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="s2">&quot;source_id&quot;</span><span class="p">,</span> <span class="n">join_type</span><span class="o">=</span><span class="s2">&quot;right&quot;</span>
                    <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">cone_error</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gaia query failed: </span><span class="si">{</span><span class="n">cone_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ke</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing header keyword: </span><span class="si">{</span><span class="n">ke</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error querying Gaia: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">gaia_table</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">gaia_table</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">gaia_table</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No Gaia sources found within search radius.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">mag_filter</span> <span class="o">=</span> <span class="n">gaia_table</span><span class="p">[</span><span class="n">filter_band</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">filter_max_mag</span>
        <span class="n">var_filter</span> <span class="o">=</span> <span class="n">gaia_table</span><span class="p">[</span><span class="s2">&quot;phot_variable_flag&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;VARIABLE&quot;</span>
        <span class="n">color_index_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">gaia_table</span><span class="p">[</span><span class="s2">&quot;bp_rp&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gaia_table</span><span class="p">[</span><span class="s2">&quot;bp_rp&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">astrometric_filter</span> <span class="o">=</span> <span class="n">gaia_table</span><span class="p">[</span><span class="s2">&quot;ruwe&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.6</span>

        <span class="n">combined_filter</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">mag_filter</span> <span class="o">&amp;</span> <span class="n">var_filter</span> <span class="o">&amp;</span> <span class="n">color_index_filter</span> <span class="o">&amp;</span> <span class="n">astrometric_filter</span>
        <span class="p">)</span>

        <span class="n">gaia_table_filtered</span> <span class="o">=</span> <span class="n">gaia_table</span><span class="p">[</span><span class="n">combined_filter</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gaia_table_filtered</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No Gaia sources found within magnitude range </span><span class="si">{</span><span class="n">filter_band</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">filter_max_mag</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtered Gaia catalog to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gaia_table_filtered</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error filtering Gaia catalog: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">gaia_skycoords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
            <span class="n">ra</span><span class="o">=</span><span class="n">gaia_table_filtered</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">gaia_table_filtered</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span>
        <span class="p">)</span>
        <span class="n">idx</span><span class="p">,</span> <span class="n">d2d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">source_positions_sky</span><span class="o">.</span><span class="n">match_to_catalog_sky</span><span class="p">(</span><span class="n">gaia_skycoords</span><span class="p">)</span>

        <span class="n">max_sep_constraint</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mean_fwhm_pixel</span> <span class="o">*</span> <span class="n">pixel_size_arcsec</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span>
        <span class="n">gaia_matches</span> <span class="o">=</span> <span class="n">d2d</span> <span class="o">&lt;</span> <span class="n">max_sep_constraint</span>

        <span class="n">matched_indices_gaia</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="n">gaia_matches</span><span class="p">]</span>
        <span class="n">matched_indices_phot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gaia_matches</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_indices_gaia</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No Gaia matches found within the separation constraint.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">matched_table_qtable</span> <span class="o">=</span> <span class="n">_phot_table</span><span class="p">[</span><span class="n">matched_indices_phot</span><span class="p">]</span>

        <span class="n">matched_table</span> <span class="o">=</span> <span class="n">matched_table_qtable</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
        <span class="n">matched_table</span><span class="p">[</span><span class="s2">&quot;gaia_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matched_indices_gaia</span>
        <span class="n">matched_table</span><span class="p">[</span><span class="s2">&quot;gaia_separation_arcsec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2d</span><span class="p">[</span><span class="n">gaia_matches</span><span class="p">]</span><span class="o">.</span><span class="n">arcsec</span>

        <span class="c1"># Add the filter_band column from the filtered Gaia table</span>
        <span class="n">matched_table</span><span class="p">[</span><span class="n">filter_band</span><span class="p">]</span> <span class="o">=</span> <span class="n">gaia_table_filtered</span><span class="p">[</span><span class="n">filter_band</span><span class="p">][</span>
            <span class="n">matched_indices_gaia</span>
        <span class="p">]</span>

        <span class="n">valid_gaia_mags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">matched_table</span><span class="p">[</span><span class="n">filter_band</span><span class="p">])</span>
        <span class="n">matched_table</span> <span class="o">=</span> <span class="n">matched_table</span><span class="p">[</span><span class="n">valid_gaia_mags</span><span class="p">]</span>

        <span class="c1"># Remove sources with SNR &lt; 1 before zero point calculation</span>
        <span class="k">if</span> <span class="s2">&quot;snr&quot;</span> <span class="ow">in</span> <span class="n">matched_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">matched_table</span> <span class="o">=</span> <span class="n">matched_table</span><span class="p">[</span><span class="n">matched_table</span><span class="p">[</span><span class="s2">&quot;snr&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matched_table</span><span class="p">)</span><span class="si">}</span><span class="s2"> Gaia matches after filtering.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">matched_table</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during cross-matching: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="calculate_zero_point">
<a class="viewcode-back" href="../../api.html#src.pipeline.calculate_zero_point">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_zero_point</span><span class="p">(</span><span class="n">_phot_table</span><span class="p">,</span> <span class="n">_matched_table</span><span class="p">,</span> <span class="n">filter_band</span><span class="p">,</span> <span class="n">air</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate photometric zero point from matched sources with GAIA.</span>

<span class="sd">    The zero point transforms instrumental magnitudes to the standard GAIA magnitude system,</span>
<span class="sd">    accounting for atmospheric extinction using the provided airmass.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    _phot_table : astropy.table.Table or pandas.DataFrame</span>
<span class="sd">        Photometry results table (underscore prevents caching issues)</span>
<span class="sd">    _matched_table : pandas.DataFrame</span>
<span class="sd">        Table of GAIA cross-matched sources (used for calibration)</span>
<span class="sd">    filter_band : str</span>
<span class="sd">        GAIA magnitude band used (e.g., &#39;phot_g_mean_mag&#39;)</span>
<span class="sd">    air : float</span>
<span class="sd">        Airmass value for atmospheric extinction correction</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (zero_point_value, zero_point_std, matplotlib_figure) where:</span>
<span class="sd">        - zero_point_value: Float value of the calculated zero point</span>
<span class="sd">        - zero_point_std: Standard deviation of the zero point</span>
<span class="sd">        - matplotlib_figure: Figure object showing GAIA vs. calibrated magnitudes</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Uses sigma clipping to remove outliers from zero point calculation</span>
<span class="sd">    - Applies a simple atmospheric extinction correction of 0.1*airmass</span>
<span class="sd">    - Stores the calibrated photometry table in session state as &#39;final_phot_table&#39;</span>
<span class="sd">    - Creates and saves a plot showing the relation between GAIA and calibrated magnitudes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">_matched_table</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">_matched_table</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No matched sources to calculate zero point.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">_matched_table</span><span class="p">[</span><span class="s2">&quot;instrumental_mag&quot;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span>
            <span class="n">_matched_table</span><span class="p">[</span><span class="n">filter_band</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">zero_points</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">_matched_table</span><span class="p">[</span><span class="n">filter_band</span><span class="p">][</span><span class="n">valid</span><span class="p">]</span>
            <span class="o">-</span> <span class="n">_matched_table</span><span class="p">[</span><span class="s2">&quot;instrumental_mag&quot;</span><span class="p">][</span><span class="n">valid</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">_matched_table</span><span class="p">[</span><span class="s2">&quot;zero_point&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero_points</span>
        <span class="n">_matched_table</span><span class="p">[</span><span class="s2">&quot;zero_point_error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">zero_points</span><span class="p">)</span>

        <span class="n">clipped_zero_points</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span>
            <span class="n">zero_points</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">cenfunc</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="n">zero_point_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">clipped_zero_points</span><span class="p">)</span>
        <span class="n">zero_point_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">clipped_zero_points</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">zero_point_value</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">zero_point_value</span><span class="p">):</span>
            <span class="n">zero_point_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">zero_point_std</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">zero_point_std</span><span class="p">):</span>
            <span class="n">zero_point_std</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>

        <span class="n">_matched_table</span><span class="p">[</span><span class="s2">&quot;calib_mag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">_matched_table</span><span class="p">[</span><span class="s2">&quot;instrumental_mag&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">zero_point_value</span> <span class="o">+</span> <span class="mf">0.09</span> <span class="o">*</span> <span class="n">air</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_phot_table</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">_phot_table</span> <span class="o">=</span> <span class="n">_phot_table</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>

        <span class="c1"># Apply calibration to all aperture radii</span>
        <span class="n">aperture_radii</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>

        <span class="c1"># Remove old single-aperture columns if they exist</span>
        <span class="n">old_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;aperture_mag&quot;</span><span class="p">,</span> <span class="s2">&quot;aperture_instrumental_mag&quot;</span><span class="p">,</span> <span class="s2">&quot;aperture_mag_err&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">old_columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">_phot_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">_phot_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Add calibrated magnitudes for all aperture radii</span>
        <span class="k">for</span> <span class="n">radius</span> <span class="ow">in</span> <span class="n">aperture_radii</span><span class="p">:</span>
            <span class="n">radius_suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_r</span><span class="si">{</span><span class="n">radius</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">instrumental_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;instrumental_mag</span><span class="si">{</span><span class="n">radius_suffix</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">aperture_mag_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;aperture_mag</span><span class="si">{</span><span class="n">radius_suffix</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="n">instrumental_col</span> <span class="ow">in</span> <span class="n">_phot_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">_phot_table</span><span class="p">[</span><span class="n">aperture_mag_col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">_phot_table</span><span class="p">[</span><span class="n">instrumental_col</span><span class="p">]</span> <span class="o">+</span> <span class="n">zero_point_value</span> <span class="o">+</span> <span class="mf">0.09</span> <span class="o">*</span> <span class="n">air</span>
                <span class="p">)</span>

        <span class="c1"># Also apply to matched table for all aperture radii</span>
        <span class="k">for</span> <span class="n">radius</span> <span class="ow">in</span> <span class="n">aperture_radii</span><span class="p">:</span>
            <span class="n">radius_suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_r</span><span class="si">{</span><span class="n">radius</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">instrumental_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;instrumental_mag</span><span class="si">{</span><span class="n">radius_suffix</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">aperture_mag_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;aperture_mag</span><span class="si">{</span><span class="n">radius_suffix</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="n">instrumental_col</span> <span class="ow">in</span> <span class="n">_matched_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">_matched_table</span><span class="p">[</span><span class="n">aperture_mag_col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">_matched_table</span><span class="p">[</span><span class="n">instrumental_col</span><span class="p">]</span> <span class="o">+</span> <span class="n">zero_point_value</span> <span class="o">+</span> <span class="mf">0.09</span> <span class="o">*</span> <span class="n">air</span>
                <span class="p">)</span>

        <span class="c1"># Keep the legacy &quot;calib_mag&quot; column using the 1.5*FWHM aperture for backward compatibility</span>
        <span class="k">if</span> <span class="s2">&quot;instrumental_mag_r1.5&quot;</span> <span class="ow">in</span> <span class="n">_phot_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">_phot_table</span><span class="p">[</span><span class="s2">&quot;calib_mag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">_phot_table</span><span class="p">[</span><span class="s2">&quot;instrumental_mag_r1.5&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">zero_point_value</span> <span class="o">+</span> <span class="mf">0.09</span> <span class="o">*</span> <span class="n">air</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;instrumental_mag_r1.5&quot;</span> <span class="ow">in</span> <span class="n">_matched_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">_matched_table</span><span class="p">[</span><span class="s2">&quot;calib_mag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">_matched_table</span><span class="p">[</span><span class="s2">&quot;instrumental_mag_r1.5&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">zero_point_value</span> <span class="o">+</span> <span class="mf">0.09</span> <span class="o">*</span> <span class="n">air</span>
            <span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;final_phot_table&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_phot_table</span>

        <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ax_resid</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

        <span class="c1"># Calculate residuals</span>
        <span class="n">_matched_table</span><span class="p">[</span><span class="s2">&quot;residual&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">_matched_table</span><span class="p">[</span><span class="n">filter_band</span><span class="p">]</span> <span class="o">-</span> <span class="n">_matched_table</span><span class="p">[</span><span class="s2">&quot;calib_mag&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Left plot: Zero point calibration</span>
        <span class="c1"># Plot individual points</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">_matched_table</span><span class="p">[</span><span class="n">filter_band</span><span class="p">],</span>
            <span class="n">_matched_table</span><span class="p">[</span><span class="s2">&quot;calib_mag&quot;</span><span class="p">],</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Matched sources&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Calculate and plot regression line with variance</span>
        <span class="n">x_data</span> <span class="o">=</span> <span class="n">_matched_table</span><span class="p">[</span><span class="n">filter_band</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y_data</span> <span class="o">=</span> <span class="n">_matched_table</span><span class="p">[</span><span class="s2">&quot;calib_mag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># Remove any NaN values for regression</span>
        <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x_data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_data</span><span class="p">)</span>
        <span class="n">x_clean</span> <span class="o">=</span> <span class="n">x_data</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
        <span class="n">y_clean</span> <span class="o">=</span> <span class="n">y_data</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_clean</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Calculate linear regression</span>
            <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x_clean</span><span class="p">,</span> <span class="n">y_clean</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">=</span> <span class="n">coeffs</span>

            <span class="c1"># Create regression line points</span>
            <span class="n">x_reg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_clean</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x_clean</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">y_reg</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">x_reg</span> <span class="o">+</span> <span class="n">intercept</span>

            <span class="c1"># Calculate residuals and standard deviation</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">x_clean</span> <span class="o">+</span> <span class="n">intercept</span>
            <span class="n">residuals</span> <span class="o">=</span> <span class="n">y_clean</span> <span class="o">-</span> <span class="n">y_pred</span>
            <span class="n">std_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>

            <span class="c1"># Plot regression line</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">x_reg</span><span class="p">,</span> <span class="n">y_reg</span><span class="p">,</span> <span class="s2">&quot;r-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Regression (slope=</span><span class="si">{</span><span class="n">slope</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Plot variance bands (Â±1Ï and Â±2Ï)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                <span class="n">x_reg</span><span class="p">,</span>
                <span class="n">y_reg</span> <span class="o">-</span> <span class="n">std_residuals</span><span class="p">,</span>
                <span class="n">y_reg</span> <span class="o">+</span> <span class="n">std_residuals</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Â±1Ï (</span><span class="si">{</span><span class="n">std_residuals</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> mag)&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                <span class="n">x_reg</span><span class="p">,</span>
                <span class="n">y_reg</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">std_residuals</span><span class="p">,</span>
                <span class="n">y_reg</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">std_residuals</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Â±2Ï (</span><span class="si">{</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">std_residuals</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> mag)&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Add a diagonal line for reference</span>
        <span class="c1"># Create ideal y=x reference line spanning the full range of magnitudes</span>
        <span class="n">mag_range</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">min</span><span class="p">(</span><span class="n">_matched_table</span><span class="p">[</span><span class="n">filter_band</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">_matched_table</span><span class="p">[</span><span class="s2">&quot;calib_mag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span>
            <span class="nb">max</span><span class="p">(</span><span class="n">_matched_table</span><span class="p">[</span><span class="n">filter_band</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">_matched_table</span><span class="p">[</span><span class="s2">&quot;calib_mag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
        <span class="p">]</span>
        <span class="n">ideal_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">mag_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mag_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ideal_mag</span><span class="p">,</span> <span class="n">ideal_mag</span><span class="p">,</span> <span class="s2">&quot;k--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;y=x&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gaia </span><span class="si">{</span><span class="n">filter_band</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Calib mag&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Gaia magnitude vs Calibrated magnitude&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="c1"># Right plot: Residuals</span>
        <span class="n">mag_cat</span> <span class="o">=</span> <span class="n">_matched_table</span><span class="p">[</span><span class="n">filter_band</span><span class="p">]</span>
        <span class="n">mag_inst</span> <span class="o">=</span> <span class="n">_matched_table</span><span class="p">[</span><span class="s2">&quot;instrumental_mag&quot;</span><span class="p">]</span>
        <span class="n">zp_mean</span> <span class="o">=</span> <span class="n">zero_point_value</span>
        <span class="n">residuals</span> <span class="o">=</span> <span class="n">mag_cat</span> <span class="o">-</span> <span class="p">(</span><span class="n">mag_inst</span> <span class="o">+</span> <span class="n">zp_mean</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;aperture_mag_err&quot;</span> <span class="ow">in</span> <span class="n">_matched_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">aperture_mag_err</span> <span class="o">=</span> <span class="n">_matched_table</span><span class="p">[</span><span class="s2">&quot;aperture_mag_err&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aperture_mag_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
        <span class="n">zp_err</span> <span class="o">=</span> <span class="n">zero_point_std</span> <span class="k">if</span> <span class="n">zero_point_std</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="n">yerr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">aperture_mag_err</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">zp_err</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">ax_resid</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
            <span class="n">mag_cat</span><span class="p">,</span>
            <span class="n">residuals</span><span class="p">,</span>
            <span class="n">yerr</span><span class="o">=</span><span class="n">yerr</span><span class="p">,</span>
            <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
            <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Residuals&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax_resid</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
        <span class="n">ax_resid</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Calibrated magnitude&quot;</span><span class="p">)</span>
        <span class="n">ax_resid</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Residual (catalog - calibrated)&quot;</span><span class="p">)</span>
        <span class="n">ax_resid</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Photometric Residuals&quot;</span><span class="p">)</span>
        <span class="n">ax_resid</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax_resid</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="c1"># Adjust layout and display</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">st</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Calculated Zero Point: </span><span class="si">{</span><span class="n">zero_point_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> Â± </span><span class="si">{</span><span class="n">zero_point_std</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">base_name</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;base_filename&quot;</span><span class="p">,</span> <span class="s2">&quot;photometry&quot;</span><span class="p">)</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;anonymous&quot;</span><span class="p">)</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="n">ensure_output_directory</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">_rpp_results&quot;</span><span class="p">)</span>
            <span class="n">zero_point_plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_zero_point_plot.png&quot;</span>
            <span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">zero_point_plot_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not save plot to file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">zero_point_value</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">zero_point_std</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">fig</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calculating zero point: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="enhance_catalog">
<a class="viewcode-back" href="../../api.html#src.pipeline.enhance_catalog">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">enhance_catalog</span><span class="p">(</span>
    <span class="n">api_key</span><span class="p">,</span>
    <span class="n">final_table</span><span class="p">,</span>
    <span class="n">matched_table</span><span class="p">,</span>
    <span class="n">header</span><span class="p">,</span>
    <span class="n">pixel_scale_arcsec</span><span class="p">,</span>
    <span class="n">search_radius_arcsec</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enhance a photometric catalog with cross-matches from multiple</span>
<span class="sd">    astronomical databases.</span>

<span class="sd">    This function queries several catalogs and databases including:</span>
<span class="sd">    - GAIA DR3 (using previously matched sources)</span>
<span class="sd">    - Astro-Colibri (for known astronomical sources)</span>
<span class="sd">    - SIMBAD (for object identifications and classifications)</span>
<span class="sd">    - SkyBoT (for solar system objects)</span>
<span class="sd">    - AAVSO VSX (for variable stars)</span>
<span class="sd">    - VizieR VII/294 (for quasars)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    final_table : pandas.DataFrame</span>
<span class="sd">        Final photometry catalog with RA/Dec coordinates</span>
<span class="sd">    matched_table : pandas.DataFrame</span>
<span class="sd">        Table of already matched GAIA sources (used for calibration)</span>
<span class="sd">    header : dict or astropy.io.fits.Header</span>
<span class="sd">        FITS header with observation information</span>
<span class="sd">    pixel_scale_arcsec : float</span>
<span class="sd">        Pixel scale in arcseconds per pixel</span>
<span class="sd">    search_radius_arcsec : float, optional</span>
<span class="sd">        Search radius for cross-matching in arcseconds, default=60</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        Input dataframe with added catalog information including:</span>
<span class="sd">        - GAIA data for calibration stars</span>
<span class="sd">        - Astro-Colibri source identifications</span>
<span class="sd">        - SIMBAD identifications and object types</span>
<span class="sd">        - Solar system object identifications from SkyBoT</span>
<span class="sd">        - Variable star information from AAVSO VSX</span>
<span class="sd">        - Quasar information from VizieR VII/294</span>
<span class="sd">        - A summary column &#39;catalog_matches&#39; listing all catalog matches</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">       The function shows progress updates in the Streamlit interface and creates</span>
<span class="sd">    a summary display of matched objects. Queries are made with appropriate</span>
<span class="sd">    error handling to prevent failures if any catalog service is unavailable.</span>
<span class="sd">    API requests are processed in batches to avoid overwhelming servers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Add input validation at the beginning</span>
    <span class="k">if</span> <span class="n">final_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;final_table is None - cannot enhance catalog&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_table</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No sources to cross-match with catalogs.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">final_table</span>

    <span class="c1"># Ensure we have valid RA/Dec coordinates in final_table</span>
    <span class="k">if</span> <span class="s2">&quot;ra&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s2">&quot;dec&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;final_table must contain &#39;ra&#39; and &#39;dec&#39; columns for cross-matching&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">final_table</span>

    <span class="c1"># Make a copy to avoid modifying the original table</span>
    <span class="n">enhanced_table</span> <span class="o">=</span> <span class="n">final_table</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Filter out sources with NaN coordinates at the beginning</span>
    <span class="n">valid_coords_mask</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">])</span>
        <span class="o">&amp;</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">])</span>
        <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">])</span>
        <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">])</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_coords_mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No sources with valid RA/Dec coordinates found for cross-matching&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">enhanced_table</span>

    <span class="n">num_invalid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">enhanced_table</span><span class="p">)</span> <span class="o">-</span> <span class="n">valid_coords_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">num_invalid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Excluding </span><span class="si">{</span><span class="n">num_invalid</span><span class="si">}</span><span class="s2"> sources with invalid coordinates from cross-matching&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Compute field of view (arcmin) ONCE and use everywhere</span>
    <span class="n">field_center_ra</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">field_center_dec</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">field_width_arcmin</span> <span class="o">=</span> <span class="mf">30.0</span>  <span class="c1"># fallback default</span>
    <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;CRVAL1&quot;</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="s2">&quot;CRVAL2&quot;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">field_center_ra</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRVAL1&quot;</span><span class="p">])</span>
            <span class="n">field_center_dec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRVAL2&quot;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s2">&quot;RA&quot;</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="s2">&quot;DEC&quot;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">field_center_ra</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;RA&quot;</span><span class="p">])</span>
            <span class="n">field_center_dec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;DEC&quot;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s2">&quot;OBJRA&quot;</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="s2">&quot;OBJDEC&quot;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">field_center_ra</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;OBJRA&quot;</span><span class="p">])</span>
            <span class="n">field_center_dec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;OBJDEC&quot;</span><span class="p">])</span>
        <span class="c1"># Compute field width if possible</span>
        <span class="k">if</span> <span class="s2">&quot;NAXIS1&quot;</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="s2">&quot;NAXIS2&quot;</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="n">pixel_scale_arcsec</span><span class="p">:</span>
            <span class="n">field_width_arcmin</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">max</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NAXIS1&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NAXIS2&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span>
                <span class="o">*</span> <span class="n">pixel_scale_arcsec</span>
                <span class="o">/</span> <span class="mf">60.0</span>
            <span class="p">)</span>

    <span class="n">status_text</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
    <span class="n">status_text</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Starting cross-match process...&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">matched_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_table</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">status_text</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Adding Gaia calibration matches...&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;xcenter&quot;</span> <span class="ow">in</span> <span class="n">enhanced_table</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;ycenter&quot;</span> <span class="ow">in</span> <span class="n">enhanced_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;match_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;xcenter&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                <span class="o">+</span> <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;ycenter&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;xcenter&quot;</span> <span class="ow">in</span> <span class="n">matched_table</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;ycenter&quot;</span> <span class="ow">in</span> <span class="n">matched_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">matched_table</span><span class="p">[</span><span class="s2">&quot;match_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">matched_table</span><span class="p">[</span><span class="s2">&quot;xcenter&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                <span class="o">+</span> <span class="n">matched_table</span><span class="p">[</span><span class="s2">&quot;ycenter&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">gaia_cols</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">col</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">matched_table</span><span class="o">.</span><span class="n">columns</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">col</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;gaia&quot;</span><span class="p">,</span> <span class="s2">&quot;phot_&quot;</span><span class="p">])</span>
            <span class="p">]</span>
            <span class="n">gaia_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;match_id&quot;</span><span class="p">)</span>

            <span class="n">gaia_subset</span> <span class="o">=</span> <span class="n">matched_table</span><span class="p">[</span><span class="n">gaia_cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">gaia_subset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="s2">&quot;match_id&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;gaia_&quot;</span><span class="p">):</span>
                    <span class="n">rename_dict</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;gaia_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="n">rename_dict</span><span class="p">:</span>
                <span class="n">gaia_subset</span> <span class="o">=</span> <span class="n">gaia_subset</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">rename_dict</span><span class="p">)</span>

            <span class="n">enhanced_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">enhanced_table</span><span class="p">,</span> <span class="n">gaia_subset</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;match_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
            <span class="p">)</span>

            <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;gaia_calib_star&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;match_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
                <span class="n">matched_table</span><span class="p">[</span><span class="s2">&quot;match_id&quot;</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matched_table</span><span class="p">)</span><span class="si">}</span><span class="s2"> Gaia calibration stars to catalog&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">field_center_ra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">field_center_dec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mi">360</span> <span class="o">&lt;=</span> <span class="n">field_center_ra</span> <span class="o">&lt;=</span> <span class="mi">360</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mi">90</span> <span class="o">&lt;=</span> <span class="n">field_center_dec</span> <span class="o">&lt;=</span> <span class="mi">90</span><span class="p">):</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid coordinates: RA=</span><span class="si">{</span><span class="n">field_center_ra</span><span class="si">}</span><span class="s2">, DEC=</span><span class="si">{</span><span class="n">field_center_dec</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not extract field center coordinates from header&quot;</span><span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Querying Astro-Colibri API...&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">api_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ASTROCOLIBRI_API&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No API key for ASTRO-COLIBRI provided or found&quot;</span><span class="p">)</span>
            <span class="k">pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Base URL of the API</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">URL</span> <span class="o">+</span> <span class="s2">&quot;cone_search&quot;</span>

            <span class="c1"># Request parameters (headers, body)</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">}</span>

            <span class="c1"># Define date range for the query</span>
            <span class="n">observation_date</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;DATE-OBS&quot;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                    <span class="n">observation_date</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;DATE-OBS&quot;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s2">&quot;DATE&quot;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                    <span class="n">observation_date</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span>

            <span class="c1"># Set time range to Â±7 days from observation date or current date</span>
            <span class="k">if</span> <span class="n">observation_date</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">base_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span>
                        <span class="n">observation_date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="n">base_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">base_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

            <span class="n">date_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">14</span><span class="p">))</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="n">date_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">))</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

            <span class="n">body</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;uid&quot;</span><span class="p">:</span> <span class="n">api_key</span><span class="p">,</span>
                <span class="s2">&quot;filter&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;time_range&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="n">date_max</span><span class="p">,</span>
                    <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="n">date_min</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;cone&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ra&quot;</span><span class="p">:</span> <span class="n">field_center_ra</span><span class="p">,</span> <span class="s2">&quot;dec&quot;</span><span class="p">:</span> <span class="n">field_center_dec</span><span class="p">},</span>
                    <span class="s2">&quot;radius&quot;</span><span class="p">:</span> <span class="n">field_width_arcmin</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>

            <span class="c1"># Perform the POST request</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">))</span>

            <span class="c1"># Process the response</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="n">events</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;voevents&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;url: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Request failed with status code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Request did NOT succeed : &quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error message : &quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error querying Astro-Colibri API: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Continue with function instead of returning None</span>

        <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">sources</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;ra&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;dec&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;discoverer_internal_name&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;classification&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="p">}</span>

            <span class="c1"># astrostars = pd.DataFrame(source)</span>
            <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;astrocolibri_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;astrocolibri_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;astrocolibri_classification&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;ra&quot;</span> <span class="ow">in</span> <span class="n">event</span> <span class="ow">and</span> <span class="s2">&quot;dec&quot;</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
                    <span class="n">sources</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">])</span>
                    <span class="n">sources</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">])</span>
                    <span class="n">sources</span><span class="p">[</span><span class="s2">&quot;discoverer_internal_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">event</span><span class="p">[</span><span class="s2">&quot;discoverer_internal_name&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">sources</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">])</span>
                    <span class="n">sources</span><span class="p">[</span><span class="s2">&quot;classification&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;classification&quot;</span><span class="p">])</span>
            <span class="n">astrostars</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">astrostars</span><span class="p">)</span><span class="si">}</span><span class="s2"> Astro-Colibri sources in field.&quot;</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">astrostars</span><span class="p">)</span>

            <span class="c1"># Filter valid coordinates for astro-colibri matching</span>
            <span class="n">valid_final_coords</span> <span class="o">=</span> <span class="n">enhanced_table</span><span class="p">[</span><span class="n">valid_coords_mask</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_final_coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">astrostars</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">source_coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
                    <span class="n">ra</span><span class="o">=</span><span class="n">valid_final_coords</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                    <span class="n">dec</span><span class="o">=</span><span class="n">valid_final_coords</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                    <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">astro_colibri_coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
                    <span class="n">ra</span><span class="o">=</span><span class="n">astrostars</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">],</span>
                    <span class="n">dec</span><span class="o">=</span><span class="n">astrostars</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">],</span>
                    <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">search_radius_arcsec</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Search radius must be a number&quot;</span><span class="p">)</span>

                <span class="n">idx</span><span class="p">,</span> <span class="n">d2d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">source_coords</span><span class="o">.</span><span class="n">match_to_catalog_sky</span><span class="p">(</span><span class="n">astro_colibri_coords</span><span class="p">)</span>
                <span class="n">matches</span> <span class="o">=</span> <span class="n">d2d</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">15</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>

                <span class="c1"># Map matches back to the original table indices</span>
                <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">valid_final_coords</span><span class="o">.</span><span class="n">index</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">match_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">idx</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                        <span class="n">original_idx</span> <span class="o">=</span> <span class="n">valid_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">enhanced_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">original_idx</span><span class="p">,</span> <span class="s2">&quot;astrocolibri_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">astrostars</span><span class="p">[</span><span class="s2">&quot;discoverer_internal_name&quot;</span><span class="p">][</span><span class="n">match_idx</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">enhanced_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">original_idx</span><span class="p">,</span> <span class="s2">&quot;astrocolibri_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">astrostars</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">][</span><span class="n">match_idx</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">enhanced_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                            <span class="n">original_idx</span><span class="p">,</span> <span class="s2">&quot;astrocolibri_classification&quot;</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">astrostars</span><span class="p">[</span><span class="s2">&quot;classification&quot;</span><span class="p">][</span><span class="n">match_idx</span><span class="p">]</span>

                <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;Astro-Colibri matched objects in field.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No valid coordinates available for Astro-Colibri matching&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No Astro-Colibri sources found in the field.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error querying Astro-Colibri: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No Astro-Colibri sources found.&quot;</span><span class="p">)</span>

    <span class="n">status_text</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Querying SIMBAD for object identifications...&quot;</span><span class="p">)</span>

    <span class="n">custom_simbad</span> <span class="o">=</span> <span class="n">Simbad</span><span class="p">()</span>
    <span class="n">custom_simbad</span><span class="o">.</span><span class="n">add_votable_fields</span><span class="p">(</span><span class="s2">&quot;otype&quot;</span><span class="p">,</span> <span class="s2">&quot;main_id&quot;</span><span class="p">,</span> <span class="s2">&quot;ids&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;V&quot;</span><span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Querying SIMBAD&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">center_coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">field_center_ra</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">field_center_dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">)</span>
        <span class="n">simbad_result</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">safe_catalog_query</span><span class="p">(</span>
            <span class="n">custom_simbad</span><span class="o">.</span><span class="n">query_region</span><span class="p">,</span>
            <span class="s2">&quot;SIMBAD query failed&quot;</span><span class="p">,</span>
            <span class="n">center_coord</span><span class="p">,</span>
            <span class="n">radius</span><span class="o">=</span><span class="n">field_width_arcmin</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcmin</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">simbad_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">simbad_result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;simbad_main_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;simbad_otype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;simbad_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;simbad_B&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;simbad_V&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># Filter valid coordinates for SIMBAD matching</span>
                <span class="n">valid_final_coords</span> <span class="o">=</span> <span class="n">enhanced_table</span><span class="p">[</span><span class="n">valid_coords_mask</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_final_coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">source_coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
                        <span class="n">ra</span><span class="o">=</span><span class="n">valid_final_coords</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                        <span class="n">dec</span><span class="o">=</span><span class="n">valid_final_coords</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                        <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">simbad_result</span><span class="o">.</span><span class="n">colnames</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="s2">&quot;dec&quot;</span><span class="p">]):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># Filter out NaN coordinates in SIMBAD result</span>
                            <span class="n">simbad_valid_mask</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">simbad_result</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">])</span>
                                <span class="o">&amp;</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">simbad_result</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">])</span>
                                <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">simbad_result</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">])</span>
                                <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">simbad_result</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">])</span>
                            <span class="p">)</span>

                            <span class="k">if</span> <span class="ow">not</span> <span class="n">simbad_valid_mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                    <span class="s2">&quot;No SIMBAD sources with valid coordinates found&quot;</span>
                                <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">simbad_filtered</span> <span class="o">=</span> <span class="n">simbad_result</span><span class="p">[</span><span class="n">simbad_valid_mask</span><span class="p">]</span>

                                <span class="n">simbad_coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
                                    <span class="n">ra</span><span class="o">=</span><span class="n">simbad_filtered</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">],</span>
                                    <span class="n">dec</span><span class="o">=</span><span class="n">simbad_filtered</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">],</span>
                                    <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span>
                                <span class="p">)</span>

                                <span class="n">idx</span><span class="p">,</span> <span class="n">d2d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">source_coords</span><span class="o">.</span><span class="n">match_to_catalog_sky</span><span class="p">(</span>
                                    <span class="n">simbad_coords</span>
                                <span class="p">)</span>
                                <span class="n">matches</span> <span class="o">=</span> <span class="n">d2d</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>

                                <span class="c1"># Map matches back to the original table indices</span>
                                <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">valid_final_coords</span><span class="o">.</span><span class="n">index</span>

                                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">match_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                                    <span class="nb">zip</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
                                <span class="p">):</span>
                                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                                        <span class="n">original_idx</span> <span class="o">=</span> <span class="n">valid_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                        <span class="n">enhanced_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                                            <span class="n">original_idx</span><span class="p">,</span> <span class="s2">&quot;simbad_main_id&quot;</span>
                                        <span class="p">]</span> <span class="o">=</span> <span class="n">simbad_filtered</span><span class="p">[</span><span class="s2">&quot;main_id&quot;</span><span class="p">][</span><span class="n">match_idx</span><span class="p">]</span>
                                        <span class="n">enhanced_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                                            <span class="n">original_idx</span><span class="p">,</span> <span class="s2">&quot;simbad_otype&quot;</span>
                                        <span class="p">]</span> <span class="o">=</span> <span class="n">simbad_filtered</span><span class="p">[</span><span class="s2">&quot;otype&quot;</span><span class="p">][</span><span class="n">match_idx</span><span class="p">]</span>
                                        <span class="n">enhanced_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">original_idx</span><span class="p">,</span> <span class="s2">&quot;simbad_B&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                            <span class="n">simbad_filtered</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">][</span><span class="n">match_idx</span><span class="p">]</span>
                                        <span class="p">)</span>
                                        <span class="n">enhanced_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">original_idx</span><span class="p">,</span> <span class="s2">&quot;simbad_V&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                            <span class="n">simbad_filtered</span><span class="p">[</span><span class="s2">&quot;V&quot;</span><span class="p">][</span><span class="n">match_idx</span><span class="p">]</span>
                                        <span class="p">)</span>
                                        <span class="k">if</span> <span class="s2">&quot;ids&quot;</span> <span class="ow">in</span> <span class="n">simbad_filtered</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                                            <span class="n">enhanced_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                                                <span class="n">original_idx</span><span class="p">,</span> <span class="s2">&quot;simbad_ids&quot;</span>
                                            <span class="p">]</span> <span class="o">=</span> <span class="n">simbad_filtered</span><span class="p">[</span><span class="s2">&quot;ids&quot;</span><span class="p">][</span><span class="n">match_idx</span><span class="p">]</span>

                                <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span><span class="si">}</span><span class="s2"> SIMBAD objects in field.&quot;</span>
                                <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Error creating SkyCoord objects from SIMBAD data: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Available SIMBAD columns: </span><span class="si">{</span><span class="n">simbad_result</span><span class="o">.</span><span class="n">colnames</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">available_cols</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">simbad_result</span><span class="o">.</span><span class="n">colnames</span><span class="p">)</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;SIMBAD result missing required columns. Available columns: </span><span class="si">{</span><span class="n">available_cols</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No valid coordinates available for SIMBAD matching&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No SIMBAD objects found in the field.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SIMBAD query execution failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field_center_ra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">field_center_dec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;DATE-OBS&quot;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="n">obs_date</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;DATE-OBS&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s2">&quot;DATE&quot;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="n">obs_date</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obs_date</span> <span class="o">=</span> <span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isot</span>

            <span class="n">obs_time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">obs_date</span><span class="p">)</span><span class="o">.</span><span class="n">isot</span>

            <span class="n">sr_value</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">field_width_arcmin</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">skybot_url</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;http://vo.imcce.fr/webservices/skybot/skybotconesearch_query.php?&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;RA=</span><span class="si">{</span><span class="n">field_center_ra</span><span class="si">}</span><span class="s2">&amp;DEC=</span><span class="si">{</span><span class="n">field_center_dec</span><span class="si">}</span><span class="s2">&amp;SR=</span><span class="si">{</span><span class="n">sr_value</span><span class="si">}</span><span class="s2">&amp;&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;EPOCH=</span><span class="si">{</span><span class="n">quote</span><span class="p">(</span><span class="n">obs_time</span><span class="p">)</span><span class="si">}</span><span class="s2">&amp;mime=json&quot;</span>
            <span class="p">)</span>

            <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Querying SkyBoT for solar system objects...&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;skybot_NAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;skybot_OBJECT_TYPE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;skybot_MAGV&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">skybot_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="n">response_text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">response_text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">response_text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">skybot_result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

                            <span class="k">if</span> <span class="s2">&quot;data&quot;</span> <span class="ow">in</span> <span class="n">skybot_result</span> <span class="ow">and</span> <span class="n">skybot_result</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]:</span>
                                <span class="n">skybot_coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
                                    <span class="n">ra</span><span class="o">=</span><span class="p">[</span>
                                        <span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;RA&quot;</span><span class="p">])</span>
                                        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">skybot_result</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
                                    <span class="p">],</span>
                                    <span class="n">dec</span><span class="o">=</span><span class="p">[</span>
                                        <span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;DEC&quot;</span><span class="p">])</span>
                                        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">skybot_result</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
                                    <span class="p">],</span>
                                    <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                                <span class="p">)</span>

                                <span class="c1"># Filter valid coordinates for SkyBoT matching</span>
                                <span class="n">valid_final_coords</span> <span class="o">=</span> <span class="n">enhanced_table</span><span class="p">[</span><span class="n">valid_coords_mask</span><span class="p">]</span>

                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_final_coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="c1"># Create source coordinates for matching</span>
                                    <span class="n">source_coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
                                        <span class="n">ra</span><span class="o">=</span><span class="n">valid_final_coords</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">],</span>
                                        <span class="n">dec</span><span class="o">=</span><span class="n">valid_final_coords</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">],</span>
                                        <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                                    <span class="p">)</span>

                                    <span class="c1"># Perform cross-matching</span>
                                    <span class="n">idx</span><span class="p">,</span> <span class="n">d2d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">source_coords</span><span class="o">.</span><span class="n">match_to_catalog_3d</span><span class="p">(</span>
                                        <span class="n">skybot_coords</span>
                                    <span class="p">)</span>
                                    <span class="n">matches</span> <span class="o">=</span> <span class="n">d2d</span><span class="o">.</span><span class="n">arcsec</span> <span class="o">&lt;=</span> <span class="mi">10</span>

                                    <span class="c1"># Add matched solar system object information to the final table</span>
                                    <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;skybot_NAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;skybot_OBJECT_TYPE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;skybot_MAGV&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                                    <span class="c1"># Initialize catalog_matches column if it doesn&#39;t exist</span>
                                    <span class="k">if</span> <span class="s2">&quot;catalog_matches&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">enhanced_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                                        <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;catalog_matches&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                                    <span class="c1"># Map matches back to the original table indices</span>
                                    <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">valid_final_coords</span><span class="o">.</span><span class="n">index</span>
                                    <span class="n">matched_sources</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">matches</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="n">matched_skybots</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="n">matches</span><span class="p">]</span>

                                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">skybot_idx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                                        <span class="n">matched_sources</span><span class="p">,</span> <span class="n">matched_skybots</span>
                                    <span class="p">):</span>
                                        <span class="n">original_idx</span> <span class="o">=</span> <span class="n">valid_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                        <span class="n">enhanced_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                                            <span class="n">original_idx</span><span class="p">,</span> <span class="s2">&quot;skybot_NAME&quot;</span>
                                        <span class="p">]</span> <span class="o">=</span> <span class="n">skybot_result</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="n">skybot_idx</span><span class="p">][</span><span class="s2">&quot;NAME&quot;</span><span class="p">]</span>
                                        <span class="n">enhanced_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                                            <span class="n">original_idx</span><span class="p">,</span> <span class="s2">&quot;skybot_OBJECT_TYPE&quot;</span>
                                        <span class="p">]</span> <span class="o">=</span> <span class="n">skybot_result</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="n">skybot_idx</span><span class="p">][</span>
                                            <span class="s2">&quot;OBJECT_TYPE&quot;</span>
                                        <span class="p">]</span>
                                        <span class="n">enhanced_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                                            <span class="n">original_idx</span><span class="p">,</span> <span class="s2">&quot;skybot_MAGV&quot;</span>
                                        <span class="p">]</span> <span class="o">=</span> <span class="n">skybot_result</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="n">skybot_idx</span><span class="p">][</span><span class="s2">&quot;MAGV&quot;</span><span class="p">]</span>

                                    <span class="c1"># Update the catalog_matches column for matched solar system objects</span>
                                    <span class="n">has_skybot</span> <span class="o">=</span> <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;skybot_NAME&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
                                    <span class="n">enhanced_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                                        <span class="n">has_skybot</span><span class="p">,</span> <span class="s2">&quot;catalog_matches&quot;</span>
                                    <span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;SkyBoT; &quot;</span>

                                    <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                                        <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">has_skybot</span><span class="p">)</span><span class="si">}</span><span class="s2"> solar system objects in field.&quot;</span>
                                    <span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                        <span class="s2">&quot;No valid coordinates available for SkyBoT matching&quot;</span>
                                    <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                    <span class="s2">&quot;No solar system objects found in the field.&quot;</span>
                                <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;No solar system objects found (no valid JSON data returned). </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No solar system objects found in the field.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;SkyBoT query failed with status code </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">req_err</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request to SkyBoT failed: </span><span class="si">{</span><span class="n">req_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not determine field center for SkyBoT query&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in SkyBoT processing: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Querying AAVSO VSX for variable stars...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field_center_ra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">field_center_dec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Vizier</span><span class="o">.</span><span class="n">ROW_LIMIT</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">vizier_result</span> <span class="o">=</span> <span class="n">Vizier</span><span class="o">.</span><span class="n">query_region</span><span class="p">(</span>
                <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">field_center_ra</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">field_center_dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span>
                <span class="n">radius</span><span class="o">=</span><span class="n">field_width_arcmin</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcmin</span><span class="p">,</span>
                <span class="n">catalog</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;B/vsx/vsx&quot;</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">vizier_result</span>
                <span class="ow">and</span> <span class="s2">&quot;B/vsx/vsx&quot;</span> <span class="ow">in</span> <span class="n">vizier_result</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">vizier_result</span><span class="p">[</span><span class="s2">&quot;B/vsx/vsx&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="n">vsx_table</span> <span class="o">=</span> <span class="n">vizier_result</span><span class="p">[</span><span class="s2">&quot;B/vsx/vsx&quot;</span><span class="p">]</span>

                <span class="n">vsx_coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
                    <span class="n">ra</span><span class="o">=</span><span class="n">vsx_table</span><span class="p">[</span><span class="s2">&quot;RAJ2000&quot;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">vsx_table</span><span class="p">[</span><span class="s2">&quot;DEJ2000&quot;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span>
                <span class="p">)</span>

                <span class="c1"># Filter valid coordinates for AAVSO matching</span>
                <span class="n">valid_final_coords</span> <span class="o">=</span> <span class="n">enhanced_table</span><span class="p">[</span><span class="n">valid_coords_mask</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_final_coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">source_coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
                        <span class="n">ra</span><span class="o">=</span><span class="n">valid_final_coords</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                        <span class="n">dec</span><span class="o">=</span><span class="n">valid_final_coords</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                        <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="n">idx</span><span class="p">,</span> <span class="n">d2d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">source_coords</span><span class="o">.</span><span class="n">match_to_catalog_sky</span><span class="p">(</span><span class="n">vsx_coords</span><span class="p">)</span>
                    <span class="n">matches</span> <span class="o">=</span> <span class="n">d2d</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>

                    <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;aavso_Name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;aavso_Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;aavso_Period&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="c1"># Map matches back to the original table indices</span>
                    <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">valid_final_coords</span><span class="o">.</span><span class="n">index</span>

                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">match_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">idx</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                            <span class="n">original_idx</span> <span class="o">=</span> <span class="n">valid_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="n">enhanced_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">original_idx</span><span class="p">,</span> <span class="s2">&quot;aavso_Name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vsx_table</span><span class="p">[</span>
                                <span class="s2">&quot;Name&quot;</span>
                            <span class="p">][</span><span class="n">match_idx</span><span class="p">]</span>
                            <span class="n">enhanced_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">original_idx</span><span class="p">,</span> <span class="s2">&quot;aavso_Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vsx_table</span><span class="p">[</span>
                                <span class="s2">&quot;Type&quot;</span>
                            <span class="p">][</span><span class="n">match_idx</span><span class="p">]</span>
                            <span class="n">enhanced_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">original_idx</span><span class="p">,</span> <span class="s2">&quot;aavso_Period&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">vsx_table</span><span class="p">[</span><span class="s2">&quot;Period&quot;</span><span class="p">][</span><span class="n">match_idx</span><span class="p">]</span>
                            <span class="p">)</span>

                    <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span><span class="si">}</span><span class="s2"> variable stars in field.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No valid coordinates available for AAVSO matching&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No variable stars found in the field.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error querying AAVSO VSX: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Querying Milliquas Catalog for quasars...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field_center_ra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">field_center_dec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Set columns to retrieve from the quasar catalog</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">Vizier</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;RAJ2000&quot;</span><span class="p">,</span> <span class="s2">&quot;DEJ2000&quot;</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;Rmag&quot;</span><span class="p">])</span>
            <span class="n">v</span><span class="o">.</span><span class="n">ROW_LIMIT</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># No row limit</span>

            <span class="c1"># Query the VII/294 catalog around the field center</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">query_region</span><span class="p">(</span>
                <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">field_center_ra</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">field_center_dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)),</span>
                <span class="n">width</span><span class="o">=</span><span class="n">field_width_arcmin</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcmin</span><span class="p">,</span>
                <span class="n">catalog</span><span class="o">=</span><span class="s2">&quot;VII/294&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">result</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">qso_table</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># Convert to pandas DataFrame for easier matching</span>
                <span class="n">qso_df</span> <span class="o">=</span> <span class="n">qso_table</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
                <span class="n">qso_coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
                    <span class="n">ra</span><span class="o">=</span><span class="n">qso_df</span><span class="p">[</span><span class="s2">&quot;RAJ2000&quot;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">qso_df</span><span class="p">[</span><span class="s2">&quot;DEJ2000&quot;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span>
                <span class="p">)</span>

                <span class="c1"># Filter valid coordinates for QSO matching</span>
                <span class="n">valid_final_coords</span> <span class="o">=</span> <span class="n">enhanced_table</span><span class="p">[</span><span class="n">valid_coords_mask</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_final_coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Create source coordinates for matching</span>
                    <span class="n">source_coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
                        <span class="n">ra</span><span class="o">=</span><span class="n">valid_final_coords</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">],</span>
                        <span class="n">dec</span><span class="o">=</span><span class="n">valid_final_coords</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">],</span>
                        <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="c1"># Perform cross-matching</span>
                    <span class="n">idx</span><span class="p">,</span> <span class="n">d2d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">source_coords</span><span class="o">.</span><span class="n">match_to_catalog_3d</span><span class="p">(</span><span class="n">qso_coords</span><span class="p">)</span>
                    <span class="n">matches</span> <span class="o">=</span> <span class="n">d2d</span><span class="o">.</span><span class="n">arcsec</span> <span class="o">&lt;=</span> <span class="mi">10</span>

                    <span class="c1"># Add matched quasar information to the final table</span>
                    <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;qso_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;qso_redshift&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;qso_Rmag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="c1"># Initialize catalog_matches column if it doesn&#39;t exist</span>
                    <span class="k">if</span> <span class="s2">&quot;catalog_matches&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">enhanced_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;catalog_matches&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                    <span class="c1"># Map matches back to the original table indices</span>
                    <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">valid_final_coords</span><span class="o">.</span><span class="n">index</span>
                    <span class="n">matched_sources</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">matches</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">matched_qsos</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="n">matches</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">qso_idx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">matched_sources</span><span class="p">,</span> <span class="n">matched_qsos</span><span class="p">):</span>
                        <span class="n">original_idx</span> <span class="o">=</span> <span class="n">valid_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">enhanced_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">original_idx</span><span class="p">,</span> <span class="s2">&quot;qso_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qso_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span>
                            <span class="n">qso_idx</span>
                        <span class="p">][</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span>
                        <span class="n">enhanced_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">original_idx</span><span class="p">,</span> <span class="s2">&quot;qso_redshift&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qso_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span>
                            <span class="n">qso_idx</span>
                        <span class="p">][</span><span class="s2">&quot;z&quot;</span><span class="p">]</span>
                        <span class="n">enhanced_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">original_idx</span><span class="p">,</span> <span class="s2">&quot;qso_Rmag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qso_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span>
                            <span class="n">qso_idx</span>
                        <span class="p">][</span><span class="s2">&quot;Rmag&quot;</span><span class="p">]</span>

                    <span class="c1"># Update the catalog_matches column for matched quasars</span>
                    <span class="n">has_qso</span> <span class="o">=</span> <span class="n">enhanced_table</span><span class="p">[</span><span class="s2">&quot;qso_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
                    <span class="n">enhanced_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">has_qso</span><span class="p">,</span> <span class="s2">&quot;catalog_matches&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;QSO; &quot;</span>

                    <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">has_qso</span><span class="p">)</span><span class="si">}</span><span class="s2"> quasars in field from Milliquas catalog.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">write_to_log</span><span class="p">(</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;log_buffer&quot;</span><span class="p">),</span>
                        <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">has_qso</span><span class="p">)</span><span class="si">}</span><span class="s2"> quasar matches in Milliquas catalog&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No valid coordinates available for QSO matching&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No quasars found in field from Milliquas catalog.&quot;</span><span class="p">)</span>
                <span class="n">write_to_log</span><span class="p">(</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;log_buffer&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;No quasars found in field from Milliquas catalog&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
                <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error querying VizieR Milliquas: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">write_to_log</span><span class="p">(</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;log_buffer&quot;</span><span class="p">),</span>
            <span class="sa">f</span><span class="s2">&quot;Error in Milliquas catalog processing: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ERROR&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">enhanced_table</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">validate_wcs_orientation</span><span class="p">(</span><span class="n">original_header</span><span class="p">,</span> <span class="n">solved_header</span><span class="p">,</span> <span class="n">test_pixel_coords</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate that WCS transformation preserves expected orientation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">orig_wcs</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">original_header</span><span class="p">)</span>
        <span class="n">solved_wcs</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">solved_header</span><span class="p">)</span>

        <span class="c1"># Test a few pixel positions</span>
        <span class="n">orig_sky</span> <span class="o">=</span> <span class="n">orig_wcs</span><span class="o">.</span><span class="n">pixel_to_world_values</span><span class="p">(</span>
            <span class="n">test_pixel_coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">test_pixel_coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">solved_sky</span> <span class="o">=</span> <span class="n">solved_wcs</span><span class="o">.</span><span class="n">pixel_to_world_values</span><span class="p">(</span>
            <span class="n">test_pixel_coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">test_pixel_coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Check if coordinates are consistent (within reasonable tolerance)</span>
        <span class="n">ra_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">orig_sky</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">solved_sky</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">dec_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">orig_sky</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">solved_sky</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ra_diff</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">dec_diff</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">):</span>  <span class="c1"># 0.1 degree tolerance</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;WCS orientation may have changed during plate solving&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not validate WCS orientation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># Assume OK if validation fails</span>


<span class="k">def</span><span class="w"> </span><span class="nf">validate_cross_match_results</span><span class="p">(</span><span class="n">phot_table</span><span class="p">,</span> <span class="n">matched_table</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate that cross-matching results make sense</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_table</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Check if matched sources are distributed across the field</span>
    <span class="c1"># (not clustered in one corner, which might indicate flipping)</span>
    <span class="n">ra_range</span> <span class="o">=</span> <span class="n">matched_table</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">matched_table</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">dec_range</span> <span class="o">=</span> <span class="n">matched_table</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">matched_table</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

    <span class="c1"># Expect some reasonable spread for a real field</span>
    <span class="k">if</span> <span class="n">ra_range</span> <span class="o">&lt;</span> <span class="mf">0.001</span> <span class="ow">or</span> <span class="n">dec_range</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span>  <span class="c1"># Less than ~4 arcsec</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Matched sources seem too clustered - possible coordinate issue&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Check separation distribution</span>
    <span class="n">separations</span> <span class="o">=</span> <span class="n">matched_table</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gaia_separation_arcsec&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">separations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">median_sep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">separations</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">median_sep</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># More than 10 arcsec median separation</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Large median separation (</span><span class="si">{</span><span class="n">median_sep</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">) suggests coordinate problems&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_field_center_coordinates</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Consistently extract field center coordinates with priority order</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Priority order for coordinate keywords</span>
    <span class="n">coord_keywords</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;CRVAL1&quot;</span><span class="p">,</span> <span class="s2">&quot;CRVAL2&quot;</span><span class="p">),</span>  <span class="c1"># Standard WCS</span>
        <span class="p">(</span><span class="s2">&quot;RA&quot;</span><span class="p">,</span> <span class="s2">&quot;DEC&quot;</span><span class="p">),</span>  <span class="c1"># Common telescope keywords</span>
        <span class="p">(</span><span class="s2">&quot;OBJRA&quot;</span><span class="p">,</span> <span class="s2">&quot;OBJDEC&quot;</span><span class="p">),</span>  <span class="c1"># Object coordinates</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">ra_key</span><span class="p">,</span> <span class="n">dec_key</span> <span class="ow">in</span> <span class="n">coord_keywords</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ra_key</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="n">dec_key</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ra</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="n">ra_key</span><span class="p">])</span>
                <span class="n">dec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="n">dec_key</span><span class="p">])</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">ra</span> <span class="o">&lt;=</span> <span class="mi">360</span> <span class="ow">and</span> <span class="o">-</span><span class="mi">90</span> <span class="o">&lt;=</span> <span class="n">dec</span> <span class="o">&lt;=</span> <span class="mi">90</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="k">continue</span>

    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024-2025, Pier-Francesco Rocci.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>