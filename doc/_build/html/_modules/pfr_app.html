

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pfr_app &mdash; Photometry Factory for RAPAS 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=01f34227"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Photometry Factory for RAPAS
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">Basic Workflow Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html#advanced-use-cases">Advanced Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_reference.html">Core Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_reference.html#image-processing">Image Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_reference.html#photometry">Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_reference.html#utilities">Utilities</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Photometry Factory for RAPAS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">pfr_app</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pfr_app</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">SkyCoord</span><span class="p">,</span> <span class="n">EarthLocation</span><span class="p">,</span> <span class="n">AltAz</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.time</span><span class="w"> </span><span class="kn">import</span> <span class="n">Time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_sun</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astroquery.simbad</span><span class="w"> </span><span class="kn">import</span> <span class="n">Simbad</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astroquery.vizier</span><span class="w"> </span><span class="kn">import</span> <span class="n">Vizier</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">quote</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.modeling</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">fitting</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">streamlit</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">st</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">sigma_clip</span><span class="p">,</span> <span class="n">SigmaClip</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.units</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">u</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astroquery.gaia</span><span class="w"> </span><span class="kn">import</span> <span class="n">Gaia</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.detection</span><span class="w"> </span><span class="kn">import</span> <span class="n">DAOStarFinder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.aperture</span><span class="w"> </span><span class="kn">import</span> <span class="n">CircularAperture</span><span class="p">,</span> <span class="n">aperture_photometry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.background</span><span class="w"> </span><span class="kn">import</span> <span class="n">Background2D</span><span class="p">,</span> <span class="n">SExtractorBackground</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">ZScaleInterval</span><span class="p">,</span> <span class="n">ImageNormalize</span><span class="p">,</span> <span class="n">simple_norm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">StringIO</span><span class="p">,</span> <span class="n">BytesIO</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.wcs</span><span class="w"> </span><span class="kn">import</span> <span class="n">WCS</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.psf</span><span class="w"> </span><span class="kn">import</span> <span class="n">EPSFBuilder</span><span class="p">,</span> <span class="n">extract_stars</span><span class="p">,</span> <span class="n">IterativePSFPhotometry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.nddata</span><span class="w"> </span><span class="kn">import</span> <span class="n">NDData</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">stdpipe</span><span class="w"> </span><span class="kn">import</span> <span class="n">astrometry</span><span class="p">,</span> <span class="n">catalogs</span><span class="p">,</span> <span class="n">pipeline</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>


<span class="n">st</span><span class="o">.</span><span class="n">set_page_config</span><span class="p">(</span>
    <span class="n">page_title</span><span class="o">=</span><span class="s2">&quot;Photometry Factory for RAPAS&quot;</span><span class="p">,</span>
    <span class="n">page_icon</span><span class="o">=</span><span class="s2">&quot;ðŸ”­&quot;</span><span class="p">,</span>
    <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;wide&quot;</span>
<span class="p">)</span>

<span class="c1"># Custom CSS to control plot display size</span>
<span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;style&gt;</span>
<span class="s2">    .stPlot &gt; div {</span>
<span class="s2">        display: flex;</span>
<span class="s2">        justify-content: center;</span>
<span class="s2">        min-height: 400px;</span>
<span class="s2">    }</span>
<span class="s2">    .main .block-container {</span>
<span class="s2">        max-width: 1200px;</span>
<span class="s2">        padding-top: 2rem;</span>
<span class="s2">        padding-bottom: 2rem;</span>
<span class="s2">    }</span>
<span class="s2">    .element-container img {</span>
<span class="s2">        max-width: 100% !important;</span>
<span class="s2">        height: auto !important;</span>
<span class="s2">    }</span>
<span class="s2">&lt;/style&gt;</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">unsafe_allow_html</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Define standard figure sizes to use throughout the app</span>
<span class="n">FIGURE_SIZES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>     <span class="c1"># For small plots</span>
    <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>    <span class="c1"># For medium plots</span>
    <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>    <span class="c1"># For large plots</span>
    <span class="s1">&#39;wide&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>    <span class="c1"># For wide plots</span>
    <span class="s1">&#39;stars_grid&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>  <span class="c1"># For grid of stars</span>
<span class="p">}</span>

<div class="viewcode-block" id="solve_with_astrometry_net">
<a class="viewcode-back" href="../api_reference.html#pfr_app.solve_with_astrometry_net">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">solve_with_astrometry_net</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Solve plate using the astrometry.net API.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image_data : numpy.ndarray</span>
<span class="sd">        The image data to solve</span>
<span class="sd">    header : dict, optional</span>
<span class="sd">        FITS header with any available metadata to help the solver</span>
<span class="sd">    api_key : str, optional</span>
<span class="sd">        Astrometry.net API key. If not provided, will look in environment variables.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (wcs_object, updated_header, status_message)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Import required libraries</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">astroquery.astrometry_net</span><span class="w"> </span><span class="kn">import</span> <span class="n">AstrometryNetClass</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
        
        <span class="c1"># Get API key from environment if not provided</span>
        <span class="k">if</span> <span class="n">api_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="s2">&quot;cnolwaeoasefkoka&quot;</span>  <span class="c1"># Default API key for testing purposes</span>
            <span class="k">if</span> <span class="n">api_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="s2">&quot;No API key provided or found in environment variables&quot;</span>
        
        <span class="c1"># Initialize AstrometryNet client</span>
        <span class="n">ast</span> <span class="o">=</span> <span class="n">AstrometryNetClass</span><span class="p">()</span>
        <span class="n">ast</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        
        <span class="c1"># Extract metadata to help with solving</span>
        <span class="n">solve_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># If we have coordinates and scale in header, use them to narrow down search</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Extract RA/DEC if available</span>
            <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">extract_coordinates</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">solve_kwargs</span><span class="p">[</span><span class="s1">&#39;center_ra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ra</span>
                <span class="n">solve_kwargs</span><span class="p">[</span><span class="s1">&#39;center_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dec</span>
                <span class="n">solve_kwargs</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Search radius in degrees</span>
                
            <span class="c1"># Extract pixel scale if available</span>
            <span class="n">scale</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">extract_pixel_scale</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scale</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># astrometry.net expects scale range in arcsec/pixel</span>
                <span class="n">solve_kwargs</span><span class="p">[</span><span class="s1">&#39;scale_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="mf">0.8</span>
                <span class="n">solve_kwargs</span><span class="p">[</span><span class="s1">&#39;scale_upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="mf">1.2</span>
        
        <span class="c1"># Send the image to astrometry.net</span>
        <span class="n">try_idx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">max_tries</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">wcs_header</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">while</span> <span class="n">try_idx</span> <span class="o">&lt;=</span> <span class="n">max_tries</span> <span class="ow">and</span> <span class="n">wcs_header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="kc">None</span>
                
                <span class="c1"># Write image to temporary FITS file</span>
                <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">file_path</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">image_data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">())</span>
                    <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Submit the job to astrometry.net</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Submitting image to astrometry.net (attempt </span><span class="si">{</span><span class="n">try_idx</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">max_tries</span><span class="si">}</span><span class="s2">)...&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># First try with a file upload</span>
                    <span class="n">wcs_header</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">solve_from_image</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="o">**</span><span class="n">solve_kwargs</span><span class="p">)</span>
                    
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error with file upload: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">. Trying with image data directly...&quot;</span><span class="p">)</span>
                    <span class="c1"># If file upload fails, try with image data directly</span>
                    <span class="n">wcs_header</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">solve_from_image</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="o">**</span><span class="n">solve_kwargs</span><span class="p">)</span>
                
                <span class="c1"># Clean up temporary file</span>
                <span class="k">if</span> <span class="n">file_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">try_idx</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Astrometry.net attempt </span><span class="si">{</span><span class="n">try_idx</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Wait before retrying</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">wcs_header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Astrometry.net failed after </span><span class="si">{</span><span class="n">max_tries</span><span class="si">}</span><span class="s2"> attempts&quot;</span>
        
        <span class="c1"># Create WCS object from the returned header</span>
        <span class="n">wcs_obj</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">wcs_header</span><span class="p">)</span>
        
        <span class="c1"># Update the original header with WCS information</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span>
            
        <span class="c1"># Add WCS keywords to the header</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">wcs_header</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;SIMPLE&#39;</span><span class="p">,</span> <span class="s1">&#39;BITPIX&#39;</span><span class="p">,</span> <span class="s1">&#39;NAXIS&#39;</span><span class="p">,</span> <span class="s1">&#39;NAXIS1&#39;</span><span class="p">,</span> <span class="s1">&#39;NAXIS2&#39;</span><span class="p">,</span> <span class="s1">&#39;EXTEND&#39;</span><span class="p">]:</span>
                <span class="c1"># Skip these structural keywords</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;HISTORY&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="c1"># Add the WCS keyword to our header</span>
            <span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        
        <span class="c1"># Also add information that this WCS came from astrometry.net</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;ASTRSRC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;astrometry.net&#39;</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;ASTRTRY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">try_idx</span>
        
        <span class="k">return</span> <span class="n">wcs_obj</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="s2">&quot;Astrometry.net solution successful&quot;</span>
    
    <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Required packages not installed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Error solving with astrometry.net: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span></div>



<div class="viewcode-block" id="ensure_output_directory">
<a class="viewcode-back" href="../api_reference.html#pfr_app.ensure_output_directory">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ensure_output_directory</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s2">&quot;pfr_results&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensure the output directory exists, create it if needed.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    directory : str</span>
<span class="sd">        Name of the directory to create</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Path to the output directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create directory if it doesn&#39;t exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">directory</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not create directory &#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;.&quot;</span>  <span class="c1"># Fallback to current directory</span>
    <span class="k">return</span> <span class="n">directory</span></div>


<div class="viewcode-block" id="safe_wcs_create">
<a class="viewcode-back" href="../api_reference.html#pfr_app.safe_wcs_create">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">safe_wcs_create</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Safely create a WCS object from a FITS header with proper error handling.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    header : dict</span>
<span class="sd">        FITS header</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (wcs_object, None) if successful, (None, error_message) if failed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">header</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;No header provided&quot;</span>
    
    <span class="c1"># Check if header contains minimum required WCS keywords</span>
    <span class="n">required_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">,</span> <span class="s1">&#39;CTYPE2&#39;</span><span class="p">,</span> <span class="s1">&#39;CRVAL1&#39;</span><span class="p">,</span> <span class="s1">&#39;CRVAL2&#39;</span><span class="p">,</span> <span class="s1">&#39;CRPIX1&#39;</span><span class="p">,</span> <span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span>
    <span class="n">missing_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">required_keys</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">missing_keys</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Missing required WCS keywords: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_keys</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">wcs_obj</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        
        <span class="c1"># Check if WCS is valid</span>
        <span class="k">if</span> <span class="n">wcs_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;WCS creation returned None&quot;</span>
            
        <span class="c1"># Check dimensionality</span>
        <span class="k">if</span> <span class="n">wcs_obj</span><span class="o">.</span><span class="n">pixel_n_dim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># Reduce to celestial coordinates only</span>
            <span class="n">wcs_obj</span> <span class="o">=</span> <span class="n">wcs_obj</span><span class="o">.</span><span class="n">celestial</span>
            
        <span class="c1"># Verify WCS has actual transformation</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">wcs_obj</span><span class="p">,</span> <span class="s1">&#39;wcs&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Created WCS object has no transformation attributes&quot;</span>
        
        <span class="k">return</span> <span class="n">wcs_obj</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;WCS creation error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="estimate_background">
<a class="viewcode-back" href="../api_reference.html#pfr_app.estimate_background">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">estimate_background</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">box_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">filter_size</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Robustly estimate image background with better error handling.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image_data : numpy.ndarray</span>
<span class="sd">        The science image data</span>
<span class="sd">    box_size : int, optional</span>
<span class="sd">        The box size for Background2D</span>
<span class="sd">    filter_size : int, optional</span>
<span class="sd">        The filter size for Background2D</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (background_2d_object, error_message)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">image_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;No image data provided&quot;</span>
        
    <span class="c1"># Validate image dimensionality</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Image data must be a numpy array, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Image must be 2D, got shape </span><span class="si">{</span><span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
        
    <span class="c1"># If image is too small, adjust box size</span>
    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">image_data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">adjusted_box_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">box_size</span><span class="p">,</span> <span class="n">height</span> <span class="o">//</span> <span class="mi">4</span><span class="p">,</span> <span class="n">width</span> <span class="o">//</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">adjusted_filter_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">filter_size</span><span class="p">,</span> <span class="n">adjusted_box_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">adjusted_box_size</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Image too small (</span><span class="si">{</span><span class="n">height</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s2">) for background estimation&quot;</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sigma_clip</span> <span class="o">=</span> <span class="n">SigmaClip</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">bkg_estimator</span> <span class="o">=</span> <span class="n">SExtractorBackground</span><span class="p">()</span>
        
        <span class="n">bkg</span> <span class="o">=</span> <span class="n">Background2D</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">image_data</span><span class="p">,</span>
            <span class="n">box_size</span><span class="o">=</span><span class="n">adjusted_box_size</span><span class="p">,</span>
            <span class="n">filter_size</span><span class="o">=</span><span class="n">adjusted_filter_size</span><span class="p">,</span>
            <span class="n">sigma_clip</span><span class="o">=</span><span class="n">sigma_clip</span><span class="p">,</span>
            <span class="n">bkg_estimator</span><span class="o">=</span><span class="n">bkg_estimator</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">bkg</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Background estimation error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span></div>



<div class="viewcode-block" id="get_header_value">
<a class="viewcode-back" href="../api_reference.html#pfr_app.get_header_value">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_header_value</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Robustly extract a header value trying multiple potential keys.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    header : dict</span>
<span class="sd">        The FITS header dictionary</span>
<span class="sd">    keys : list</span>
<span class="sd">        List of possible keys to try in order of preference</span>
<span class="sd">    default : any</span>
<span class="sd">        Default value to return if no keys are found</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    any</span>
<span class="sd">        The header value or default if not found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default</span>
        
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">default</span></div>


<div class="viewcode-block" id="extract_pixel_scale">
<a class="viewcode-back" href="../api_reference.html#pfr_app.extract_pixel_scale">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_pixel_scale</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract pixel scale from FITS header using multiple possible keywords.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    header : dict</span>
<span class="sd">        FITS header</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (pixel_scale_value, source_description)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;default (no header)&quot;</span>
    
    <span class="c1"># Try direct pixel scale keywords</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PIXSIZE&#39;</span><span class="p">,</span> <span class="s1">&#39;PIXSCALE&#39;</span><span class="p">,</span> <span class="s1">&#39;PIXELSCAL&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="c1"># Try WCS CDELT keywords</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">,</span> <span class="s1">&#39;CDELT1&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">*</span> <span class="mf">3600.0</span>
            <span class="k">return</span> <span class="n">scale</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="c1"># Try calculating from physical pixel size and focal length</span>
    <span class="k">if</span> <span class="s1">&#39;XPIXSZ&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
        <span class="c1"># Check if we have a focal length</span>
        <span class="k">if</span> <span class="s1">&#39;FOCALLEN&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">focal_length_mm</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;FOCALLEN&#39;</span><span class="p">]</span>
            <span class="n">pixel_size</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;XPIXSZ&#39;</span><span class="p">]</span>
            
            <span class="c1"># Check unit of XPIXSZ</span>
            <span class="n">xpixsz_unit</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;XPIXSZU&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">xpixsz_unit</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;arcsec&#39;</span><span class="p">,</span> <span class="s1">&#39;as&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="s2">&quot;from XPIXSZ (in arcsec)&quot;</span>
            <span class="k">elif</span> <span class="n">xpixsz_unit</span> <span class="o">==</span> <span class="s1">&#39;mm&#39;</span><span class="p">:</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">pixel_size</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">focal_length_mm</span> <span class="o">*</span> <span class="mf">206.265</span>
                <span class="k">return</span> <span class="n">scale</span><span class="p">,</span> <span class="s2">&quot;calculated from XPIXSZ (mm) and FOCALLEN&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Assume microns</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="n">pixel_size</span> <span class="o">/</span> <span class="n">focal_length_mm</span> <span class="o">*</span> <span class="mf">206.265</span>
                <span class="k">return</span> <span class="n">scale</span><span class="p">,</span> <span class="s2">&quot;calculated from XPIXSZ (Î¼m) and FOCALLEN&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Assume XPIXSZ is already in arcsec if no FOCALLEN</span>
            <span class="k">return</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;XPIXSZ&#39;</span><span class="p">],</span> <span class="s2">&quot;from XPIXSZ (assumed arcsec)&quot;</span>
            
    <span class="c1"># Default fallback</span>
    <span class="k">return</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;default fallback value&quot;</span></div>


<div class="viewcode-block" id="extract_coordinates">
<a class="viewcode-back" href="../api_reference.html#pfr_app.extract_coordinates">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_coordinates</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract RA and DEC coordinates from FITS header.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    header : dict</span>
<span class="sd">        FITS header dictionary</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (ra, dec, source_description) or (None, None, error_message)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;No header available&quot;</span>
    
    <span class="c1"># Try different coordinate keyword combinations</span>
    <span class="n">ra_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">,</span> <span class="s1">&#39;OBJRA&#39;</span><span class="p">,</span> <span class="s1">&#39;RA---&#39;</span><span class="p">,</span> <span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span>
    <span class="n">dec_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">,</span> <span class="s1">&#39;OBJDEC&#39;</span><span class="p">,</span> <span class="s1">&#39;DEC---&#39;</span><span class="p">,</span> <span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span>
    
    <span class="n">ra</span> <span class="o">=</span> <span class="n">get_header_value</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">ra_keys</span><span class="p">)</span>
    <span class="n">dec</span> <span class="o">=</span> <span class="n">get_header_value</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">dec_keys</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">ra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Determine which keys were used</span>
        <span class="n">ra_source</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ra_keys</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">header</span><span class="p">),</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
        <span class="n">dec_source</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dec_keys</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">header</span><span class="p">),</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ra_source</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">dec_source</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="c1"># Validate coordinate ranges</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ra_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span>
            <span class="n">dec_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
            
            <span class="c1"># Apply basic validation</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mi">360</span> <span class="o">&lt;=</span> <span class="n">ra_val</span> <span class="o">&lt;=</span> <span class="mi">360</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Invalid RA value: </span><span class="si">{</span><span class="n">ra_val</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mi">90</span> <span class="o">&lt;=</span> <span class="n">dec_val</span> <span class="o">&lt;=</span> <span class="mi">90</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Invalid DEC value: </span><span class="si">{</span><span class="n">dec_val</span><span class="si">}</span><span class="s2">&quot;</span>
                
            <span class="k">return</span> <span class="n">ra_val</span><span class="p">,</span> <span class="n">dec_val</span><span class="p">,</span> <span class="n">source</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Non-numeric coordinates: RA=</span><span class="si">{</span><span class="n">ra</span><span class="si">}</span><span class="s2">, DEC=</span><span class="si">{</span><span class="n">dec</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Coordinates not found in header&quot;</span></div>


<div class="viewcode-block" id="safe_catalog_query">
<a class="viewcode-back" href="../api_reference.html#pfr_app.safe_catalog_query">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">safe_catalog_query</span><span class="p">(</span><span class="n">query_func</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Safely execute a catalog query with proper error handling.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    query_func : callable</span>
<span class="sd">        The function to call for the catalog query</span>
<span class="sd">    error_msg : str</span>
<span class="sd">        Base error message to display</span>
<span class="sd">    *args, **kwargs</span>
<span class="sd">        Arguments to pass to query_func</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (result, None) if successful, (None, error_message) if failed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">query_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">: Network error - </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">: Query timed out&quot;</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">: Value error - </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span></div>


<span class="c1"># Function to create standardized matplotlib figures</span>
<div class="viewcode-block" id="create_figure">
<a class="viewcode-back" href="../api_reference.html#pfr_app.create_figure">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_figure</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a matplotlib figure with standardized size&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">FIGURE_SIZES</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="n">FIGURE_SIZES</span><span class="p">[</span><span class="n">size</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="n">FIGURE_SIZES</span><span class="p">[</span><span class="s1">&#39;medium&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span></div>



<div class="viewcode-block" id="airmass">
<a class="viewcode-back" href="../api_reference.html#pfr_app.airmass">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">airmass</span><span class="p">(</span>
    <span class="n">_header</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">observatory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">return_details</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the airmass for a celestial object from header data</span>
<span class="sd">    and observatory information.</span>

<span class="sd">    This function handles multiple coordinate formats and performs</span>
<span class="sd">    physical validity checks on the results.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    _header : Dict</span>
<span class="sd">        FITS header or dictionary containing observation information.</span>
<span class="sd">        Must contain:</span>
<span class="sd">        - Coordinates (RA/DEC or OBJRA/OBJDEC)</span>
<span class="sd">        - Observation date (DATE-OBS)</span>
<span class="sd">    observatory : Dict, optional</span>
<span class="sd">        Information about the observatory. If not provided, uses the default (TJMS).</span>
<span class="sd">        Format:</span>
<span class="sd">        {</span>
<span class="sd">            &#39;name&#39;: str,           # Observatory name</span>
<span class="sd">            &#39;latitude&#39;: float,     # Latitude in degrees</span>
<span class="sd">            &#39;longitude&#39;: float,    # Longitude in degrees</span>
<span class="sd">            &#39;elevation&#39;: float     # Elevation in meters</span>
<span class="sd">        }</span>
<span class="sd">    return_details : bool, optional</span>
<span class="sd">        If True, returns additional information about the observation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Union[float, Tuple[float, Dict]]</span>
<span class="sd">        - If return_details=False: airmass (float)</span>
<span class="sd">        - If return_details=True: (airmass, observation_details)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Airmass is a measure of the amount of atmosphere traversed</span>
<span class="sd">    by the light from a celestial object. An airmass of 1 corresponds</span>
<span class="sd">    to an observation at zenith.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Default observatory (OHP)</span>
    <span class="n">DEFAULT_OBSERVATORY</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;TJMS&#39;</span><span class="p">,</span>
        <span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="mf">48.29166</span><span class="p">,</span>
        <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="mf">2.43805</span><span class="p">,</span>
        <span class="s1">&#39;elevation&#39;</span><span class="p">:</span> <span class="mf">94.0</span>
    <span class="p">}</span>

    <span class="c1"># Use the specified observatory or the default one</span>
    <span class="n">obs_data</span> <span class="o">=</span> <span class="n">observatory</span> <span class="ow">or</span> <span class="n">DEFAULT_OBSERVATORY</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Extract coordinates with handling of different formats</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="n">_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;RA&quot;</span><span class="p">,</span> <span class="n">_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OBJRA&quot;</span><span class="p">,</span> <span class="n">_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;RA---&quot;</span><span class="p">)))</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DEC&quot;</span><span class="p">,</span> <span class="n">_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OBJDEC&quot;</span><span class="p">,</span> <span class="n">_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DEC---&quot;</span><span class="p">)))</span>
        <span class="n">obstime_str</span> <span class="o">=</span> <span class="n">_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DATE-OBS&quot;</span><span class="p">,</span> <span class="n">_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DATE&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">obstime_str</span><span class="p">]):</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">ra</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;RA&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;DEC&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obstime_str</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;DATE-OBS&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required header keywords: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Convert coordinates and create SkyCoord object</span>
        <span class="n">coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">)</span>

        <span class="c1"># Create Time object</span>
        <span class="n">obstime</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">obstime_str</span><span class="p">)</span>

        <span class="c1"># Create EarthLocation object for the observatory</span>
        <span class="n">location</span> <span class="o">=</span> <span class="n">EarthLocation</span><span class="p">(</span>
            <span class="n">lat</span><span class="o">=</span><span class="n">obs_data</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
            <span class="n">lon</span><span class="o">=</span><span class="n">obs_data</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="n">obs_data</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">m</span>
        <span class="p">)</span>

        <span class="c1"># Calculate altitude and airmass</span>
        <span class="n">altaz_frame</span> <span class="o">=</span> <span class="n">AltAz</span><span class="p">(</span><span class="n">obstime</span><span class="o">=</span><span class="n">obstime</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">)</span>
        <span class="n">altaz</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">altaz_frame</span><span class="p">)</span>
        <span class="n">airmass_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">altaz</span><span class="o">.</span><span class="n">secz</span><span class="p">)</span>

        <span class="c1"># Physical verification</span>
        <span class="k">if</span> <span class="n">airmass_value</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Calculated airmass is less than 1 (physically impossible)&quot;</span><span class="p">)</span>
            <span class="n">airmass_value</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">elif</span> <span class="n">airmass_value</span> <span class="o">&gt;</span> <span class="mf">40.0</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Extremely high airmass (&gt;40), object near horizon&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate the Sun&#39;s position to check observation conditions</span>
        <span class="n">sun_altaz</span> <span class="o">=</span> <span class="n">get_sun</span><span class="p">(</span><span class="n">obstime</span><span class="p">)</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">altaz_frame</span><span class="p">)</span>
        <span class="n">sun_alt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sun_altaz</span><span class="o">.</span><span class="n">alt</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>

        <span class="c1"># Create details dictionary</span>
        <span class="n">details</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;observatory&#39;</span><span class="p">:</span> <span class="n">obs_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
            <span class="s1">&#39;datetime&#39;</span><span class="p">:</span> <span class="n">obstime</span><span class="o">.</span><span class="n">iso</span><span class="p">,</span>
            <span class="s1">&#39;target_coords&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;ra&#39;</span><span class="p">:</span> <span class="n">coord</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">),</span>
                <span class="s1">&#39;dec&#39;</span><span class="p">:</span> <span class="n">coord</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="s1">&#39;altaz&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;altitude&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">altaz</span><span class="o">.</span><span class="n">alt</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s1">&#39;azimuth&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">altaz</span><span class="o">.</span><span class="n">az</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="s1">&#39;sun_altitude&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">sun_alt</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;observation_type&#39;</span><span class="p">:</span> <span class="s1">&#39;night&#39;</span> <span class="k">if</span> <span class="n">sun_alt</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">18</span> <span class="k">else</span> 
                              <span class="s1">&#39;twilight&#39;</span> <span class="k">if</span> <span class="n">sun_alt</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> 
                              <span class="s1">&#39;day&#39;</span>
        <span class="p">}</span>

        <span class="c1"># Display information</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Date &amp; Local Time: </span><span class="si">{</span><span class="n">obstime</span><span class="o">.</span><span class="n">iso</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Altitude: </span><span class="si">{</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;altaz&#39;</span><span class="p">][</span><span class="s1">&#39;altitude&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">Â°, &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;Azimuth: </span><span class="si">{</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;altaz&#39;</span><span class="p">][</span><span class="s1">&#39;azimuth&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">Â°&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_details</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">airmass_value</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">details</span>
        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">airmass_value</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calculating airmass: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_details</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="mf">0.0</span></div>



<div class="viewcode-block" id="load_fits_data">
<a class="viewcode-back" href="../api_reference.html#pfr_app.load_fits_data">[docs]</a>
<span class="nd">@st</span><span class="o">.</span><span class="n">cache_data</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_fits_data</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load FITS data from an uploaded file with robust error handling.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file : UploadedFile</span>
<span class="sd">        Streamlit file object from file uploader</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (image_data, header) where image_data is a 2D numpy array and header is the FITS header</span>
<span class="sd">        Returns (None, None) if loading fails</span>
<span class="sd">        </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Automatically handles multi-extension FITS by trying primary HDU first</span>
<span class="sd">    - For 3D/4D data (RGB, data cubes), extracts only the first 2D plane</span>
<span class="sd">    - First HDU with data is used if primary HDU has no data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">file_content</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="c1"># Create HDUList explicitly to avoid typing issues</span>
        <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">file_content</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;readonly&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Start with primary HDU</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
            
            <span class="c1"># If primary HDU has no data, look for first image HDU</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hdu</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">hdu</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">data</span>
                        <span class="n">header</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Primary HDU has no data. Using data from HDU #</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                        <span class="k">break</span>
            
            <span class="c1"># Handle case where no data was found</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No image data found in the FITS file.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
                
            <span class="c1"># Handle different data dimensionality</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1"># Determine if this is likely an RGB image</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># RGB/RGBA with color as first dimension</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected RGB data with shape </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">. Using first color channel.&quot;</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># RGB/RGBA with color as last dimension</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected RGB data with shape </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">. Using first color channel.&quot;</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># Some other 3D data structure (e.g., data cube)</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected 3D data with shape </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">. Using first plane.&quot;</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="si">}</span><span class="s2"> dimensions. Using first slice only.&quot;</span><span class="p">)</span>
                <span class="c1"># Take first slice along all higher dimensions</span>
                <span class="n">sliced_data</span> <span class="o">=</span> <span class="n">data</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">sliced_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">sliced_data</span> <span class="o">=</span> <span class="n">sliced_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">sliced_data</span>
            
            <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">header</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading FITS file: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">hdul</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="calibrate_image_streamlit">
<a class="viewcode-back" href="../api_reference.html#pfr_app.calibrate_image_streamlit">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calibrate_image_streamlit</span><span class="p">(</span><span class="n">science_data</span><span class="p">,</span> <span class="n">science_header</span><span class="p">,</span> <span class="n">bias_data</span><span class="p">,</span> <span class="n">dark_data</span><span class="p">,</span> <span class="n">flat_data</span><span class="p">,</span> 
                              <span class="n">exposure_time_science</span><span class="p">,</span> <span class="n">exposure_time_dark</span><span class="p">,</span> <span class="n">apply_bias</span><span class="p">,</span> <span class="n">apply_dark</span><span class="p">,</span> <span class="n">apply_flat</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calibrates a science image using bias, dark, and flat frames according to user selections.</span>
<span class="sd">    This function performs standard CCD calibration steps based on the user&#39;s choices:</span>
<span class="sd">    1. Bias subtraction (optional)</span>
<span class="sd">    2. Dark frame subtraction with exposure time scaling (optional)</span>
<span class="sd">    3. Flat field correction using normalized flat (optional)</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    science_data : numpy.ndarray</span>
<span class="sd">        The raw science image data to be calibrated</span>
<span class="sd">    science_header : dict or fits.Header</span>
<span class="sd">        Header information from the science image</span>
<span class="sd">    bias_data : numpy.ndarray or None</span>
<span class="sd">        Bias frame data for zero-level correction</span>
<span class="sd">    dark_data : numpy.ndarray or None</span>
<span class="sd">        Dark frame data for thermal noise correction</span>
<span class="sd">    flat_data : numpy.ndarray or None</span>
<span class="sd">        Flat field data for sensitivity/vignetting correction</span>
<span class="sd">    exposure_time_science : float</span>
<span class="sd">        Exposure time of the science image in seconds</span>
<span class="sd">    exposure_time_dark : float</span>
<span class="sd">        Exposure time of the dark frame in seconds</span>
<span class="sd">    apply_bias : bool</span>
<span class="sd">        Whether to apply bias subtraction</span>
<span class="sd">    apply_dark : bool</span>
<span class="sd">        Whether to apply dark frame subtraction</span>
<span class="sd">    apply_flat : bool</span>
<span class="sd">        Whether to apply flat field correction</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (calibrated_science, science_header) where:</span>
<span class="sd">        - calibrated_science is the processed science image as numpy.ndarray</span>
<span class="sd">        - science_header is the unchanged header information</span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    If bias correction is applied, it&#39;s also applied to dark and flat frames before they&#39;re used.</span>
<span class="sd">    The flat field is normalized by its median value before division.</span>
<span class="sd">    Dark frames are scaled according to exposure time ratios if different from science exposure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">apply_bias</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">apply_dark</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">apply_flat</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Calibration steps are disabled. Returning raw science data.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">science_data</span><span class="p">,</span> <span class="n">science_header</span>

    <span class="n">calibrated_science</span> <span class="o">=</span> <span class="n">science_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">steps_applied</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Initialize corrected data variables</span>
    <span class="n">dark_data_corrected</span> <span class="o">=</span> <span class="n">dark_data</span>
    <span class="n">flat_data_corrected</span> <span class="o">=</span> <span class="n">flat_data</span>

    <span class="k">if</span> <span class="n">apply_bias</span> <span class="ow">and</span> <span class="n">bias_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Application de la soustraction du bias...&quot;</span><span class="p">)</span>
        <span class="n">calibrated_science</span> <span class="o">-=</span> <span class="n">bias_data</span>
        <span class="n">steps_applied</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Soustraction du Bias&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dark_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dark_data_corrected</span> <span class="o">=</span> <span class="n">dark_data</span> <span class="o">-</span> <span class="n">bias_data</span>
        <span class="k">if</span> <span class="n">flat_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">flat_data_corrected</span> <span class="o">=</span> <span class="n">flat_data</span> <span class="o">-</span> <span class="n">bias_data</span>

    <span class="k">if</span> <span class="n">apply_dark</span> <span class="ow">and</span> <span class="n">dark_data_corrected</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Application de la soustraction du dark...&quot;</span><span class="p">)</span>
        <span class="c1"># Scale dark frame if exposure times are different</span>
        <span class="k">if</span> <span class="n">exposure_time_science</span> <span class="o">!=</span> <span class="n">exposure_time_dark</span><span class="p">:</span>
            <span class="n">dark_scale_factor</span> <span class="o">=</span> <span class="n">exposure_time_science</span> <span class="o">/</span> <span class="n">exposure_time_dark</span>
            <span class="n">scaled_dark</span> <span class="o">=</span> <span class="n">dark_data_corrected</span> <span class="o">*</span> <span class="n">dark_scale_factor</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scaled_dark</span> <span class="o">=</span> <span class="n">dark_data_corrected</span>
        <span class="n">calibrated_science</span> <span class="o">-=</span> <span class="n">scaled_dark</span>
        <span class="n">steps_applied</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Soustraction du Dark&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">apply_flat</span> <span class="ow">and</span> <span class="n">flat_data_corrected</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Application de la correction du flat field...&quot;</span><span class="p">)</span>
        <span class="c1"># Normalize the flat field</span>
        <span class="n">normalized_flat</span> <span class="o">=</span> <span class="n">flat_data_corrected</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flat_data_corrected</span><span class="p">)</span>
        <span class="n">calibrated_science</span> <span class="o">/=</span> <span class="n">normalized_flat</span>
        <span class="n">steps_applied</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Correction du Flat Field&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">steps_applied</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No calibration steps were applied because files are missing or options are disabled.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">science_data</span><span class="p">,</span> <span class="n">science_header</span>

    <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calibration steps applied: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">steps_applied</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">calibrated_science</span><span class="p">,</span> <span class="n">science_header</span></div>



<div class="viewcode-block" id="make_border_mask">
<a class="viewcode-back" href="../api_reference.html#pfr_app.make_border_mask">[docs]</a>
<span class="nd">@st</span><span class="o">.</span><span class="n">cache_data</span>
<span class="k">def</span><span class="w"> </span><span class="nf">make_border_mask</span><span class="p">(</span> <span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">border</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
    <span class="n">invert</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="nb">bool</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a binary mask for an image excluding one or more borders.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image : np.ndarray</span>
<span class="sd">        The input image as a NumPy array.</span>
<span class="sd">    border : int or tuple of int, default=50</span>
<span class="sd">        Border size(s) to exclude from the mask:</span>
<span class="sd">        - If int: same border size on all sides</span>
<span class="sd">        - If tuple of 2 elements: (vertical, horizontal) borders</span>
<span class="sd">        - If tuple of 4 elements: (top, bottom, left, right) borders</span>
<span class="sd">    invert : bool, default=True</span>
<span class="sd">        If True, the mask will be inverted (False for border regions)</span>
<span class="sd">        If False, the mask will be True for non-border regions</span>
<span class="sd">    dtype : np.dtype, default=bool</span>
<span class="sd">        Data type of the output mask</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Binary mask with the same height and width as the input image</span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    TypeError</span>
<span class="sd">        If image is not a NumPy array or border is not of the correct type</span>
<span class="sd">    ValueError</span>
<span class="sd">        If image is empty, borders are negative, borders are larger than the image,</span>
<span class="sd">        or border tuple has an invalid length</span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; img = np.ones((100, 100))</span>
<span class="sd">    &gt;&gt;&gt; # Create a mask with 10px border on all sides</span>
<span class="sd">    &gt;&gt;&gt; mask = make_border_mask(img, 10)</span>
<span class="sd">    &gt;&gt;&gt; # Create a mask with different vertical/horizontal borders</span>
<span class="sd">    &gt;&gt;&gt; mask = make_border_mask(img, (20, 30))</span>
<span class="sd">    &gt;&gt;&gt; # Create a mask with custom borders for each side</span>
<span class="sd">    &gt;&gt;&gt; mask = make_border_mask(img, (10, 20, 30, 40), invert=False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Image validation</span>
    <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Image cannot be None&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Image must be a numpy.ndarray&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Image cannot be empty&quot;</span><span class="p">)</span>

    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Convert and validate borders</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">border</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">border</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">border</span><span class="p">)</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">left</span> <span class="o">=</span> <span class="n">right</span> <span class="o">=</span> <span class="n">border</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">border</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">border</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">vert</span><span class="p">,</span> <span class="n">horiz</span> <span class="o">=</span> <span class="n">border</span>
            <span class="n">top</span> <span class="o">=</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">vert</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">right</span> <span class="o">=</span> <span class="n">horiz</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">border</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">top</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">border</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;border must be an int or a tuple of 2 or 4 elements&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;border must be an int or a tuple&quot;</span><span class="p">)</span>

    <span class="c1"># Validate dimensions</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">b</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Borders cannot be negative&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">top</span> <span class="o">+</span> <span class="n">bottom</span> <span class="o">&gt;=</span> <span class="n">height</span> <span class="ow">or</span> <span class="n">left</span> <span class="o">+</span> <span class="n">right</span> <span class="o">&gt;=</span> <span class="n">width</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Borders are larger than the image&quot;</span><span class="p">)</span>

    <span class="c1"># Create mask</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">mask</span><span class="p">[</span><span class="n">top</span><span class="p">:</span><span class="n">height</span><span class="o">-</span><span class="n">bottom</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span><span class="n">width</span><span class="o">-</span><span class="n">right</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="o">~</span><span class="n">mask</span> <span class="k">if</span> <span class="n">invert</span> <span class="k">else</span> <span class="n">mask</span></div>



<div class="viewcode-block" id="fwhm_fit">
<a class="viewcode-back" href="../api_reference.html#pfr_app.fwhm_fit">[docs]</a>
<span class="nd">@st</span><span class="o">.</span><span class="n">cache_data</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fwhm_fit</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">pixel_scale</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">std_lo</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">std_hi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimate the Full Width at Half Maximum (FWHM) of stars in an astronomical image.</span>
<span class="sd">    This function detects sources in the image using DAOStarFinder, filters them based on </span>
<span class="sd">    flux values, and fits 1D Gaussian models to the marginal distributions of each source </span>
<span class="sd">    to calculate FWHM values. The median FWHM of all successful fits is returned.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : np.ndarray</span>
<span class="sd">        The 2D image array containing astronomical sources.</span>
<span class="sd">    fwhm : float</span>
<span class="sd">        Initial FWHM estimate in pixels, used for source detection.</span>
<span class="sd">    pixel_scale : float</span>
<span class="sd">        The pixel scale of the image (not used directly in current implementation).</span>
<span class="sd">    mask : np.ndarray, optional</span>
<span class="sd">        Boolean mask array where True indicates pixels to ignore during source detection.</span>
<span class="sd">    std_lo : float, default=0.5</span>
<span class="sd">        Lower bound for flux filtering, in standard deviations below median flux.</span>
<span class="sd">    std_hi : float, default=0.5</span>
<span class="sd">        Upper bound for flux filtering, in standard deviations above median flux.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float or None</span>
<span class="sd">        The median FWHM value in pixels (rounded to nearest integer) if successful, </span>
<span class="sd">        or None if no valid sources could be measured.</span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If no sources are found, no valid sources remain after filtering,</span>
<span class="sd">        all FWHM values are NaN/infinite, or other calculation errors occur.</span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function uses marginal sums along the x and y dimensions and fits 1D Gaussian </span>
<span class="sd">    profiles to estimate FWHM. For each source, a box of size ~6Ã—FWHM is extracted, </span>
<span class="sd">    and profiles are fit independently in both dimensions, with the results averaged.</span>
<span class="sd">    Progress and error messages are displayed using Streamlit (st).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_fwhm_marginal_sums</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">center_row</span><span class="p">,</span> <span class="n">center_col</span><span class="p">,</span> <span class="n">box_size</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute Full Width at Half Maximum (FWHM) of a source in an image using marginal sums and Gaussian fitting.</span>
<span class="sd">        This function extracts a square region around a specified center position, computes the marginal sums</span>
<span class="sd">        in both row and column directions, and then fits Gaussian profiles to determine the FWHM.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        image_data : numpy.ndarray</span>
<span class="sd">            2D image array to analyze</span>
<span class="sd">        center_row : int</span>
<span class="sd">            Initial row coordinate of the source center</span>
<span class="sd">        center_col : int</span>
<span class="sd">            Initial column coordinate of the source center</span>
<span class="sd">        box_size : int</span>
<span class="sd">            Size of the square box to extract around the center (should be at least 5)</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple or None</span>
<span class="sd">            If successful, returns a tuple containing:</span>
<span class="sd">            - fwhm_row (float): FWHM in the row direction</span>
<span class="sd">            - fwhm_col (float): FWHM in the column direction</span>
<span class="sd">            - center_row_fit (float): Refined row center from Gaussian fit</span>
<span class="sd">            - center_col_fit (float): Refined column center from Gaussian fit</span>
<span class="sd">            Returns None if:</span>
<span class="sd">            - Box size is less than 5 pixels</span>
<span class="sd">            - Box extends beyond image boundaries</span>
<span class="sd">            - Signal is too weak for reliable fitting</span>
<span class="sd">            - Gaussian fitting fails for any reason</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">half_box</span> <span class="o">=</span> <span class="n">box_size</span> <span class="o">//</span> <span class="mi">2</span>
        
        <span class="c1"># Enforce minimum box size for fitting</span>
        <span class="k">if</span> <span class="n">box_size</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Box too small for reliable fitting</span>
        
        <span class="c1"># Check if box is within image boundaries of the FULL IMAGE</span>
        <span class="n">row_start</span> <span class="o">=</span> <span class="n">center_row</span> <span class="o">-</span> <span class="n">half_box</span>
        <span class="n">row_end</span> <span class="o">=</span> <span class="n">center_row</span> <span class="o">+</span> <span class="n">half_box</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">col_start</span> <span class="o">=</span> <span class="n">center_col</span> <span class="o">-</span> <span class="n">half_box</span>
        <span class="n">col_end</span> <span class="o">=</span> <span class="n">center_col</span> <span class="o">+</span> <span class="n">half_box</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">row_start</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">row_end</span> <span class="o">&gt;</span> <span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">col_start</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">col_end</span> <span class="o">&gt;</span> <span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Box extends beyond image boundaries</span>
        
        <span class="c1"># Extract box region from the COMPLETE IMAGE</span>
        <span class="n">box_data</span> <span class="o">=</span> <span class="n">image_data</span><span class="p">[</span><span class="n">row_start</span><span class="p">:</span><span class="n">row_end</span><span class="p">,</span> <span class="n">col_start</span><span class="p">:</span><span class="n">col_end</span><span class="p">]</span>
        
        <span class="c1"># Skip if box is too small (due to boundary conditions)</span>
        <span class="k">if</span> <span class="n">box_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="ow">or</span> <span class="n">box_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="c1"># Calculate marginal sums</span>
        <span class="n">sum_rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">box_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sum_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">box_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Skip if not enough signal (avoid fitting noise)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sum_rows</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sum_rows</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sum_cols</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sum_cols</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="c1"># Create axis data for fitting</span>
        <span class="n">row_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">box_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">col_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">box_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="c1"># Fit Gaussians</span>
        <span class="n">fitter</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>
        
        <span class="c1"># Fit rows - with better initial estimates and error handling</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Better initial parameter estimation</span>
            <span class="n">row_max_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">sum_rows</span><span class="p">)</span>
            <span class="n">row_max_val</span> <span class="o">=</span> <span class="n">sum_rows</span><span class="p">[</span><span class="n">row_max_idx</span><span class="p">]</span>
            
            <span class="n">model_row</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian1D</span><span class="p">(</span>
                <span class="n">amplitude</span><span class="o">=</span><span class="n">row_max_val</span><span class="p">,</span>
                <span class="n">mean</span><span class="o">=</span><span class="n">row_max_idx</span><span class="p">,</span>
                <span class="n">stddev</span><span class="o">=</span><span class="n">box_size</span><span class="o">/</span><span class="mi">6</span>  <span class="c1"># More conservative initial stddev</span>
            <span class="p">)</span>
            
            <span class="n">fitted_row</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">model_row</span><span class="p">,</span> <span class="n">row_indices</span><span class="p">,</span> <span class="n">sum_rows</span><span class="p">)</span>
            <span class="n">center_row_fit</span> <span class="o">=</span> <span class="n">fitted_row</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">row_start</span>
            <span class="n">fwhm_row</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">fitted_row</span><span class="o">.</span><span class="n">stddev</span><span class="o">.</span><span class="n">value</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># If row fitting fails, return None</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="c1"># Fit columns - with better initial estimates and error handling</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Better initial parameter estimation</span>
            <span class="n">col_max_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">sum_cols</span><span class="p">)</span>
            <span class="n">col_max_val</span> <span class="o">=</span> <span class="n">sum_cols</span><span class="p">[</span><span class="n">col_max_idx</span><span class="p">]</span>
            
            <span class="n">model_col</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian1D</span><span class="p">(</span>
                <span class="n">amplitude</span><span class="o">=</span><span class="n">col_max_val</span><span class="p">,</span>
                <span class="n">mean</span><span class="o">=</span><span class="n">col_max_idx</span><span class="p">,</span>
                <span class="n">stddev</span><span class="o">=</span><span class="n">box_size</span><span class="o">/</span><span class="mi">6</span>  <span class="c1"># More conservative initial stddev</span>
            <span class="p">)</span>
            
            <span class="n">fitted_col</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">model_col</span><span class="p">,</span> <span class="n">col_indices</span><span class="p">,</span> <span class="n">sum_cols</span><span class="p">)</span>
            <span class="n">center_col_fit</span> <span class="o">=</span> <span class="n">fitted_col</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">col_start</span>
            <span class="n">fwhm_col</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">fitted_col</span><span class="o">.</span><span class="n">stddev</span><span class="o">.</span><span class="n">value</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># If column fitting fails, return None</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">return</span> <span class="n">fwhm_row</span><span class="p">,</span> <span class="n">fwhm_col</span><span class="p">,</span> <span class="n">center_row_fit</span><span class="p">,</span> <span class="n">center_col_fit</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">fwhm</span><span class="o">=</span><span class="mf">1.5</span><span class="o">*</span><span class="n">fwhm</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">6</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No sources found !&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Filter sources by flux</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span>
        <span class="n">median_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
        <span class="n">std_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
        <span class="n">mask_flux</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux</span> <span class="o">&gt;</span> <span class="n">median_flux</span> <span class="o">-</span> <span class="n">std_lo</span> <span class="o">*</span> <span class="n">std_flux</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">flux</span> <span class="o">&lt;</span> <span class="n">median_flux</span> <span class="o">+</span> <span class="n">std_hi</span> <span class="o">*</span> <span class="n">std_flux</span><span class="p">)</span>
        <span class="n">filtered_sources</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="n">mask_flux</span><span class="p">]</span>

        <span class="c1"># Remove sources with NaN flux values</span>
        <span class="n">filtered_sources</span> <span class="o">=</span> <span class="n">filtered_sources</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">filtered_sources</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">])]</span>

        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of sources after flux filtering: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_sources</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_sources</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No valid sources for fitting found after filtering.&quot;</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Define analysis box size (in pixels)</span>
        <span class="n">box_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="nb">round</span><span class="p">(</span><span class="n">fwhm</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">box_size</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Ensure box_size is odd</span>
            <span class="n">box_size</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">fwhm_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">skipped_sources</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Counter for skipped sources</span>

        <span class="c1"># Fit model for each filtered source</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">filtered_sources</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x_cen</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">])</span>
                <span class="n">y_cen</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">])</span>

                <span class="c1"># Calculate FWHM using marginal sums</span>
                <span class="n">fwhm_results</span> <span class="o">=</span> <span class="n">compute_fwhm_marginal_sums</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">y_cen</span><span class="p">,</span> <span class="n">x_cen</span><span class="p">,</span> <span class="n">box_size</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fwhm_results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Instead of individual warning, just increment counter</span>
                    <span class="n">skipped_sources</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>

                <span class="n">fwhm_row</span><span class="p">,</span> <span class="n">fwhm_col</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">fwhm_results</span>

                <span class="c1"># Use average of FWHM_row and FWHM_col as FWHM estimate for this source</span>
                <span class="n">fwhm_source</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">fwhm_row</span><span class="p">,</span> <span class="n">fwhm_col</span><span class="p">])</span>
                <span class="n">fwhm_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fwhm_source</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">skipped_sources</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>

        <span class="c1"># Display summary of skipped sources</span>
        <span class="k">if</span> <span class="n">skipped_sources</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FWHM calculation failed for </span><span class="si">{</span><span class="n">skipped_sources</span><span class="si">}</span><span class="s2"> sources out of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_sources</span><span class="p">)</span><span class="si">}</span><span class="s2"> and were skipped.&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fwhm_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No valid sources for FWHM fitting after marginal sums adjustment.&quot;</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Convert list to array to filter NaN and infinite values</span>
        <span class="n">fwhm_values_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fwhm_values</span><span class="p">)</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">fwhm_values_arr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">fwhm_values_arr</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">valid</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;All FWHM values are NaN or infinite after marginal sums calculation.&quot;</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">mean_fwhm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">fwhm_values_arr</span><span class="p">[</span><span class="n">valid</span><span class="p">])</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FWHM estimate based on Gaussian model: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">mean_fwhm</span><span class="p">)</span><span class="si">}</span><span class="s2"> pixels&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">mean_fwhm</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error in fwhm_fit: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error in fwhm_fit: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="perform_epsf_photometry">
<a class="viewcode-back" href="../api_reference.html#pfr_app.perform_epsf_photometry">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">perform_epsf_photometry</span><span class="p">(</span>
    <span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">phot_table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span>
    <span class="n">fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">daostarfind</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>   
    <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Table</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform PSF photometry using an EPSF model.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : np.ndarray</span>
<span class="sd">        Image with sky background subtracted.</span>
<span class="sd">    phot_table : astropy.table.Table</span>
<span class="sd">        Table containing source positions.</span>
<span class="sd">    fwhm : float</span>
<span class="sd">        Full Width at Half Maximum used to define fitting size.</span>
<span class="sd">    daostarfind : callable</span>
<span class="sd">        Star detection function used as &quot;finder&quot; in PSF photometry.</span>
<span class="sd">    mask : np.ndarray, optional</span>
<span class="sd">        Mask to exclude certain image areas.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tuple[astropy.table.Table, photutils.epsf.EPSF]</span>
<span class="sd">        - phot_epsf_result : Table containing PSF photometry results, including fitted fluxes and positions.</span>
<span class="sd">        - epsf : The fitted EPSF model used for photometry.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Validate the input image</span>
        <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid image data provided. Ensure the image is a non-empty numpy array.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Prepare data: convert image to NDData object</span>
        <span class="n">nddata</span> <span class="o">=</span> <span class="n">NDData</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">img</span><span class="p">)</span>
        <span class="c1"># st.write(&quot;NDData created successfully.&quot;)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating NDData: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Build star table from phot_table</span>
        <span class="n">stars_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
        <span class="n">stars_table</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;xcenter&#39;</span><span class="p">]</span>
        <span class="n">stars_table</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;ycenter&#39;</span><span class="p">]</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Star positions table prepared.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error preparing star positions table: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fwhm</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;FWHM must be a positive number.&quot;</span><span class="p">)</span>
        <span class="n">fit_shape</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">round</span><span class="p">(</span><span class="n">fwhm</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Define fitting shape (box size for star extraction)</span>
        <span class="n">fit_shape</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">round</span><span class="p">(</span><span class="n">fwhm</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fitting shape: </span><span class="si">{</span><span class="n">fit_shape</span><span class="si">}</span><span class="s2"> pixels.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calculating fitting shape: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Extract stars in sub-image</span>
        <span class="n">stars</span> <span class="o">=</span> <span class="n">extract_stars</span><span class="p">(</span><span class="n">nddata</span><span class="p">,</span> <span class="n">stars_table</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fit_shape</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span><span class="si">}</span><span class="s2"> stars extracted.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error extracting stars: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span>
        <span class="n">fig_stars</span><span class="p">,</span> <span class="n">ax_stars</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZES</span><span class="p">[</span><span class="s1">&#39;stars_grid&#39;</span><span class="p">],</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_stars</span> <span class="o">=</span> <span class="n">ax_stars</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">n_disp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stars</span><span class="p">),</span> <span class="n">nrows</span> <span class="o">*</span> <span class="n">ncols</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_disp</span><span class="p">):</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.0</span><span class="p">)</span>
            <span class="n">ax_stars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">st</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="n">fig_stars</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error displaying extracted stars: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Build and fit EPSF model</span>
        <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">epsf_builder</span> <span class="o">=</span> <span class="n">EPSFBuilder</span><span class="p">(</span><span class="n">oversampling</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">progress_bar</span><span class="o">=</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">)</span>
        <span class="n">epsf</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">epsf_builder</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span>
        <span class="n">progress_bar</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>  <span class="c1"># Clear the progress bar</span>
        <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;PSF model fitted successfully.&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;epsf_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsf</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fitting PSF model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="k">if</span> <span class="n">epsf</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">epsf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Save the PSF model as a FITS file</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
            <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">epsf</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            
            <span class="c1"># Add metadata to header</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;PSF model created with photutils.EPSFBuilder&#39;</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;FWHMPIX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fwhm</span><span class="p">,</span> <span class="s1">&#39;FWHM in pixels used for extraction&#39;</span><span class="p">)</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OVERSAMP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Oversampling factor&#39;</span><span class="p">)</span>
            
            <span class="c1"># Create filename based on the base filename in session state</span>
            <span class="n">psf_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;base_filename&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;psf_model&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_epsf.fits&quot;</span>
            <span class="n">psf_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">),</span> <span class="n">psf_filename</span><span class="p">)</span>
            
            <span class="c1"># Save the FITS file</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">psf_filepath</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;PSF model saved as FITS file&quot;</span><span class="p">)</span>
            
            <span class="c1"># Also display the model</span>
            <span class="n">norm_epsf</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">epsf</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.</span><span class="p">)</span>
            <span class="n">fig_epsf_model</span><span class="p">,</span> <span class="n">ax_epsf_model</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZES</span><span class="p">[</span><span class="s1">&#39;medium&#39;</span><span class="p">],</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">ax_epsf_model</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">epsf</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm_epsf</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
            <span class="n">ax_epsf_model</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Fitted PSF Model&quot;</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="n">fig_epsf_model</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error working with PSF model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;EPSF data is empty or invalid. Cannot display the PSF model.&quot;</span><span class="p">)</span>
        <span class="c1"># Ensure daostarfind is a valid star finder</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">daostarfind</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The &#39;finder&#39; parameter must be a callable star finder, such as DAOStarFinder.&quot;</span><span class="p">)</span>

    <span class="n">psfphot</span> <span class="o">=</span> <span class="n">IterativePSFPhotometry</span><span class="p">(</span>
        <span class="n">psf_model</span><span class="o">=</span><span class="n">epsf</span><span class="p">,</span>  
        <span class="n">fit_shape</span><span class="o">=</span><span class="n">fit_shape</span><span class="p">,</span>  <span class="c1"># Changed from fitshape to fit_shape</span>
        <span class="n">finder</span><span class="o">=</span><span class="n">daostarfind</span><span class="p">,</span>
        <span class="n">aperture_radius</span><span class="o">=</span><span class="n">fit_shape</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">maxiters</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">progress_bar</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    
    <span class="c1"># Validate inputs before running PSF photometry</span>
    <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid image data provided. Ensure the image is a non-empty numpy array.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid mask provided. Ensure the mask is a numpy array with the same shape as the image.&quot;</span><span class="p">)</span>
    
    <span class="c1"># Specify source positions</span>
    <span class="n">psfphot</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;xcenter&#39;</span><span class="p">]</span>
    <span class="n">psfphot</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;ycenter&#39;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Run PSF photometry with provided mask</span>
        <span class="n">phot_epsf_result</span> <span class="o">=</span> <span class="n">psfphot</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;epsf_photometry_result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot_epsf_result</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;PSF photometry completed successfully.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error executing PSF photometry: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="k">return</span> <span class="n">phot_epsf_result</span><span class="p">,</span> <span class="n">epsf</span></div>



<div class="viewcode-block" id="find_sources_and_photometry_streamlit">
<a class="viewcode-back" href="../api_reference.html#pfr_app.find_sources_and_photometry_streamlit">[docs]</a>
<span class="nd">@st</span><span class="o">.</span><span class="n">cache_data</span>
<span class="k">def</span><span class="w"> </span><span class="nf">find_sources_and_photometry_streamlit</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">_science_header</span><span class="p">,</span> <span class="n">mean_fwhm_pixel</span><span class="p">,</span> <span class="n">threshold_sigma</span><span class="p">,</span> <span class="n">detection_mask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find sources and perform photometry on astronomical images.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image_data : numpy.ndarray</span>
<span class="sd">        Science image data</span>
<span class="sd">    _science_header : dict</span>
<span class="sd">        Header information from FITS file (underscore prevents caching issues)</span>
<span class="sd">    mean_fwhm_pixel : float</span>
<span class="sd">        Estimated FWHM in pixels</span>
<span class="sd">    threshold_sigma : float</span>
<span class="sd">        Detection threshold in sigma</span>
<span class="sd">    detection_mask : int</span>
<span class="sd">        Border size to mask during detection</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (phot_table, epsf_table, daofind, bkg)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initialize daofind to None</span>
    <span class="n">daofind</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="c1"># Get pixel scale from header</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">wcs_error</span> <span class="o">=</span> <span class="n">safe_wcs_create</span><span class="p">(</span><span class="n">_science_header</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating WCS: </span><span class="si">{</span><span class="n">wcs_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">daofind</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating WCS: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">daofind</span><span class="p">,</span> <span class="kc">None</span>
    
    <span class="n">pixel_scale</span> <span class="o">=</span> <span class="n">_science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PIXSCALE&#39;</span><span class="p">,</span> <span class="n">_science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PIXSIZE&#39;</span><span class="p">,</span> <span class="n">_science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PIXELSCAL&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)))</span>
    
    <span class="c1"># Estimate background and noise</span>
    <span class="n">bkg</span><span class="p">,</span> <span class="n">bkg_error</span> <span class="o">=</span> <span class="n">estimate_background</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">box_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">filter_size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bkg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error estimating background: </span><span class="si">{</span><span class="n">bkg_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">daofind</span><span class="p">,</span> <span class="kc">None</span>
    
    <span class="c1"># Create detection mask</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">make_border_mask</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="n">detection_mask</span><span class="p">)</span>
    
    <span class="c1"># Calculate total error</span>
    <span class="n">total_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">bkg</span><span class="o">.</span><span class="n">background_rms</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background_median</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">bkg</span><span class="o">.</span><span class="n">background_median</span><span class="p">)</span>
    
    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Estimating FWHM...&quot;</span><span class="p">)</span>
    <span class="n">fwhm_estimate</span> <span class="o">=</span> <span class="n">fwhm_fit</span><span class="p">(</span><span class="n">image_data</span> <span class="o">-</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="n">mean_fwhm_pixel</span><span class="p">,</span> <span class="n">pixel_scale</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">fwhm_estimate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to estimate FWHM. Using the initial estimate.&quot;</span><span class="p">)</span>
        <span class="n">fwhm_estimate</span> <span class="o">=</span> <span class="n">mean_fwhm_pixel</span>
    
    <span class="c1"># Source detection using DAOStarFinder</span>
    <span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">fwhm</span><span class="o">=</span><span class="mf">1.5</span><span class="o">*</span><span class="n">fwhm_estimate</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold_sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">image_data</span> <span class="o">-</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background</span><span class="p">))</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">image_data</span> <span class="o">-</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No sources found!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">daofind</span><span class="p">,</span> <span class="n">bkg</span>
    
    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Doing astrometry refinement with GAIA DR3...&quot;</span><span class="p">)</span>
    <span class="c1"># Get the center of the image using WCS</span>
    <span class="n">ra0</span><span class="p">,</span> <span class="n">dec0</span><span class="p">,</span> <span class="n">sr0</span> <span class="o">=</span> <span class="n">astrometry</span><span class="o">.</span><span class="n">get_frame_center</span><span class="p">(</span><span class="n">wcs</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">height</span><span class="o">=</span><span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">cat</span> <span class="o">=</span> <span class="n">catalogs</span><span class="o">.</span><span class="n">get_cat_vizier</span><span class="p">(</span><span class="n">ra0</span><span class="p">,</span> <span class="n">dec0</span><span class="p">,</span> <span class="n">sr0</span><span class="p">,</span> <span class="s1">&#39;gaiadr3&#39;</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;RPmag&#39;</span><span class="p">:</span><span class="s1">&#39;&lt;19&#39;</span><span class="p">})</span>
    <span class="n">cat_col_mag</span> <span class="o">=</span> <span class="s1">&#39;RPmag&#39;</span>
    <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">]</span>
    <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">wcs</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">refine_astrometry</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">fwhm_estimate</span><span class="o">*</span><span class="n">pixel_scale</span><span class="o">/</span><span class="mi">3600</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">cat_col_mag</span><span class="o">=</span><span class="n">cat_col_mag</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Update WCS info in the header</span>
        <span class="n">astrometry</span><span class="o">.</span><span class="n">clear_wcs</span><span class="p">(</span><span class="n">_science_header</span><span class="p">,</span> <span class="n">remove_comments</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove_underscored</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove_history</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">_science_header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">(</span><span class="n">relax</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping WCS refinement:  </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Aperture photometry</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]))</span>
    <span class="n">apertures</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mf">1.5</span><span class="o">*</span><span class="n">fwhm_estimate</span><span class="p">)</span>
    
    <span class="c1"># Perform aperture photometry</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Check if WCS exists and has the right dimensionality</span>
        <span class="n">wcs_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;CTYPE1&#39;</span> <span class="ow">in</span> <span class="n">_science_header</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">wcs_obj</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">_science_header</span><span class="p">)</span>
                <span class="c1"># Check if WCS has more than 2 dimensions, and if so, reduce it</span>
                <span class="k">if</span> <span class="n">wcs_obj</span><span class="o">.</span><span class="n">pixel_n_dim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">wcs_obj</span> <span class="o">=</span> <span class="n">wcs_obj</span><span class="o">.</span><span class="n">celestial</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reduced WCS to 2D celestial coordinates for photometry&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating WCS object: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">wcs_obj</span> <span class="o">=</span> <span class="kc">None</span>
                
        <span class="n">phot_table</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span>
            <span class="n">image_data</span> <span class="o">-</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background</span><span class="p">,</span>
            <span class="n">apertures</span><span class="p">,</span>
            <span class="n">error</span><span class="o">=</span><span class="n">total_error</span><span class="p">,</span>
            <span class="n">wcs</span><span class="o">=</span><span class="n">wcs_obj</span>
        <span class="p">)</span>
        
        <span class="c1"># Add source positions to table</span>
        <span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;xcenter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">]</span>
        <span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;ycenter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]</span>
        
        <span class="c1"># Calculate instrumental magnitudes for aperture photometry</span>
        <span class="n">instrumental_mags</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">])</span>
        <span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;instrumental_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instrumental_mags</span>
        
        <span class="c1"># Perform PSF/EPSF photometry</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">epsf_table</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">perform_epsf_photometry</span><span class="p">(</span>
                <span class="n">image_data</span> <span class="o">-</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background</span><span class="p">,</span> 
                <span class="n">phot_table</span><span class="p">,</span> 
                <span class="n">fwhm_estimate</span><span class="p">,</span> 
                <span class="n">daofind</span><span class="p">,</span> 
                <span class="n">mask</span>
            <span class="p">)</span>
            
            <span class="c1"># Calculate instrumental magnitudes for PSF photometry</span>
            <span class="n">epsf_instrumental_mags</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">epsf_table</span><span class="p">[</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">])</span>
            <span class="n">epsf_table</span><span class="p">[</span><span class="s1">&#39;instrumental_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsf_instrumental_mags</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error performing EPSF photometry: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">epsf_table</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Keep only valid sources for aperture photometry</span>
        <span class="n">valid_sources</span> <span class="o">=</span> <span class="p">(</span><span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;instrumental_mag&#39;</span><span class="p">])</span>
        <span class="n">phot_table</span> <span class="o">=</span> <span class="n">phot_table</span><span class="p">[</span><span class="n">valid_sources</span><span class="p">]</span>
        
        <span class="c1"># Keep only valid sources for PSF photometry if available</span>
        <span class="k">if</span> <span class="n">epsf_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">epsf_valid_sources</span> <span class="o">=</span> <span class="p">(</span><span class="n">epsf_table</span><span class="p">[</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">epsf_table</span><span class="p">[</span><span class="s1">&#39;instrumental_mag&#39;</span><span class="p">])</span>

            <span class="n">epsf_table</span> <span class="o">=</span> <span class="n">epsf_table</span><span class="p">[</span><span class="n">epsf_valid_sources</span><span class="p">]</span>

        <span class="c1"># Add RA and Dec if WCS is available</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">wcs_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Process phot_table</span>
                <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">wcs_obj</span><span class="o">.</span><span class="n">pixel_to_world_values</span><span class="p">(</span><span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;xcenter&#39;</span><span class="p">],</span> <span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;ycenter&#39;</span><span class="p">])</span>
                <span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ra</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
                <span class="n">phot_table</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dec</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
                
                <span class="c1"># Process epsf_table if available</span>
                <span class="k">if</span> <span class="n">epsf_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">epsf_ra</span><span class="p">,</span> <span class="n">epsf_dec</span> <span class="o">=</span> <span class="n">wcs_obj</span><span class="o">.</span><span class="n">pixel_to_world_values</span><span class="p">(</span><span class="n">epsf_table</span><span class="p">[</span><span class="s1">&#39;x_fit&#39;</span><span class="p">],</span> <span class="n">epsf_table</span><span class="p">[</span><span class="s1">&#39;y_fit&#39;</span><span class="p">])</span>
                        <span class="n">epsf_table</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsf_ra</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
                        <span class="n">epsf_table</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsf_dec</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not add coordinates to EPSF table: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If no WCS but we have RA/DEC in header, try to create approximate coordinates</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">_science_header</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">,</span> <span class="s1">&#39;DEC&#39;</span><span class="p">,</span> <span class="s1">&#39;NAXIS1&#39;</span><span class="p">,</span> <span class="s1">&#39;NAXIS2&#39;</span><span class="p">]):</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using simple linear approximation for RA/DEC coordinates&quot;</span><span class="p">)</span>
                    <span class="n">center_ra</span> <span class="o">=</span> <span class="n">_science_header</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]</span>
                    <span class="n">center_dec</span> <span class="o">=</span> <span class="n">_science_header</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">]</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="n">_science_header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span>
                    <span class="n">height</span> <span class="o">=</span> <span class="n">_science_header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span>
                    
                    <span class="c1"># Estimate pixel scale if not available</span>
                    <span class="n">pix_scale</span> <span class="o">=</span> <span class="n">pixel_scale</span> <span class="ow">or</span> <span class="mf">1.0</span>  <span class="c1"># arcsec/pixel</span>
                    
                    <span class="c1"># Create simple WCS transformation (approximate)</span>
                    <span class="n">center_x</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="n">center_y</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span>
                    
                    <span class="c1"># Add coordinates to tables</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phot_table</span><span class="p">):</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;xcenter&#39;</span><span class="p">]</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ycenter&#39;</span><span class="p">]</span>
                        <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">center_x</span><span class="p">)</span> <span class="o">*</span> <span class="n">pix_scale</span> <span class="o">/</span> <span class="mf">3600.0</span>  <span class="c1"># convert to degrees</span>
                        <span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">center_y</span><span class="p">)</span> <span class="o">*</span> <span class="n">pix_scale</span> <span class="o">/</span> <span class="mf">3600.0</span>  <span class="c1"># convert to degrees</span>
                        <span class="n">phot_table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">center_ra</span> <span class="o">+</span> <span class="n">dx</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">center_dec</span><span class="p">))</span>
                        <span class="n">phot_table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">center_dec</span> <span class="o">+</span> <span class="n">dy</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WCS transformation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. RA and Dec not added to tables.&quot;</span><span class="p">)</span>
            
        <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">phot_table</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources and performed photometry.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">phot_table</span><span class="p">,</span> <span class="n">epsf_table</span><span class="p">,</span> <span class="n">daofind</span><span class="p">,</span> <span class="n">bkg</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error performing aperture photometry: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">daofind</span><span class="p">,</span> <span class="n">bkg</span></div>



<div class="viewcode-block" id="cross_match_with_gaia_streamlit">
<a class="viewcode-back" href="../api_reference.html#pfr_app.cross_match_with_gaia_streamlit">[docs]</a>
<span class="nd">@st</span><span class="o">.</span><span class="n">cache_data</span>
<span class="k">def</span><span class="w"> </span><span class="nf">cross_match_with_gaia_streamlit</span><span class="p">(</span><span class="n">_phot_table</span><span class="p">,</span> <span class="n">_science_header</span><span class="p">,</span> <span class="n">pixel_size_arcsec</span><span class="p">,</span> <span class="n">mean_fwhm_pixel</span><span class="p">,</span> <span class="n">gaia_band</span><span class="p">,</span> <span class="n">gaia_min_mag</span><span class="p">,</span> <span class="n">gaia_max_mag</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cross-matches sources with Gaia catalog.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    _phot_table : astropy.table.Table</span>
<span class="sd">        Table containing source positions (underscore prevents caching issues)</span>
<span class="sd">    _science_header : dict</span>
<span class="sd">        FITS header with WCS information (underscore prevents caching issues)</span>
<span class="sd">    pixel_size_arcsec : float</span>
<span class="sd">        Pixel scale in arcseconds per pixel</span>
<span class="sd">    mean_fwhm_pixel : float</span>
<span class="sd">        FWHM in pixels</span>
<span class="sd">    gaia_band : str</span>
<span class="sd">        Gaia magnitude band to use (e.g., &#39;phot_g_mean_mag&#39;)</span>
<span class="sd">    gaia_min_mag : float</span>
<span class="sd">        Minimum magnitude for filtering Gaia sources</span>
<span class="sd">    gaia_max_mag : float</span>
<span class="sd">        Maximum magnitude for filtering Gaia sources</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        Matched sources table</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Cross-matching with Gaia DR3...&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">_science_header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No header information available. Cannot cross-match with Gaia.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">_science_header</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating WCS: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Convert pixel positions to sky coordinates</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">source_positions_pixel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="n">_phot_table</span><span class="p">[</span><span class="s1">&#39;xcenter&#39;</span><span class="p">],</span> <span class="n">_phot_table</span><span class="p">[</span><span class="s1">&#39;ycenter&#39;</span><span class="p">]))</span>
        <span class="n">source_positions_sky</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">pixel_to_world</span><span class="p">(</span><span class="n">source_positions_pixel</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">source_positions_pixel</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error converting pixel positions to sky coordinates: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Query Gaia</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">image_center_ra_dec</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">pixel_to_world</span><span class="p">(</span><span class="n">_science_header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">_science_header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Calculate search radius as half the image diagonal</span>
        <span class="n">gaia_search_radius_arcsec</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">_science_header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">],</span> <span class="n">_science_header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">pixel_size_arcsec</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">radius_query</span> <span class="o">=</span> <span class="n">gaia_search_radius_arcsec</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span>

        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Querying Gaia DR3 in a radius of </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">radius_query</span><span class="o">.</span><span class="n">value</span><span class="o">/</span><span class="mf">60.</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> arcmin.&quot;</span><span class="p">)</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">Gaia</span><span class="o">.</span><span class="n">cone_search</span><span class="p">(</span><span class="n">image_center_ra_dec</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius_query</span><span class="p">)</span>
        <span class="n">gaia_table</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error querying Gaia: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">gaia_table</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">gaia_table</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No Gaia sources found within search radius.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Apply filters to Gaia catalog</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Apply magnitude filter</span>
        <span class="n">mag_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">gaia_table</span><span class="p">[</span><span class="n">gaia_band</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">gaia_max_mag</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gaia_table</span><span class="p">[</span><span class="n">gaia_band</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">gaia_min_mag</span><span class="p">)</span>
        
        <span class="c1"># Apply variable star filter if column exists</span>
        <span class="k">if</span> <span class="s2">&quot;phot_variable_flag&quot;</span> <span class="ow">in</span> <span class="n">gaia_table</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
            <span class="n">var_filter</span> <span class="o">=</span> <span class="n">gaia_table</span><span class="p">[</span><span class="s2">&quot;phot_variable_flag&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;VARIABLE&quot;</span>
            <span class="n">combined_filter</span> <span class="o">=</span> <span class="n">mag_filter</span> <span class="o">&amp;</span> <span class="n">var_filter</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">combined_filter</span> <span class="o">=</span> <span class="n">mag_filter</span>
            
        <span class="n">gaia_table_filtered</span> <span class="o">=</span> <span class="n">gaia_table</span><span class="p">[</span><span class="n">combined_filter</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gaia_table_filtered</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No Gaia sources found within magnitude range </span><span class="si">{</span><span class="n">gaia_min_mag</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">gaia_band</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">gaia_max_mag</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
            
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtered Gaia catalog to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gaia_table_filtered</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error filtering Gaia catalog: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Cross-match</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">gaia_skycoords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">gaia_table_filtered</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">gaia_table_filtered</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
        <span class="n">idx</span><span class="p">,</span> <span class="n">d2d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">source_positions_sky</span><span class="o">.</span><span class="n">match_to_catalog_sky</span><span class="p">(</span><span class="n">gaia_skycoords</span><span class="p">)</span>
        
        <span class="c1"># Set maximum separation constraint based on FWHM and pixel scale</span>
        <span class="n">max_sep_constraint</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mean_fwhm_pixel</span> <span class="o">*</span> <span class="n">pixel_size_arcsec</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span>
        <span class="n">gaia_matches</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2d</span> <span class="o">&lt;=</span> <span class="n">max_sep_constraint</span><span class="p">)</span>

        <span class="n">matched_indices_gaia</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="n">gaia_matches</span><span class="p">]</span>
        <span class="n">matched_indices_phot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gaia_matches</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_indices_gaia</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No Gaia matches found within the separation constraint.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
            
        <span class="c1"># Extract matched sources</span>
        <span class="n">matched_table_qtable</span> <span class="o">=</span> <span class="n">_phot_table</span><span class="p">[</span><span class="n">matched_indices_phot</span><span class="p">]</span>
        
        <span class="c1"># Convert to pandas DataFrame</span>
        <span class="n">matched_table</span> <span class="o">=</span> <span class="n">matched_table_qtable</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
        <span class="n">matched_table</span><span class="p">[</span><span class="s1">&#39;gaia_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matched_indices_gaia</span>
        <span class="n">matched_table</span><span class="p">[</span><span class="s1">&#39;gaia_separation_arcsec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2d</span><span class="p">[</span><span class="n">gaia_matches</span><span class="p">]</span><span class="o">.</span><span class="n">arcsec</span>
        <span class="n">matched_table</span><span class="p">[</span><span class="n">gaia_band</span><span class="p">]</span> <span class="o">=</span> <span class="n">gaia_table_filtered</span><span class="p">[</span><span class="n">gaia_band</span><span class="p">][</span><span class="n">matched_indices_gaia</span><span class="p">]</span>
        
        <span class="c1"># Filter invalid magnitudes</span>
        <span class="n">valid_gaia_mags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">matched_table</span><span class="p">[</span><span class="n">gaia_band</span><span class="p">])</span>
        <span class="n">matched_table</span> <span class="o">=</span> <span class="n">matched_table</span><span class="p">[</span><span class="n">valid_gaia_mags</span><span class="p">]</span>
        
        <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matched_table</span><span class="p">)</span><span class="si">}</span><span class="s2"> Gaia matches after filtering.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">matched_table</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during cross-matching: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="calculate_zero_point_streamlit">
<a class="viewcode-back" href="../api_reference.html#pfr_app.calculate_zero_point_streamlit">[docs]</a>
<span class="nd">@st</span><span class="o">.</span><span class="n">cache_data</span>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_zero_point_streamlit</span><span class="p">(</span><span class="n">_phot_table</span><span class="p">,</span> <span class="n">_matched_table</span><span class="p">,</span> <span class="n">gaia_band</span><span class="p">,</span> <span class="n">air</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates photometric zero point using matched sources.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    _phot_table : astropy.table.Table or pandas.DataFrame</span>
<span class="sd">        Photometry results table (underscore prevents caching issues)</span>
<span class="sd">    _matched_table : pandas.DataFrame</span>
<span class="sd">        Table of Gaia cross-matched sources (underscore prevents caching issues)</span>
<span class="sd">    gaia_band : str</span>
<span class="sd">        Gaia magnitude band used</span>
<span class="sd">    air : float</span>
<span class="sd">        Airmass value for extinction correction</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (zero_point_value, zero_point_std, matplotlib_figure)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Calculating zero point...&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">_matched_table</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">_matched_table</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No matched sources to calculate zero point.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Calculate zero points</span>
        <span class="n">zero_points</span> <span class="o">=</span> <span class="n">_matched_table</span><span class="p">[</span><span class="n">gaia_band</span><span class="p">]</span> <span class="o">-</span> <span class="n">_matched_table</span><span class="p">[</span><span class="s1">&#39;instrumental_mag&#39;</span><span class="p">]</span>
        <span class="n">_matched_table</span><span class="p">[</span><span class="s1">&#39;zero_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero_points</span>
        <span class="n">_matched_table</span><span class="p">[</span><span class="s1">&#39;zero_point_error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">zero_points</span><span class="p">)</span>
        
        <span class="c1"># Apply sigma clipping to remove outliers</span>
        <span class="n">clipped_zero_points</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">zero_points</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">zero_point_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">clipped_zero_points</span><span class="p">)</span>
        <span class="n">zero_point_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">clipped_zero_points</span><span class="p">)</span>
        
        <span class="c1"># Calculate calibrated magnitude for matched sources</span>
        <span class="n">_matched_table</span><span class="p">[</span><span class="s1">&#39;calib_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_matched_table</span><span class="p">[</span><span class="s1">&#39;instrumental_mag&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">zero_point_value</span> <span class="o">+</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">air</span>
        
        <span class="c1"># Convert _phot_table to DataFrame if needed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_phot_table</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">_phot_table</span> <span class="o">=</span> <span class="n">_phot_table</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
            
        <span class="c1"># Calculate calibrated magnitudes for all sources</span>
        <span class="n">_phot_table</span><span class="p">[</span><span class="s1">&#39;calib_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_phot_table</span><span class="p">[</span><span class="s1">&#39;instrumental_mag&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">zero_point_value</span> <span class="o">+</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">air</span>
        
        <span class="c1"># Store results in session state</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;final_phot_table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_phot_table</span>
        
        <span class="c1"># Create plot</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZES</span><span class="p">[</span><span class="s1">&#39;medium&#39;</span><span class="p">],</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">_matched_table</span><span class="p">[</span><span class="n">gaia_band</span><span class="p">],</span> <span class="n">_matched_table</span><span class="p">[</span><span class="s1">&#39;calib_mag&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Matched sources&#39;</span><span class="p">)</span>
    
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gaia </span><span class="si">{</span><span class="n">gaia_band</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Calibrated magnitude&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Gaia magnitude vs Calibrated magnitude&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                
        <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculated Zero Point: </span><span class="si">{</span><span class="n">zero_point_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> Â± </span><span class="si">{</span><span class="n">zero_point_std</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Save plot but handle exceptions</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">zero_point_plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;zero_point_plot.png&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">zero_point_plot_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not save plot to file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">zero_point_value</span><span class="p">,</span> <span class="n">zero_point_std</span><span class="p">,</span> <span class="n">fig</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calculating zero point: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>



<span class="c1"># Main workflow function for zero point calibration</span>
<div class="viewcode-block" id="run_zero_point_calibration">
<a class="viewcode-back" href="../api_reference.html#pfr_app.run_zero_point_calibration">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">run_zero_point_calibration</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">pixel_size_arcsec</span><span class="p">,</span> <span class="n">mean_fwhm_pixel</span><span class="p">,</span> 
                               <span class="n">threshold_sigma</span><span class="p">,</span> <span class="n">detection_mask</span><span class="p">,</span> <span class="n">gaia_band</span><span class="p">,</span> <span class="n">gaia_min_mag</span><span class="p">,</span> <span class="n">gaia_max_mag</span><span class="p">,</span> <span class="n">air</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs the complete zero point calibration workflow.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image_data : numpy.ndarray</span>
<span class="sd">        Image data to process</span>
<span class="sd">    header : dict</span>
<span class="sd">        FITS header</span>
<span class="sd">    pixel_size_arcsec : float</span>
<span class="sd">        Pixel scale in arcseconds</span>
<span class="sd">    mean_fwhm_pixel : float</span>
<span class="sd">        FWHM estimate in pixels</span>
<span class="sd">    threshold_sigma : float</span>
<span class="sd">        Detection threshold</span>
<span class="sd">    detection_mask : int</span>
<span class="sd">        Border mask size</span>
<span class="sd">    gaia_band : str</span>
<span class="sd">        Gaia magnitude band</span>
<span class="sd">    gaia_min_mag, gaia_max_mag : float</span>
<span class="sd">        Magnitude limits for Gaia sources</span>
<span class="sd">    air : float</span>
<span class="sd">        Airmass value</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (zero_point_value, zero_point_std, phot_table)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">spinner</span><span class="p">(</span><span class="s2">&quot;Finding sources and performing photometry...&quot;</span><span class="p">):</span>
        <span class="n">phot_table_qtable</span><span class="p">,</span> <span class="n">epsf_table</span><span class="p">,</span> <span class="n">daofind</span><span class="p">,</span> <span class="n">bkg</span> <span class="o">=</span> <span class="n">find_sources_and_photometry_streamlit</span><span class="p">(</span>
            <span class="n">image_to_process</span><span class="p">,</span> <span class="n">header_to_process</span><span class="p">,</span> <span class="n">mean_fwhm_pixel</span><span class="p">,</span> <span class="n">threshold_sigma</span><span class="p">,</span> <span class="n">detection_mask</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">phot_table_qtable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to perform photometry - no sources found&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            
    <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">spinner</span><span class="p">(</span><span class="s2">&quot;Cross-matching with Gaia...&quot;</span><span class="p">):</span>
        <span class="n">matched_table</span> <span class="o">=</span> <span class="n">cross_match_with_gaia_streamlit</span><span class="p">(</span>
            <span class="n">phot_table_qtable</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">pixel_size_arcsec</span><span class="p">,</span> <span class="n">mean_fwhm_pixel</span><span class="p">,</span>
            <span class="n">gaia_band</span><span class="p">,</span> <span class="n">gaia_min_mag</span><span class="p">,</span> <span class="n">gaia_max_mag</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">matched_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to cross-match with Gaia&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">phot_table_qtable</span>
    
    <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Cross-matched Gaia Catalog (first 10 rows)&quot;</span><span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">matched_table</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    
    <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">spinner</span><span class="p">(</span><span class="s2">&quot;Calculating zero point...&quot;</span><span class="p">):</span>
        <span class="n">zero_point_value</span><span class="p">,</span> <span class="n">zero_point_std</span><span class="p">,</span> <span class="n">zp_plot</span> <span class="o">=</span> <span class="n">calculate_zero_point_streamlit</span><span class="p">(</span>
            <span class="n">phot_table_qtable</span><span class="p">,</span> <span class="n">matched_table</span><span class="p">,</span> <span class="n">gaia_band</span><span class="p">,</span> <span class="n">air</span>  <span class="c1"># Use phot_table_qtable, not phot_table</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">zero_point_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="n">zp_plot</span><span class="p">)</span>
            <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Zero point: </span><span class="si">{</span><span class="n">zero_point_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> Â± </span><span class="si">{</span><span class="n">zero_point_std</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Airmass: </span><span class="si">{</span><span class="n">air</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Save the zero point plot with timestamp</span>
            <span class="n">final_table</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;final_phot_table&#39;</span><span class="p">]</span>
                
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Add PSF photometry results if available</span>
                <span class="k">if</span> <span class="s1">&#39;epsf_photometry_result&#39;</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span> <span class="ow">and</span> <span class="n">epsf_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Convert tables to pandas if needed</span>
                    <span class="n">epsf_df</span> <span class="o">=</span> <span class="n">epsf_table</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">epsf_table</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="k">else</span> <span class="n">epsf_table</span>
                    
                    <span class="c1"># Add a unique ID for matching (based on x,y position)</span>
                    <span class="n">epsf_df</span><span class="p">[</span><span class="s1">&#39;match_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsf_df</span><span class="p">[</span><span class="s1">&#39;xcenter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">epsf_df</span><span class="p">[</span><span class="s1">&#39;ycenter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                    <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;match_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;xcenter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;ycenter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                    
                    <span class="c1"># Select just the columns we need from EPSF results</span>
                    <span class="n">epsf_cols</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;match_id&#39;</span><span class="p">:</span> <span class="s1">&#39;match_id&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;flux_fit&#39;</span><span class="p">:</span> <span class="s1">&#39;epsf_flux_fit&#39;</span><span class="p">,</span> 
                        <span class="s1">&#39;flux_unc&#39;</span><span class="p">:</span> <span class="s1">&#39;epsf_flux_unc&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;instrumental_mag&#39;</span><span class="p">:</span> <span class="s1">&#39;epsf_instrumental_mag&#39;</span>
                    <span class="p">}</span>
                    
                    <span class="c1"># Only continue if we have the necessary columns</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">epsf_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s1">&#39;match_id&#39;</span> <span class="ow">in</span> <span class="n">epsf_df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s1">&#39;match_id&#39;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="c1"># Select columns that actually exist</span>
                        <span class="n">epsf_subset</span> <span class="o">=</span> <span class="n">epsf_df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">epsf_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">epsf_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">epsf_cols</span><span class="p">)</span>
                    
                    <span class="c1"># Merge the EPSF results with the final table</span>
                    <span class="n">final_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">final_table</span><span class="p">,</span> <span class="n">epsf_subset</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;match_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
                    
                    <span class="c1"># Calculate calibrated magnitudes for EPSF photometry</span>
                    <span class="k">if</span> <span class="s1">&#39;epsf_instrumental_mag&#39;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;epsf_calib_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;epsf_instrumental_mag&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">zero_point_value</span> <span class="o">+</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">air</span>
                    
                    <span class="c1"># Remove temporary match column</span>
                    <span class="n">final_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;match_id&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    
                    <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;Added EPSF photometry results to the catalog&quot;</span><span class="p">)</span>
                
                <span class="c1"># Create a StringIO buffer for CSV data</span>
                <span class="n">csv_buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
                
                <span class="c1"># Check and remove problematic columns if they exist</span>
                <span class="n">cols_to_drop</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sky_center.ra&#39;</span><span class="p">,</span> <span class="s1">&#39;sky_center.dec&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">cols_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">cols_to_drop</span><span class="p">:</span>
                    <span class="n">final_table</span> <span class="o">=</span> <span class="n">final_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols_to_drop</span><span class="p">)</span>
                
                <span class="c1"># Before writing to CSV, ensure match_id column is removed</span>
                <span class="k">if</span> <span class="s1">&#39;match_id&#39;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">final_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;match_id&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
                <span class="c1"># Add zero point information to the table</span>
                <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;zero_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero_point_value</span>
                <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;zero_point_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero_point_std</span>
                <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">air</span>
                
                <span class="c1"># Create a catalog summary in the UI</span>
                <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Final Photometry Catalog&quot;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">final_table</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
                
                <span class="c1"># Write the filtered DataFrame to the buffer</span>
                <span class="n">final_table</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_buffer</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">csv_data</span> <span class="o">=</span> <span class="n">csv_buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
                
                <span class="c1"># Ensure filename has .csv extension</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">catalog_name</span> <span class="k">if</span> <span class="n">catalog_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">catalog_name</span><span class="si">}</span><span class="s2">.csv&quot;</span>
                <span class="n">catalog_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

                <span class="c1"># Provide download button with better formatting</span>
                <span class="n">download_link</span> <span class="o">=</span> <span class="n">get_download_link</span><span class="p">(</span>
                    <span class="n">csv_data</span><span class="p">,</span> 
                    <span class="n">filename</span><span class="p">,</span> 
                    <span class="n">link_text</span><span class="o">=</span><span class="s2">&quot;Download Photometry Catalog&quot;</span>
                <span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="n">download_link</span><span class="p">,</span> <span class="n">unsafe_allow_html</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Also save locally in the output directory</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">catalog_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">csv_data</span><span class="p">)</span>
                
                <span class="c1"># Also create a metadata file with analysis parameters</span>
                <span class="n">metadata_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_catalog_name</span><span class="si">}</span><span class="s2">_metadata.txt&quot;</span>
                <span class="n">metadata_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">metadata_filename</span><span class="p">)</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;RAPAS Photometry Analysis Metadata</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;================================</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis Date: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input File: </span><span class="si">{</span><span class="n">science_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Catalog File: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Zero Point: </span><span class="si">{</span><span class="n">zero_point_value</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> Â± </span><span class="si">{</span><span class="n">zero_point_std</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Airmass: </span><span class="si">{</span><span class="n">air</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pixel Scale: </span><span class="si">{</span><span class="n">pixel_size_arcsec</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> arcsec/pixel</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FWHM (estimated): </span><span class="si">{</span><span class="n">mean_fwhm_pixel</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> pixels (</span><span class="si">{</span><span class="n">seeing</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> arcsec)</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Detection Parameters:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Threshold: </span><span class="si">{</span><span class="n">threshold_sigma</span><span class="si">}</span><span class="s2"> sigma</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Edge Mask: </span><span class="si">{</span><span class="n">detection_mask</span><span class="si">}</span><span class="s2"> pixels</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Gaia Magnitude Range: </span><span class="si">{</span><span class="n">gaia_min_mag</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">gaia_max_mag</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="s2">&quot;Saved catalog metadata&quot;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis metadata saved to </span><span class="si">{</span><span class="n">metadata_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error preparing download: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">zero_point_value</span><span class="p">,</span> <span class="n">zero_point_std</span><span class="p">,</span> <span class="n">final_table</span></div>



<div class="viewcode-block" id="enhance_catalog_with_crossmatches">
<a class="viewcode-back" href="../api_reference.html#pfr_app.enhance_catalog_with_crossmatches">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">enhance_catalog_with_crossmatches</span><span class="p">(</span><span class="n">final_table</span><span class="p">,</span> <span class="n">matched_table</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">pixel_scale_arcsec</span><span class="p">,</span> <span class="n">search_radius_arcsec</span><span class="o">=</span><span class="mf">6.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enhance the catalog with cross-matches from GAIA DR3, SIMBAD, SkyBoT and AAVSO</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    final_table : pandas.DataFrame</span>
<span class="sd">        Final photometry catalog with RA/DEC coordinates</span>
<span class="sd">    matched_table : pandas.DataFrame</span>
<span class="sd">        Table of already matched Gaia sources (used for calibration)</span>
<span class="sd">    header : dict</span>
<span class="sd">        FITS header with observation information</span>
<span class="sd">    pixel_scale_arcsec : float</span>
<span class="sd">        Pixel scale in arcseconds per pixel</span>
<span class="sd">    search_radius_arcsec : float, optional</span>
<span class="sd">        Search radius for cross-matching in arcseconds</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        Input dataframe with added catalog information</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">final_table</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_table</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No sources to cross-match with catalogs.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">final_table</span>
    
    <span class="k">if</span> <span class="s1">&#39;ra&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s1">&#39;dec&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;RA/DEC columns missing from catalog. Cannot cross-match.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">final_table</span>
    
    <span class="c1"># Add progress tracking</span>
    <span class="n">status_text</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
    <span class="n">status_text</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Starting cross-match process...&quot;</span><span class="p">)</span>
    
    <span class="c1"># 1. First, add the GAIA calibration matches we already have</span>
    <span class="k">if</span> <span class="n">matched_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_table</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">status_text</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Adding Gaia calibration matches...&quot;</span><span class="p">)</span>
        
        <span class="c1"># Create a unique ID for matching based on x,y coordinates</span>
        <span class="k">if</span> <span class="s1">&#39;xcenter&#39;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s1">&#39;ycenter&#39;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;match_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;xcenter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;ycenter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="s1">&#39;xcenter&#39;</span> <span class="ow">in</span> <span class="n">matched_table</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s1">&#39;ycenter&#39;</span> <span class="ow">in</span> <span class="n">matched_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">matched_table</span><span class="p">[</span><span class="s1">&#39;match_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matched_table</span><span class="p">[</span><span class="s1">&#39;xcenter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">matched_table</span><span class="p">[</span><span class="s1">&#39;ycenter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            
            <span class="c1"># Get Gaia columns to add</span>
            <span class="n">gaia_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">matched_table</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">col</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gaia&#39;</span><span class="p">,</span> <span class="s1">&#39;phot_&#39;</span><span class="p">])]</span>
            <span class="n">gaia_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;match_id&#39;</span><span class="p">)</span>
            
            <span class="c1"># Select Gaia data subset</span>
            <span class="n">gaia_subset</span> <span class="o">=</span> <span class="n">matched_table</span><span class="p">[</span><span class="n">gaia_cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            
            <span class="c1"># Rename columns to be clearer</span>
            <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">gaia_subset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="s1">&#39;match_id&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;gaia_&#39;</span><span class="p">):</span>
                    <span class="n">rename_dict</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;gaia_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&#39;</span>
            
            <span class="k">if</span> <span class="n">rename_dict</span><span class="p">:</span>
                <span class="n">gaia_subset</span> <span class="o">=</span> <span class="n">gaia_subset</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">rename_dict</span><span class="p">)</span>
            
            <span class="c1"># Merge with final table</span>
            <span class="n">final_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">final_table</span><span class="p">,</span> <span class="n">gaia_subset</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;match_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
            
            <span class="c1"># Add a flag for calibration stars</span>
            <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;gaia_calib_star&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;match_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">matched_table</span><span class="p">[</span><span class="s1">&#39;match_id&#39;</span><span class="p">])</span>
            
            <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matched_table</span><span class="p">)</span><span class="si">}</span><span class="s2"> Gaia calibration stars to catalog&quot;</span><span class="p">)</span>
    
    <span class="c1"># 2. Cross-match with SIMBAD - Fixed version</span>
    <span class="n">status_text</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Querying SIMBAD for object identifications...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Extract center coordinates and field size</span>
        <span class="n">field_center_ra</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">field_center_dec</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Try different header keywords for coordinates</span>
        <span class="k">if</span> <span class="s1">&#39;CRVAL1&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="s1">&#39;CRVAL2&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">field_center_ra</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">])</span>
            <span class="n">field_center_dec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s1">&#39;RA&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="s1">&#39;DEC&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">field_center_ra</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">])</span>
            <span class="n">field_center_dec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s1">&#39;OBJRA&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="s1">&#39;OBJDEC&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">field_center_ra</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OBJRA&#39;</span><span class="p">])</span>
            <span class="n">field_center_dec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OBJDEC&#39;</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">field_center_ra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">field_center_dec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Validate coordinates are within reasonable range</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mi">360</span> <span class="o">&lt;=</span> <span class="n">field_center_ra</span> <span class="o">&lt;=</span> <span class="mi">360</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mi">90</span> <span class="o">&lt;=</span> <span class="n">field_center_dec</span> <span class="o">&lt;=</span> <span class="mi">90</span><span class="p">):</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid coordinates: RA=</span><span class="si">{</span><span class="n">field_center_ra</span><span class="si">}</span><span class="s2">, DEC=</span><span class="si">{</span><span class="n">field_center_dec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Calculate field width in arcmin based on image dimensions and pixel scale</span>
                <span class="k">if</span> <span class="s1">&#39;NAXIS1&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="s1">&#39;NAXIS2&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                    <span class="n">field_width_arcmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span> <span class="o">*</span> <span class="n">pixel_scale_arcsec</span> <span class="o">/</span> <span class="mf">60.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">field_width_arcmin</span> <span class="o">=</span> <span class="mf">30.0</span> <span class="c1"># Default to 30 arcmin</span>
                    
                <span class="c1"># Configure Simbad</span>
                <span class="n">custom_simbad</span> <span class="o">=</span> <span class="n">Simbad</span><span class="p">()</span>
                <span class="n">custom_simbad</span><span class="o">.</span><span class="n">add_votable_fields</span><span class="p">(</span><span class="s1">&#39;otype&#39;</span><span class="p">,</span> <span class="s1">&#39;main_id&#39;</span><span class="p">,</span> <span class="s1">&#39;ids&#39;</span><span class="p">,</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">)</span>
                
                <span class="c1"># Query SIMBAD in a cone around field center</span>
                <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Querying SIMBAD&quot;</span><span class="p">)</span>
                
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Create a SkyCoord object for the query</span>
                    <span class="n">center_coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">field_center_ra</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">field_center_dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
                    <span class="n">simbad_result</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">safe_catalog_query</span><span class="p">(</span>
                        <span class="n">custom_simbad</span><span class="o">.</span><span class="n">query_region</span><span class="p">,</span>
                        <span class="s2">&quot;SIMBAD query failed&quot;</span><span class="p">,</span>
                        <span class="n">center_coord</span><span class="p">,</span>
                        <span class="n">radius</span><span class="o">=</span><span class="n">field_width_arcmin</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcmin</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Process simbad_result</span>
                        <span class="k">if</span> <span class="n">simbad_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">simbad_result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="c1"># Initialize columns if they don&#39;t exist</span>
                            <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;simbad_main_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;simbad_otype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;simbad_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;simbad_B&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;simbad_V&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            
                            <span class="c1"># Convert catalog positions to SkyCoord objects with explicit unit</span>
                            <span class="n">source_coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
                            
                            <span class="c1"># Check if RA and DEC columns exist and create SkyCoord</span>
                            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">simbad_result</span><span class="o">.</span><span class="n">colnames</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">]):</span>  <span class="c1"># Changed from &#39;RA&#39;, &#39;DEC&#39; to lowercase</span>
                                <span class="c1"># Get SIMBAD coordinates with proper units</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">simbad_coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
                                        <span class="n">ra</span><span class="o">=</span><span class="n">simbad_result</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span>  <span class="c1"># Changed from &#39;RA&#39; to &#39;ra&#39;</span>
                                        <span class="n">dec</span><span class="o">=</span><span class="n">simbad_result</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span>  <span class="c1"># Changed from &#39;DEC&#39; to &#39;dec&#39;</span>
                                        <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
                                    <span class="p">)</span>
                                    
                                    <span class="c1"># Match coordinates</span>
                                    <span class="n">idx</span><span class="p">,</span> <span class="n">d2d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">source_coords</span><span class="o">.</span><span class="n">match_to_catalog_sky</span><span class="p">(</span><span class="n">simbad_coords</span><span class="p">)</span>
                                    <span class="n">matches</span> <span class="o">=</span> <span class="n">d2d</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">search_radius_arcsec</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>
                                    
                                    <span class="c1"># Add matches to table</span>
                                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">match_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">idx</span><span class="p">)):</span>
                                        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                                            <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;simbad_main_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">simbad_result</span><span class="p">[</span><span class="s1">&#39;main_id&#39;</span><span class="p">][</span><span class="n">match_idx</span><span class="p">]</span>  <span class="c1"># Changed from &#39;MAIN_ID&#39;</span>
                                            <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;simbad_otype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">simbad_result</span><span class="p">[</span><span class="s1">&#39;otype&#39;</span><span class="p">][</span><span class="n">match_idx</span><span class="p">]</span>    <span class="c1"># Changed from &#39;OTYPE&#39;</span>
                                            <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;simbad_B&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">simbad_result</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">][</span><span class="n">match_idx</span><span class="p">]</span> 
                                            <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;simbad_V&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">simbad_result</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">][</span><span class="n">match_idx</span><span class="p">]</span> 
                                            <span class="k">if</span> <span class="s1">&#39;ids&#39;</span> <span class="ow">in</span> <span class="n">simbad_result</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>  <span class="c1"># Changed from &#39;IDS&#39;</span>
                                                <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;simbad_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">simbad_result</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">][</span><span class="n">match_idx</span><span class="p">]</span>
                                    
                                    <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span><span class="si">}</span><span class="s2"> SIMBAD objects in field.&quot;</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating SkyCoord objects from SIMBAD data: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Available SIMBAD columns: </span><span class="si">{</span><span class="n">simbad_result</span><span class="o">.</span><span class="n">colnames</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">available_cols</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">simbad_result</span><span class="o">.</span><span class="n">colnames</span><span class="p">)</span>
                                <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SIMBAD result missing required columns. Available columns: </span><span class="si">{</span><span class="n">available_cols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No SIMBAD objects found in the field.&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SIMBAD query execution failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not extract field center coordinates from header&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in SIMBAD processing: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># 3. Cross-match with SkyBoT for solar system objects - Fixed version</span>
    <span class="n">status_text</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Querying SkyBoT for solar system objects...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field_center_ra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">field_center_dec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Get observation date</span>
            <span class="k">if</span> <span class="s1">&#39;DATE-OBS&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="n">obs_date</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;DATE-OBS&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;DATE&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="n">obs_date</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;DATE&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obs_date</span> <span class="o">=</span> <span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isot</span>
                
            <span class="c1"># Format date for SkyBoT</span>
            <span class="n">obs_time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">obs_date</span><span class="p">)</span><span class="o">.</span><span class="n">isot</span>
            
            <span class="c1"># Build SkyBoT URL</span>
            <span class="n">sr_value</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">field_width_arcmin</span><span class="o">/</span><span class="mf">60.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># Limit to 1 degree max</span>
            <span class="n">skybot_url</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;http://vo.imcce.fr/webservices/skybot/skybotconesearch_query.php?&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;RA=</span><span class="si">{</span><span class="n">field_center_ra</span><span class="si">}</span><span class="s2">&amp;DEC=</span><span class="si">{</span><span class="n">field_center_dec</span><span class="si">}</span><span class="s2">&amp;SR=</span><span class="si">{</span><span class="n">sr_value</span><span class="si">}</span><span class="s2">&amp;&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;EPOCH=</span><span class="si">{</span><span class="n">quote</span><span class="p">(</span><span class="n">obs_time</span><span class="p">)</span><span class="si">}</span><span class="s2">&amp;mime=json&quot;</span>
            <span class="p">)</span>
            
            <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Querying SkyBoT for solar system objects...&quot;</span><span class="p">)</span>
            
            <span class="c1"># Query SkyBoT with better error handling</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Initialize columns</span>
                <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;skybot_NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;skybot_OBJECT_TYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;skybot_MAGV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                
                <span class="c1"># Make request with extended timeout</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">skybot_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="n">response_text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    
                    <span class="c1"># Check if we got a valid JSON response</span>
                    <span class="k">if</span> <span class="n">response_text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">response_text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">skybot_result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                            
                            <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">skybot_result</span> <span class="ow">and</span> <span class="n">skybot_result</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]:</span>
                                <span class="n">skybot_coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
                                    <span class="n">ra</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">skybot_result</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]],</span> 
                                    <span class="n">dec</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">skybot_result</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]],</span> 
                                    <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span>
                                <span class="p">)</span>
                                
                                <span class="c1"># Convert our catalog positions to SkyCoord</span>
                                <span class="n">source_coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
                                                         <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
                                
                                <span class="c1"># Find best matches</span>
                                <span class="n">idx</span><span class="p">,</span> <span class="n">d2d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">source_coords</span><span class="o">.</span><span class="n">match_to_catalog_sky</span><span class="p">(</span><span class="n">skybot_coords</span><span class="p">)</span>
                                <span class="n">matches</span> <span class="o">=</span> <span class="n">d2d</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">search_radius_arcsec</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>
                                
                                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">match_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">idx</span><span class="p">)):</span>
                                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                                        <span class="n">obj</span> <span class="o">=</span> <span class="n">skybot_result</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">match_idx</span><span class="p">]</span>
                                        <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;skybot_NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="p">]</span>
                                        <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;skybot_OBJECT_TYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;OBJECT_TYPE&#39;</span><span class="p">]</span>
                                        <span class="k">if</span> <span class="s1">&#39;MAGV&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                                            <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;skybot_MAGV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;MAGV&#39;</span><span class="p">]</span>
                                
                                <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span><span class="si">}</span><span class="s2"> solar system objects in field.&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No solar system objects found in the field.&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No solar system objects found (no valid JSON data returned). </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No solar system objects found in the field.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SkyBoT query failed with status code </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">req_err</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request to SkyBoT failed: </span><span class="si">{</span><span class="n">req_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not determine field center for SkyBoT query&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in SkyBoT processing: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    
    <span class="c1"># 4. Cross-match with AAVSO VSX (Variable stars)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Querying AAVSO VSX for variable stars...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field_center_ra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">field_center_dec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use VizieR to access the VSX catalog (B/vsx/vsx)</span>
            <span class="n">Vizier</span><span class="o">.</span><span class="n">ROW_LIMIT</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># No row limit</span>
            <span class="n">vizier_result</span> <span class="o">=</span> <span class="n">Vizier</span><span class="o">.</span><span class="n">query_region</span><span class="p">(</span>
                <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">field_center_ra</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">field_center_dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span>
                <span class="n">radius</span><span class="o">=</span><span class="n">field_width_arcmin</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcmin</span><span class="p">,</span>
                <span class="n">catalog</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;B/vsx/vsx&#39;</span><span class="p">]</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">vizier_result</span> <span class="ow">and</span> <span class="s1">&#39;B/vsx/vsx&#39;</span> <span class="ow">in</span> <span class="n">vizier_result</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">vizier_result</span><span class="p">[</span><span class="s1">&#39;B/vsx/vsx&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">vsx_table</span> <span class="o">=</span> <span class="n">vizier_result</span><span class="p">[</span><span class="s1">&#39;B/vsx/vsx&#39;</span><span class="p">]</span>
                
                <span class="c1"># Create SkyCoord objects</span>
                <span class="n">vsx_coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">vsx_table</span><span class="p">[</span><span class="s1">&#39;RAJ2000&#39;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">vsx_table</span><span class="p">[</span><span class="s1">&#39;DEJ2000&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
                <span class="n">source_coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
                                         <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
                
                <span class="c1"># Find best matches</span>
                <span class="n">idx</span><span class="p">,</span> <span class="n">d2d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">source_coords</span><span class="o">.</span><span class="n">match_to_catalog_sky</span><span class="p">(</span><span class="n">vsx_coords</span><span class="p">)</span>
                <span class="n">matches</span> <span class="o">=</span> <span class="n">d2d</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">search_radius_arcsec</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>
                
                <span class="c1"># Add AAVSO information to matched sources</span>
                <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;aavso_Name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;aavso_Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;aavso_Period&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">match_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">idx</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                        <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;aavso_Name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vsx_table</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">][</span><span class="n">match_idx</span><span class="p">]</span>
                        <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;aavso_Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vsx_table</span><span class="p">[</span><span class="s1">&#39;Type&#39;</span><span class="p">][</span><span class="n">match_idx</span><span class="p">]</span>
                        <span class="k">if</span> <span class="s1">&#39;Period&#39;</span> <span class="ow">in</span> <span class="n">vsx_table</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                            <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;aavso_Period&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vsx_table</span><span class="p">[</span><span class="s1">&#39;Period&#39;</span><span class="p">][</span><span class="n">match_idx</span><span class="p">]</span>
                
                <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span><span class="si">}</span><span class="s2"> variable stars in field.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No variable stars found in the field.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error querying AAVSO VSX: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">status_text</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Cross-matching complete!&quot;</span><span class="p">)</span>
    
    <span class="c1"># Create a readable summary of matches</span>
    <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;catalog_matches&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    
    <span class="c1"># Add matches to summary</span>
    <span class="k">if</span> <span class="s1">&#39;gaia_calib_star&#39;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">is_calib</span> <span class="o">=</span> <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;gaia_calib_star&#39;</span><span class="p">]</span>
        <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">is_calib</span><span class="p">,</span> <span class="s1">&#39;catalog_matches&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;GAIA (calib); &#39;</span>
    
    <span class="k">if</span> <span class="s1">&#39;simbad_main_id&#39;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">has_simbad</span> <span class="o">=</span> <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;simbad_main_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
        <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">has_simbad</span><span class="p">,</span> <span class="s1">&#39;catalog_matches&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;SIMBAD; &#39;</span>
    
    <span class="k">if</span> <span class="s1">&#39;skybot_NAME&#39;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">has_skybot</span> <span class="o">=</span> <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;skybot_NAME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
        <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">has_skybot</span><span class="p">,</span> <span class="s1">&#39;catalog_matches&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;SkyBoT; &#39;</span>
    
    <span class="k">if</span> <span class="s1">&#39;aavso_Name&#39;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">has_aavso</span> <span class="o">=</span> <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;aavso_Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
        <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">has_aavso</span><span class="p">,</span> <span class="s1">&#39;catalog_matches&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;AAVSO; &#39;</span>
    
    <span class="c1"># Remove trailing separators and empty entries</span>
    <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;catalog_matches&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;catalog_matches&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;; &#39;</span><span class="p">)</span>
    <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;catalog_matches&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;catalog_matches&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="c1"># Display matches summary</span>
    <span class="n">matches_count</span> <span class="o">=</span> <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;catalog_matches&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">matches_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Matched Objects Summary (</span><span class="si">{</span><span class="n">matches_count</span><span class="si">}</span><span class="s2"> sources)&quot;</span><span class="p">)</span>
        <span class="n">matched_df</span> <span class="o">=</span> <span class="n">final_table</span><span class="p">[</span><span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;catalog_matches&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Select columns to display</span>
        <span class="n">display_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;xcenter&#39;</span><span class="p">,</span> <span class="s1">&#39;ycenter&#39;</span><span class="p">,</span> <span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="s1">&#39;aperture_calib_mag&#39;</span><span class="p">,</span> <span class="s1">&#39;catalog_matches&#39;</span><span class="p">]</span>
        <span class="n">display_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">display_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">matched_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        
        <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">matched_df</span><span class="p">[</span><span class="n">display_cols</span><span class="p">])</span>
    
    <span class="c1"># Remove temporary match_id column if it exists</span>
    <span class="k">if</span> <span class="s1">&#39;match_id&#39;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">final_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;match_id&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">final_table</span></div>



<div class="viewcode-block" id="get_download_link">
<a class="viewcode-back" href="../api_reference.html#pfr_app.get_download_link">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_download_link</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">link_text</span><span class="o">=</span><span class="s2">&quot;Download&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a download link for data with improved styling and error handling.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : str</span>
<span class="sd">        String data to be downloaded</span>
<span class="sd">    filename : str</span>
<span class="sd">        Name of the file to be downloaded</span>
<span class="sd">    link_text : str, optional</span>
<span class="sd">        Text to display on the download button</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        HTML for the download link</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;div class=&quot;error-text&quot;&gt;No data available to download&lt;/div&gt;&#39;</span>
        
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
        
        <span class="c1"># Ensure we have string data</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">b64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        
        <span class="n">href</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&lt;a href=&quot;data:file/csv;base64,</span><span class="si">{</span><span class="n">b64</span><span class="si">}</span><span class="s1">&quot; download=&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&quot; class=&quot;download-button&quot;&gt;</span><span class="si">{</span><span class="n">link_text</span><span class="si">}</span><span class="s1">&lt;/a&gt;&#39;</span>
        
        <span class="n">button_style</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        &lt;style&gt;</span>
<span class="s2">        .download-button {</span>
<span class="s2">            display: inline-block;</span>
<span class="s2">            padding: 0.8em 1.4em;</span>
<span class="s2">            background-color: #4CAF50;  /* Green background */</span>
<span class="s2">            color: white;  /* White text */</span>
<span class="s2">            text-align: center;</span>
<span class="s2">            text-decoration: none;</span>
<span class="s2">            font-size: 16px;</span>
<span class="s2">            font-weight: 500;</span>
<span class="s2">            border-radius: 4px;</span>
<span class="s2">            border: none;</span>
<span class="s2">            cursor: pointer;</span>
<span class="s2">            margin-top: 15px;</span>
<span class="s2">            transition: all 0.3s ease;</span>
<span class="s2">            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);</span>
<span class="s2">        }</span>
<span class="s2">        .download-button:hover {</span>
<span class="s2">            background-color: #45a049;</span>
<span class="s2">            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);</span>
<span class="s2">            transform: translateY(-1px);</span>
<span class="s2">        }</span>
<span class="s2">        .error-text {</span>
<span class="s2">            color: red;</span>
<span class="s2">            font-style: italic;</span>
<span class="s2">        }</span>
<span class="s2">        &lt;/style&gt;</span>
<span class="s2">        &quot;&quot;&quot;</span>
        
        <span class="k">return</span> <span class="n">button_style</span> <span class="o">+</span> <span class="n">href</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;div class=&quot;error-text&quot;&gt;Error creating download link: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&lt;/div&gt;&#39;</span></div>



<div class="viewcode-block" id="save_header_to_txt">
<a class="viewcode-back" href="../api_reference.html#pfr_app.save_header_to_txt">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">save_header_to_txt</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save FITS header to a text file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    header : dict</span>
<span class="sd">        FITS header dictionary</span>
<span class="sd">    filename : str</span>
<span class="sd">        Base filename to use (without extension)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Full path to the saved file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
        
    <span class="c1"># Create a nicely formatted text representation of the header</span>
    <span class="n">header_txt</span> <span class="o">=</span> <span class="s2">&quot;FITS Header</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">header_txt</span> <span class="o">+=</span> <span class="s2">&quot;==========</span><span class="se">\n\n</span><span class="s2">&quot;</span>
    
    <span class="c1"># Format each key-value pair</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">header_txt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">:</span><span class="s2">8</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    
    <span class="c1"># Use the output directory</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">output_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>
    
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header_txt</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">output_filename</span></div>



<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Main Script Execution</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="initialize_session_state">
<a class="viewcode-back" href="../api_reference.html#pfr_app.initialize_session_state">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">initialize_session_state</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize all session state variables in one place to improve organization.&quot;&quot;&quot;</span>
    <span class="c1"># Image data storage</span>
    <span class="k">if</span> <span class="s1">&#39;calibrated_data&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;calibrated_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39;calibrated_header&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;calibrated_header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39;final_phot_table&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;final_phot_table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39;epsf_model&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;epsf_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39;epsf_photometry_result&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;epsf_photometry_result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="c1"># Log handling</span>
    <span class="k">if</span> <span class="s1">&#39;log_buffer&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;log_buffer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39;base_filename&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;base_filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;photometry&quot;</span>
    
    <span class="c1"># Coordinate storage</span>
    <span class="k">if</span> <span class="s1">&#39;manual_ra&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;manual_ra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;manual_dec&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;manual_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;valid_ra&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;valid_ra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39;valid_dec&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;valid_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="c1"># Analysis parameters</span>
    <span class="k">if</span> <span class="s1">&#39;analysis_parameters&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;analysis_parameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;seeing&#39;</span><span class="p">:</span> <span class="mf">3.5</span><span class="p">,</span>
            <span class="s1">&#39;threshold_sigma&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
            <span class="s1">&#39;detection_mask&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
            <span class="s1">&#39;gaia_band&#39;</span><span class="p">:</span> <span class="s2">&quot;phot_g_mean_mag&quot;</span><span class="p">,</span>
            <span class="s1">&#39;gaia_min_mag&#39;</span><span class="p">:</span> <span class="mf">11.0</span><span class="p">,</span>
            <span class="s1">&#39;gaia_max_mag&#39;</span><span class="p">:</span> <span class="mf">19.0</span><span class="p">,</span>
            <span class="s1">&#39;calibrate_bias&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;calibrate_dark&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;calibrate_flat&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>
    
    <span class="c1"># File tracking</span>
    <span class="k">if</span> <span class="s1">&#39;files_loaded&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;files_loaded&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;science_file&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;bias_file&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;dark_file&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;flat_file&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span></div>



<div class="viewcode-block" id="get_base_filename">
<a class="viewcode-back" href="../api_reference.html#pfr_app.get_base_filename">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_base_filename</span><span class="p">(</span><span class="n">file_obj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the base filename from an uploaded file object without extension.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file_obj : UploadedFile</span>
<span class="sd">        The uploaded file object</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Base filename without extension</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">file_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;photometry&quot;</span>
        
    <span class="c1"># Get original filename</span>
    <span class="n">original_name</span> <span class="o">=</span> <span class="n">file_obj</span><span class="o">.</span><span class="n">name</span>
    
    <span class="c1"># Remove extension(s) from filename</span>
    <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">original_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># Remove any additional extensions (e.g. for .fits.fz files)</span>
    <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">base_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">base_name</span></div>



<div class="viewcode-block" id="initialize_log">
<a class="viewcode-back" href="../api_reference.html#pfr_app.initialize_log">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">initialize_log</span><span class="p">(</span><span class="n">base_filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize a log file for the current processing session.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    base_filename : str</span>
<span class="sd">        Base name for the log file</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    StringIO</span>
<span class="sd">        Log buffer object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log_buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
    
    <span class="n">log_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Photometry Factory for RAPAS Log</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">log_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;===============================</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">log_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing started: </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">log_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input file: </span><span class="si">{</span><span class="n">base_filename</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">log_buffer</span></div>



<div class="viewcode-block" id="write_to_log">
<a class="viewcode-back" href="../api_reference.html#pfr_app.write_to_log">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a message to the log buffer with timestamp and level.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    log_buffer : StringIO</span>
<span class="sd">        The log buffer to write to</span>
<span class="sd">    message : str</span>
<span class="sd">        The message to log</span>
<span class="sd">    level : str, optional</span>
<span class="sd">        Log level (INFO, WARNING, ERROR)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">log_buffer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
        
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">)</span>
    <span class="n">log_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>



<span class="n">initialize_session_state</span><span class="p">()</span>

<span class="n">st</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;_Photometry Factory for RAPAS_&quot;</span><span class="p">)</span>

<span class="c1"># Photometry parameters in sidebar</span>
<span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="p">:</span>
    <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Upload FITS Files&quot;</span><span class="p">)</span>
    
    <span class="c1"># Store uploaded files in session state</span>
    <span class="n">bias_file</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">file_uploader</span><span class="p">(</span><span class="s2">&quot;Master Bias (optional)&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fits&#39;</span><span class="p">,</span> <span class="s1">&#39;fit&#39;</span><span class="p">,</span> <span class="s1">&#39;fts&#39;</span><span class="p">],</span> 
                                <span class="n">key</span><span class="o">=</span><span class="s2">&quot;bias_uploader&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bias_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">files_loaded</span><span class="p">[</span><span class="s1">&#39;bias_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bias_file</span>
    
    <span class="n">dark_file</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">file_uploader</span><span class="p">(</span><span class="s2">&quot;Master Dark (optional)&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fits&#39;</span><span class="p">,</span> <span class="s1">&#39;fit&#39;</span><span class="p">,</span> <span class="s1">&#39;fts&#39;</span><span class="p">],</span>
                                <span class="n">key</span><span class="o">=</span><span class="s2">&quot;dark_uploader&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dark_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">files_loaded</span><span class="p">[</span><span class="s1">&#39;dark_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dark_file</span>
    
    <span class="n">flat_file</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">file_uploader</span><span class="p">(</span><span class="s2">&quot;Master Flat (optional)&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fits&#39;</span><span class="p">,</span> <span class="s1">&#39;fit&#39;</span><span class="p">,</span> <span class="s1">&#39;fts&#39;</span><span class="p">],</span>
                                <span class="n">key</span><span class="o">=</span><span class="s2">&quot;flat_uploader&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">flat_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">files_loaded</span><span class="p">[</span><span class="s1">&#39;flat_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flat_file</span>
    
    <span class="n">science_file</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">file_uploader</span><span class="p">(</span><span class="s2">&quot;Science Image (required)&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fits&#39;</span><span class="p">,</span> <span class="s1">&#39;fit&#39;</span><span class="p">,</span> <span class="s1">&#39;fts&#39;</span><span class="p">],</span> 
                                   <span class="n">key</span><span class="o">=</span><span class="s2">&quot;science_uploader&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">science_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">files_loaded</span><span class="p">[</span><span class="s1">&#39;science_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">science_file</span>
        
        <span class="c1"># Get base filename for logs and output</span>
        <span class="n">base_filename</span> <span class="o">=</span> <span class="n">get_base_filename</span><span class="p">(</span><span class="n">science_file</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;base_filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_filename</span>
        
        <span class="c1"># Initialize log</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;log_buffer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initialize_log</span><span class="p">(</span><span class="n">science_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    
     <span class="c1"># Also move calibration options to sidebar</span>
    <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Calibration Options&quot;</span><span class="p">)</span>
    <span class="n">calibrate_bias</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">checkbox</span><span class="p">(</span><span class="s2">&quot;Apply Bias&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Subtract bias frame from science image&quot;</span><span class="p">)</span>
    <span class="n">calibrate_dark</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">checkbox</span><span class="p">(</span><span class="s2">&quot;Apply Dark&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Subtract dark frame from science image&quot;</span><span class="p">)</span>
    <span class="n">calibrate_flat</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">checkbox</span><span class="p">(</span><span class="s2">&quot;Apply Flat Field&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Divide science image by flat field&quot;</span><span class="p">)</span>
    
    <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Analysis Parameters&quot;</span><span class="p">)</span>
    <span class="n">seeing</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">number_input</span><span class="p">(</span><span class="s2">&quot;Seeing (arcsec)&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span> 
                     <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Estimate of the atmospheric seeing in arcseconds&quot;</span><span class="p">)</span>
    <span class="n">threshold_sigma</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">number_input</span><span class="p">(</span><span class="s2">&quot;Detection Threshold (Ïƒ)&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
                              <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Source detection threshold in sigma above background&quot;</span><span class="p">)</span>
    <span class="n">detection_mask</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">slider</span><span class="p">(</span><span class="s2">&quot;Border Mask (pixels)&quot;</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span>
                           <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Size of border to exclude from source detection&quot;</span><span class="p">)</span>
    
    <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Gaia Parameters&quot;</span><span class="p">)</span>
    <span class="n">gaia_band</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span><span class="s2">&quot;Gaia Band&quot;</span><span class="p">,</span> 
                          <span class="p">[</span><span class="s2">&quot;phot_g_mean_mag&quot;</span><span class="p">,</span> <span class="s2">&quot;phot_bp_mean_mag&quot;</span><span class="p">,</span> <span class="s2">&quot;phot_rp_mean_mag&quot;</span><span class="p">],</span>
                          <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                          <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Gaia magnitude band to use for calibration&quot;</span><span class="p">)</span>
    <span class="n">gaia_min_mag</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">slider</span><span class="p">(</span><span class="s2">&quot;Gaia Min Magnitude&quot;</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">,</span> <span class="mf">12.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span>
                          <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Minimum magnitude for Gaia sources&quot;</span><span class="p">)</span>
    <span class="n">gaia_max_mag</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">slider</span><span class="p">(</span><span class="s2">&quot;Gaia Max Magnitude&quot;</span><span class="p">,</span> <span class="mf">16.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">,</span> <span class="mf">19.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span>
                          <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Maximum magnitude for Gaia sources&quot;</span><span class="p">)</span>
    
    <span class="c1"># Move catalog name to sidebar as well</span>
    <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Output Options&quot;</span><span class="p">)</span>
    <span class="n">default_catalog_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;base_filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_phot.csv&quot;</span>
    <span class="n">catalog_name</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span><span class="s2">&quot;Output Catalog Filename&quot;</span><span class="p">,</span> <span class="n">default_catalog_name</span><span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">link_button</span><span class="p">(</span><span class="s2">&quot;GAIA Archive&quot;</span><span class="p">,</span> <span class="s2">&quot;https://gea.esac.esa.int/archive/&quot;</span><span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">link_button</span><span class="p">(</span><span class="s2">&quot;Simbad&quot;</span><span class="p">,</span> <span class="s2">&quot;http://simbad.u-strasbg.fr/simbad/&quot;</span><span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">link_button</span><span class="p">(</span><span class="s2">&quot;VizieR&quot;</span><span class="p">,</span> <span class="s2">&quot;http://vizier.u-strasbg.fr/viz-bin/VizieR&quot;</span><span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">link_button</span><span class="p">(</span><span class="s2">&quot;NED&quot;</span><span class="p">,</span> <span class="s2">&quot;https://ned.ipac.caltech.edu/&quot;</span><span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">link_button</span><span class="p">(</span><span class="s2">&quot;ADS&quot;</span><span class="p">,</span> <span class="s2">&quot;https://ui.adsabs.harvard.edu/&quot;</span><span class="p">)</span>

<span class="c1"># Make sure the output directory exists</span>
<span class="n">output_dir</span> <span class="o">=</span> <span class="n">ensure_output_directory</span><span class="p">(</span><span class="s2">&quot;pfr_results&quot;</span><span class="p">)</span>
<span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;output_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_dir</span>

<span class="c1"># Main processing logic</span>
<span class="k">if</span> <span class="n">science_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">science_data</span><span class="p">,</span> <span class="n">science_header</span> <span class="o">=</span> <span class="n">load_fits_data</span><span class="p">(</span><span class="n">science_file</span><span class="p">)</span>
    <span class="n">bias_data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_fits_data</span><span class="p">(</span><span class="n">bias_file</span><span class="p">)</span>
    <span class="n">dark_data</span><span class="p">,</span> <span class="n">dark_header</span> <span class="o">=</span> <span class="n">load_fits_data</span><span class="p">(</span><span class="n">dark_file</span><span class="p">)</span>
    <span class="n">flat_data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_fits_data</span><span class="p">(</span><span class="n">flat_file</span><span class="p">)</span>

    <span class="c1"># Check if we have valid WCS in the header</span>
    <span class="n">wcs_obj</span><span class="p">,</span> <span class="n">wcs_error</span> <span class="o">=</span> <span class="n">safe_wcs_create</span><span class="p">(</span><span class="n">science_header</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">wcs_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid WCS found in the FITS header: </span><span class="si">{</span><span class="n">wcs_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Ask user if they want to solve with astrometry.net</span>
        <span class="n">use_astrometry</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">checkbox</span><span class="p">(</span>
            <span class="s2">&quot;Attempt plate solving with astrometry.net?&quot;</span><span class="p">,</span> 
            <span class="n">value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Uses the online astrometry.net service to determine WCS coordinates&quot;</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">use_astrometry</span><span class="p">:</span>
            <span class="c1"># Let user input their API key</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span>
                <span class="s2">&quot;Astrometry.net API Key&quot;</span><span class="p">,</span> 
                <span class="n">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> 
                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;password&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Get your key at https://nova.astrometry.net/api_help&quot;</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
                <span class="c1"># Try to solve with astrometry.net</span>
                <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">spinner</span><span class="p">(</span><span class="s2">&quot;Running plate solve with astrometry.net (this may take a while)...&quot;</span><span class="p">):</span>
                    <span class="n">wcs_obj</span><span class="p">,</span> <span class="n">science_header</span><span class="p">,</span> <span class="n">astrometry_msg</span> <span class="o">=</span> <span class="n">solve_with_astrometry_net</span><span class="p">(</span>
                        <span class="n">science_data</span><span class="p">,</span> <span class="n">science_header</span><span class="p">,</span> <span class="n">api_key</span>
                    <span class="p">)</span>
                    
                    <span class="c1"># Get log buffer from session state</span>
                    <span class="n">log_buffer</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;log_buffer&#39;</span><span class="p">]</span>
                    
                    <span class="k">if</span> <span class="n">wcs_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;Astrometry.net plate solving successful!&quot;</span><span class="p">)</span>
                        <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Solved plate with astrometry.net: </span><span class="si">{</span><span class="n">astrometry_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        
                        <span class="c1"># Save the updated header with WCS information to a file</span>
                        <span class="n">wcs_header_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;base_filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_wcs_header&quot;</span>
                        <span class="n">wcs_header_file_path</span> <span class="o">=</span> <span class="n">save_header_to_txt</span><span class="p">(</span><span class="n">science_header</span><span class="p">,</span> <span class="n">wcs_header_filename</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">wcs_header_file_path</span><span class="p">:</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updated WCS header saved&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Astrometry.net plate solving failed: </span><span class="si">{</span><span class="n">astrometry_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Failed to solve plate: </span><span class="si">{</span><span class="n">astrometry_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;ERROR&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Please enter your astrometry.net API key to proceed with plate solving.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;Valid WCS found in the FITS header.&quot;</span><span class="p">)</span>
        <span class="c1"># Get the log buffer from session state</span>
        <span class="n">log_buffer</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;log_buffer&#39;</span><span class="p">]</span>
        <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="s2">&quot;Valid WCS found in header&quot;</span><span class="p">)</span>

    <span class="c1"># Save header to text file</span>
    <span class="k">if</span> <span class="n">science_header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Get the log buffer from session state first</span>
        <span class="n">log_buffer</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;log_buffer&#39;</span><span class="p">]</span>
        
        <span class="c1"># Format current time for filename</span>
        <span class="n">timestamp_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
        
        <span class="c1"># Save the header to a text file with timestamp</span>
        <span class="n">header_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;base_filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_header&quot;</span>
        <span class="n">header_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">header_filename</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>
        
        <span class="n">header_file</span> <span class="o">=</span> <span class="n">save_header_to_txt</span><span class="p">(</span><span class="n">science_header</span><span class="p">,</span> <span class="n">header_filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">header_file</span><span class="p">:</span>
            <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Saved header to </span><span class="si">{</span><span class="n">header_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Log file loading</span>
    <span class="n">log_buffer</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;log_buffer&#39;</span><span class="p">]</span>
    <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Loaded science image: </span><span class="si">{</span><span class="n">science_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bias_file</span><span class="p">:</span>
        <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Loaded bias frame: </span><span class="si">{</span><span class="n">bias_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dark_file</span><span class="p">:</span>
        <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Loaded dark frame: </span><span class="si">{</span><span class="n">dark_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">flat_file</span><span class="p">:</span>
        <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Loaded flat field: </span><span class="si">{</span><span class="n">flat_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># If headers are None, create empty dictionaries to avoid errors</span>
    <span class="k">if</span> <span class="n">science_header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">science_header</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">dark_header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dark_header</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Science Image&quot;</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="s2">&quot;science-image&quot;</span><span class="p">)</span>
    
    <span class="c1"># Show the image with zscale stretching</span>
    <span class="k">if</span> <span class="n">science_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># First create the plot</span>
            <span class="n">fig_preview</span><span class="p">,</span> <span class="n">ax_preview</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZES</span><span class="p">[</span><span class="s1">&#39;medium&#39;</span><span class="p">])</span>
            
            <span class="c1"># Try ZScaleInterval first, fall back to simple normalization if that fails</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">science_data</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">ZScaleInterval</span><span class="p">())</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">ax_preview</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">science_data</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">norm_error</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ZScale normalization failed: </span><span class="si">{</span><span class="n">norm_error</span><span class="si">}</span><span class="s2">. Using simple normalization.&quot;</span><span class="p">)</span>
                <span class="c1"># Fall back to simple normalization</span>
                <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">science_data</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">99</span><span class="p">])</span>  <span class="c1"># Use percentiles to avoid outliers</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">ax_preview</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">science_data</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">)</span>
            
            <span class="n">fig_preview</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_preview</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pixel Value&#39;</span><span class="p">)</span>
            <span class="n">ax_preview</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">science_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ax_preview</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
            
            <span class="c1"># Display the plot first (before saving)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="n">fig_preview</span><span class="p">)</span>
            
            <span class="c1"># Save after displaying</span>
            <span class="n">timestamp_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
            <span class="n">image_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;base_filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_image.png&quot;</span>
            <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">image_filename</span><span class="p">)</span>
            
            <span class="c1"># Saving as separate step</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fig_preview</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
                <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="s2">&quot;Saved image plot&quot;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Image saved&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">save_error</span><span class="p">:</span>
                <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Failed to save image plot: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">save_error</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;ERROR&quot;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving image: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">save_error</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Clear the figure to avoid memory issues</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig_preview</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error displaying image: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>  <span class="c1"># Show full traceback for debugging</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No image data available to display. Check if the file was loaded correctly.&quot;</span><span class="p">)</span>

    <span class="c1"># Show header information</span>
    <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">expander</span><span class="p">(</span><span class="s2">&quot;Science Image Header&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">science_header</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">science_header</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No header information available for science image.&quot;</span><span class="p">)</span>

    <span class="c1"># Show basic statistics about the image</span>
    <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Science Image Statistics&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">science_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">stats_col1</span><span class="p">,</span> <span class="n">stats_col2</span><span class="p">,</span> <span class="n">stats_col3</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">stats_col1</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="s2">&quot;Mean&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">science_data</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">stats_col2</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="s2">&quot;Median&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">science_data</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">stats_col3</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="s2">&quot;Std Dev&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">science_data</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Get pixel scale and calculate estimated FWHM</span>
        <span class="n">pixel_size_arcsec</span><span class="p">,</span> <span class="n">pixel_scale_source</span> <span class="o">=</span> <span class="n">extract_pixel_scale</span><span class="p">(</span><span class="n">science_header</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="s2">&quot;Pixel Scale (arcsec/pixel)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pixel_size_arcsec</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (estimated from header)&quot;</span><span class="p">)</span>
        <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Pixel scale: </span><span class="si">{</span><span class="n">pixel_size_arcsec</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> arcsec/pixel (</span><span class="si">{</span><span class="n">pixel_scale_source</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">mean_fwhm_pixel</span> <span class="o">=</span> <span class="n">seeing</span> <span class="o">/</span> <span class="n">pixel_size_arcsec</span>
        <span class="n">st</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="s2">&quot;Mean FWHM (pixels)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mean_fwhm_pixel</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (estimated from seeing)&quot;</span><span class="p">)</span>
        <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Seeing FWHM: </span><span class="si">{</span><span class="n">seeing</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> arcsec (</span><span class="si">{</span><span class="n">mean_fwhm_pixel</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> pixels)&quot;</span><span class="p">)</span>
        
        <span class="c1"># Check if RA/DEC are missing from header</span>
        <span class="n">ra_val</span><span class="p">,</span> <span class="n">dec_val</span><span class="p">,</span> <span class="n">coord_source</span> <span class="o">=</span> <span class="n">extract_coordinates</span><span class="p">(</span><span class="n">science_header</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ra_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dec_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target: RA=</span><span class="si">{</span><span class="n">ra_val</span><span class="si">}</span><span class="s2">Â°, DEC=</span><span class="si">{</span><span class="n">dec_val</span><span class="si">}</span><span class="s2">Â°&quot;</span><span class="p">)</span>
            <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Target coordinates: RA=</span><span class="si">{</span><span class="n">ra_val</span><span class="si">}</span><span class="s2">Â°, DEC=</span><span class="si">{</span><span class="n">dec_val</span><span class="si">}</span><span class="s2">Â° (</span><span class="si">{</span><span class="n">coord_source</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">ra_missing</span> <span class="o">=</span> <span class="n">dec_missing</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Coordinate issue: </span><span class="si">{</span><span class="n">coord_source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Coordinate issue: </span><span class="si">{</span><span class="n">coord_source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;WARNING&quot;</span><span class="p">)</span>
            <span class="n">ra_missing</span> <span class="o">=</span> <span class="n">dec_missing</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Initialize session state for manual coordinates if needed</span>
        <span class="k">if</span> <span class="s1">&#39;manual_ra&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;manual_ra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;manual_dec&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;manual_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            
        <span class="c1"># If coordinates are missing, show input fields</span>
        <span class="k">if</span> <span class="n">ra_missing</span> <span class="ow">or</span> <span class="n">dec_missing</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Target coordinates (RA/DEC) not found in FITS header. Please enter them manually:&quot;</span><span class="p">)</span>
            
            <span class="n">coord_col1</span><span class="p">,</span> <span class="n">coord_col2</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="k">with</span> <span class="n">coord_col1</span><span class="p">:</span>
                <span class="c1"># Default to empty or center of image if available</span>
                <span class="n">default_ra</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;manual_ra&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">default_ra</span> <span class="ow">and</span> <span class="s1">&#39;NAXIS1&#39;</span> <span class="ow">in</span> <span class="n">science_header</span> <span class="ow">and</span> <span class="s1">&#39;CRPIX1&#39;</span> <span class="ow">in</span> <span class="n">science_header</span> <span class="ow">and</span> <span class="s1">&#39;CD1_1&#39;</span> <span class="ow">in</span> <span class="n">science_header</span><span class="p">:</span>
                    <span class="c1"># Try to estimate center RA from WCS if partial WCS exists</span>
                    <span class="n">default_ra</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                    
                <span class="n">manual_ra</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span>
                    <span class="s2">&quot;Right Ascension (degrees)&quot;</span><span class="p">,</span> 
                    <span class="n">value</span><span class="o">=</span><span class="n">default_ra</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enter RA in decimal degrees (0-360)&quot;</span><span class="p">,</span>
                    <span class="n">key</span><span class="o">=</span><span class="s2">&quot;ra_input&quot;</span>
                <span class="p">)</span>
                <span class="c1"># Store in session state</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;manual_ra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">manual_ra</span>
            
            <span class="k">with</span> <span class="n">coord_col2</span><span class="p">:</span>
                <span class="n">default_dec</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;manual_dec&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">default_dec</span> <span class="ow">and</span> <span class="s1">&#39;NAXIS2&#39;</span> <span class="ow">in</span> <span class="n">science_header</span> <span class="ow">and</span> <span class="s1">&#39;CRPIX2&#39;</span> <span class="ow">in</span> <span class="n">science_header</span> <span class="ow">and</span> <span class="s1">&#39;CD2_2&#39;</span> <span class="ow">in</span> <span class="n">science_header</span><span class="p">:</span>
                    <span class="c1"># Try to estimate center DEC from WCS if partial WCS exists</span>
                    <span class="n">default_dec</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                    
                <span class="n">manual_dec</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span>
                    <span class="s2">&quot;Declination (degrees)&quot;</span><span class="p">,</span> 
                    <span class="n">value</span><span class="o">=</span><span class="n">default_dec</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enter DEC in decimal degrees (-90 to +90)&quot;</span><span class="p">,</span>
                    <span class="n">key</span><span class="o">=</span><span class="s2">&quot;dec_input&quot;</span>
                <span class="p">)</span>
                <span class="c1"># Store in session state</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;manual_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">manual_dec</span>
            
            <span class="c1"># Add the manual coordinates to the header if provided</span>
            <span class="k">if</span> <span class="n">manual_ra</span> <span class="ow">and</span> <span class="n">manual_dec</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Validate input is numeric</span>
                    <span class="n">ra_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">manual_ra</span><span class="p">)</span>
                    <span class="n">dec_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">manual_dec</span><span class="p">)</span>
                    
                    <span class="c1"># Validate ranges</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">ra_val</span> <span class="o">&lt;</span> <span class="mi">360</span><span class="p">):</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;RA must be between 0 and 360 degrees&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mi">90</span> <span class="o">&lt;=</span> <span class="n">dec_val</span> <span class="o">&lt;=</span> <span class="mi">90</span><span class="p">):</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;DEC must be between -90 and +90 degrees&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Add to header and session state for persistence</span>
                        <span class="n">science_header</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ra_val</span>
                        <span class="n">science_header</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dec_val</span>
                        
                        <span class="c1"># Store the validated coordinates in a more permanent session state</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;valid_ra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ra_val</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;valid_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dec_val</span>
                        
                        <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using manual coordinates: RA=</span><span class="si">{</span><span class="n">ra_val</span><span class="si">}</span><span class="s2">Â°, DEC=</span><span class="si">{</span><span class="n">dec_val</span><span class="si">}</span><span class="s2">Â°&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;RA and DEC must be valid numbers&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Please enter both RA and DEC coordinates&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If header has coordinates, store them in session state</span>
            <span class="k">for</span> <span class="n">ra_key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">,</span> <span class="s1">&#39;OBJRA&#39;</span><span class="p">,</span> <span class="s1">&#39;RA---&#39;</span><span class="p">,</span> <span class="s1">&#39;CRVAL1&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">ra_key</span> <span class="ow">in</span> <span class="n">science_header</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;valid_ra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">science_header</span><span class="p">[</span><span class="n">ra_key</span><span class="p">]</span>
                    <span class="k">break</span>
                    
            <span class="k">for</span> <span class="n">dec_key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">,</span> <span class="s1">&#39;OBJDEC&#39;</span><span class="p">,</span> <span class="s1">&#39;DEC---&#39;</span><span class="p">,</span> <span class="s1">&#39;CRVAL2&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">dec_key</span> <span class="ow">in</span> <span class="n">science_header</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;valid_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">science_header</span><span class="p">[</span><span class="n">dec_key</span><span class="p">]</span>
                    <span class="k">break</span>

        <span class="c1"># Ensure the header has the coordinates from session state before calculating airmass</span>
        <span class="k">if</span> <span class="s1">&#39;valid_ra&#39;</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span> <span class="ow">and</span> <span class="s1">&#39;valid_dec&#39;</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
            <span class="n">science_header</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;valid_ra&#39;</span><span class="p">]</span>
            <span class="n">science_header</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;valid_dec&#39;</span><span class="p">]</span>

        <span class="c1"># Calculate airmass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">air</span> <span class="o">=</span> <span class="n">airmass</span><span class="p">(</span><span class="n">science_header</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Airmass: </span><span class="si">{</span><span class="n">air</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calculating airmass: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">air</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default airmass: </span><span class="si">{</span><span class="n">air</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Image calibration button</span>
        <span class="n">calibration_disabled</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span><span class="n">calibrate_bias</span> <span class="ow">or</span> <span class="n">calibrate_dark</span> <span class="ow">or</span> <span class="n">calibrate_flat</span><span class="p">)</span>
        <span class="n">exposure_time_science</span> <span class="o">=</span> <span class="n">science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;EXPOSURE&#39;</span><span class="p">,</span> <span class="n">science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
        <span class="n">exposure_time_dark</span> <span class="o">=</span> <span class="n">dark_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;EXPOSURE&#39;</span><span class="p">,</span> <span class="n">dark_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">,</span> <span class="n">exposure_time_science</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="s2">&quot;Run Image Calibration&quot;</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="n">calibration_disabled</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">spinner</span><span class="p">(</span><span class="s2">&quot;Calibrating image...&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">calibrated_data</span><span class="p">,</span> <span class="n">calibrated_header</span> <span class="o">=</span> <span class="n">calibrate_image_streamlit</span><span class="p">(</span>
                        <span class="n">science_data</span><span class="p">,</span> <span class="n">science_header</span><span class="p">,</span> <span class="n">bias_data</span><span class="p">,</span> <span class="n">dark_data</span><span class="p">,</span> <span class="n">flat_data</span><span class="p">,</span>
                        <span class="n">exposure_time_science</span><span class="p">,</span> <span class="n">exposure_time_dark</span><span class="p">,</span>
                        <span class="n">calibrate_bias</span><span class="p">,</span> <span class="n">calibrate_dark</span><span class="p">,</span> <span class="n">calibrate_flat</span>
                    <span class="p">)</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;calibrated_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calibrated_data</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;calibrated_header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calibrated_header</span>
                    
                    <span class="c1"># Show calibrated image</span>
                    <span class="k">if</span> <span class="n">calibrated_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Calibrated Science Image&quot;</span><span class="p">)</span>
                        <span class="n">norm_calibrated</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">calibrated_data</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">ZScaleInterval</span><span class="p">())</span>
                        <span class="n">fig_calibrated</span><span class="p">,</span> <span class="n">ax_calibrated</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZES</span><span class="p">[</span><span class="s1">&#39;medium&#39;</span><span class="p">],</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
                        <span class="n">im_calibrated</span> <span class="o">=</span> <span class="n">ax_calibrated</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">calibrated_data</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm_calibrated</span><span class="p">,</span>
                                                             <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">)</span>
                        <span class="n">fig_calibrated</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im_calibrated</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_calibrated</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pixel value&#39;</span><span class="p">)</span>
                        <span class="n">ax_calibrated</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Calibrated Image (zscale)&quot;</span><span class="p">)</span>
                        <span class="n">ax_calibrated</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="n">fig_calibrated</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during calibration: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Zero point calibration button</span>
        <span class="n">zero_point_button_disabled</span> <span class="o">=</span> <span class="n">science_file</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="s2">&quot;Run Zero Point Calibration&quot;</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="n">zero_point_button_disabled</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;run_zp&quot;</span><span class="p">):</span>
            <span class="c1"># Determine which data to use</span>
            <span class="n">image_to_process</span> <span class="o">=</span> <span class="n">science_data</span>  <span class="c1"># Default to raw science data</span>
            <span class="n">header_to_process</span> <span class="o">=</span> <span class="n">science_header</span>
            
            <span class="c1"># Use calibrated data if available</span>
            <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;calibrated_data&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">image_to_process</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;calibrated_data&#39;</span><span class="p">]</span>
                <span class="n">header_to_process</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;calibrated_header&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">image_to_process</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">spinner</span><span class="p">(</span><span class="s2">&quot;Background Extraction, Find Sources and Perform Photometry...&quot;</span><span class="p">):</span>
                        <span class="n">phot_table_qtable</span><span class="p">,</span> <span class="n">epsf_table</span><span class="p">,</span> <span class="n">daofind</span><span class="p">,</span> <span class="n">bkg</span> <span class="o">=</span> <span class="n">find_sources_and_photometry_streamlit</span><span class="p">(</span>
                            <span class="n">image_to_process</span><span class="p">,</span> <span class="n">header_to_process</span><span class="p">,</span> <span class="n">mean_fwhm_pixel</span><span class="p">,</span> <span class="n">threshold_sigma</span><span class="p">,</span> <span class="n">detection_mask</span>
                        <span class="p">)</span>
                        
                        <span class="c1"># Create a deep copy to avoid modifying the cached data</span>
                        <span class="k">if</span> <span class="n">phot_table_qtable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">phot_table_df</span> <span class="o">=</span> <span class="n">phot_table_qtable</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No sources detected in the image.&quot;</span><span class="p">)</span>
                            <span class="n">phot_table_df</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="k">if</span> <span class="n">phot_table_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">spinner</span><span class="p">(</span><span class="s2">&quot;Cross-matching with Gaia...&quot;</span><span class="p">):</span>
                            <span class="n">matched_table</span> <span class="o">=</span> <span class="n">cross_match_with_gaia_streamlit</span><span class="p">(</span>
                                <span class="n">phot_table_qtable</span><span class="p">,</span> <span class="n">header_to_process</span><span class="p">,</span> <span class="n">pixel_size_arcsec</span><span class="p">,</span> 
                                <span class="n">mean_fwhm_pixel</span><span class="p">,</span> <span class="n">gaia_band</span><span class="p">,</span> <span class="n">gaia_min_mag</span><span class="p">,</span> <span class="n">gaia_max_mag</span>
                            <span class="p">)</span>

                        <span class="k">if</span> <span class="n">matched_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Cross-matched Gaia Catalog (first 10 rows)&quot;</span><span class="p">)</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">matched_table</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

                            <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">spinner</span><span class="p">(</span><span class="s2">&quot;Calculating zero point...&quot;</span><span class="p">):</span>
                                <span class="n">zero_point_value</span><span class="p">,</span> <span class="n">zero_point_std</span><span class="p">,</span> <span class="n">zp_plot</span> <span class="o">=</span> <span class="n">calculate_zero_point_streamlit</span><span class="p">(</span>
                                    <span class="n">phot_table_qtable</span><span class="p">,</span> <span class="n">matched_table</span><span class="p">,</span> <span class="n">gaia_band</span><span class="p">,</span> <span class="n">air</span>
                                <span class="p">)</span>
                                
                                <span class="k">if</span> <span class="n">zero_point_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">st</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="n">zp_plot</span><span class="p">)</span>
                                    <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Zero point: </span><span class="si">{</span><span class="n">zero_point_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> Â± </span><span class="si">{</span><span class="n">zero_point_std</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                    <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Airmass: </span><span class="si">{</span><span class="n">air</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                    
                                    <span class="c1"># Prepare for download if final_phot_table exists in session state</span>
                                    <span class="k">if</span> <span class="s1">&#39;final_phot_table&#39;</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
                                        <span class="n">final_table</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;final_phot_table&#39;</span><span class="p">]</span>
                                        
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="c1"># Add EPSF photometry results if available</span>
                                            <span class="k">if</span> <span class="s1">&#39;epsf_photometry_result&#39;</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span> <span class="ow">and</span> <span class="n">epsf_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                                <span class="c1"># Convert tables to pandas if needed</span>
                                                <span class="n">epsf_df</span> <span class="o">=</span> <span class="n">epsf_table</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">epsf_table</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="k">else</span> <span class="n">epsf_table</span>
                                                
                                                <span class="c1"># Check what column names are used for coordinates</span>
                                                <span class="n">epsf_x_col</span> <span class="o">=</span> <span class="s1">&#39;x_fit&#39;</span> <span class="k">if</span> <span class="s1">&#39;x_fit&#39;</span> <span class="ow">in</span> <span class="n">epsf_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="s1">&#39;xcenter&#39;</span>
                                                <span class="n">epsf_y_col</span> <span class="o">=</span> <span class="s1">&#39;y_fit&#39;</span> <span class="k">if</span> <span class="s1">&#39;y_fit&#39;</span> <span class="ow">in</span> <span class="n">epsf_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="s1">&#39;ycenter&#39;</span>
                                                
                                                <span class="c1"># Find coordinate columns in final table</span>
                                                <span class="n">final_x_col</span> <span class="o">=</span> <span class="s1">&#39;xcenter&#39;</span> <span class="k">if</span> <span class="s1">&#39;xcenter&#39;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="s1">&#39;x_0&#39;</span>
                                                <span class="n">final_y_col</span> <span class="o">=</span> <span class="s1">&#39;ycenter&#39;</span> <span class="k">if</span> <span class="s1">&#39;ycenter&#39;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="s1">&#39;y_0&#39;</span>
                                                
                                                <span class="c1"># Add a unique ID for matching (based on x,y position)</span>
                                                <span class="k">if</span> <span class="n">epsf_x_col</span> <span class="ow">in</span> <span class="n">epsf_df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">epsf_y_col</span> <span class="ow">in</span> <span class="n">epsf_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                                                    <span class="n">epsf_df</span><span class="p">[</span><span class="s1">&#39;match_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsf_df</span><span class="p">[</span><span class="n">epsf_x_col</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">epsf_df</span><span class="p">[</span><span class="n">epsf_y_col</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                                                    
                                                <span class="k">if</span> <span class="n">final_x_col</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">final_y_col</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                                                    <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;match_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_table</span><span class="p">[</span><span class="n">final_x_col</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">final_table</span><span class="p">[</span><span class="n">final_y_col</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                                                <span class="k">else</span><span class="p">:</span>
                                                    <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Coordinate columns not found in final table. Available columns: </span><span class="si">{</span><span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                                    
                                                <span class="c1"># Select just the columns we need from EPSF results</span>
                                                <span class="n">epsf_cols</span> <span class="o">=</span> <span class="p">{}</span>
                                                <span class="n">epsf_cols</span><span class="p">[</span><span class="s1">&#39;match_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;match_id&#39;</span>
                                                <span class="n">epsf_cols</span><span class="p">[</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;epsf_flux_fit&#39;</span>
                                                <span class="n">epsf_cols</span><span class="p">[</span><span class="s1">&#39;flux_unc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;epsf_flux_unc&#39;</span>
                                                <span class="n">epsf_cols</span><span class="p">[</span><span class="s1">&#39;instrumental_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;epsf_instrumental_mag&#39;</span>
                                                
                                                <span class="c1"># Only continue if we have the necessary columns</span>
                                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">epsf_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s1">&#39;match_id&#39;</span> <span class="ow">in</span> <span class="n">epsf_df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s1">&#39;match_id&#39;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                                                    <span class="c1"># Select columns that actually exist</span>
                                                    <span class="n">epsf_subset</span> <span class="o">=</span> <span class="n">epsf_df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">epsf_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">epsf_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">epsf_cols</span><span class="p">)</span>
                                                    
                                                    <span class="c1"># Merge the EPSF results with the final table</span>
                                                    <span class="n">final_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">final_table</span><span class="p">,</span> <span class="n">epsf_subset</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;match_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
                                                    
                                                    <span class="c1"># Calculate calibrated magnitudes for EPSF photometry</span>
                                                    <span class="k">if</span> <span class="s1">&#39;epsf_instrumental_mag&#39;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                                                        <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;psf_calib_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;epsf_instrumental_mag&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">zero_point_value</span> <span class="o">+</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">air</span>
                                                        <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;Added EPSF photometry results to the catalog&quot;</span><span class="p">)</span>
                                                    
                                                    <span class="c1"># Ensure we have aperture photometry in the final table too</span>
                                                    <span class="k">if</span> <span class="s1">&#39;instrumental_mag&#39;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                                                        <span class="k">if</span> <span class="s1">&#39;calib_mag&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                                                            <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;aperture_instrumental_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;instrumental_mag&#39;</span><span class="p">]</span>
                                                            <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;aperture_calib_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;instrumental_mag&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">zero_point_value</span> <span class="o">+</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">air</span>
                                                        <span class="k">else</span><span class="p">:</span>
                                                            <span class="n">final_table</span> <span class="o">=</span> <span class="n">final_table</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                                                                <span class="s1">&#39;instrumental_mag&#39;</span><span class="p">:</span> <span class="s1">&#39;aperture_instrumental_mag&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;calib_mag&#39;</span><span class="p">:</span> <span class="s1">&#39;aperture_calib_mag&#39;</span>
                                                            <span class="p">})</span>
                                                        <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;Added aperture photometry results to the catalog&quot;</span><span class="p">)</span>
                                                    
                                                    <span class="c1"># Remove temporary match column</span>
                                                    <span class="n">final_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;match_id&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                            
                                            <span class="c1"># Create a StringIO buffer for CSV data</span>
                                            <span class="n">csv_buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
                                            
                                            <span class="c1"># Check and remove problematic columns if they exist</span>
                                            <span class="n">cols_to_drop</span> <span class="o">=</span> <span class="p">[]</span>
                                            <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sky_center.ra&#39;</span><span class="p">,</span> <span class="s1">&#39;sky_center.dec&#39;</span><span class="p">]:</span>
                                                <span class="k">if</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                                                    <span class="n">cols_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>
                                            
                                            <span class="k">if</span> <span class="n">cols_to_drop</span><span class="p">:</span>
                                                <span class="n">final_table</span> <span class="o">=</span> <span class="n">final_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols_to_drop</span><span class="p">)</span>
                                            
                                            <span class="c1"># Before writing to CSV, ensure match_id column is removed</span>
                                            <span class="k">if</span> <span class="s1">&#39;match_id&#39;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                                                <span class="n">final_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;match_id&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                            
                                            <span class="c1"># Add zero point information to the table</span>
                                            <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;zero_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero_point_value</span>
                                            <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;zero_point_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero_point_std</span>
                                            <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">air</span>
                                            
                                            <span class="c1"># Create a catalog summary in the UI</span>
                                            <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Final Photometry Catalog&quot;</span><span class="p">)</span>
                                            <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">final_table</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
                                            
                                            <span class="c1"># Show which columns are included</span>
                                            <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Catalog includes </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">final_table</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources.&quot;</span><span class="p">)</span>
                                            
                                            <span class="c1"># Add cross-matching functionality</span>
                                            <span class="k">if</span> <span class="s1">&#39;ra&#39;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s1">&#39;dec&#39;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                                                <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Cross-matching with Astronomical Catalogs&quot;</span><span class="p">)</span>
                                                <span class="c1"># Calculate search radius based on FWHM</span>
                                                <span class="n">search_radius</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mean_fwhm_pixel</span> <span class="o">*</span> <span class="n">pixel_size_arcsec</span>
                                                <span class="n">final_table</span> <span class="o">=</span> <span class="n">enhance_catalog_with_crossmatches</span><span class="p">(</span>
                                                    <span class="n">final_table</span><span class="p">,</span>
                                                    <span class="n">matched_table</span><span class="p">,</span>  <span class="c1"># Pass our Gaia-matched calibration table </span>
                                                    <span class="n">header_to_process</span><span class="p">,</span>
                                                    <span class="n">pixel_size_arcsec</span><span class="p">,</span> 
                                                    <span class="n">search_radius_arcsec</span><span class="o">=</span><span class="n">search_radius</span>
                                                <span class="p">)</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;RA/DEC coordinates not available for catalog cross-matching&quot;</span><span class="p">)</span>

                                            <span class="c1"># Write the filtered DataFrame to the buffer</span>
                                            <span class="n">final_table</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_buffer</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                                            <span class="n">csv_data</span> <span class="o">=</span> <span class="n">csv_buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

                                            <span class="c1"># Add timestamp to catalog filename</span>
                                            <span class="n">timestamp_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
                                            <span class="n">base_catalog_name</span> <span class="o">=</span> <span class="n">catalog_name</span>
                                            <span class="k">if</span> <span class="n">base_catalog_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">):</span>
                                                <span class="n">base_catalog_name</span> <span class="o">=</span> <span class="n">base_catalog_name</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
                                            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_catalog_name</span><span class="si">}</span><span class="s2">.csv&quot;</span>

                                            <span class="c1"># Save to rapas_results directory</span>
                                            <span class="n">catalog_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

                                            <span class="c1"># Provide download button with better formatting</span>
                                            <span class="n">download_link</span> <span class="o">=</span> <span class="n">get_download_link</span><span class="p">(</span>
                                                <span class="n">csv_data</span><span class="p">,</span> 
                                                <span class="n">filename</span><span class="p">,</span> 
                                                <span class="n">link_text</span><span class="o">=</span><span class="s2">&quot;Download Photometry Catalog&quot;</span>
                                            <span class="p">)</span>
                                            <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="n">download_link</span><span class="p">,</span> <span class="n">unsafe_allow_html</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                                            <span class="c1"># Also save locally in the output directory</span>
                                            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">catalog_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">csv_data</span><span class="p">)</span>
                                            
                                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error preparing download: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to cross-match with Gaia catalog. Check WCS information in image header.&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during zero point calibration: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>  <span class="c1"># This will show the full traceback for debugging</span>

                <span class="c1"># Display DSS2 color view with detected sources</span>
                <span class="c1"># st.subheader(&quot;DSS2 Color View&quot;)</span>

                <span class="c1"># Extract RA/DEC from header or WCS</span>
                <span class="n">ra_center</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">dec_center</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="s1">&#39;CRVAL1&#39;</span> <span class="ow">in</span> <span class="n">header_to_process</span> <span class="ow">and</span> <span class="s1">&#39;CRVAL2&#39;</span> <span class="ow">in</span> <span class="n">header_to_process</span><span class="p">:</span>
                    <span class="n">ra_center</span> <span class="o">=</span> <span class="n">header_to_process</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span>
                    <span class="n">dec_center</span> <span class="o">=</span> <span class="n">header_to_process</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s1">&#39;RA&#39;</span> <span class="ow">in</span> <span class="n">header_to_process</span> <span class="ow">and</span> <span class="s1">&#39;DEC&#39;</span> <span class="ow">in</span> <span class="n">header_to_process</span><span class="p">:</span>
                    <span class="n">ra_center</span> <span class="o">=</span> <span class="n">header_to_process</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]</span>
                    <span class="n">dec_center</span> <span class="o">=</span> <span class="n">header_to_process</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s1">&#39;OBJRA&#39;</span> <span class="ow">in</span> <span class="n">header_to_process</span> <span class="ow">and</span> <span class="s1">&#39;OBJDEC&#39;</span> <span class="ow">in</span> <span class="n">header_to_process</span><span class="p">:</span>
                    <span class="n">ra_center</span> <span class="o">=</span> <span class="n">header_to_process</span><span class="p">[</span><span class="s1">&#39;OBJRA&#39;</span><span class="p">]</span>
                    <span class="n">dec_center</span> <span class="o">=</span> <span class="n">header_to_process</span><span class="p">[</span><span class="s1">&#39;OBJDEC&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">ra_center</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dec_center</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># st.write(f&quot;Aladin view centered at RA={ra_center}, DEC={dec_center}&quot;)</span>
    
                    <span class="c1"># Create a button to open Aladin in a new tab with catalog</span>
                    <span class="k">if</span> <span class="s1">&#39;final_phot_table&#39;</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;final_phot_table&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                        <span class="c1"># Create URL with parameters</span>
                        <span class="n">aladin_href</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;./static/aladin_static.html?ra=</span><span class="si">{</span><span class="n">ra_center</span><span class="si">}</span><span class="s2">&amp;dec=</span><span class="si">{</span><span class="n">dec_center</span><span class="si">}</span><span class="s2">&quot;</span>
                        
                        <span class="c1"># Create HTML link that opens in a new tab</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                            &lt;a href=&quot;</span><span class="si">{</span><span class="n">aladin_href</span><span class="si">}</span><span class="s2">&quot; target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; </span>
<span class="s2">                               style=&quot;display: inline-block; padding: 0.6em 1.2em; </span>
<span class="s2">                                     color: white; background-color: #4CAF50; </span>
<span class="s2">                                     text-decoration: none; font-weight: 600;</span>
<span class="s2">                                     border-radius: 0.25rem; cursor: pointer;&quot;&gt;</span>
<span class="s2">                                Open Aladin Catalog Viewer in New Tab</span>
<span class="s2">                            &lt;/a&gt;</span>
<span class="s2">                            &lt;p style=&quot;font-size: 0.9em; margin-top: 5px;&quot;&gt;</span>
<span class="s2">                                After opening Aladin, upload the catalog CSV file you downloaded above.</span>
<span class="s2">                            &lt;/p&gt;</span>
<span class="s2">                            &quot;&quot;&quot;</span><span class="p">,</span> 
                            <span class="n">unsafe_allow_html</span><span class="o">=</span><span class="kc">True</span>
                        <span class="p">)</span>
                    
                    <span class="c1"># Add ESA Sky button with target coordinates</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">link_button</span><span class="p">(</span>
                        <span class="s2">&quot;ESA Sky&quot;</span><span class="p">,</span> 
                        <span class="sa">f</span><span class="s2">&quot;https://sky.esa.int/esasky/?target=</span><span class="si">{</span><span class="n">ra_center</span><span class="si">}</span><span class="s2">%20</span><span class="si">{</span><span class="n">dec_center</span><span class="si">}</span><span class="s2">&amp;hips=DSS2+color&amp;fov=1&amp;projection=SIN&amp;cooframe=J2000&amp;sci=true&amp;lang=en&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Open ESA Sky with the same target coordinates&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not determine coordinates from image header. Cannot display PanSTARRS view.&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ðŸ‘† Please upload a science image FITS file to start.&quot;</span><span class="p">)</span>


<span class="c1"># Save log file only if we have a log buffer</span>
<span class="k">if</span> <span class="s1">&#39;log_buffer&#39;</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span> <span class="ow">and</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;log_buffer&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">log_buffer</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;log_buffer&#39;</span><span class="p">]</span>
    <span class="c1"># Remove timestamp from log filename</span>
    <span class="n">log_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;base_filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.log&quot;</span>
    <span class="n">log_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">log_filename</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1"># Add final timestamp</span>
        <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="s2">&quot;Processing completed&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log_buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Log saved to </span><span class="si">{</span><span class="n">log_filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Pier-Francesco Rocci.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>