

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pfr_app &mdash; Photometry Factory for RAPAS 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=01f34227"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Photometry Factory for RAPAS
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage.html">Usage Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">Examples</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Photometry Factory for RAPAS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">pfr_app</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pfr_app</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s2">&quot;frozen&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">importlib.metadata</span>

    <span class="n">importlib</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">distributions</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="p">[]</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">platform</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">quote</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">SkyCoord</span><span class="p">,</span> <span class="n">EarthLocation</span><span class="p">,</span> <span class="n">AltAz</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.time</span><span class="w"> </span><span class="kn">import</span> <span class="n">Time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_sun</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astroquery.simbad</span><span class="w"> </span><span class="kn">import</span> <span class="n">Simbad</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astroquery.vizier</span><span class="w"> </span><span class="kn">import</span> <span class="n">Vizier</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.modeling</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">fitting</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">streamlit</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">st</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">streamlit.components.v1</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">components</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">sigma_clip</span><span class="p">,</span> <span class="n">SigmaClip</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.units</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">u</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astroquery.gaia</span><span class="w"> </span><span class="kn">import</span> <span class="n">Gaia</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.detection</span><span class="w"> </span><span class="kn">import</span> <span class="n">DAOStarFinder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.aperture</span><span class="w"> </span><span class="kn">import</span> <span class="n">CircularAperture</span><span class="p">,</span> <span class="n">aperture_photometry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.background</span><span class="w"> </span><span class="kn">import</span> <span class="n">Background2D</span><span class="p">,</span> <span class="n">SExtractorBackground</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">ZScaleInterval</span><span class="p">,</span> <span class="n">ImageNormalize</span><span class="p">,</span> <span class="n">simple_norm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">StringIO</span><span class="p">,</span> <span class="n">BytesIO</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.wcs</span><span class="w"> </span><span class="kn">import</span> <span class="n">WCS</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.psf</span><span class="w"> </span><span class="kn">import</span> <span class="n">EPSFBuilder</span><span class="p">,</span> <span class="n">extract_stars</span><span class="p">,</span> <span class="n">IterativePSFPhotometry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.nddata</span><span class="w"> </span><span class="kn">import</span> <span class="n">NDData</span>

<span class="c1"># from stdpipe import astrometry, catalogs, pipeline</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>


<span class="n">st</span><span class="o">.</span><span class="n">set_page_config</span><span class="p">(</span>
    <span class="n">page_title</span><span class="o">=</span><span class="s2">&quot;Photometry Factory for RAPAS&quot;</span><span class="p">,</span> <span class="n">page_icon</span><span class="o">=</span><span class="s2">&quot;ðŸ”­&quot;</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;wide&quot;</span>
<span class="p">)</span>

<span class="c1"># Add application version to the sidebar</span>
<span class="n">APP_VERSION</span> <span class="o">=</span> <span class="s2">&quot;1.0.0&quot;</span>
<span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**App Version:** </span><span class="si">{</span><span class="n">APP_VERSION</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Custom CSS to control plot display size</span>
<span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">&lt;style&gt;</span>
<span class="sd">    .stPlot &gt; div {</span>
<span class="sd">        display: flex;</span>
<span class="sd">        justify-content: center;</span>
<span class="sd">        min-height: 400px;</span>
<span class="sd">    }</span>
<span class="sd">    .main .block-container {</span>
<span class="sd">        max-width: 1200px;</span>
<span class="sd">        padding-top: 2rem;</span>
<span class="sd">        padding-bottom: 2rem;</span>
<span class="sd">    }</span>
<span class="sd">    .element-container img {</span>
<span class="sd">        max-width: 100% !important;</span>
<span class="sd">        height: auto !important;</span>
<span class="sd">    }</span>
<span class="sd">&lt;/style&gt;</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">unsafe_allow_html</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Define standard figure sizes to use throughout the app</span>
<span class="n">FIGURE_SIZES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;small&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>  <span class="c1"># For small plots</span>
    <span class="s2">&quot;medium&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>  <span class="c1"># For medium plots</span>
    <span class="s2">&quot;large&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>  <span class="c1"># For large plots</span>
    <span class="s2">&quot;wide&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>  <span class="c1"># For wide plots</span>
    <span class="s2">&quot;stars_grid&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>  <span class="c1"># For grid of stars</span>
<span class="p">}</span>

<span class="n">URL</span> <span class="o">=</span> <span class="s1">&#39;https://astro-colibri.science&#39;</span>


<div class="viewcode-block" id="getJson">
<a class="viewcode-back" href="../api.html#pfr_app.getJson">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">getJson</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">json</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch JSON data from a given URL and handle errors gracefully.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    url : str</span>
<span class="sd">        The URL to fetch JSON data from</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    json</span>
<span class="sd">        Parsed JSON data if successful, or error message in JSON format if failed</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Handles network errors and JSON parsing errors.</span>
<span class="sd">    - Returns an error message in JSON format if the request fails or the response is empty.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;invalid URL&quot;</span><span class="p">})</span>
    <span class="c1"># if not url.endswith(&quot;.json&quot;):</span>
    <span class="c1">#     return json.dumps({&quot;error&quot;: &quot;not a JSON file&quot;})</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Send a GET request to the provided URL using the requests library</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="c1"># Raise an error if the request was not successful</span>
        <span class="n">req</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="c1"># Check if the response has any content</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
            <span class="c1"># If the response is empty, return an error message as JSON</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;empty response&quot;</span><span class="p">})</span>
        <span class="c1"># If the response has content, parse it as JSON and return it</span>
        <span class="k">return</span> <span class="n">req</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># If there was an error making the request, return an error message as JSON</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;request exception&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># If there was an error parsing the JSON, return an error message as JSON</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;invalid json&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span></div>



<div class="viewcode-block" id="solve_with_astrometry_net">
<a class="viewcode-back" href="../api.html#pfr_app.solve_with_astrometry_net">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">solve_with_astrometry_net</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Solve astrometric plate using the astrometry.net web API.</span>

<span class="sd">    This function sends an image to the astrometry.net service to determine</span>
<span class="sd">    accurate WCS (World Coordinate System) information. It handles retries</span>
<span class="sd">    and extracting metadata from the header to aid in solving.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image_data : numpy.ndarray</span>
<span class="sd">        The 2D image array to solve</span>
<span class="sd">    header : astropy.io.fits.Header or dict, optional</span>
<span class="sd">        FITS header with any available metadata to help the solver,</span>
<span class="sd">        such as approximate coordinates or pixel scale</span>
<span class="sd">    api_key : str, optional</span>
<span class="sd">        Astrometry.net API key. If not provided, will look in environment variables.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (wcs_object, updated_header, status_message) where:</span>
<span class="sd">        - wcs_object: astropy.wcs.WCS object if successful, None if failed</span>
<span class="sd">        - updated_header: Header with WCS keywords added if successful</span>
<span class="sd">        - status_message: String explaining the result or error</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function will use any available metadata in the header to constrain</span>
<span class="sd">    the search, including RA/Dec and pixel scale, which can significantly</span>
<span class="sd">    improve solving speed and accuracy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">astroquery.astrometry_net</span><span class="w"> </span><span class="kn">import</span> <span class="n">AstrometryNetClass</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

        <span class="k">if</span> <span class="n">api_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ASTROMETRY_API_KEY&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">api_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">header</span><span class="p">,</span>
                    <span class="s2">&quot;No API key provided or found in environment variables&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">ast</span> <span class="o">=</span> <span class="n">AstrometryNetClass</span><span class="p">()</span>
        <span class="n">ast</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>

        <span class="n">solve_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">extract_coordinates</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">solve_kwargs</span><span class="p">[</span><span class="s2">&quot;center_ra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ra</span>
                <span class="n">solve_kwargs</span><span class="p">[</span><span class="s2">&quot;center_dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dec</span>
                <span class="n">solve_kwargs</span><span class="p">[</span><span class="s2">&quot;radius&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="n">scale</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">extract_pixel_scale</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scale</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">solve_kwargs</span><span class="p">[</span><span class="s2">&quot;scale_lower&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="mf">0.8</span>
                <span class="n">solve_kwargs</span><span class="p">[</span><span class="s2">&quot;scale_upper&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="mf">1.2</span>

        <span class="n">try_idx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">max_tries</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">wcs_header</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">while</span> <span class="n">try_idx</span> <span class="o">&lt;=</span> <span class="n">max_tries</span> <span class="ow">and</span> <span class="n">wcs_header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.fits&quot;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">file_path</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">image_data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">())</span>
                    <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Submitting image to astrometry.net (attempt </span><span class="si">{</span><span class="n">try_idx</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">max_tries</span><span class="si">}</span><span class="s2">)...&quot;</span>
                    <span class="p">)</span>
                    <span class="n">wcs_header</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">solve_from_image</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="o">**</span><span class="n">solve_kwargs</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Error with file upload: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">. Trying with image data directly...&quot;</span>
                    <span class="p">)</span>
                    <span class="n">wcs_header</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">solve_from_image</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="o">**</span><span class="n">solve_kwargs</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">file_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">try_idx</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Astrometry.net attempt </span><span class="si">{</span><span class="n">try_idx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">wcs_header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Astrometry.net failed after </span><span class="si">{</span><span class="n">max_tries</span><span class="si">}</span><span class="s2"> attempts&quot;</span>

        <span class="n">wcs_obj</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">wcs_header</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">wcs_header</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;SIMPLE&quot;</span><span class="p">,</span> <span class="s2">&quot;BITPIX&quot;</span><span class="p">,</span> <span class="s2">&quot;NAXIS&quot;</span><span class="p">,</span> <span class="s2">&quot;NAXIS1&quot;</span><span class="p">,</span> <span class="s2">&quot;NAXIS2&quot;</span><span class="p">,</span> <span class="s2">&quot;EXTEND&quot;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;HISTORY&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;COMMENT&quot;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;ASTRSRC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;astrometry.net&quot;</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;ASTRTRY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">try_idx</span>

        <span class="k">return</span> <span class="n">wcs_obj</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="s2">&quot;Astrometry.net solution successful&quot;</span>

    <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Required packages not installed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Error solving with astrometry.net: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span></div>



<div class="viewcode-block" id="ensure_output_directory">
<a class="viewcode-back" href="../api.html#pfr_app.ensure_output_directory">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ensure_output_directory</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s2">&quot;pfr_results&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create an output directory if it doesn&#39;t exist.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    directory : str, optional</span>
<span class="sd">        Path to the directory to create. Default is &quot;pfr_results&quot;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Path to the created/existing output directory, or &quot;.&quot; (current directory)</span>
<span class="sd">        if creation failed</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Will attempt to create the directory and display a warning in Streamlit</span>
<span class="sd">    if creation fails. In case of failure, returns the current directory as fallback.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">directory</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not create directory &#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;.&quot;</span>
    <span class="k">return</span> <span class="n">directory</span></div>



<div class="viewcode-block" id="safe_wcs_create">
<a class="viewcode-back" href="../api.html#pfr_app.safe_wcs_create">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">safe_wcs_create</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a WCS (World Coordinate System) object from a FITS header with robust error handling.</span>

<span class="sd">    This function validates the header contains required WCS keywords before attempting</span>
<span class="sd">    to create a WCS object, and properly handles various edge cases and errors.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    header : dict or astropy.io.fits.Header</span>
<span class="sd">        FITS header containing WCS information</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (wcs_object, None) if successful, (None, error_message) if failed, where:</span>
<span class="sd">        - wcs_object: astropy.wcs.WCS object</span>
<span class="sd">        - error_message: String describing the error if WCS creation failed</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function checks for required WCS keywords and validates the resulting</span>
<span class="sd">    WCS object. For higher dimensional data, it will reduce the WCS to celestial</span>
<span class="sd">    coordinates only.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">header</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;No header provided&quot;</span>

    <span class="n">required_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CTYPE1&quot;</span><span class="p">,</span> <span class="s2">&quot;CTYPE2&quot;</span><span class="p">,</span> <span class="s2">&quot;CRVAL1&quot;</span><span class="p">,</span> <span class="s2">&quot;CRVAL2&quot;</span><span class="p">,</span> <span class="s2">&quot;CRPIX1&quot;</span><span class="p">,</span> <span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span>
    <span class="n">missing_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">required_keys</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">missing_keys</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Missing required WCS keywords: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_keys</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">wcs_obj</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">wcs_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;WCS creation returned None&quot;</span>

        <span class="k">if</span> <span class="n">wcs_obj</span><span class="o">.</span><span class="n">pixel_n_dim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">wcs_obj</span> <span class="o">=</span> <span class="n">wcs_obj</span><span class="o">.</span><span class="n">celestial</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">wcs_obj</span><span class="p">,</span> <span class="s2">&quot;wcs&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Created WCS object has no transformation attributes&quot;</span>

        <span class="k">return</span> <span class="n">wcs_obj</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;WCS creation error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span></div>



<div class="viewcode-block" id="estimate_background">
<a class="viewcode-back" href="../api.html#pfr_app.estimate_background">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">estimate_background</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">box_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">filter_size</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimate the background and background RMS of an astronomical image.</span>

<span class="sd">    Uses photutils.Background2D to create a 2D background model with sigma-clipping</span>
<span class="sd">    and the SExtractor background estimation algorithm. Includes error handling</span>
<span class="sd">    and automatic adjustment for small images.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image_data : numpy.ndarray</span>
<span class="sd">        The 2D science image array</span>
<span class="sd">    box_size : int, optional</span>
<span class="sd">        The box size in pixels for the local background estimation.</span>
<span class="sd">        Will be automatically adjusted if the image is small.</span>
<span class="sd">    filter_size : int, optional</span>
<span class="sd">        Size of the filter for smoothing the background.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (background_2d_object, error_message) where:</span>
<span class="sd">        - background_2d_object: photutils.Background2D object if successful, None if failed</span>
<span class="sd">        - error_message: None if successful, string describing the error if failed</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function automatically adjusts the box_size and filter_size parameters</span>
<span class="sd">    if the image is too small, and handles various edge cases to ensure robust</span>
<span class="sd">    background estimation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">image_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;No image data provided&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Image data must be a numpy array, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Image must be 2D, got shape </span><span class="si">{</span><span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">image_data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">adjusted_box_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">box_size</span><span class="p">,</span> <span class="n">height</span> <span class="o">//</span> <span class="mi">4</span><span class="p">,</span> <span class="n">width</span> <span class="o">//</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">adjusted_filter_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">filter_size</span><span class="p">,</span> <span class="n">adjusted_box_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">adjusted_box_size</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Image too small (</span><span class="si">{</span><span class="n">height</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s2">) for background estimation&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">sigma_clip</span> <span class="o">=</span> <span class="n">SigmaClip</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">bkg_estimator</span> <span class="o">=</span> <span class="n">SExtractorBackground</span><span class="p">()</span>

        <span class="n">bkg</span> <span class="o">=</span> <span class="n">Background2D</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">image_data</span><span class="p">,</span>
            <span class="n">box_size</span><span class="o">=</span><span class="n">adjusted_box_size</span><span class="p">,</span>
            <span class="n">filter_size</span><span class="o">=</span><span class="n">adjusted_filter_size</span><span class="p">,</span>
            <span class="n">sigma_clip</span><span class="o">=</span><span class="n">sigma_clip</span><span class="p">,</span>
            <span class="n">bkg_estimator</span><span class="o">=</span><span class="n">bkg_estimator</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">bkg</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Background estimation error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">get_header_value</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract a value from a FITS header by trying multiple possible keywords.</span>

<span class="sd">    This is useful for handling FITS files with different keyword conventions.</span>
<span class="sd">    The function tries each key in the provided list in order of preference.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    header : dict or astropy.io.fits.Header</span>
<span class="sd">        The FITS header dictionary</span>
<span class="sd">    keys : list of str</span>
<span class="sd">        List of possible header keywords to try in order of preference</span>
<span class="sd">    default : any, optional</span>
<span class="sd">        Default value to return if none of the keys are found</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    any</span>
<span class="sd">        The header value corresponding to the first found key,</span>
<span class="sd">        or the default value if no keys are found</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; # Try different exposure time keywords</span>
<span class="sd">    &gt;&gt;&gt; exposure = get_header_value(header, [&#39;EXPTIME&#39;, &#39;EXPOSURE&#39;, &#39;EXP&#39;], 0.0)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">default</span>


<div class="viewcode-block" id="extract_pixel_scale">
<a class="viewcode-back" href="../api.html#pfr_app.extract_pixel_scale">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_pixel_scale</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the pixel scale (arcsec/pixel) from a FITS header.</span>

<span class="sd">    Tries multiple approaches to determine the pixel scale:</span>
<span class="sd">    1. Direct pixel scale keywords (PIXSIZE, PIXSCALE, etc.)</span>
<span class="sd">    2. WCS CDELT keywords</span>
<span class="sd">    3. Calculation from physical pixel size and focal length</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    header : dict or astropy.io.fits.Header</span>
<span class="sd">        FITS header with metadata</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (pixel_scale_value, source_description) where:</span>
<span class="sd">        - pixel_scale_value: Float value of pixel scale in arcseconds per pixel</span>
<span class="sd">        - source_description: String describing how the value was determined</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Returns a default value of 1.0 arcsec/pixel if no pixel scale information</span>
<span class="sd">    can be determined from the header.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;default (no header)&quot;</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;PIXSIZE&quot;</span><span class="p">,</span> <span class="s2">&quot;PIXSCALE&quot;</span><span class="p">,</span> <span class="s2">&quot;PIXELSCAL&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;CDELT2&quot;</span><span class="p">,</span> <span class="s2">&quot;CDELT1&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">*</span> <span class="mf">3600.0</span>
            <span class="k">return</span> <span class="n">scale</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;XPIXSZ&quot;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;FOCALLEN&quot;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">focal_length_mm</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;FOCALLEN&quot;</span><span class="p">]</span>
            <span class="n">pixel_size</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;XPIXSZ&quot;</span><span class="p">]</span>

            <span class="n">xpixsz_unit</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XPIXSZU&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">xpixsz_unit</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;arcsec&quot;</span><span class="p">,</span> <span class="s2">&quot;as&quot;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="s2">&quot;from XPIXSZ (in arcsec)&quot;</span>
            <span class="k">elif</span> <span class="n">xpixsz_unit</span> <span class="o">==</span> <span class="s2">&quot;mm&quot;</span><span class="p">:</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">pixel_size</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">focal_length_mm</span> <span class="o">*</span> <span class="mf">206.265</span>
                <span class="k">return</span> <span class="n">scale</span><span class="p">,</span> <span class="s2">&quot;calculated from XPIXSZ (mm) and FOCALLEN&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="n">pixel_size</span> <span class="o">/</span> <span class="n">focal_length_mm</span> <span class="o">*</span> <span class="mf">206.265</span>
                <span class="k">return</span> <span class="n">scale</span><span class="p">,</span> <span class="s2">&quot;calculated from XPIXSZ (Î¼m) and FOCALLEN&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;XPIXSZ&quot;</span><span class="p">],</span> <span class="s2">&quot;from XPIXSZ (assumed arcsec)&quot;</span>

    <span class="k">return</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;default fallback value&quot;</span></div>



<div class="viewcode-block" id="extract_coordinates">
<a class="viewcode-back" href="../api.html#pfr_app.extract_coordinates">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_coordinates</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract celestial coordinates (RA/Dec) from a FITS header.</span>

<span class="sd">    Tries multiple possible coordinate keywords and validates the values</span>
<span class="sd">    are within reasonable ranges.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    header : dict or astropy.io.fits.Header</span>
<span class="sd">        FITS header containing coordinate information</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (ra, dec, source_description) where:</span>
<span class="sd">        - ra: Right Ascension value in degrees or None if not found/invalid</span>
<span class="sd">        - dec: Declination value in degrees or None if not found/invalid</span>
<span class="sd">        - source_description: String describing the source keywords or error message</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Coordinates are validated to ensure RA is between -360 and 360 degrees</span>
<span class="sd">    and DEC is between -90 and 90 degrees. Values outside these ranges will</span>
<span class="sd">    be rejected with an appropriate error message.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;No header available&quot;</span>

    <span class="n">ra_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;RA&quot;</span><span class="p">,</span> <span class="s2">&quot;OBJRA&quot;</span><span class="p">,</span> <span class="s2">&quot;RA---&quot;</span><span class="p">,</span> <span class="s2">&quot;CRVAL1&quot;</span><span class="p">]</span>
    <span class="n">dec_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;DEC&quot;</span><span class="p">,</span> <span class="s2">&quot;OBJDEC&quot;</span><span class="p">,</span> <span class="s2">&quot;DEC---&quot;</span><span class="p">,</span> <span class="s2">&quot;CRVAL2&quot;</span><span class="p">]</span>

    <span class="n">ra</span> <span class="o">=</span> <span class="n">get_header_value</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">ra_keys</span><span class="p">)</span>
    <span class="n">dec</span> <span class="o">=</span> <span class="n">get_header_value</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">dec_keys</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ra_source</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ra_keys</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">header</span><span class="p">),</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
        <span class="n">dec_source</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dec_keys</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">header</span><span class="p">),</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ra_source</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">dec_source</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ra_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span>
            <span class="n">dec_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mi">360</span> <span class="o">&lt;=</span> <span class="n">ra_val</span> <span class="o">&lt;=</span> <span class="mi">360</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Invalid RA value: </span><span class="si">{</span><span class="n">ra_val</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mi">90</span> <span class="o">&lt;=</span> <span class="n">dec_val</span> <span class="o">&lt;=</span> <span class="mi">90</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Invalid DEC value: </span><span class="si">{</span><span class="n">dec_val</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">return</span> <span class="n">ra_val</span><span class="p">,</span> <span class="n">dec_val</span><span class="p">,</span> <span class="n">source</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Non-numeric coordinates: RA=</span><span class="si">{</span><span class="n">ra</span><span class="si">}</span><span class="s2">, DEC=</span><span class="si">{</span><span class="n">dec</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Coordinates not found in header&quot;</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">safe_catalog_query</span><span class="p">(</span><span class="n">query_func</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute an astronomical catalog query with comprehensive error handling.</span>

<span class="sd">    This function wraps catalog query functions (like those from astroquery)</span>
<span class="sd">    with standardized error handling to catch network issues, timeouts,</span>
<span class="sd">    and other common problems when querying online services.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    query_func : callable</span>
<span class="sd">        The catalog query function to call</span>
<span class="sd">    error_msg : str</span>
<span class="sd">        Base error message to prepend to any caught exception message</span>
<span class="sd">    *args, **kwargs</span>
<span class="sd">        Arguments to pass through to query_func</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (result, error_message) where:</span>
<span class="sd">        - result: Query result object if successful, None if failed</span>
<span class="sd">        - error_message: None if successful, string describing the error if failed</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from astroquery.simbad import Simbad</span>
<span class="sd">    &gt;&gt;&gt; result, error = safe_catalog_query(</span>
<span class="sd">    ...     Simbad.query_object,</span>
<span class="sd">    ...     &quot;Failed to query SIMBAD&quot;,</span>
<span class="sd">    ...     &quot;M31&quot;</span>
<span class="sd">    ... )</span>
<span class="sd">    &gt;&gt;&gt; if error:</span>
<span class="sd">    ...     print(f&quot;Query failed: {error}&quot;)</span>
<span class="sd">    &gt;&gt;&gt; else:</span>
<span class="sd">    ...     print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">query_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">: Network error - </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">: Query timed out&quot;</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">: Value error - </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>


<div class="viewcode-block" id="create_figure">
<a class="viewcode-back" href="../api.html#pfr_app.create_figure">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_figure</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a matplotlib figure with standardized size for consistent visualizations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    size : str, optional</span>
<span class="sd">        Predefined size key: &#39;small&#39;, &#39;medium&#39;, &#39;large&#39;, &#39;wide&#39;, or &#39;stars_grid&#39;.</span>
<span class="sd">        The sizes are defined in the FIGURE_SIZES global dictionary.</span>
<span class="sd">    dpi : int, optional</span>
<span class="sd">        Dots per inch (resolution) for the figure</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matplotlib.figure.Figure</span>
<span class="sd">        Figure object with the specified dimensions</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Uses the FIGURE_SIZES global dictionary to map size names to actual dimensions.</span>
<span class="sd">    If an invalid size is provided, falls back to &#39;medium&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">FIGURE_SIZES</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="n">FIGURE_SIZES</span><span class="p">[</span><span class="n">size</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="n">FIGURE_SIZES</span><span class="p">[</span><span class="s2">&quot;medium&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span></div>



<div class="viewcode-block" id="airmass">
<a class="viewcode-back" href="../api.html#pfr_app.airmass">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">airmass</span><span class="p">(</span>
    <span class="n">_header</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">observatory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">return_details</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the airmass for a celestial object from observation parameters.</span>

<span class="sd">    Airmass is a measure of the optical path length through Earth&#39;s atmosphere.</span>
<span class="sd">    This function calculates it from header information and observatory location,</span>
<span class="sd">    handling multiple coordinate formats and performing physical validity checks.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    _header : Dict</span>
<span class="sd">        FITS header or dictionary containing observation information.</span>
<span class="sd">        Must include:</span>
<span class="sd">        - Coordinates (RA/DEC or OBJRA/OBJDEC)</span>
<span class="sd">        - Observation date (DATE-OBS)</span>
<span class="sd">    observatory : Dict, optional</span>
<span class="sd">        Information about the observatory. If not provided, uses the default (TJMS).</span>
<span class="sd">        Format: {</span>
<span class="sd">            &#39;name&#39;: str,           # Observatory name</span>
<span class="sd">            &#39;latitude&#39;: float,     # Latitude in degrees</span>
<span class="sd">            &#39;longitude&#39;: float,    # Longitude in degrees</span>
<span class="sd">            &#39;elevation&#39;: float     # Elevation in meters</span>
<span class="sd">        }</span>
<span class="sd">    return_details : bool, optional</span>
<span class="sd">        If True, returns additional information about the observation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Union[float, Tuple[float, Dict]]</span>
<span class="sd">        - If return_details=False: airmass (float)</span>
<span class="sd">        - If return_details=True: (airmass, observation_details)</span>
<span class="sd">          where observation_details is a dictionary with:</span>
<span class="sd">          - observatory name</span>
<span class="sd">          - datetime</span>
<span class="sd">          - target coordinates</span>
<span class="sd">          - altitude/azimuth</span>
<span class="sd">          - sun altitude</span>
<span class="sd">          - observation type (night/twilight/day)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Airmass is approximately sec(z) where z is the zenith angle.</span>
<span class="sd">    The function enforces physical constraints (airmass â‰¥ 1.0) and</span>
<span class="sd">    displays warnings for extreme values. It also determines whether</span>
<span class="sd">    the observation was taken during night, twilight or day.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DEFAULT_OBSERVATORY</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;TJMS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="mf">48.29166</span><span class="p">,</span>
        <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="mf">2.43805</span><span class="p">,</span>
        <span class="s2">&quot;elevation&quot;</span><span class="p">:</span> <span class="mf">94.0</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">obs_data</span> <span class="o">=</span> <span class="n">observatory</span> <span class="ow">or</span> <span class="n">DEFAULT_OBSERVATORY</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="n">_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;RA&quot;</span><span class="p">,</span> <span class="n">_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OBJRA&quot;</span><span class="p">,</span> <span class="n">_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;RA---&quot;</span><span class="p">)))</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DEC&quot;</span><span class="p">,</span> <span class="n">_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OBJDEC&quot;</span><span class="p">,</span> <span class="n">_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DEC---&quot;</span><span class="p">)))</span>
        <span class="n">obstime_str</span> <span class="o">=</span> <span class="n">_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DATE-OBS&quot;</span><span class="p">,</span> <span class="n">_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DATE&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">obstime_str</span><span class="p">]):</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">ra</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;RA&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;DEC&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obstime_str</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;DATE-OBS&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required header keywords: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;icrs&quot;</span><span class="p">)</span>
        <span class="n">obstime</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">obstime_str</span><span class="p">)</span>
        <span class="n">location</span> <span class="o">=</span> <span class="n">EarthLocation</span><span class="p">(</span>
            <span class="n">lat</span><span class="o">=</span><span class="n">obs_data</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
            <span class="n">lon</span><span class="o">=</span><span class="n">obs_data</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="n">obs_data</span><span class="p">[</span><span class="s2">&quot;elevation&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">altaz_frame</span> <span class="o">=</span> <span class="n">AltAz</span><span class="p">(</span><span class="n">obstime</span><span class="o">=</span><span class="n">obstime</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">)</span>
        <span class="n">altaz</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">altaz_frame</span><span class="p">)</span>
        <span class="n">airmass_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">altaz</span><span class="o">.</span><span class="n">secz</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">airmass_value</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Calculated airmass is less than 1 (physically impossible)&quot;</span><span class="p">)</span>
            <span class="n">airmass_value</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">elif</span> <span class="n">airmass_value</span> <span class="o">&gt;</span> <span class="mf">40.0</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Extremely high airmass (&gt;40), object near horizon&quot;</span><span class="p">)</span>

        <span class="n">sun_altaz</span> <span class="o">=</span> <span class="n">get_sun</span><span class="p">(</span><span class="n">obstime</span><span class="p">)</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">altaz_frame</span><span class="p">)</span>
        <span class="n">sun_alt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sun_altaz</span><span class="o">.</span><span class="n">alt</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>

        <span class="n">details</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;observatory&quot;</span><span class="p">:</span> <span class="n">obs_data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
            <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">obstime</span><span class="o">.</span><span class="n">iso</span><span class="p">,</span>
            <span class="s2">&quot;target_coords&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;ra&quot;</span><span class="p">:</span> <span class="n">coord</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">),</span>
                <span class="s2">&quot;dec&quot;</span><span class="p">:</span> <span class="n">coord</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span>
            <span class="p">},</span>
            <span class="s2">&quot;altaz&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;altitude&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">altaz</span><span class="o">.</span><span class="n">alt</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s2">&quot;azimuth&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">altaz</span><span class="o">.</span><span class="n">az</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">},</span>
            <span class="s2">&quot;sun_altitude&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">sun_alt</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s2">&quot;observation_type&quot;</span><span class="p">:</span> <span class="s2">&quot;night&quot;</span>
            <span class="k">if</span> <span class="n">sun_alt</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">18</span>
            <span class="k">else</span> <span class="s2">&quot;twilight&quot;</span>
            <span class="k">if</span> <span class="n">sun_alt</span> <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="s2">&quot;day&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Date &amp; Local Time: </span><span class="si">{</span><span class="n">obstime</span><span class="o">.</span><span class="n">iso</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Altitude: </span><span class="si">{</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;altaz&#39;</span><span class="p">][</span><span class="s1">&#39;altitude&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">Â°, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Azimuth: </span><span class="si">{</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;altaz&#39;</span><span class="p">][</span><span class="s1">&#39;azimuth&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">Â°&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">return_details</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">airmass_value</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">details</span>
        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">airmass_value</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calculating airmass: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_details</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="mf">0.0</span></div>



<div class="viewcode-block" id="load_fits_data">
<a class="viewcode-back" href="../api.html#pfr_app.load_fits_data">[docs]</a>
<span class="nd">@st</span><span class="o">.</span><span class="n">cache_data</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_fits_data</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load image data and header from a FITS file with robust error handling.</span>

<span class="sd">    Handles multiple FITS formats including multi-extension files, data cubes,</span>
<span class="sd">    and RGB images. For multi-dimensional data, extracts a 2D plane.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file : Streamlit UploadedFile</span>
<span class="sd">        FITS file object from Streamlit file uploader</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (image_data, header) where:</span>
<span class="sd">        - image_data: 2D numpy array of pixel values, or None if loading failed</span>
<span class="sd">        - header: FITS header dictionary, or None if loading failed</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - For multi-extension FITS files, uses the primary HDU if it contains data,</span>
<span class="sd">      otherwise uses the first HDU with valid data.</span>
<span class="sd">    - For 3D data (RGB or data cube), extracts the first 2D plane with appropriate warnings.</span>
<span class="sd">    - For higher dimensional data, takes the first slice along all extra dimensions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">file_content</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">file_content</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;readonly&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>

            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hdu</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">hdu</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">data</span>
                        <span class="n">header</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Primary HDU has no data. Using data from HDU #</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                        <span class="k">break</span>

            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No image data found in the FITS file.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Detected RGB data with shape </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">. Using first color channel.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Detected RGB data with shape </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">. Using first color channel.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Detected 3D data with shape </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">. Using first plane.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Data has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="si">}</span><span class="s2"> dimensions. Using first slice only.&quot;</span>
                <span class="p">)</span>
                <span class="n">sliced_data</span> <span class="o">=</span> <span class="n">data</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">sliced_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">sliced_data</span> <span class="o">=</span> <span class="n">sliced_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">sliced_data</span>

            <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">header</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading FITS file: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">hdul</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="calibrate_image_streamlit">
<a class="viewcode-back" href="../api.html#pfr_app.calibrate_image_streamlit">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calibrate_image_streamlit</span><span class="p">(</span>
    <span class="n">science_data</span><span class="p">,</span>
    <span class="n">science_header</span><span class="p">,</span>
    <span class="n">bias_data</span><span class="p">,</span>
    <span class="n">dark_data</span><span class="p">,</span>
    <span class="n">flat_data</span><span class="p">,</span>
    <span class="n">exposure_time_science</span><span class="p">,</span>
    <span class="n">exposure_time_dark</span><span class="p">,</span>
    <span class="n">apply_bias</span><span class="p">,</span>
    <span class="n">apply_dark</span><span class="p">,</span>
    <span class="n">apply_flat</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calibrate an astronomical science image using bias, dark, and flat-field frames.</span>

<span class="sd">    This function performs standard CCD calibration steps with status updates in Streamlit:</span>
<span class="sd">    1. Bias subtraction (optional)</span>
<span class="sd">    2. Dark frame subtraction with exposure time scaling (optional)</span>
<span class="sd">    3. Flat field correction using normalized flat (optional)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    science_data : numpy.ndarray</span>
<span class="sd">        The raw science image data to be calibrated</span>
<span class="sd">    science_header : dict or astropy.io.fits.Header</span>
<span class="sd">        Header information from the science image</span>
<span class="sd">    bias_data : numpy.ndarray or None</span>
<span class="sd">        Bias frame data for zero-level correction</span>
<span class="sd">    dark_data : numpy.ndarray or None</span>
<span class="sd">        Dark frame data for thermal noise correction</span>
<span class="sd">    flat_data : numpy.ndarray or None</span>
<span class="sd">        Flat field data for sensitivity/vignetting correction</span>
<span class="sd">    exposure_time_science : float</span>
<span class="sd">        Exposure time of the science image in seconds</span>
<span class="sd">    exposure_time_dark : float</span>
<span class="sd">        Exposure time of the dark frame in seconds</span>
<span class="sd">    apply_bias : bool</span>
<span class="sd">        Whether to apply bias subtraction</span>
<span class="sd">    apply_dark : bool</span>
<span class="sd">        Whether to apply dark frame subtraction</span>
<span class="sd">    apply_flat : bool</span>
<span class="sd">        Whether to apply flat field correction</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (calibrated_science, science_header) where:</span>
<span class="sd">        - calibrated_science is the processed science image as numpy.ndarray</span>
<span class="sd">        - science_header is the unchanged header information</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - If bias correction is applied, it&#39;s also applied to dark and flat frames before they&#39;re used.</span>
<span class="sd">    - Dark frames are scaled according to the exposure time ratio if different from science exposure.</span>
<span class="sd">    - The flat field is normalized by its median value before division.</span>
<span class="sd">    - Progress updates are shown in the Streamlit interface.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">apply_bias</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">apply_dark</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">apply_flat</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Calibration steps are disabled. Returning raw science data.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">science_data</span><span class="p">,</span> <span class="n">science_header</span>

    <span class="n">calibrated_science</span> <span class="o">=</span> <span class="n">science_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">steps_applied</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">dark_data_corrected</span> <span class="o">=</span> <span class="n">dark_data</span>
    <span class="n">flat_data_corrected</span> <span class="o">=</span> <span class="n">flat_data</span>

    <span class="k">if</span> <span class="n">apply_bias</span> <span class="ow">and</span> <span class="n">bias_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Application de la soustraction du bias...&quot;</span><span class="p">)</span>
        <span class="n">calibrated_science</span> <span class="o">-=</span> <span class="n">bias_data</span>
        <span class="n">steps_applied</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Soustraction du Bias&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dark_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dark_data_corrected</span> <span class="o">=</span> <span class="n">dark_data</span> <span class="o">-</span> <span class="n">bias_data</span>
        <span class="k">if</span> <span class="n">flat_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">flat_data_corrected</span> <span class="o">=</span> <span class="n">flat_data</span> <span class="o">-</span> <span class="n">bias_data</span>

    <span class="k">if</span> <span class="n">apply_dark</span> <span class="ow">and</span> <span class="n">dark_data_corrected</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Application de la soustraction du dark...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exposure_time_science</span> <span class="o">!=</span> <span class="n">exposure_time_dark</span><span class="p">:</span>
            <span class="n">dark_scale_factor</span> <span class="o">=</span> <span class="n">exposure_time_science</span> <span class="o">/</span> <span class="n">exposure_time_dark</span>
            <span class="n">scaled_dark</span> <span class="o">=</span> <span class="n">dark_data_corrected</span> <span class="o">*</span> <span class="n">dark_scale_factor</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scaled_dark</span> <span class="o">=</span> <span class="n">dark_data_corrected</span>
        <span class="n">calibrated_science</span> <span class="o">-=</span> <span class="n">scaled_dark</span>
        <span class="n">steps_applied</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Soustraction du Dark&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">apply_flat</span> <span class="ow">and</span> <span class="n">flat_data_corrected</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Application de la correction du flat field...&quot;</span><span class="p">)</span>
        <span class="n">normalized_flat</span> <span class="o">=</span> <span class="n">flat_data_corrected</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flat_data_corrected</span><span class="p">)</span>
        <span class="n">calibrated_science</span> <span class="o">/=</span> <span class="n">normalized_flat</span>
        <span class="n">steps_applied</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Correction du Flat Field&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">steps_applied</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s2">&quot;No calibration steps were applied because files are missing or options are disabled.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">science_data</span><span class="p">,</span> <span class="n">science_header</span>

    <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calibration steps applied: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">steps_applied</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">calibrated_science</span><span class="p">,</span> <span class="n">science_header</span></div>



<div class="viewcode-block" id="make_border_mask">
<a class="viewcode-back" href="../api.html#pfr_app.make_border_mask">[docs]</a>
<span class="nd">@st</span><span class="o">.</span><span class="n">cache_data</span>
<span class="k">def</span><span class="w"> </span><span class="nf">make_border_mask</span><span class="p">(</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">border</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
    <span class="n">invert</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a binary mask for an image excluding one or more border regions.</span>

<span class="sd">    This function creates a mask that can be used to exclude border pixels</span>
<span class="sd">    from analysis, which is useful for operations that might be affected</span>
<span class="sd">    by edge artifacts.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image : numpy.ndarray</span>
<span class="sd">        The input image as a NumPy array</span>
<span class="sd">    border : int or tuple of int, default=50</span>
<span class="sd">        Border size(s) to exclude from the mask:</span>
<span class="sd">        - If int: same border size on all sides</span>
<span class="sd">        - If tuple of 2 elements: (vertical, horizontal) borders</span>
<span class="sd">        - If tuple of 4 elements: (top, bottom, left, right) borders</span>
<span class="sd">    invert : bool, default=True</span>
<span class="sd">        If True, the mask will be inverted (False for border regions)</span>
<span class="sd">        If False, the mask will be True for non-border regions</span>
<span class="sd">    dtype : numpy.dtype, default=bool</span>
<span class="sd">        Data type of the output mask</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        Binary mask with the same height and width as the input image</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    TypeError</span>
<span class="sd">        If image is not a NumPy array or border is not of the correct type</span>
<span class="sd">    ValueError</span>
<span class="sd">        If image is empty, borders are negative, borders are larger than the image,</span>
<span class="sd">        or border tuple has an invalid length</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; img = np.ones((100, 100))</span>
<span class="sd">    &gt;&gt;&gt; # Create a mask with 10px border on all sides</span>
<span class="sd">    &gt;&gt;&gt; mask = make_border_mask(img, 10)</span>
<span class="sd">    &gt;&gt;&gt; # Create a mask with different vertical/horizontal borders</span>
<span class="sd">    &gt;&gt;&gt; mask = make_border_mask(img, (20, 30))</span>
<span class="sd">    &gt;&gt;&gt; # Create a mask with custom borders for each side</span>
<span class="sd">    &gt;&gt;&gt; mask = make_border_mask(img, (10, 20, 30, 40), invert=False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Image cannot be None&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Image must be a numpy.ndarray&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Image cannot be empty&quot;</span><span class="p">)</span>

    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">border</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">border</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">border</span><span class="p">)</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">left</span> <span class="o">=</span> <span class="n">right</span> <span class="o">=</span> <span class="n">border</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">border</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">border</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">vert</span><span class="p">,</span> <span class="n">horiz</span> <span class="o">=</span> <span class="n">border</span>
            <span class="n">top</span> <span class="o">=</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">vert</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">right</span> <span class="o">=</span> <span class="n">horiz</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">border</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">top</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">border</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;border must be an int or a tuple of 2 or 4 elements&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;border must be an int or a tuple&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">b</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Borders cannot be negative&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">top</span> <span class="o">+</span> <span class="n">bottom</span> <span class="o">&gt;=</span> <span class="n">height</span> <span class="ow">or</span> <span class="n">left</span> <span class="o">+</span> <span class="n">right</span> <span class="o">&gt;=</span> <span class="n">width</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Borders are larger than the image&quot;</span><span class="p">)</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">mask</span><span class="p">[</span><span class="n">top</span> <span class="p">:</span> <span class="n">height</span> <span class="o">-</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">left</span> <span class="p">:</span> <span class="n">width</span> <span class="o">-</span> <span class="n">right</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="o">~</span><span class="n">mask</span> <span class="k">if</span> <span class="n">invert</span> <span class="k">else</span> <span class="n">mask</span></div>



<div class="viewcode-block" id="fwhm_fit">
<a class="viewcode-back" href="../api.html#pfr_app.fwhm_fit">[docs]</a>
<span class="nd">@st</span><span class="o">.</span><span class="n">cache_data</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fwhm_fit</span><span class="p">(</span>
    <span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">pixel_scale</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">std_lo</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">std_hi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimate the Full Width at Half Maximum (FWHM) of stars in an astronomical image.</span>

<span class="sd">    This function detects sources in the image using DAOStarFinder, filters them based on</span>
<span class="sd">    flux values, and fits 1D Gaussian models to the marginal distributions of each source</span>
<span class="sd">    to calculate FWHM values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : numpy.ndarray</span>
<span class="sd">        The 2D image array containing astronomical sources</span>
<span class="sd">    fwhm : float</span>
<span class="sd">        Initial FWHM estimate in pixels, used for source detection</span>
<span class="sd">    pixel_scale : float</span>
<span class="sd">        The pixel scale of the image in arcseconds per pixel</span>
<span class="sd">    mask : numpy.ndarray, optional</span>
<span class="sd">        Boolean mask array where True indicates pixels to ignore during source detection</span>
<span class="sd">    std_lo : float, default=0.5</span>
<span class="sd">        Lower bound for flux filtering, in standard deviations below median flux</span>
<span class="sd">    std_hi : float, default=0.5</span>
<span class="sd">        Upper bound for flux filtering, in standard deviations above median flux</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float or None</span>
<span class="sd">        The median FWHM value in pixels (rounded to nearest integer) if successful,</span>
<span class="sd">        or None if no valid sources could be measured</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function uses marginal sums along the x and y dimensions and fits 1D Gaussian</span>
<span class="sd">    profiles to estimate FWHM. For each source, a box of size ~6Ã—FWHM is extracted,</span>
<span class="sd">    and profiles are fit independently in both dimensions, with the results averaged.</span>

<span class="sd">    Progress updates and error messages are displayed using Streamlit.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_fwhm_marginal_sums</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">center_row</span><span class="p">,</span> <span class="n">center_col</span><span class="p">,</span> <span class="n">box_size</span><span class="p">):</span>
        <span class="n">half_box</span> <span class="o">=</span> <span class="n">box_size</span> <span class="o">//</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="n">box_size</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">row_start</span> <span class="o">=</span> <span class="n">center_row</span> <span class="o">-</span> <span class="n">half_box</span>
        <span class="n">row_end</span> <span class="o">=</span> <span class="n">center_row</span> <span class="o">+</span> <span class="n">half_box</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">col_start</span> <span class="o">=</span> <span class="n">center_col</span> <span class="o">-</span> <span class="n">half_box</span>
        <span class="n">col_end</span> <span class="o">=</span> <span class="n">center_col</span> <span class="o">+</span> <span class="n">half_box</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">row_start</span> <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="ow">or</span> <span class="n">row_end</span> <span class="o">&gt;</span> <span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="ow">or</span> <span class="n">col_start</span> <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="ow">or</span> <span class="n">col_end</span> <span class="o">&gt;</span> <span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">box_data</span> <span class="o">=</span> <span class="n">image_data</span><span class="p">[</span><span class="n">row_start</span><span class="p">:</span><span class="n">row_end</span><span class="p">,</span> <span class="n">col_start</span><span class="p">:</span><span class="n">col_end</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">box_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="ow">or</span> <span class="n">box_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">sum_rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">box_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sum_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">box_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sum_rows</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sum_rows</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
            <span class="n">sum_cols</span>
        <span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sum_cols</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">row_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">box_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">col_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">box_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">fitter</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">row_max_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">sum_rows</span><span class="p">)</span>
            <span class="n">row_max_val</span> <span class="o">=</span> <span class="n">sum_rows</span><span class="p">[</span><span class="n">row_max_idx</span><span class="p">]</span>

            <span class="n">model_row</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian1D</span><span class="p">(</span>
                <span class="n">amplitude</span><span class="o">=</span><span class="n">row_max_val</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">row_max_idx</span><span class="p">,</span> <span class="n">stddev</span><span class="o">=</span><span class="n">box_size</span> <span class="o">/</span> <span class="mi">6</span>
            <span class="p">)</span>

            <span class="n">fitted_row</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">model_row</span><span class="p">,</span> <span class="n">row_indices</span><span class="p">,</span> <span class="n">sum_rows</span><span class="p">)</span>
            <span class="n">center_row_fit</span> <span class="o">=</span> <span class="n">fitted_row</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">row_start</span>
            <span class="n">fwhm_row</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">fitted_row</span><span class="o">.</span><span class="n">stddev</span><span class="o">.</span><span class="n">value</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">col_max_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">sum_cols</span><span class="p">)</span>
            <span class="n">col_max_val</span> <span class="o">=</span> <span class="n">sum_cols</span><span class="p">[</span><span class="n">col_max_idx</span><span class="p">]</span>

            <span class="n">model_col</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian1D</span><span class="p">(</span>
                <span class="n">amplitude</span><span class="o">=</span><span class="n">col_max_val</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">col_max_idx</span><span class="p">,</span> <span class="n">stddev</span><span class="o">=</span><span class="n">box_size</span> <span class="o">/</span> <span class="mi">6</span>
            <span class="p">)</span>

            <span class="n">fitted_col</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">model_col</span><span class="p">,</span> <span class="n">col_indices</span><span class="p">,</span> <span class="n">sum_cols</span><span class="p">)</span>
            <span class="n">center_col_fit</span> <span class="o">=</span> <span class="n">fitted_col</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">col_start</span>
            <span class="n">fwhm_col</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">fitted_col</span><span class="o">.</span><span class="n">stddev</span><span class="o">.</span><span class="n">value</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">fwhm_row</span><span class="p">,</span> <span class="n">fwhm_col</span><span class="p">,</span> <span class="n">center_row_fit</span><span class="p">,</span> <span class="n">center_col_fit</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">fwhm</span><span class="o">=</span><span class="mf">1.5</span> <span class="o">*</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">6</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No sources found !&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">flux</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span>
        <span class="n">median_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
        <span class="n">std_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
        <span class="n">mask_flux</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux</span> <span class="o">&gt;</span> <span class="n">median_flux</span> <span class="o">-</span> <span class="n">std_lo</span> <span class="o">*</span> <span class="n">std_flux</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">flux</span> <span class="o">&lt;</span> <span class="n">median_flux</span> <span class="o">+</span> <span class="n">std_hi</span> <span class="o">*</span> <span class="n">std_flux</span>
        <span class="p">)</span>
        <span class="n">filtered_sources</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="n">mask_flux</span><span class="p">]</span>

        <span class="n">filtered_sources</span> <span class="o">=</span> <span class="n">filtered_sources</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">filtered_sources</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">])]</span>

        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of sources after flux filtering: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_sources</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_sources</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No valid sources for fitting found after filtering.&quot;</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">box_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="nb">round</span><span class="p">(</span><span class="n">fwhm</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">box_size</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">box_size</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">fwhm_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">skipped_sources</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">filtered_sources</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x_cen</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;xcentroid&quot;</span><span class="p">])</span>
                <span class="n">y_cen</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;ycentroid&quot;</span><span class="p">])</span>

                <span class="n">fwhm_results</span> <span class="o">=</span> <span class="n">compute_fwhm_marginal_sums</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">y_cen</span><span class="p">,</span> <span class="n">x_cen</span><span class="p">,</span> <span class="n">box_size</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fwhm_results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">skipped_sources</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>

                <span class="n">fwhm_row</span><span class="p">,</span> <span class="n">fwhm_col</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">fwhm_results</span>

                <span class="n">fwhm_source</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">fwhm_row</span><span class="p">,</span> <span class="n">fwhm_col</span><span class="p">])</span>
                <span class="n">fwhm_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fwhm_source</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">skipped_sources</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>

        <span class="k">if</span> <span class="n">skipped_sources</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;FWHM calculation failed for </span><span class="si">{</span><span class="n">skipped_sources</span><span class="si">}</span><span class="s2"> sources out of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_sources</span><span class="p">)</span><span class="si">}</span><span class="s2"> and were skipped.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fwhm_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No valid sources for FWHM fitting after marginal sums adjustment.&quot;</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">fwhm_values_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fwhm_values</span><span class="p">)</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">fwhm_values_arr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">fwhm_values_arr</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">valid</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;All FWHM values are NaN or infinite after marginal sums calculation.&quot;</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">mean_fwhm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">fwhm_values_arr</span><span class="p">[</span><span class="n">valid</span><span class="p">])</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FWHM estimate based on Gaussian model: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">mean_fwhm</span><span class="p">)</span><span class="si">}</span><span class="s2"> pixels&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">mean_fwhm</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error in fwhm_fit: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error in fwhm_fit: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="perform_epsf_photometry">
<a class="viewcode-back" href="../api.html#pfr_app.perform_epsf_photometry">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">perform_epsf_photometry</span><span class="p">(</span>
    <span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">phot_table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span>
    <span class="n">fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">daostarfind</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Table</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform PSF (Point Spread Function) photometry using an empirically-constructed PSF model.</span>

<span class="sd">    This function builds an empirical PSF (EPSF) from bright stars in the image</span>
<span class="sd">    and then uses this model to perform PSF photometry on all detected sources.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : numpy.ndarray</span>
<span class="sd">        Image with sky background subtracted</span>
<span class="sd">    phot_table : astropy.table.Table</span>
<span class="sd">        Table containing source positions</span>
<span class="sd">    fwhm : float</span>
<span class="sd">        Full Width at Half Maximum in pixels, used to define extraction and fitting sizes</span>
<span class="sd">    daostarfind : callable</span>
<span class="sd">        Star detection function used as &quot;finder&quot; in PSF photometry</span>
<span class="sd">    mask : numpy.ndarray, optional</span>
<span class="sd">        Mask to exclude certain image areas from analysis</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tuple[astropy.table.Table, photutils.psf.EPSFModel]</span>
<span class="sd">        - phot_epsf_result : Table containing PSF photometry results, including fitted fluxes and positions</span>
<span class="sd">        - epsf : The fitted EPSF model used for photometry</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function displays the extracted stars used for PSF model building and the</span>
<span class="sd">    resulting PSF model in the Streamlit interface. It also saves the PSF model</span>
<span class="sd">    as a FITS file in the output directory.</span>

<span class="sd">    If successful, the photometry results are also stored in the Streamlit session state</span>
<span class="sd">    under &#39;epsf_photometry_result&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid image data provided. Ensure the image is a non-empty numpy array.&quot;</span>
            <span class="p">)</span>

        <span class="n">nddata</span> <span class="o">=</span> <span class="n">NDData</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">img</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating NDData: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">stars_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
        <span class="n">stars_table</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;xcenter&quot;</span><span class="p">]</span>
        <span class="n">stars_table</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;ycenter&quot;</span><span class="p">]</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Star positions table prepared.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error preparing star positions table: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fwhm</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;FWHM must be a positive number.&quot;</span><span class="p">)</span>
        <span class="n">fit_shape</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">round</span><span class="p">(</span><span class="n">fwhm</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">fit_shape</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">round</span><span class="p">(</span><span class="n">fwhm</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fitting shape: </span><span class="si">{</span><span class="n">fit_shape</span><span class="si">}</span><span class="s2"> pixels.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calculating fitting shape: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">stars</span> <span class="o">=</span> <span class="n">extract_stars</span><span class="p">(</span><span class="n">nddata</span><span class="p">,</span> <span class="n">stars_table</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fit_shape</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span><span class="si">}</span><span class="s2"> stars extracted.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error extracting stars: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span>
        <span class="n">fig_stars</span><span class="p">,</span> <span class="n">ax_stars</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZES</span><span class="p">[</span><span class="s2">&quot;stars_grid&quot;</span><span class="p">],</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">ax_stars</span> <span class="o">=</span> <span class="n">ax_stars</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">n_disp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stars</span><span class="p">),</span> <span class="n">nrows</span> <span class="o">*</span> <span class="n">ncols</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_disp</span><span class="p">):</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.0</span><span class="p">)</span>
            <span class="n">ax_stars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">st</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="n">fig_stars</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error displaying extracted stars: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">epsf_builder</span> <span class="o">=</span> <span class="n">EPSFBuilder</span><span class="p">(</span>
            <span class="n">oversampling</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">progress_bar</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">epsf</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">epsf_builder</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;epsf_model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsf</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fitting PSF model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="k">if</span> <span class="n">epsf</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">epsf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">epsf</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

            <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;COMMENT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PSF model created with photutils.EPSFBuilder&quot;</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FWHMPIX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fwhm</span><span class="p">,</span> <span class="s2">&quot;FWHM in pixels used for extraction&quot;</span><span class="p">)</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;OVERSAMP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Oversampling factor&quot;</span><span class="p">)</span>

            <span class="n">psf_filename</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;base_filename&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;psf_model&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_epsf.fits&quot;</span>
            <span class="p">)</span>
            <span class="n">psf_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">),</span> <span class="n">psf_filename</span>
            <span class="p">)</span>

            <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">psf_filepath</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;PSF model saved as FITS file&quot;</span><span class="p">)</span>

            <span class="n">norm_epsf</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">epsf</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.0</span><span class="p">)</span>
            <span class="n">fig_epsf_model</span><span class="p">,</span> <span class="n">ax_epsf_model</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                <span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZES</span><span class="p">[</span><span class="s2">&quot;medium&quot;</span><span class="p">],</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span>
            <span class="p">)</span>
            <span class="n">ax_epsf_model</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                <span class="n">epsf</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="n">norm</span><span class="o">=</span><span class="n">norm_epsf</span><span class="p">,</span>
                <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
                <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax_epsf_model</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Fitted PSF Model&quot;</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="n">fig_epsf_model</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error working with PSF model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;EPSF data is empty or invalid. Cannot display the PSF model.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">daostarfind</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The &#39;finder&#39; parameter must be a callable star finder, such as DAOStarFinder.&quot;</span>
            <span class="p">)</span>

    <span class="n">psfphot</span> <span class="o">=</span> <span class="n">IterativePSFPhotometry</span><span class="p">(</span>
        <span class="n">psf_model</span><span class="o">=</span><span class="n">epsf</span><span class="p">,</span>
        <span class="n">fit_shape</span><span class="o">=</span><span class="n">fit_shape</span><span class="p">,</span>
        <span class="n">finder</span><span class="o">=</span><span class="n">daostarfind</span><span class="p">,</span>
        <span class="n">aperture_radius</span><span class="o">=</span><span class="n">fit_shape</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">maxiters</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Invalid image data provided. Ensure the image is a non-empty numpy array.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Invalid mask provided. Ensure the mask is a numpy array with the same shape as the image.&quot;</span>
        <span class="p">)</span>

    <span class="n">psfphot</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;xcenter&quot;</span><span class="p">]</span>
    <span class="n">psfphot</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;ycenter&quot;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Performing PSF photometry...&quot;</span><span class="p">)</span>
        <span class="n">phot_epsf_result</span> <span class="o">=</span> <span class="n">psfphot</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;epsf_photometry_result&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot_epsf_result</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;PSF photometry completed successfully.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error executing PSF photometry: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="k">return</span> <span class="n">phot_epsf_result</span><span class="p">,</span> <span class="n">epsf</span></div>



<div class="viewcode-block" id="find_sources_and_photometry_streamlit">
<a class="viewcode-back" href="../api.html#pfr_app.find_sources_and_photometry_streamlit">[docs]</a>
<span class="nd">@st</span><span class="o">.</span><span class="n">cache_data</span>
<span class="k">def</span><span class="w"> </span><span class="nf">find_sources_and_photometry_streamlit</span><span class="p">(</span>
    <span class="n">image_data</span><span class="p">,</span> <span class="n">_science_header</span><span class="p">,</span> <span class="n">mean_fwhm_pixel</span><span class="p">,</span> <span class="n">threshold_sigma</span><span class="p">,</span> <span class="n">detection_mask</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find astronomical sources and perform both aperture and PSF photometry.</span>

<span class="sd">    This comprehensive function handles the full photometry workflow:</span>
<span class="sd">    1. Background estimation</span>
<span class="sd">    2. Source detection</span>
<span class="sd">    3. WCS refinement with GAIA DR3</span>
<span class="sd">    4. Aperture photometry</span>
<span class="sd">    5. PSF/EPSF photometry</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image_data : numpy.ndarray</span>
<span class="sd">        Science image data (2D array)</span>
<span class="sd">    _science_header : dict or astropy.io.fits.Header</span>
<span class="sd">        Header information from FITS file (underscore prevents caching issues)</span>
<span class="sd">    mean_fwhm_pixel : float</span>
<span class="sd">        Estimated FWHM in pixels for aperture sizing</span>
<span class="sd">    threshold_sigma : float</span>
<span class="sd">        Detection threshold in sigma units above background</span>
<span class="sd">    detection_mask : int</span>
<span class="sd">        Border size in pixels to mask during detection</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (phot_table, epsf_table, daofind, bkg) where:</span>
<span class="sd">        - phot_table: Table with aperture photometry results</span>
<span class="sd">        - epsf_table: Table with PSF photometry results</span>
<span class="sd">        - daofind: The DAOStarFinder object used for detection</span>
<span class="sd">        - bkg: Background2D object with background model</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Uses stdpipe for astrometry refinement with GAIA DR3</span>
<span class="sd">    - Automatically adds celestial coordinates (RA/Dec) to the photometry tables if WCS is available</span>
<span class="sd">    - Both aperture and PSF photometry include instrumental magnitude calculations</span>
<span class="sd">    - Shows progress and status updates in the Streamlit interface</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">daofind</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">wcs_error</span> <span class="o">=</span> <span class="n">safe_wcs_create</span><span class="p">(</span><span class="n">_science_header</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating WCS: </span><span class="si">{</span><span class="n">wcs_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">daofind</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating WCS: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">daofind</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">pixel_scale</span> <span class="o">=</span> <span class="n">_science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;PIXSCALE&quot;</span><span class="p">,</span>
        <span class="n">_science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PIXSIZE&quot;</span><span class="p">,</span> <span class="n">_science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PIXELSCAL&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
    <span class="p">)</span>

    <span class="n">bkg</span><span class="p">,</span> <span class="n">bkg_error</span> <span class="o">=</span> <span class="n">estimate_background</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">box_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">filter_size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bkg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error estimating background: </span><span class="si">{</span><span class="n">bkg_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">daofind</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">make_border_mask</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="n">detection_mask</span><span class="p">)</span>

    <span class="n">total_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">bkg</span><span class="o">.</span><span class="n">background_rms</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background_median</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
        <span class="n">bkg</span><span class="o">.</span><span class="n">background_median</span>
    <span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Estimating FWHM...&quot;</span><span class="p">)</span>
    <span class="n">fwhm_estimate</span> <span class="o">=</span> <span class="n">fwhm_fit</span><span class="p">(</span>
        <span class="n">image_data</span> <span class="o">-</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="n">mean_fwhm_pixel</span><span class="p">,</span> <span class="n">pixel_scale</span><span class="p">,</span> <span class="n">mask</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">fwhm_estimate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to estimate FWHM. Using the initial estimate.&quot;</span><span class="p">)</span>
        <span class="n">fwhm_estimate</span> <span class="o">=</span> <span class="n">mean_fwhm_pixel</span>

    <span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span>
        <span class="n">fwhm</span><span class="o">=</span><span class="mf">1.5</span> <span class="o">*</span> <span class="n">fwhm_estimate</span><span class="p">,</span>
        <span class="n">threshold</span><span class="o">=</span><span class="n">threshold_sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">image_data</span> <span class="o">-</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">image_data</span> <span class="o">-</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No sources found!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">daofind</span><span class="p">,</span> <span class="n">bkg</span>

    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Doing astrometry refinement with GAIA DR3...&quot;</span><span class="p">)</span>
    <span class="c1"># ra0, dec0, sr0 = astrometry.get_frame_center(wcs=w, width=image_data.shape[1], height=image_data.shape[0])</span>
    <span class="c1"># cat = catalogs.get_cat_vizier(ra0, dec0, sr0, &#39;gaiadr3&#39;, filters={&#39;Rpmag&#39;:&#39;&lt;19&#39;})</span>
    <span class="c1"># cat_col_mag = &#39;Rpmag&#39;</span>
    <span class="c1"># sources[&#39;x&#39;] = sources[&#39;xcentroid&#39;]</span>
    <span class="c1"># sources[&#39;y&#39;] = sources[&#39;ycentroid&#39;]</span>
    <span class="c1"># try:</span>
    <span class="c1">#     # Add error column if not present</span>
    <span class="c1">#     if &#39;Rpmag_error&#39; in cat.colnames:</span>
    <span class="c1">#         cat_col_magerr = &#39;Rpmag_error&#39;</span>
    <span class="c1">#     elif &#39;e_Rpmag&#39; in cat.colnames:</span>
    <span class="c1">#         cat_col_magerr = &#39;e_Rpmag&#39;</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         # Create a dummy error column if needed</span>
    <span class="c1">#         cat[&#39;Rpmag_error&#39;] = np.ones_like(cat[&#39;Rpmag&#39;]) * 0.01</span>
    <span class="c1">#         cat_col_magerr = &#39;Rpmag_error&#39;</span>

    <span class="c1">#     wcs = pipeline.refine_astrometry(sources, cat, 1.5*fwhm_estimate*pixel_scale/3600, wcs=w, order=0,</span>
    <span class="c1">#                                      cat_col_mag=cat_col_mag, cat_col_magerr=cat_col_magerr, verbose=True)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Refined WCS successfully.&quot;</span><span class="p">)</span>
    <span class="c1">#     astrometry.clear_wcs(_science_header, remove_comments=True, remove_underscored=True, remove_history=True)</span>
    <span class="c1">#     _science_header.update(wcs.to_header(relax=True))</span>
    <span class="c1"># except Exception as e:</span>
    <span class="c1">#     st.warning(f&quot;Skipping WCS refinement: {str(e)}&quot;)</span>
    <span class="c1">#     # Print column names to help diagnose</span>
    <span class="c1">#     if &#39;cat&#39; in locals() and hasattr(cat, &#39;colnames&#39;):</span>
    <span class="c1">#         st.info(f&quot;Available catalog columns: {cat.colnames}&quot;)</span>

    <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="n">sources</span><span class="p">[</span><span class="s2">&quot;xcentroid&quot;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s2">&quot;ycentroid&quot;</span><span class="p">]))</span>
    <span class="n">apertures</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mf">1.5</span> <span class="o">*</span> <span class="n">fwhm_estimate</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">wcs_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;CTYPE1&quot;</span> <span class="ow">in</span> <span class="n">_science_header</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">wcs_obj</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">_science_header</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">wcs_obj</span><span class="o">.</span><span class="n">pixel_n_dim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">wcs_obj</span> <span class="o">=</span> <span class="n">wcs_obj</span><span class="o">.</span><span class="n">celestial</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reduced WCS to 2D celestial coordinates for photometry&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating WCS object: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">wcs_obj</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">phot_table</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span>
            <span class="n">image_data</span> <span class="o">-</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="n">apertures</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">total_error</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="n">wcs_obj</span>
        <span class="p">)</span>

        <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;xcenter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s2">&quot;xcentroid&quot;</span><span class="p">]</span>
        <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;ycenter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s2">&quot;ycentroid&quot;</span><span class="p">]</span>

        <span class="n">instrumental_mags</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;aperture_sum&quot;</span><span class="p">])</span>
        <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;instrumental_mag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instrumental_mags</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">epsf_table</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">perform_epsf_photometry</span><span class="p">(</span>
                <span class="n">image_data</span> <span class="o">-</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="n">phot_table</span><span class="p">,</span> <span class="n">fwhm_estimate</span><span class="p">,</span> <span class="n">daofind</span><span class="p">,</span> <span class="n">mask</span>
            <span class="p">)</span>

            <span class="n">epsf_instrumental_mags</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">epsf_table</span><span class="p">[</span><span class="s2">&quot;flux_fit&quot;</span><span class="p">])</span>
            <span class="n">epsf_table</span><span class="p">[</span><span class="s2">&quot;instrumental_mag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsf_instrumental_mags</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error performing EPSF photometry: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">epsf_table</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">valid_sources</span> <span class="o">=</span> <span class="p">(</span><span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;aperture_sum&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span>
            <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;instrumental_mag&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">phot_table</span> <span class="o">=</span> <span class="n">phot_table</span><span class="p">[</span><span class="n">valid_sources</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">epsf_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">epsf_valid_sources</span> <span class="o">=</span> <span class="p">(</span><span class="n">epsf_table</span><span class="p">[</span><span class="s2">&quot;flux_fit&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span>
                <span class="n">epsf_table</span><span class="p">[</span><span class="s2">&quot;instrumental_mag&quot;</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="n">epsf_table</span> <span class="o">=</span> <span class="n">epsf_table</span><span class="p">[</span><span class="n">epsf_valid_sources</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">wcs_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">wcs_obj</span><span class="o">.</span><span class="n">pixel_to_world_values</span><span class="p">(</span>
                    <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;xcenter&quot;</span><span class="p">],</span> <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;ycenter&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ra</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
                <span class="n">phot_table</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dec</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>

                <span class="k">if</span> <span class="n">epsf_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">epsf_ra</span><span class="p">,</span> <span class="n">epsf_dec</span> <span class="o">=</span> <span class="n">wcs_obj</span><span class="o">.</span><span class="n">pixel_to_world_values</span><span class="p">(</span>
                            <span class="n">epsf_table</span><span class="p">[</span><span class="s2">&quot;x_fit&quot;</span><span class="p">],</span> <span class="n">epsf_table</span><span class="p">[</span><span class="s2">&quot;y_fit&quot;</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">epsf_table</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsf_ra</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
                        <span class="n">epsf_table</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsf_dec</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not add coordinates to EPSF table: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
                    <span class="n">key</span> <span class="ow">in</span> <span class="n">_science_header</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;RA&quot;</span><span class="p">,</span> <span class="s2">&quot;DEC&quot;</span><span class="p">,</span> <span class="s2">&quot;NAXIS1&quot;</span><span class="p">,</span> <span class="s2">&quot;NAXIS2&quot;</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using simple linear approximation for RA/DEC coordinates&quot;</span><span class="p">)</span>
                    <span class="n">center_ra</span> <span class="o">=</span> <span class="n">_science_header</span><span class="p">[</span><span class="s2">&quot;RA&quot;</span><span class="p">]</span>
                    <span class="n">center_dec</span> <span class="o">=</span> <span class="n">_science_header</span><span class="p">[</span><span class="s2">&quot;DEC&quot;</span><span class="p">]</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="n">_science_header</span><span class="p">[</span><span class="s2">&quot;NAXIS1&quot;</span><span class="p">]</span>
                    <span class="n">height</span> <span class="o">=</span> <span class="n">_science_header</span><span class="p">[</span><span class="s2">&quot;NAXIS2&quot;</span><span class="p">]</span>

                    <span class="n">pix_scale</span> <span class="o">=</span> <span class="n">pixel_scale</span> <span class="ow">or</span> <span class="mf">1.0</span>

                    <span class="n">center_x</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="n">center_y</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span>

                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phot_table</span><span class="p">):</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;xcenter&quot;</span><span class="p">]</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;ycenter&quot;</span><span class="p">]</span>
                        <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">center_x</span><span class="p">)</span> <span class="o">*</span> <span class="n">pix_scale</span> <span class="o">/</span> <span class="mf">3600.0</span>
                        <span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">center_y</span><span class="p">)</span> <span class="o">*</span> <span class="n">pix_scale</span> <span class="o">/</span> <span class="mf">3600.0</span>
                        <span class="n">phot_table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">center_ra</span> <span class="o">+</span> <span class="n">dx</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">center_dec</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">phot_table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">center_dec</span> <span class="o">+</span> <span class="n">dy</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;WCS transformation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. RA and Dec not added to tables.&quot;</span>
            <span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">phot_table</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources and performed photometry.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">phot_table</span><span class="p">,</span> <span class="n">epsf_table</span><span class="p">,</span> <span class="n">daofind</span><span class="p">,</span> <span class="n">bkg</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error performing aperture photometry: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">daofind</span><span class="p">,</span> <span class="n">bkg</span></div>



<div class="viewcode-block" id="cross_match_with_gaia_streamlit">
<a class="viewcode-back" href="../api.html#pfr_app.cross_match_with_gaia_streamlit">[docs]</a>
<span class="nd">@st</span><span class="o">.</span><span class="n">cache_data</span>
<span class="k">def</span><span class="w"> </span><span class="nf">cross_match_with_gaia_streamlit</span><span class="p">(</span>
    <span class="n">_phot_table</span><span class="p">,</span>
    <span class="n">_science_header</span><span class="p">,</span>
    <span class="n">pixel_size_arcsec</span><span class="p">,</span>
    <span class="n">mean_fwhm_pixel</span><span class="p">,</span>
    <span class="n">gaia_band</span><span class="p">,</span>
    <span class="n">gaia_min_mag</span><span class="p">,</span>
    <span class="n">gaia_max_mag</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cross-match detected sources with the GAIA DR3 star catalog.</span>

<span class="sd">    This function queries the GAIA catalog for a region matching the image field of view,</span>
<span class="sd">    applies filtering based on magnitude range, and matches GAIA sources to the detected sources.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    _phot_table : astropy.table.Table</span>
<span class="sd">        Table containing detected source positions (underscore prevents caching issues)</span>
<span class="sd">    _science_header : dict or astropy.io.fits.Header</span>
<span class="sd">        FITS header with WCS information (underscore prevents caching issues)</span>
<span class="sd">    pixel_size_arcsec : float</span>
<span class="sd">        Pixel scale in arcseconds per pixel</span>
<span class="sd">    mean_fwhm_pixel : float</span>
<span class="sd">        FWHM in pixels, used to determine matching radius</span>
<span class="sd">    gaia_band : str</span>
<span class="sd">        GAIA magnitude band to use for filtering (e.g., &#39;phot_g_mean_mag&#39;)</span>
<span class="sd">    gaia_min_mag : float</span>
<span class="sd">        Minimum magnitude for GAIA source filtering</span>
<span class="sd">    gaia_max_mag : float</span>
<span class="sd">        Maximum magnitude for GAIA source filtering</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame or None</span>
<span class="sd">        DataFrame containing matched sources with both measured and GAIA catalog data,</span>
<span class="sd">        or None if the cross-match failed or found no matches</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - The maximum separation for matching is set to twice the FWHM in arcseconds</span>
<span class="sd">    - Includes filtering to exclude variable stars if the information is available</span>
<span class="sd">    - Progress and status updates are displayed in the Streamlit interface</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Cross-matching with Gaia DR3...&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">_science_header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No header information available. Cannot cross-match with Gaia.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">_science_header</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating WCS: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">source_positions_pixel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
            <span class="p">(</span><span class="n">_phot_table</span><span class="p">[</span><span class="s2">&quot;xcenter&quot;</span><span class="p">],</span> <span class="n">_phot_table</span><span class="p">[</span><span class="s2">&quot;ycenter&quot;</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="n">source_positions_sky</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">pixel_to_world</span><span class="p">(</span>
            <span class="n">source_positions_pixel</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">source_positions_pixel</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error converting pixel positions to sky coordinates: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">image_center_ra_dec</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">pixel_to_world</span><span class="p">(</span>
            <span class="n">_science_header</span><span class="p">[</span><span class="s2">&quot;NAXIS1&quot;</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">_science_header</span><span class="p">[</span><span class="s2">&quot;NAXIS2&quot;</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="p">)</span>
        <span class="n">gaia_search_radius_arcsec</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">max</span><span class="p">(</span><span class="n">_science_header</span><span class="p">[</span><span class="s2">&quot;NAXIS1&quot;</span><span class="p">],</span> <span class="n">_science_header</span><span class="p">[</span><span class="s2">&quot;NAXIS2&quot;</span><span class="p">])</span>
            <span class="o">*</span> <span class="n">pixel_size_arcsec</span>
            <span class="o">/</span> <span class="mf">2.0</span>
        <span class="p">)</span>
        <span class="n">radius_query</span> <span class="o">=</span> <span class="n">gaia_search_radius_arcsec</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span>

        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Querying Gaia DR3 in a radius of </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">radius_query</span><span class="o">.</span><span class="n">value</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">60.0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> arcmin.&quot;</span>
        <span class="p">)</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">Gaia</span><span class="o">.</span><span class="n">cone_search</span><span class="p">(</span><span class="n">image_center_ra_dec</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius_query</span><span class="p">)</span>
        <span class="n">gaia_table</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error querying Gaia: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">gaia_table</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">gaia_table</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No Gaia sources found within search radius.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">mag_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">gaia_table</span><span class="p">[</span><span class="n">gaia_band</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">gaia_max_mag</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">gaia_table</span><span class="p">[</span><span class="n">gaia_band</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">gaia_min_mag</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;phot_variable_flag&quot;</span> <span class="ow">in</span> <span class="n">gaia_table</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
            <span class="n">var_filter</span> <span class="o">=</span> <span class="n">gaia_table</span><span class="p">[</span><span class="s2">&quot;phot_variable_flag&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;VARIABLE&quot;</span>
            <span class="n">combined_filter</span> <span class="o">=</span> <span class="n">mag_filter</span> <span class="o">&amp;</span> <span class="n">var_filter</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">combined_filter</span> <span class="o">=</span> <span class="n">mag_filter</span>

        <span class="n">gaia_table_filtered</span> <span class="o">=</span> <span class="n">gaia_table</span><span class="p">[</span><span class="n">combined_filter</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gaia_table_filtered</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No Gaia sources found within magnitude range </span><span class="si">{</span><span class="n">gaia_min_mag</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">gaia_band</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">gaia_max_mag</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtered Gaia catalog to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gaia_table_filtered</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error filtering Gaia catalog: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">gaia_skycoords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
            <span class="n">ra</span><span class="o">=</span><span class="n">gaia_table_filtered</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">gaia_table_filtered</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span>
        <span class="p">)</span>
        <span class="n">idx</span><span class="p">,</span> <span class="n">d2d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">source_positions_sky</span><span class="o">.</span><span class="n">match_to_catalog_sky</span><span class="p">(</span><span class="n">gaia_skycoords</span><span class="p">)</span>

        <span class="n">max_sep_constraint</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mean_fwhm_pixel</span> <span class="o">*</span> <span class="n">pixel_size_arcsec</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span>
        <span class="n">gaia_matches</span> <span class="o">=</span> <span class="n">d2d</span> <span class="o">&lt;=</span> <span class="n">max_sep_constraint</span>

        <span class="n">matched_indices_gaia</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="n">gaia_matches</span><span class="p">]</span>
        <span class="n">matched_indices_phot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gaia_matches</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_indices_gaia</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No Gaia matches found within the separation constraint.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">matched_table_qtable</span> <span class="o">=</span> <span class="n">_phot_table</span><span class="p">[</span><span class="n">matched_indices_phot</span><span class="p">]</span>

        <span class="n">matched_table</span> <span class="o">=</span> <span class="n">matched_table_qtable</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
        <span class="n">matched_table</span><span class="p">[</span><span class="s2">&quot;gaia_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matched_indices_gaia</span>
        <span class="n">matched_table</span><span class="p">[</span><span class="s2">&quot;gaia_separation_arcsec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2d</span><span class="p">[</span><span class="n">gaia_matches</span><span class="p">]</span><span class="o">.</span><span class="n">arcsec</span>
        <span class="n">matched_table</span><span class="p">[</span><span class="n">gaia_band</span><span class="p">]</span> <span class="o">=</span> <span class="n">gaia_table_filtered</span><span class="p">[</span><span class="n">gaia_band</span><span class="p">][</span><span class="n">matched_indices_gaia</span><span class="p">]</span>

        <span class="n">valid_gaia_mags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">matched_table</span><span class="p">[</span><span class="n">gaia_band</span><span class="p">])</span>
        <span class="n">matched_table</span> <span class="o">=</span> <span class="n">matched_table</span><span class="p">[</span><span class="n">valid_gaia_mags</span><span class="p">]</span>

        <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matched_table</span><span class="p">)</span><span class="si">}</span><span class="s2"> Gaia matches after filtering.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">matched_table</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during cross-matching: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="calculate_zero_point_streamlit">
<a class="viewcode-back" href="../api.html#pfr_app.calculate_zero_point_streamlit">[docs]</a>
<span class="nd">@st</span><span class="o">.</span><span class="n">cache_data</span>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_zero_point_streamlit</span><span class="p">(</span><span class="n">_phot_table</span><span class="p">,</span> <span class="n">_matched_table</span><span class="p">,</span> <span class="n">gaia_band</span><span class="p">,</span> <span class="n">air</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate photometric zero point from matched sources with GAIA.</span>

<span class="sd">    The zero point transforms instrumental magnitudes to the standard GAIA magnitude system,</span>
<span class="sd">    accounting for atmospheric extinction using the provided airmass.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    _phot_table : astropy.table.Table or pandas.DataFrame</span>
<span class="sd">        Photometry results table (underscore prevents caching issues)</span>
<span class="sd">    _matched_table : pandas.DataFrame</span>
<span class="sd">        Table of GAIA cross-matched sources (underscore prevents caching issues)</span>
<span class="sd">    gaia_band : str</span>
<span class="sd">        GAIA magnitude band used (e.g., &#39;phot_g_mean_mag&#39;)</span>
<span class="sd">    air : float</span>
<span class="sd">        Airmass value for atmospheric extinction correction</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (zero_point_value, zero_point_std, matplotlib_figure) where:</span>
<span class="sd">        - zero_point_value: Float value of the calculated zero point</span>
<span class="sd">        - zero_point_std: Standard deviation of the zero point</span>
<span class="sd">        - matplotlib_figure: Figure object showing GAIA vs. calibrated magnitudes</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Uses sigma clipping to remove outliers from zero point calculation</span>
<span class="sd">    - Applies a simple atmospheric extinction correction of 0.1*airmass</span>
<span class="sd">    - Stores the calibrated photometry table in session state as &#39;final_phot_table&#39;</span>
<span class="sd">    - Creates and saves a plot showing the relation between GAIA and calibrated magnitudes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Calculating zero point...&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">_matched_table</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">_matched_table</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No matched sources to calculate zero point.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">zero_points</span> <span class="o">=</span> <span class="n">_matched_table</span><span class="p">[</span><span class="n">gaia_band</span><span class="p">]</span> <span class="o">-</span> <span class="n">_matched_table</span><span class="p">[</span><span class="s2">&quot;instrumental_mag&quot;</span><span class="p">]</span>
        <span class="n">_matched_table</span><span class="p">[</span><span class="s2">&quot;zero_point&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero_points</span>
        <span class="n">_matched_table</span><span class="p">[</span><span class="s2">&quot;zero_point_error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">zero_points</span><span class="p">)</span>

        <span class="n">clipped_zero_points</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">zero_points</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">zero_point_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">clipped_zero_points</span><span class="p">)</span>
        <span class="n">zero_point_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">clipped_zero_points</span><span class="p">)</span>

        <span class="n">_matched_table</span><span class="p">[</span><span class="s2">&quot;calib_mag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">_matched_table</span><span class="p">[</span><span class="s2">&quot;instrumental_mag&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">zero_point_value</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">air</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_phot_table</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">_phot_table</span> <span class="o">=</span> <span class="n">_phot_table</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>

        <span class="n">_phot_table</span><span class="p">[</span><span class="s2">&quot;calib_mag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">_phot_table</span><span class="p">[</span><span class="s2">&quot;instrumental_mag&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">zero_point_value</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">air</span>
        <span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;final_phot_table&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_phot_table</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZES</span><span class="p">[</span><span class="s2">&quot;medium&quot;</span><span class="p">],</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">_matched_table</span><span class="p">[</span><span class="n">gaia_band</span><span class="p">],</span>
            <span class="n">_matched_table</span><span class="p">[</span><span class="s2">&quot;calib_mag&quot;</span><span class="p">],</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Matched sources&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gaia </span><span class="si">{</span><span class="n">gaia_band</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Calibrated magnitude&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Gaia magnitude vs Calibrated magnitude&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Calculated Zero Point: </span><span class="si">{</span><span class="n">zero_point_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> Â± </span><span class="si">{</span><span class="n">zero_point_std</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">zero_point_plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;zero_point_plot.png&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">zero_point_plot_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not save plot to file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">zero_point_value</span><span class="p">,</span> <span class="n">zero_point_std</span><span class="p">,</span> <span class="n">fig</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calculating zero point: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">run_zero_point_calibration</span><span class="p">(</span>
    <span class="n">header</span><span class="p">,</span>
    <span class="n">pixel_size_arcsec</span><span class="p">,</span>
    <span class="n">mean_fwhm_pixel</span><span class="p">,</span>
    <span class="n">threshold_sigma</span><span class="p">,</span>
    <span class="n">detection_mask</span><span class="p">,</span>
    <span class="n">gaia_band</span><span class="p">,</span>
    <span class="n">gaia_min_mag</span><span class="p">,</span>
    <span class="n">gaia_max_mag</span><span class="p">,</span>
    <span class="n">air</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the complete photometric zero point calibration workflow.</span>

<span class="sd">    This function orchestrates the full photometric analysis pipeline:</span>
<span class="sd">    1. Source detection and photometry</span>
<span class="sd">    2. GAIA catalog cross-matching</span>
<span class="sd">    3. Zero point determination</span>
<span class="sd">    4. Results display and catalog creation</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    header : dict or astropy.io.fits.Header</span>
<span class="sd">        FITS header with observation metadata</span>
<span class="sd">    pixel_size_arcsec : float</span>
<span class="sd">        Pixel scale in arcseconds per pixel</span>
<span class="sd">    mean_fwhm_pixel : float</span>
<span class="sd">        FWHM estimate in pixels</span>
<span class="sd">    threshold_sigma : float</span>
<span class="sd">        Detection threshold in sigma units</span>
<span class="sd">    detection_mask : int</span>
<span class="sd">        Border mask size in pixels</span>
<span class="sd">    gaia_band : str</span>
<span class="sd">        GAIA magnitude band to use</span>
<span class="sd">    gaia_min_mag, gaia_max_mag : float</span>
<span class="sd">        Magnitude limits for GAIA sources</span>
<span class="sd">    air : float</span>
<span class="sd">        Airmass value for extinction correction</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (zero_point_value, zero_point_std, final_phot_table) where:</span>
<span class="sd">        - zero_point_value: Calculated zero point value</span>
<span class="sd">        - zero_point_std: Standard deviation of the zero point</span>
<span class="sd">        - final_phot_table: DataFrame with the complete photometry catalog</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This function manages the workflow with appropriate Streamlit spinners and messages,</span>
<span class="sd">    creates downloadable output files, logs progress, and provides interactive data views.</span>

<span class="sd">    If PSF photometry results are available, they&#39;re added to the final catalog alongside</span>
<span class="sd">    aperture photometry results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">spinner</span><span class="p">(</span><span class="s2">&quot;Finding sources and performing photometry...&quot;</span><span class="p">):</span>
        <span class="n">phot_table_qtable</span><span class="p">,</span> <span class="n">epsf_table</span><span class="p">,</span> <span class="n">daofind</span><span class="p">,</span> <span class="n">bkg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">find_sources_and_photometry_streamlit</span><span class="p">(</span>
                <span class="n">image_to_process</span><span class="p">,</span>
                <span class="n">header_to_process</span><span class="p">,</span>
                <span class="n">mean_fwhm_pixel</span><span class="p">,</span>
                <span class="n">threshold_sigma</span><span class="p">,</span>
                <span class="n">detection_mask</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">phot_table_qtable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to perform photometry - no sources found&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">spinner</span><span class="p">(</span><span class="s2">&quot;Cross-matching with Gaia...&quot;</span><span class="p">):</span>
        <span class="n">matched_table</span> <span class="o">=</span> <span class="n">cross_match_with_gaia_streamlit</span><span class="p">(</span>
            <span class="n">phot_table_qtable</span><span class="p">,</span>
            <span class="n">header</span><span class="p">,</span>
            <span class="n">pixel_size_arcsec</span><span class="p">,</span>
            <span class="n">mean_fwhm_pixel</span><span class="p">,</span>
            <span class="n">gaia_band</span><span class="p">,</span>
            <span class="n">gaia_min_mag</span><span class="p">,</span>
            <span class="n">gaia_max_mag</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">matched_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to cross-match with Gaia&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">phot_table_qtable</span>

    <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Cross-matched Gaia Catalog (first 10 rows)&quot;</span><span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">matched_table</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

    <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">spinner</span><span class="p">(</span><span class="s2">&quot;Calculating zero point...&quot;</span><span class="p">):</span>
        <span class="n">zero_point_value</span><span class="p">,</span> <span class="n">zero_point_std</span><span class="p">,</span> <span class="n">zp_plot</span> <span class="o">=</span> <span class="n">calculate_zero_point_streamlit</span><span class="p">(</span>
            <span class="n">phot_table_qtable</span><span class="p">,</span> <span class="n">matched_table</span><span class="p">,</span> <span class="n">gaia_band</span><span class="p">,</span> <span class="n">air</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">zero_point_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="n">zp_plot</span><span class="p">)</span>
            <span class="n">write_to_log</span><span class="p">(</span>
                <span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Zero point: </span><span class="si">{</span><span class="n">zero_point_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> Â± </span><span class="si">{</span><span class="n">zero_point_std</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Airmass: </span><span class="si">{</span><span class="n">air</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="s2">&quot;epsf_photometry_result&quot;</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span>
                    <span class="ow">and</span> <span class="n">epsf_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="p">):</span>
                    <span class="n">epsf_df</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">epsf_table</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">epsf_table</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
                        <span class="k">else</span> <span class="n">epsf_table</span>
                    <span class="p">)</span>

                    <span class="n">epsf_df</span><span class="p">[</span><span class="s2">&quot;match_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">epsf_df</span><span class="p">[</span><span class="s2">&quot;xcenter&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                        <span class="o">+</span> <span class="n">epsf_df</span><span class="p">[</span><span class="s2">&quot;ycenter&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;match_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;xcenter&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                        <span class="o">+</span> <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;ycenter&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                    <span class="p">)</span>

                    <span class="n">epsf_cols</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;match_id&quot;</span><span class="p">:</span> <span class="s2">&quot;match_id&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;flux_fit&quot;</span><span class="p">:</span> <span class="s2">&quot;psf_flux_fit&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;flux_unc&quot;</span><span class="p">:</span> <span class="s2">&quot;psf_flux_unc&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;instrumental_mag&quot;</span><span class="p">:</span> <span class="s2">&quot;psf_instrumental_mag&quot;</span><span class="p">,</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">epsf_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
                        <span class="ow">and</span> <span class="s2">&quot;match_id&quot;</span> <span class="ow">in</span> <span class="n">epsf_df</span><span class="o">.</span><span class="n">columns</span>
                        <span class="ow">and</span> <span class="s2">&quot;match_id&quot;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span>
                    <span class="p">):</span>
                        <span class="n">epsf_subset</span> <span class="o">=</span> <span class="n">epsf_df</span><span class="p">[</span>
                            <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">epsf_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">epsf_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">epsf_cols</span><span class="p">)</span>

                    <span class="n">final_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                        <span class="n">final_table</span><span class="p">,</span> <span class="n">epsf_subset</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;match_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="s2">&quot;epsf_instrumental_mag&quot;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;psf_calib_mag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;psf_instrumental_mag&quot;</span><span class="p">]</span>
                            <span class="o">+</span> <span class="n">zero_point_value</span>
                            <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">air</span>
                        <span class="p">)</span>

                    <span class="n">final_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;match_id&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;Added PSF photometry results to the catalog&quot;</span><span class="p">)</span>

                <span class="n">csv_buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>

                <span class="n">cols_to_drop</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;sky_center.ra&quot;</span><span class="p">,</span> <span class="s2">&quot;sky_center.dec&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">cols_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">cols_to_drop</span><span class="p">:</span>
                    <span class="n">final_table</span> <span class="o">=</span> <span class="n">final_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols_to_drop</span><span class="p">)</span>

                <span class="k">if</span> <span class="s2">&quot;match_id&quot;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">final_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;match_id&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;zero_point&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero_point_value</span>
                <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;zero_point_std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero_point_std</span>
                <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;airmass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">air</span>

                <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Final Photometry Catalog&quot;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">final_table</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

                <span class="n">final_table</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_buffer</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">csv_data</span> <span class="o">=</span> <span class="n">csv_buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

                <span class="n">filename</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">catalog_name</span>
                    <span class="k">if</span> <span class="n">catalog_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">)</span>
                    <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">catalog_name</span><span class="si">}</span><span class="s2">.csv&quot;</span>
                <span class="p">)</span>
                <span class="n">catalog_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">catalog_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">csv_data</span><span class="p">)</span>

                <span class="n">metadata_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_catalog_name</span><span class="si">}</span><span class="s2">_metadata.txt&quot;</span>
                <span class="n">metadata_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">metadata_filename</span><span class="p">)</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;RAPAS Photometry Analysis Metadata</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;================================</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Analysis Date: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input File: </span><span class="si">{</span><span class="n">science_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Catalog File: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Zero Point: </span><span class="si">{</span><span class="n">zero_point_value</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> Â± </span><span class="si">{</span><span class="n">zero_point_std</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Airmass: </span><span class="si">{</span><span class="n">air</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pixel Scale: </span><span class="si">{</span><span class="n">pixel_size_arcsec</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> arcsec/pixel</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;FWHM (estimated): </span><span class="si">{</span><span class="n">mean_fwhm_pixel</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> pixels (</span><span class="si">{</span><span class="n">seeing</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> arcsec)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Detection Parameters:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Threshold: </span><span class="si">{</span><span class="n">threshold_sigma</span><span class="si">}</span><span class="s2"> sigma</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Edge Mask: </span><span class="si">{</span><span class="n">detection_mask</span><span class="si">}</span><span class="s2"> pixels</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;  Gaia Magnitude Range: </span><span class="si">{</span><span class="n">gaia_min_mag</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">gaia_max_mag</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="s2">&quot;Saved catalog metadata&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error preparing download: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">zero_point_value</span><span class="p">,</span> <span class="n">zero_point_std</span><span class="p">,</span> <span class="n">final_table</span>


<span class="k">def</span><span class="w"> </span><span class="nf">batch_api_requests</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process API requests in batches to avoid overloading the server.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sources : list</span>
<span class="sd">        List of source names to query</span>
<span class="sd">    batch_size : int, optional</span>
<span class="sd">        Number of sources to process in each batch, default=100</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Combined results from all batches</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;ra&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;dec&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[]</span>
    <span class="p">}</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing batch </span><span class="si">{</span><span class="n">i</span><span class="o">//</span><span class="n">batch_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">batch_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">getJson</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">URL</span><span class="si">}</span><span class="s2">/source_details?name=</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
            
        <span class="c1"># Add a small delay between batches</span>
        <span class="c1"># time.sleep(0.5)</span>
        
    <span class="k">return</span> <span class="n">results</span>


<div class="viewcode-block" id="enhance_catalog_with_crossmatches">
<a class="viewcode-back" href="../api.html#pfr_app.enhance_catalog_with_crossmatches">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">enhance_catalog_with_crossmatches</span><span class="p">(</span>
    <span class="n">final_table</span><span class="p">,</span> <span class="n">matched_table</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">pixel_scale_arcsec</span><span class="p">,</span> <span class="n">search_radius_arcsec</span><span class="o">=</span><span class="mi">60</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enhance a photometric catalog with cross-matches from multiple astronomical databases.</span>

<span class="sd">    This function queries several catalogs and databases including:</span>
<span class="sd">    - GAIA DR3 (using previously matched sources)</span>
<span class="sd">    - Astro-Colibri (for known astronomical sources)</span>
<span class="sd">    - SIMBAD (for object identifications and classifications)</span>
<span class="sd">    - SkyBoT (for solar system objects)</span>
<span class="sd">    - AAVSO VSX (for variable stars)</span>
<span class="sd">    - VizieR VII/294 (for quasars)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    final_table : pandas.DataFrame</span>
<span class="sd">        Final photometry catalog with RA/Dec coordinates</span>
<span class="sd">    matched_table : pandas.DataFrame</span>
<span class="sd">        Table of already matched GAIA sources (used for calibration)</span>
<span class="sd">    header : dict or astropy.io.fits.Header</span>
<span class="sd">        FITS header with observation information</span>
<span class="sd">    pixel_scale_arcsec : float</span>
<span class="sd">        Pixel scale in arcseconds per pixel</span>
<span class="sd">    search_radius_arcsec : float, optional</span>
<span class="sd">        Search radius for cross-matching in arcseconds, default=60</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        Input dataframe with added catalog information including:</span>
<span class="sd">        - GAIA data for calibration stars</span>
<span class="sd">        - Astro-Colibri source identifications</span>
<span class="sd">        - SIMBAD identifications and object types</span>
<span class="sd">        - Solar system object identifications from SkyBoT</span>
<span class="sd">        - Variable star information from AAVSO VSX</span>
<span class="sd">        - Quasar information from VizieR VII/294</span>
<span class="sd">        - A summary column &#39;catalog_matches&#39; listing all catalog matches</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function shows progress updates in the Streamlit interface and creates</span>
<span class="sd">    a summary display of matched objects. Queries are made with appropriate</span>
<span class="sd">    error handling to prevent failures if any catalog service is unavailable.</span>
<span class="sd">    API requests are processed in batches to avoid overwhelming servers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">final_table</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_table</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No sources to cross-match with catalogs.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">final_table</span>

    <span class="n">status_text</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
    <span class="n">status_text</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Starting cross-match process...&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">matched_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_table</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">status_text</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Adding Gaia calibration matches...&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;xcenter&quot;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;ycenter&quot;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;match_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;xcenter&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                <span class="o">+</span> <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;ycenter&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;xcenter&quot;</span> <span class="ow">in</span> <span class="n">matched_table</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;ycenter&quot;</span> <span class="ow">in</span> <span class="n">matched_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">matched_table</span><span class="p">[</span><span class="s2">&quot;match_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">matched_table</span><span class="p">[</span><span class="s2">&quot;xcenter&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                <span class="o">+</span> <span class="n">matched_table</span><span class="p">[</span><span class="s2">&quot;ycenter&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">gaia_cols</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">col</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">matched_table</span><span class="o">.</span><span class="n">columns</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">col</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;gaia&quot;</span><span class="p">,</span> <span class="s2">&quot;phot_&quot;</span><span class="p">])</span>
            <span class="p">]</span>
            <span class="n">gaia_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;match_id&quot;</span><span class="p">)</span>

            <span class="n">gaia_subset</span> <span class="o">=</span> <span class="n">matched_table</span><span class="p">[</span><span class="n">gaia_cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">gaia_subset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="s2">&quot;match_id&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;gaia_&quot;</span><span class="p">):</span>
                    <span class="n">rename_dict</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;gaia_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="n">rename_dict</span><span class="p">:</span>
                <span class="n">gaia_subset</span> <span class="o">=</span> <span class="n">gaia_subset</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">rename_dict</span><span class="p">)</span>

            <span class="n">final_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">final_table</span><span class="p">,</span> <span class="n">gaia_subset</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;match_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

            <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;gaia_calib_star&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;match_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
                <span class="n">matched_table</span><span class="p">[</span><span class="s2">&quot;match_id&quot;</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matched_table</span><span class="p">)</span><span class="si">}</span><span class="s2"> Gaia calibration stars to catalog&quot;</span><span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Querying Astro-Colibri for object identifications...&quot;</span><span class="p">)</span>
    <span class="n">source</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;ra&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;dec&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">getJson</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">URL</span><span class="si">}</span><span class="s2">/known_sources&quot;</span><span class="p">)</span>
            
            <span class="c1"># Check if response is a string (likely JSON-encoded)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sources</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;sources&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse API response as JSON: </span><span class="si">{</span><span class="n">response</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected API response format: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error querying Astro-Colibri API: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Continue with function instead of returning None</span>

        <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Use batching for source details requests</span>
            <span class="c1"># source = batch_api_requests(sources)</span>
            <span class="c1"># astrostars = pd.DataFrame(source)</span>

            <span class="c1"># final_table[&quot;astro_colibri_name&quot;] = None</span>

            <span class="c1"># source_coords = SkyCoord(</span>
            <span class="c1">#     ra=final_table[&quot;ra&quot;].values,</span>
            <span class="c1">#     dec=final_table[&quot;dec&quot;].values,</span>
            <span class="c1">#     unit=&quot;deg&quot;,</span>
            <span class="c1"># )</span>

            <span class="c1"># astro_colibri_coords = SkyCoord(</span>
            <span class="c1">#     ra=astrostars[&quot;ra&quot;],</span>
            <span class="c1">#     dec=astrostars[&quot;dec&quot;],</span>
            <span class="c1">#     unit=(u.deg, u.deg),</span>
            <span class="c1"># )</span>

            <span class="c1"># if not isinstance(search_radius_arcsec, (int, float)) or search_radius_arcsec &lt;= 0:</span>
            <span class="c1">#     raise ValueError(&quot;Search radius must be a positive number&quot;)</span>
            
            <span class="c1"># idx, d2d, _ = source_coords.match_to_catalog_sky(astro_colibri_coords)</span>
            <span class="c1"># matches = d2d &lt; (search_radius_arcsec * u.arcsec)</span>

            <span class="c1"># for i, (match, match_idx) in enumerate(zip(matches, idx)):</span>
            <span class="c1">#     if match:</span>
            <span class="c1">#         final_table.loc[i, &quot;astro_colibri_name&quot;] = astrostars[&quot;name&quot;][match_idx]</span>
                    
            <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span><span class="si">}</span><span class="s2"> Astro-Colibri objects in field.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No Astro-Colibri sources found in the field.&quot;</span><span class="p">)</span>
            
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error querying Astro-Colibri: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No Astro-Colibri sources found.&quot;</span><span class="p">)</span>
        <span class="c1"># Continue with function instead of returning None</span>

    <span class="n">status_text</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Querying SIMBAD for object identifications...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">field_center_ra</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">field_center_dec</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s2">&quot;CRVAL1&quot;</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="s2">&quot;CRVAL2&quot;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">field_center_ra</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRVAL1&quot;</span><span class="p">])</span>
            <span class="n">field_center_dec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRVAL2&quot;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s2">&quot;RA&quot;</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="s2">&quot;DEC&quot;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">field_center_ra</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;RA&quot;</span><span class="p">])</span>
            <span class="n">field_center_dec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;DEC&quot;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s2">&quot;OBJRA&quot;</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="s2">&quot;OBJDEC&quot;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">field_center_ra</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;OBJRA&quot;</span><span class="p">])</span>
            <span class="n">field_center_dec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;OBJDEC&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">field_center_ra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">field_center_dec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mi">360</span> <span class="o">&lt;=</span> <span class="n">field_center_ra</span> <span class="o">&lt;=</span> <span class="mi">360</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="o">-</span><span class="mi">90</span> <span class="o">&lt;=</span> <span class="n">field_center_dec</span> <span class="o">&lt;=</span> <span class="mi">90</span>
            <span class="p">):</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Invalid coordinates: RA=</span><span class="si">{</span><span class="n">field_center_ra</span><span class="si">}</span><span class="s2">, DEC=</span><span class="si">{</span><span class="n">field_center_dec</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;NAXIS1&quot;</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="s2">&quot;NAXIS2&quot;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                    <span class="n">field_width_arcmin</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="nb">max</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NAXIS1&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NAXIS2&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span>
                        <span class="o">*</span> <span class="n">pixel_scale_arcsec</span>
                        <span class="o">/</span> <span class="mf">60.0</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">field_width_arcmin</span> <span class="o">=</span> <span class="mf">30.0</span>

                <span class="n">custom_simbad</span> <span class="o">=</span> <span class="n">Simbad</span><span class="p">()</span>
                <span class="n">custom_simbad</span><span class="o">.</span><span class="n">add_votable_fields</span><span class="p">(</span><span class="s2">&quot;otype&quot;</span><span class="p">,</span> <span class="s2">&quot;main_id&quot;</span><span class="p">,</span> <span class="s2">&quot;ids&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;V&quot;</span><span class="p">)</span>

                <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Querying SIMBAD&quot;</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">center_coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
                        <span class="n">ra</span><span class="o">=</span><span class="n">field_center_ra</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">field_center_dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span>
                    <span class="p">)</span>
                    <span class="n">simbad_result</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">safe_catalog_query</span><span class="p">(</span>
                        <span class="n">custom_simbad</span><span class="o">.</span><span class="n">query_region</span><span class="p">,</span>
                        <span class="s2">&quot;SIMBAD query failed&quot;</span><span class="p">,</span>
                        <span class="n">center_coord</span><span class="p">,</span>
                        <span class="n">radius</span><span class="o">=</span><span class="n">field_width_arcmin</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcmin</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">simbad_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">simbad_result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;simbad_main_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;simbad_otype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;simbad_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;simbad_B&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;simbad_V&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                            <span class="n">source_coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
                                <span class="n">ra</span><span class="o">=</span><span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                <span class="n">dec</span><span class="o">=</span><span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">,</span>
                            <span class="p">)</span>

                            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
                                <span class="n">col</span> <span class="ow">in</span> <span class="n">simbad_result</span><span class="o">.</span><span class="n">colnames</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="s2">&quot;dec&quot;</span><span class="p">]</span>
                            <span class="p">):</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">simbad_coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
                                        <span class="n">ra</span><span class="o">=</span><span class="n">simbad_result</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">],</span>
                                        <span class="n">dec</span><span class="o">=</span><span class="n">simbad_result</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">],</span>
                                        <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span>
                                    <span class="p">)</span>

                                    <span class="n">idx</span><span class="p">,</span> <span class="n">d2d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">source_coords</span><span class="o">.</span><span class="n">match_to_catalog_sky</span><span class="p">(</span>
                                        <span class="n">simbad_coords</span>
                                    <span class="p">)</span>
                                    <span class="n">matches</span> <span class="o">=</span> <span class="n">d2d</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">search_radius_arcsec</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>

                                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">match_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                                        <span class="nb">zip</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
                                    <span class="p">):</span>
                                        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                                            <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;simbad_main_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                                <span class="n">simbad_result</span><span class="p">[</span><span class="s2">&quot;main_id&quot;</span><span class="p">][</span><span class="n">match_idx</span><span class="p">]</span>
                                            <span class="p">)</span>
                                            <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;simbad_otype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                                <span class="n">simbad_result</span><span class="p">[</span><span class="s2">&quot;otype&quot;</span><span class="p">][</span><span class="n">match_idx</span><span class="p">]</span>
                                            <span class="p">)</span>
                                            <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;simbad_B&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                                <span class="n">simbad_result</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">][</span><span class="n">match_idx</span><span class="p">]</span>
                                            <span class="p">)</span>
                                            <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;simbad_V&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                                <span class="n">simbad_result</span><span class="p">[</span><span class="s2">&quot;V&quot;</span><span class="p">][</span><span class="n">match_idx</span><span class="p">]</span>
                                            <span class="p">)</span>
                                            <span class="k">if</span> <span class="s2">&quot;ids&quot;</span> <span class="ow">in</span> <span class="n">simbad_result</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                                                <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;simbad_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                                    <span class="n">simbad_result</span><span class="p">[</span><span class="s2">&quot;ids&quot;</span><span class="p">][</span><span class="n">match_idx</span><span class="p">]</span>
                                                <span class="p">)</span>

                                    <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                                        <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span><span class="si">}</span><span class="s2"> SIMBAD objects in field.&quot;</span>
                                    <span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                        <span class="sa">f</span><span class="s2">&quot;Error creating SkyCoord objects from SIMBAD data: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                                    <span class="p">)</span>
                                    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                        <span class="sa">f</span><span class="s2">&quot;Available SIMBAD columns: </span><span class="si">{</span><span class="n">simbad_result</span><span class="o">.</span><span class="n">colnames</span><span class="si">}</span><span class="s2">&quot;</span>
                                    <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">available_cols</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">simbad_result</span><span class="o">.</span><span class="n">colnames</span><span class="p">)</span>
                                <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;SIMBAD result missing required columns. Available columns: </span><span class="si">{</span><span class="n">available_cols</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No SIMBAD objects found in the field.&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SIMBAD query execution failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not extract field center coordinates from header&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in SIMBAD processing: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">status_text</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Querying SkyBoT for solar system objects...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field_center_ra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">field_center_dec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;DATE-OBS&quot;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="n">obs_date</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;DATE-OBS&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s2">&quot;DATE&quot;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="n">obs_date</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obs_date</span> <span class="o">=</span> <span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isot</span>

            <span class="n">obs_time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">obs_date</span><span class="p">)</span><span class="o">.</span><span class="n">isot</span>

            <span class="n">sr_value</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">field_width_arcmin</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">skybot_url</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;http://vo.imcce.fr/webservices/skybot/skybotconesearch_query.php?&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;RA=</span><span class="si">{</span><span class="n">field_center_ra</span><span class="si">}</span><span class="s2">&amp;DEC=</span><span class="si">{</span><span class="n">field_center_dec</span><span class="si">}</span><span class="s2">&amp;SR=</span><span class="si">{</span><span class="n">sr_value</span><span class="si">}</span><span class="s2">&amp;&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;EPOCH=</span><span class="si">{</span><span class="n">quote</span><span class="p">(</span><span class="n">obs_time</span><span class="p">)</span><span class="si">}</span><span class="s2">&amp;mime=json&quot;</span>
            <span class="p">)</span>

            <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Querying SkyBoT for solar system objects...&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;skybot_NAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;skybot_OBJECT_TYPE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;skybot_MAGV&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">skybot_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="n">response_text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">response_text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">response_text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">skybot_result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

                            <span class="k">if</span> <span class="s2">&quot;data&quot;</span> <span class="ow">in</span> <span class="n">skybot_result</span> <span class="ow">and</span> <span class="n">skybot_result</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]:</span>
                                <span class="n">skybot_coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
                                    <span class="n">ra</span><span class="o">=</span><span class="p">[</span>
                                        <span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;RA&quot;</span><span class="p">])</span>
                                        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">skybot_result</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
                                    <span class="p">],</span>
                                    <span class="n">dec</span><span class="o">=</span><span class="p">[</span>
                                        <span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;DEC&quot;</span><span class="p">])</span>
                                        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">skybot_result</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
                                    <span class="p">],</span>
                                    <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                                <span class="p">)</span>

                                <span class="n">source_coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
                                    <span class="n">ra</span><span class="o">=</span><span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                    <span class="n">dec</span><span class="o">=</span><span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                    <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                                <span class="p">)</span>

                                <span class="n">idx</span><span class="p">,</span> <span class="n">d2d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">source_coords</span><span class="o">.</span><span class="n">match_to_catalog_sky</span><span class="p">(</span>
                                    <span class="n">skybot_coords</span>
                                <span class="p">)</span>
                                <span class="n">matches</span> <span class="o">=</span> <span class="n">d2d</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">search_radius_arcsec</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>

                                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">match_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                                    <span class="nb">zip</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
                                <span class="p">):</span>
                                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                                        <span class="n">obj</span> <span class="o">=</span> <span class="n">skybot_result</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="n">match_idx</span><span class="p">]</span>
                                        <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;skybot_NAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;NAME&quot;</span><span class="p">]</span>
                                        <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;skybot_OBJECT_TYPE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span>
                                            <span class="s2">&quot;OBJECT_TYPE&quot;</span>
                                        <span class="p">]</span>
                                        <span class="k">if</span> <span class="s2">&quot;MAGV&quot;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                                            <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;skybot_MAGV&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span>
                                                <span class="s2">&quot;MAGV&quot;</span>
                                            <span class="p">]</span>

                                <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span><span class="si">}</span><span class="s2"> solar system objects in field.&quot;</span>
                                <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No solar system objects found in the field.&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;No solar system objects found (no valid JSON data returned). </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No solar system objects found in the field.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;SkyBoT query failed with status code </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">req_err</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request to SkyBoT failed: </span><span class="si">{</span><span class="n">req_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not determine field center for SkyBoT query&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in SkyBoT processing: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Querying AAVSO VSX for variable stars...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field_center_ra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">field_center_dec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Vizier</span><span class="o">.</span><span class="n">ROW_LIMIT</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">vizier_result</span> <span class="o">=</span> <span class="n">Vizier</span><span class="o">.</span><span class="n">query_region</span><span class="p">(</span>
                <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">field_center_ra</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">field_center_dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span>
                <span class="n">radius</span><span class="o">=</span><span class="n">field_width_arcmin</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcmin</span><span class="p">,</span>
                <span class="n">catalog</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;B/vsx/vsx&quot;</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">vizier_result</span>
                <span class="ow">and</span> <span class="s2">&quot;B/vsx/vsx&quot;</span> <span class="ow">in</span> <span class="n">vizier_result</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">vizier_result</span><span class="p">[</span><span class="s2">&quot;B/vsx/vsx&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="n">vsx_table</span> <span class="o">=</span> <span class="n">vizier_result</span><span class="p">[</span><span class="s2">&quot;B/vsx/vsx&quot;</span><span class="p">]</span>

                <span class="n">vsx_coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
                    <span class="n">ra</span><span class="o">=</span><span class="n">vsx_table</span><span class="p">[</span><span class="s2">&quot;RAJ2000&quot;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">vsx_table</span><span class="p">[</span><span class="s2">&quot;DEJ2000&quot;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span>
                <span class="p">)</span>
                <span class="n">source_coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
                    <span class="n">ra</span><span class="o">=</span><span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                    <span class="n">dec</span><span class="o">=</span><span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                    <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">idx</span><span class="p">,</span> <span class="n">d2d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">source_coords</span><span class="o">.</span><span class="n">match_to_catalog_sky</span><span class="p">(</span><span class="n">vsx_coords</span><span class="p">)</span>
                <span class="n">matches</span> <span class="o">=</span> <span class="n">d2d</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">search_radius_arcsec</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>

                <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;aavso_Name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;aavso_Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;aavso_Period&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">match_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">idx</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                        <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;aavso_Name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vsx_table</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">][</span><span class="n">match_idx</span><span class="p">]</span>
                        <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;aavso_Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vsx_table</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">][</span><span class="n">match_idx</span><span class="p">]</span>
                        <span class="k">if</span> <span class="s2">&quot;Period&quot;</span> <span class="ow">in</span> <span class="n">vsx_table</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                            <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;aavso_Period&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vsx_table</span><span class="p">[</span><span class="s2">&quot;Period&quot;</span><span class="p">][</span>
                                <span class="n">match_idx</span>
                            <span class="p">]</span>

                <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span><span class="si">}</span><span class="s2"> variable stars in field.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No variable stars found in the field.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error querying AAVSO VSX: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Querying VizieR VII/294 for quasars...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field_center_ra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">field_center_dec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># Set columns to retrieve from the quasar catalog</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">Vizier</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;RAJ2000&#39;</span><span class="p">,</span> <span class="s1">&#39;DEJ2000&#39;</span><span class="p">,</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;r_mag&#39;</span><span class="p">])</span>
            <span class="n">v</span><span class="o">.</span><span class="n">ROW_LIMIT</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># No row limit</span>

            <span class="c1"># Query the VII/294 catalog around the field center</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">query_region</span><span class="p">(</span>
                <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">field_center_ra</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">field_center_dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)),</span>
                <span class="n">width</span><span class="o">=</span><span class="n">field_width_arcmin</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcmin</span><span class="p">,</span>
                <span class="n">catalog</span><span class="o">=</span><span class="s1">&#39;VII/294&#39;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">result</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">qso_table</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                
                <span class="c1"># Convert to pandas DataFrame for easier matching</span>
                <span class="n">qso_df</span> <span class="o">=</span> <span class="n">qso_table</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
                <span class="n">qso_coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">qso_df</span><span class="p">[</span><span class="s1">&#39;RAJ2000&#39;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">qso_df</span><span class="p">[</span><span class="s1">&#39;DEJ2000&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
                
                <span class="c1"># Create source coordinates for matching</span>
                <span class="n">source_coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
                
                <span class="c1"># Perform cross-matching</span>
                <span class="n">idx</span><span class="p">,</span> <span class="n">d2d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">source_coords</span><span class="o">.</span><span class="n">match_to_catalog_3d</span><span class="p">(</span><span class="n">qso_coords</span><span class="p">)</span>
                <span class="n">matches</span> <span class="o">=</span> <span class="n">d2d</span><span class="o">.</span><span class="n">arcsec</span> <span class="o">&lt;=</span> <span class="n">search_radius_arcsec</span>
                
                <span class="c1"># Add matched quasar information to the final table</span>
                <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;qso_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;qso_redshift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;qso_r_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                
                <span class="n">matched_sources</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">matches</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">matched_qsos</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="n">matches</span><span class="p">]</span>
                
                <span class="k">for</span> <span class="n">source_idx</span><span class="p">,</span> <span class="n">qso_idx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">matched_sources</span><span class="p">,</span> <span class="n">matched_qsos</span><span class="p">):</span>
                    <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">source_idx</span><span class="p">,</span> <span class="s1">&#39;qso_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qso_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">qso_idx</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span>
                    <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">source_idx</span><span class="p">,</span> <span class="s1">&#39;qso_redshift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qso_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">qso_idx</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>
                    <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">source_idx</span><span class="p">,</span> <span class="s1">&#39;qso_r_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qso_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">qso_idx</span><span class="p">][</span><span class="s1">&#39;r_mag&#39;</span><span class="p">]</span>
                
                <span class="c1"># Update the catalog_matches column for matched quasars</span>
                <span class="n">has_qso</span> <span class="o">=</span> <span class="n">final_table</span><span class="p">[</span><span class="s1">&#39;qso_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
                <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">has_qso</span><span class="p">,</span> <span class="s1">&#39;catalog_matches&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;QSO; &#39;</span>
                
                <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">has_qso</span><span class="p">)</span><span class="si">}</span><span class="s2"> quasars in field from VII/294 catalog.&quot;</span><span class="p">)</span>
                <span class="n">write_to_log</span><span class="p">(</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;log_buffer&#39;</span><span class="p">),</span>
                    <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">has_qso</span><span class="p">)</span><span class="si">}</span><span class="s2"> quasar matches in VII/294 catalog&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;INFO&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No quasars found in field from VII/294 catalog.&quot;</span><span class="p">)</span>
                <span class="n">write_to_log</span><span class="p">(</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;log_buffer&#39;</span><span class="p">),</span>
                    <span class="s2">&quot;No quasars found in field from VII/294 catalog&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;INFO&quot;</span>
                <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error querying VizieR VII/294: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">write_to_log</span><span class="p">(</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;log_buffer&#39;</span><span class="p">),</span>
            <span class="sa">f</span><span class="s2">&quot;Error in VizieR VII/294 processing: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ERROR&quot;</span>
        <span class="p">)</span>

    <span class="n">status_text</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Cross-matching complete&quot;</span><span class="p">)</span>

    <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;catalog_matches&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;gaia_calib_star&quot;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">is_calib</span> <span class="o">=</span> <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;gaia_calib_star&quot;</span><span class="p">]</span>
        <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">is_calib</span><span class="p">,</span> <span class="s2">&quot;catalog_matches&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;GAIA (calib); &quot;</span>

    <span class="k">if</span> <span class="s2">&quot;simbad_main_id&quot;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">has_simbad</span> <span class="o">=</span> <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;simbad_main_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
        <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">has_simbad</span><span class="p">,</span> <span class="s2">&quot;catalog_matches&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;SIMBAD; &quot;</span>

    <span class="k">if</span> <span class="s2">&quot;skybot_NAME&quot;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">has_skybot</span> <span class="o">=</span> <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;skybot_NAME&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
        <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">has_skybot</span><span class="p">,</span> <span class="s2">&quot;catalog_matches&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;SkyBoT; &quot;</span>

    <span class="k">if</span> <span class="s2">&quot;aavso_Name&quot;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">has_aavso</span> <span class="o">=</span> <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;aavso_Name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
        <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">has_aavso</span><span class="p">,</span> <span class="s2">&quot;catalog_matches&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;AAVSO; &quot;</span>
    
    <span class="k">if</span> <span class="s2">&quot;qso_name&quot;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">has_qso</span> <span class="o">=</span> <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;qso_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
        <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">has_qso</span><span class="p">,</span> <span class="s2">&quot;catalog_matches&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;QSO; &quot;</span>

    <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;catalog_matches&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;catalog_matches&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)</span>
    <span class="n">final_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;catalog_matches&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;catalog_matches&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">matches_count</span> <span class="o">=</span> <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;catalog_matches&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">matches_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Matched Objects Summary (</span><span class="si">{</span><span class="n">matches_count</span><span class="si">}</span><span class="s2"> sources)&quot;</span><span class="p">)</span>
        <span class="n">matched_df</span> <span class="o">=</span> <span class="n">final_table</span><span class="p">[</span><span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;catalog_matches&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">display_cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;xcenter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ycenter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ra&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dec&quot;</span><span class="p">,</span>
            <span class="s2">&quot;aperture_calib_mag&quot;</span><span class="p">,</span>
            <span class="s2">&quot;catalog_matches&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">display_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">display_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">matched_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

        <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">matched_df</span><span class="p">[</span><span class="n">display_cols</span><span class="p">])</span>

    <span class="k">if</span> <span class="s2">&quot;match_id&quot;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">final_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;match_id&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">final_table</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">save_header_to_txt</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save a FITS header to a formatted text file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    header : dict or astropy.io.fits.Header</span>
<span class="sd">        FITS header dictionary or object</span>
<span class="sd">    filename : str</span>
<span class="sd">        Base filename to use (without extension)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str or None</span>
<span class="sd">        Full path to the saved file, or None if saving failed</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function formats the header with each keyword-value pair on a separate line,</span>
<span class="sd">    includes a header section, and saves the file to the current output directory</span>
<span class="sd">    (retrieved from session state).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">header_txt</span> <span class="o">=</span> <span class="s2">&quot;FITS Header</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">header_txt</span> <span class="o">+=</span> <span class="s2">&quot;==========</span><span class="se">\n\n</span><span class="s2">&quot;</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">header_txt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">:</span><span class="s2">8</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="n">output_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header_txt</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_filename</span>


<div class="viewcode-block" id="display_catalog_in_aladin">
<a class="viewcode-back" href="../api.html#pfr_app.display_catalog_in_aladin">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">display_catalog_in_aladin</span><span class="p">(</span>
    <span class="n">final_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">ra_center</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">dec_center</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">fov</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">ra_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ra&quot;</span><span class="p">,</span>
    <span class="n">dec_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;dec&quot;</span><span class="p">,</span>
    <span class="n">mag_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;calib_mag&quot;</span><span class="p">,</span>
    <span class="n">alt_mag_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;aperture_calib_mag&quot;</span><span class="p">,</span>
    <span class="n">catalog_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;catalog_matches&quot;</span><span class="p">,</span>
    <span class="n">id_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;simbad_main_id&quot;</span><span class="p">,</span> <span class="s2">&quot;skybot_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;aavso_Name&quot;</span><span class="p">],</span>
    <span class="n">fallback_id_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Source&quot;</span><span class="p">,</span>
    <span class="n">survey</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;CDS/P/DSS2/color&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display a DataFrame catalog in an embedded Aladin Lite interactive sky viewer.</span>

<span class="sd">    This function creates an interactive astronomical image with catalog overlay</span>
<span class="sd">    that allows exploring detected sources and their cross-matches.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    final_table : pandas.DataFrame</span>
<span class="sd">        DataFrame containing catalog data with coordinates and photometry</span>
<span class="sd">    ra_center : float</span>
<span class="sd">        Right Ascension center coordinate for the Aladin view (degrees)</span>
<span class="sd">    dec_center : float</span>
<span class="sd">        Declination center coordinate for the Aladin view (degrees)</span>
<span class="sd">    fov : float, optional</span>
<span class="sd">        Initial field of view in degrees, default=0.5</span>
<span class="sd">    ra_col : str, optional</span>
<span class="sd">        Name of the column containing Right Ascension values, default=&#39;ra&#39;</span>
<span class="sd">    dec_col : str, optional</span>
<span class="sd">        Name of the column containing Declination values, default=&#39;dec&#39;</span>
<span class="sd">    mag_col : str, optional</span>
<span class="sd">        Name of the primary magnitude column, default=&#39;calib_mag&#39;</span>
<span class="sd">    alt_mag_col : str, optional</span>
<span class="sd">        Name of an alternative (preferred) magnitude column, default=&#39;aperture_calib_mag&#39;</span>
<span class="sd">    catalog_col : str, optional</span>
<span class="sd">        Name of the column containing catalog match information, default=&#39;catalog_matches&#39;</span>
<span class="sd">    id_cols : list[str], optional</span>
<span class="sd">        List of column names (in order of preference) to use for source identifiers</span>
<span class="sd">    fallback_id_prefix : str, optional</span>
<span class="sd">        Prefix to use for source names if no ID is found, default=&quot;Source&quot;</span>
<span class="sd">    survey : str, optional</span>
<span class="sd">        The initial sky survey to display in Aladin Lite, default=&quot;CDS/P/DSS2/color&quot;</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function creates an interactive HTML component embedded in Streamlit that</span>
<span class="sd">    shows a DSS image of the field with catalog sources overlaid as interactive markers.</span>
<span class="sd">    Each marker shows a popup with detailed source information when clicked.</span>

<span class="sd">    Handles errors gracefully and provides feedback in the Streamlit interface</span>
<span class="sd">    if any issues occur.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">ra_center</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dec_center</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
    <span class="p">):</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Missing or invalid center coordinates (RA/Dec) for Aladin display.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">final_table</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">or</span> <span class="n">final_table</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Input table is empty or not a DataFrame. Cannot display in Aladin.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">ra_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="n">dec_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Required columns &#39;</span><span class="si">{</span><span class="n">ra_col</span><span class="si">}</span><span class="s2">&#39; or &#39;</span><span class="si">{</span><span class="n">dec_col</span><span class="si">}</span><span class="s2">&#39; not found in the DataFrame.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span>

    <span class="n">catalog_sources</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">required_cols</span> <span class="o">=</span> <span class="p">{</span><span class="n">ra_col</span><span class="p">,</span> <span class="n">dec_col</span><span class="p">}</span>
    <span class="n">optional_cols</span> <span class="o">=</span> <span class="p">{</span><span class="n">mag_col</span><span class="p">,</span> <span class="n">alt_mag_col</span><span class="p">,</span> <span class="n">catalog_col</span><span class="p">}</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">id_cols</span><span class="p">))</span>
    <span class="n">available_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="n">present_optional_cols</span> <span class="o">=</span> <span class="n">optional_cols</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">available_cols</span><span class="p">)</span>
    <span class="n">cols_to_iterate</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">required_cols</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">present_optional_cols</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">final_table</span><span class="p">[</span><span class="n">cols_to_iterate</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">ra_val</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">ra_col</span><span class="p">]</span>
        <span class="n">dec_val</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">dec_col</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">ra_val</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">dec_val</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ra&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">ra_val</span><span class="p">),</span> <span class="s2">&quot;dec&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">dec_val</span><span class="p">)}</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">mag_to_use</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">alt_mag_col</span> <span class="ow">in</span> <span class="n">present_optional_cols</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">alt_mag_col</span><span class="p">]):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mag_to_use</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">alt_mag_col</span><span class="p">])</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">mag_col</span> <span class="ow">in</span> <span class="n">present_optional_cols</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">mag_col</span><span class="p">]):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mag_to_use</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">mag_col</span><span class="p">])</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="k">pass</span>

            <span class="k">if</span> <span class="n">mag_to_use</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">source</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mag_to_use</span>

            <span class="k">if</span> <span class="n">catalog_col</span> <span class="ow">in</span> <span class="n">present_optional_cols</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">catalog_col</span><span class="p">]):</span>
                <span class="n">source</span><span class="p">[</span><span class="s2">&quot;catalog&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">catalog_col</span><span class="p">])</span>

            <span class="n">source_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fallback_id_prefix</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">id_cols</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">id_col</span> <span class="ow">in</span> <span class="n">id_cols</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">id_col</span> <span class="ow">in</span> <span class="n">present_optional_cols</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">id_col</span><span class="p">]):</span>
                        <span class="n">source_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">id_col</span><span class="p">])</span>
                        <span class="k">break</span>
            <span class="n">source</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_id</span>

            <span class="n">catalog_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">catalog_sources</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No valid sources with RA/Dec found in the table to display.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">spinner</span><span class="p">(</span><span class="s2">&quot;Loading Aladin Lite viewer...&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sources_json_b64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">catalog_sources</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

            <span class="n">html_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            &lt;!DOCTYPE html&gt;</span>
<span class="s2">            &lt;html&gt;</span>
<span class="s2">            &lt;head&gt;</span>
<span class="s2">                &lt;meta charset=&quot;utf-8&quot;&gt;</span>
<span class="s2">                &lt;title&gt;Aladin Lite&lt;/title&gt;</span>
<span class="s2">            &lt;/head&gt;</span>
<span class="s2">            &lt;body&gt;</span>
<span class="s2">                &lt;div id=&quot;aladin-lite-div&quot; style=&quot;width:100%;height:550px;&quot;&gt;&lt;/div&gt;</span>
<span class="s2">                &lt;script type=&quot;text/javascript&quot; src=&quot;https://aladin.u-strasbg.fr/AladinLite/api/v3/latest/aladin.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;</span>
<span class="s2">                &lt;script type=&quot;text/javascript&quot;&gt;</span>
<span class="s2">                    document.addEventListener(&quot;DOMContentLoaded&quot;, function(event) </span><span class="se">{{</span>
<span class="s2">                        try </span><span class="se">{{</span>
<span class="s2">                            let aladin = A.aladin(&#39;#aladin-lite-div&#39;, </span><span class="se">{{</span>
<span class="s2">                                target: &#39;</span><span class="si">{</span><span class="n">ra_center</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">dec_center</span><span class="si">}</span><span class="s2">&#39;,</span>
<span class="s2">                                fov: </span><span class="si">{</span><span class="n">fov</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                                survey: &#39;</span><span class="si">{</span><span class="n">survey</span><span class="si">}</span><span class="s2">&#39;,</span>
<span class="s2">                                cooFrame: &#39;J2000&#39;,</span>
<span class="s2">                                showReticle: false,</span>
<span class="s2">                                showZoomControl: true,</span>
<span class="s2">                                showFullscreenControl: true,</span>
<span class="s2">                                showLayersControl: true,</span>
<span class="s2">                                showGotoControl: true,</span>
<span class="s2">                                showSimbadPointerControl: true</span>
<span class="s2">                            </span><span class="se">}}</span><span class="s2">);</span>

<span class="s2">                            let cat = A.catalog(</span><span class="se">{{</span>
<span class="s2">                                name: &#39;Photometry Results&#39;,</span>
<span class="s2">                                sourceSize: 12,</span>
<span class="s2">                                shape: &#39;circle&#39;,</span>
<span class="s2">                                color: &#39;#00ff88&#39;,</span>
<span class="s2">                                onClick: &#39;showPopup&#39;</span>
<span class="s2">                            </span><span class="se">}}</span><span class="s2">);</span>
<span class="s2">                            aladin.addCatalog(cat);</span>

<span class="s2">                            let sourcesData = JSON.parse(atob(&quot;</span><span class="si">{</span><span class="n">sources_json_b64</span><span class="si">}</span><span class="s2">&quot;));</span>
<span class="s2">                            let aladinSources = [];</span>

<span class="s2">                            sourcesData.forEach(function(source) </span><span class="se">{{</span>
<span class="s2">                                let popupContent = &#39;&lt;div style=&quot;padding:5px;&quot;&gt;&#39;;</span>
<span class="s2">                                if(source.name) </span><span class="se">{{</span>
<span class="s2">                                    popupContent += &#39;&lt;b&gt;&#39; + source.name + &#39;&lt;/b&gt;&lt;br/&gt;&#39;;</span>
<span class="s2">                                </span><span class="se">}}</span>
<span class="s2">                                popupContent += &#39;RA: &#39; + (typeof source.ra === &#39;number&#39; ? source.ra.toFixed(6) : source.ra) + &#39;&lt;br/&gt;&#39;;</span>
<span class="s2">                                popupContent += &#39;Dec: &#39; + (typeof source.dec === &#39;number&#39; ? source.dec.toFixed(6) : source.dec) + &#39;&lt;br/&gt;&#39;;</span>

<span class="s2">                                if(source.mag) </span><span class="se">{{</span>
<span class="s2">                                    popupContent += &#39;Mag: &#39; + (typeof source.mag === &#39;number&#39; ? source.mag.toFixed(2) : source.mag) + &#39;&lt;br/&gt;&#39;;</span>
<span class="s2">                                </span><span class="se">}}</span>
<span class="s2">                                if(source.catalog) </span><span class="se">{{</span>
<span class="s2">                                    popupContent += &#39;Catalogs: &#39; + source.catalog + &#39;&lt;br/&gt;&#39;;</span>
<span class="s2">                                </span><span class="se">}}</span>
<span class="s2">                                popupContent += &#39;&lt;/div&gt;&#39;;</span>

<span class="s2">                                let aladinSource = A.source(</span>
<span class="s2">                                    source.ra,</span>
<span class="s2">                                    source.dec,</span>
<span class="s2">                                    </span><span class="se">{{</span><span class="s2"> description: popupContent </span><span class="se">}}</span>
<span class="s2">                                );</span>
<span class="s2">                                aladinSources.push(aladinSource);</span>
<span class="s2">                            </span><span class="se">}}</span><span class="s2">);</span>

<span class="s2">                            if (aladinSources.length &gt; 0) </span><span class="se">{{</span>
<span class="s2">                                cat.addSources(aladinSources);</span>
<span class="s2">                            </span><span class="se">}}</span>

<span class="s2">                        </span><span class="se">}}</span><span class="s2"> catch (error) </span><span class="se">{{</span>
<span class="s2">                            console.error(&quot;Error initializing Aladin Lite or adding sources:&quot;, error);</span>
<span class="s2">                            document.getElementById(&#39;aladin-lite-div&#39;).innerHTML = &#39;&lt;p style=&quot;color:red;&quot;&gt;Error loading Aladin viewer. Check console.&lt;/p&gt;&#39;;</span>
<span class="s2">                        </span><span class="se">}}</span>
<span class="s2">                    </span><span class="se">}}</span><span class="s2">);</span>
<span class="s2">                &lt;/script&gt;</span>
<span class="s2">            &lt;/body&gt;</span>
<span class="s2">            &lt;/html&gt;</span>
<span class="s2">            &quot;&quot;&quot;</span>

            <span class="n">components</span><span class="o">.</span><span class="n">html</span><span class="p">(</span>
                <span class="n">html_content</span><span class="p">,</span>
                <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>  <span class="c1"># Explicitly set a height</span>
                <span class="n">scrolling</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Streamlit failed to render the Aladin HTML component: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>



<div class="viewcode-block" id="initialize_session_state">
<a class="viewcode-back" href="../api.html#pfr_app.initialize_session_state">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">initialize_session_state</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize all session state variables for the application.</span>

<span class="sd">    This function ensures all required session state variables are properly</span>
<span class="sd">    initialized with default values when the application starts or reloads.</span>

<span class="sd">    The session state includes:</span>
<span class="sd">    - Image data storage (calibrated data, headers, photometry tables)</span>
<span class="sd">    - Log handling (buffer and filenames)</span>
<span class="sd">    - Coordinate storage (manual input and validated coordinates)</span>
<span class="sd">    - Analysis parameters (seeing, thresholds, calibration options)</span>
<span class="sd">    - File tracking (loaded files)</span>

<span class="sd">    This centralized initialization ensures consistent state management</span>
<span class="sd">    throughout the application lifecycle.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;calibrated_data&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;calibrated_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s2">&quot;calibrated_header&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;calibrated_header&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s2">&quot;final_phot_table&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;final_phot_table&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s2">&quot;epsf_model&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;epsf_model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s2">&quot;epsf_photometry_result&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;epsf_photometry_result&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="s2">&quot;log_buffer&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;log_buffer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s2">&quot;base_filename&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;base_filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;photometry&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;manual_ra&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;manual_ra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;manual_dec&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;manual_dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;valid_ra&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;valid_ra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s2">&quot;valid_dec&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;valid_dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="s2">&quot;analysis_parameters&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;analysis_parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;seeing&quot;</span><span class="p">:</span> <span class="mf">3.5</span><span class="p">,</span>
            <span class="s2">&quot;threshold_sigma&quot;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
            <span class="s2">&quot;detection_mask&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
            <span class="s2">&quot;gaia_band&quot;</span><span class="p">:</span> <span class="s2">&quot;phot_g_mean_mag&quot;</span><span class="p">,</span>
            <span class="s2">&quot;gaia_min_mag&quot;</span><span class="p">:</span> <span class="mf">11.0</span><span class="p">,</span>
            <span class="s2">&quot;gaia_max_mag&quot;</span><span class="p">:</span> <span class="mf">19.0</span><span class="p">,</span>
            <span class="s2">&quot;calibrate_bias&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;calibrate_dark&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;calibrate_flat&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">if</span> <span class="s2">&quot;files_loaded&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;files_loaded&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;science_file&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;bias_file&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;dark_file&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;flat_file&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">get_base_filename</span><span class="p">(</span><span class="n">file_obj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the base filename from an uploaded file object without extension.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file_obj : UploadedFile</span>
<span class="sd">        The uploaded file object from Streamlit&#39;s file_uploader</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Base filename without extension(s)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Returns &quot;photometry&quot; as default if file_obj is None</span>
<span class="sd">    - Handles multiple extensions (e.g., .fits.fz) by applying splitext twice</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">file_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;photometry&quot;</span>

    <span class="n">original_name</span> <span class="o">=</span> <span class="n">file_obj</span><span class="o">.</span><span class="n">name</span>
    <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">original_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">base_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">base_name</span>


<span class="k">def</span><span class="w"> </span><span class="nf">initialize_log</span><span class="p">(</span><span class="n">base_filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize a log buffer for the current processing session.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    base_filename : str</span>
<span class="sd">        Base name for the log file (usually from the science file)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    StringIO</span>
<span class="sd">        Log buffer object with header information</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Creates a formatted log header with timestamp and input filename,</span>
<span class="sd">    which will be written to a file at the end of processing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log_buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>

    <span class="n">log_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Photometry Factory for RAPAS Log</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">log_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;===============================</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">log_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing started: </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">log_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input file: </span><span class="si">{</span><span class="n">base_filename</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">log_buffer</span>


<div class="viewcode-block" id="write_to_log">
<a class="viewcode-back" href="../api.html#pfr_app.write_to_log">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a message to the log buffer with timestamp and severity level.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    log_buffer : StringIO</span>
<span class="sd">        The log buffer to write to</span>
<span class="sd">    message : str</span>
<span class="sd">        The message to log</span>
<span class="sd">    level : str, optional</span>
<span class="sd">        Log severity level (INFO, WARNING, ERROR), default=&quot;INFO&quot;</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Does nothing if log_buffer is None</span>
<span class="sd">    - Prepends each log entry with a timestamp and level indicator</span>
<span class="sd">    - Format: [HH:MM:SS] LEVEL: Message</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">log_buffer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">)</span>
    <span class="n">log_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">provide_download_buttons</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a single download button for a zip file containing all files in the specified folder.</span>
<span class="sd">    </span>
<span class="sd">    This function compresses all files in the given folder into a single zip archive</span>
<span class="sd">    and provides a download button for the archive.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        folder_path (str): The path to the folder containing files to be zipped and made downloadable</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        None: The function creates a Streamlit download button directly in the app interface</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">BytesIO</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No files found in output directory&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># Create a timestamp for the zip filename</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;base_filename&#39;</span><span class="p">,</span> <span class="s1">&#39;pfr_results&#39;</span><span class="p">)</span>
        <span class="n">zip_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.zip&quot;</span>
        
        <span class="c1"># Create in-memory zip file</span>
        <span class="n">zip_buffer</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_buffer</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span> <span class="k">as</span> <span class="n">zip_file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                <span class="c1"># Add each file to the zip archive with its filename (not the full path)</span>
                <span class="n">zip_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
        
        <span class="c1"># Reset buffer position to the beginning</span>
        <span class="n">zip_buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Create download button for the zip file</span>
        <span class="n">st</span><span class="o">.</span><span class="n">download_button</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ðŸ“¦ Download All Results (ZIP)&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">zip_buffer</span><span class="p">,</span>
            <span class="n">file_name</span><span class="o">=</span><span class="n">zip_filename</span><span class="p">,</span>
            <span class="n">mime</span><span class="o">=</span><span class="s2">&quot;application/zip&quot;</span><span class="p">,</span>
            <span class="n">on_click</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span>
        <span class="p">)</span>
        
        <span class="c1"># Show number of files included</span>
        <span class="n">st</span><span class="o">.</span><span class="n">caption</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Archive contains </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2"> files&quot;</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating zip archive: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">update_observatory_inputs</span><span class="p">(</span><span class="n">science_header</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update observatory inputs with values from science header or defaults&quot;&quot;&quot;</span>
    <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Observatory Location&quot;</span><span class="p">)</span>
    
    <span class="c1"># Default values</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;TJMS&#39;</span><span class="p">,</span>
        <span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="mf">48.29166</span><span class="p">,</span>
        <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="mf">2.43805</span><span class="p">,</span>
        <span class="s1">&#39;elevation&#39;</span><span class="p">:</span> <span class="mf">94.0</span>
    <span class="p">}</span>

    <span class="c1"># Get values from header if available</span>
    <span class="k">if</span> <span class="n">science_header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OBSERVAT&#39;</span><span class="p">,</span> <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LATITUDE&#39;</span><span class="p">,</span> 
                                   <span class="n">science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LAT-OBS&#39;</span><span class="p">,</span> <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">])))</span>
        <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LONGITUD&#39;</span><span class="p">,</span> 
                                    <span class="n">science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LONG-OBS&#39;</span><span class="p">,</span> <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">])))</span>
        <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ELEVATIO&#39;</span><span class="p">,</span> 
                                    <span class="n">science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ALT-OBS&#39;</span><span class="p">,</span> <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">])))</span>

    <span class="c1"># Create a unique prefix for keys based on whether we&#39;re using header values</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;header_&quot;</span> <span class="k">if</span> <span class="n">science_header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;default_&quot;</span>

    <span class="c1"># Create the input widgets with the determined values and unique keys</span>
    <span class="n">observatory_name</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span>
        <span class="s2">&quot;Observatory Name&quot;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Name of the observatory&quot;</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">observatory_name&quot;</span>
    <span class="p">)</span>
    
    <span class="n">latitude</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">number_input</span><span class="p">(</span>
        <span class="s2">&quot;Latitude (Â°)&quot;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">],</span>
        <span class="n">min_value</span><span class="o">=-</span><span class="mf">90.0</span><span class="p">,</span>
        <span class="n">max_value</span><span class="o">=</span><span class="mf">90.0</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Observatory latitude in degrees (-90 to 90)&quot;</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">latitude&quot;</span>
    <span class="p">)</span>
    
    <span class="n">longitude</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">number_input</span><span class="p">(</span>
        <span class="s2">&quot;Longitude (Â°)&quot;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">],</span>
        <span class="n">min_value</span><span class="o">=-</span><span class="mf">180.0</span><span class="p">,</span>
        <span class="n">max_value</span><span class="o">=</span><span class="mf">180.0</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Observatory longitude in degrees (-180 to 180)&quot;</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">longitude&quot;</span>
    <span class="p">)</span>
    
    <span class="n">elevation</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">number_input</span><span class="p">(</span>
        <span class="s2">&quot;Elevation (m)&quot;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">],</span>
        <span class="n">min_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Observatory elevation in meters above sea level&quot;</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">elevation&quot;</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">observatory_name</span><span class="p">,</span>
        <span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="n">latitude</span><span class="p">,</span>
        <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="n">longitude</span><span class="p">,</span>
        <span class="s1">&#39;elevation&#39;</span><span class="p">:</span> <span class="n">elevation</span>
    <span class="p">}</span>


<span class="n">initialize_session_state</span><span class="p">()</span>

<span class="n">st</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;_Photometry Factory for RAPAS_&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="p">:</span>
    <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Upload FITS Files&quot;</span><span class="p">)</span>

    <span class="n">bias_file</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">file_uploader</span><span class="p">(</span>
        <span class="s2">&quot;Master Bias (optional)&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;fits&quot;</span><span class="p">,</span> <span class="s2">&quot;fit&quot;</span><span class="p">,</span> <span class="s2">&quot;fts&quot;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;bias_uploader&quot;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">bias_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">files_loaded</span><span class="p">[</span><span class="s2">&quot;bias_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bias_file</span>

    <span class="n">dark_file</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">file_uploader</span><span class="p">(</span>
        <span class="s2">&quot;Master Dark (optional)&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;fits&quot;</span><span class="p">,</span> <span class="s2">&quot;fit&quot;</span><span class="p">,</span> <span class="s2">&quot;fts&quot;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;dark_uploader&quot;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">dark_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">files_loaded</span><span class="p">[</span><span class="s2">&quot;dark_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dark_file</span>

    <span class="n">flat_file</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">file_uploader</span><span class="p">(</span>
        <span class="s2">&quot;Master Flat (optional)&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;fits&quot;</span><span class="p">,</span> <span class="s2">&quot;fit&quot;</span><span class="p">,</span> <span class="s2">&quot;fts&quot;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;flat_uploader&quot;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">flat_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">files_loaded</span><span class="p">[</span><span class="s2">&quot;flat_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flat_file</span>

    <span class="n">science_file</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">file_uploader</span><span class="p">(</span>
        <span class="s2">&quot;Science Image (required)&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;fits&quot;</span><span class="p">,</span> <span class="s2">&quot;fit&quot;</span><span class="p">,</span> <span class="s2">&quot;fts&quot;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;science_uploader&quot;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">science_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">files_loaded</span><span class="p">[</span><span class="s2">&quot;science_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">science_file</span>

        <span class="n">base_filename</span> <span class="o">=</span> <span class="n">get_base_filename</span><span class="p">(</span><span class="n">science_file</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;base_filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_filename</span>

        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;log_buffer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initialize_log</span><span class="p">(</span><span class="n">science_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Calibration Options&quot;</span><span class="p">)</span>
    <span class="n">calibrate_bias</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">checkbox</span><span class="p">(</span>
        <span class="s2">&quot;Apply Bias&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Subtract bias frame from science image&quot;</span>
    <span class="p">)</span>
    <span class="n">calibrate_dark</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">checkbox</span><span class="p">(</span>
        <span class="s2">&quot;Apply Dark&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Subtract dark frame from science image&quot;</span>
    <span class="p">)</span>
    <span class="n">calibrate_flat</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">checkbox</span><span class="p">(</span>
        <span class="s2">&quot;Apply Flat Field&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Divide science image by flat field&quot;</span>
    <span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Astrometry.net&quot;</span><span class="p">)</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span>
        <span class="s2">&quot;API Key&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enter your astrometry.net API key&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;password&quot;</span>
    <span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">caption</span><span class="p">(</span><span class="s2">&quot;Get your own key at [nova.astrometry.net](http://nova.astrometry.net/)&quot;</span><span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Analysis Parameters&quot;</span><span class="p">)</span>
    <span class="n">seeing</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">slider</span><span class="p">(</span>
        <span class="s2">&quot;Seeing (arcsec)&quot;</span><span class="p">,</span>
        <span class="mf">1.0</span><span class="p">,</span>
        <span class="mf">6.0</span><span class="p">,</span>
        <span class="mf">3.0</span><span class="p">,</span>
        <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Estimate of the atmospheric seeing in arcseconds&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">threshold_sigma</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">slider</span><span class="p">(</span>
        <span class="s2">&quot;Detection Threshold (Ïƒ)&quot;</span><span class="p">,</span>
        <span class="mf">1.0</span><span class="p">,</span>
        <span class="mf">5.0</span><span class="p">,</span>
        <span class="mf">3.0</span><span class="p">,</span>
        <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Source detection threshold in sigma above background&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">detection_mask</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">slider</span><span class="p">(</span>
        <span class="s2">&quot;Border Mask (pixels)&quot;</span><span class="p">,</span>
        <span class="mi">25</span><span class="p">,</span>
        <span class="mi">200</span><span class="p">,</span>
        <span class="mi">50</span><span class="p">,</span>
        <span class="mi">25</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Size of border to exclude from source detection&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Initialize observatory with default values</span>
    <span class="k">if</span> <span class="s1">&#39;observatory_data&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">observatory_data</span> <span class="o">=</span> <span class="n">update_observatory_inputs</span><span class="p">()</span>

    <span class="c1"># st.header(&quot;Observatory Location&quot;)</span>
    <span class="c1"># observatory_name = st.text_input(</span>
    <span class="c1">#     &quot;Observatory Name&quot;,</span>
    <span class="c1">#     value=science_header.get(&#39;OBSERVAT&#39;, &#39;TJMS&#39;) if science_header is not None else &#39;TJMS&#39;,</span>
    <span class="c1">#     help=&quot;Name of the observatory&quot;</span>
    <span class="c1"># )</span>
    <span class="c1"># latitude = st.number_input(</span>
    <span class="c1">#     &quot;Latitude (Â°)&quot;, </span>
    <span class="c1">#     value=float(science_header.get(&#39;LATITUDE&#39;, science_header.get(&#39;LAT-OBS&#39;, 48.29166))) if science_header is not None else 48.29166,</span>
    <span class="c1">#     min_value=-90.0,</span>
    <span class="c1">#     max_value=90.0,</span>
    <span class="c1">#     help=&quot;Observatory latitude in degrees (-90 to 90)&quot;</span>
    <span class="c1"># )</span>
    <span class="c1"># longitude = st.number_input(</span>
    <span class="c1">#     &quot;Longitude (Â°)&quot;,</span>
    <span class="c1">#     value=float(science_header.get(&#39;LONGITUD&#39;, science_header.get(&#39;LONG-OBS&#39;, 2.43805))) if science_header is not None else 2.43805,</span>
    <span class="c1">#     min_value=-180.0,</span>
    <span class="c1">#     max_value=180.0,</span>
    <span class="c1">#     help=&quot;Observatory longitude in degrees (-180 to 180)&quot; </span>
    <span class="c1"># )</span>
    <span class="c1"># elevation = st.number_input(</span>
    <span class="c1">#     &quot;Elevation (m)&quot;,</span>
    <span class="c1">#     value=float(science_header.get(&#39;ELEVATIO&#39;, science_header.get(&#39;ALT-OBS&#39;, 94.0))) if science_header is not None else 94.0,</span>
    <span class="c1">#     min_value=0.0,</span>
    <span class="c1">#     help=&quot;Observatory elevation in meters above sea level&quot;</span>
    <span class="c1"># )</span>

    <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Gaia Parameters&quot;</span><span class="p">)</span>
    <span class="n">gaia_band</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span>
        <span class="s2">&quot;Gaia Band&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;phot_g_mean_mag&quot;</span><span class="p">,</span> <span class="s2">&quot;phot_bp_mean_mag&quot;</span><span class="p">,</span> <span class="s2">&quot;phot_rp_mean_mag&quot;</span><span class="p">],</span>
        <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Gaia magnitude band to use for calibration&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">gaia_min_mag</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">slider</span><span class="p">(</span>
        <span class="s2">&quot;Gaia Min Magnitude&quot;</span><span class="p">,</span>
        <span class="mf">6.0</span><span class="p">,</span>
        <span class="mf">12.0</span><span class="p">,</span>
        <span class="mf">10.0</span><span class="p">,</span>
        <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Minimum magnitude for Gaia sources&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">gaia_max_mag</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">slider</span><span class="p">(</span>
        <span class="s2">&quot;Gaia Max Magnitude&quot;</span><span class="p">,</span>
        <span class="mf">15.0</span><span class="p">,</span>
        <span class="mf">20.0</span><span class="p">,</span>
        <span class="mf">19.0</span><span class="p">,</span>
        <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Maximum magnitude for Gaia sources&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Output Options&quot;</span><span class="p">)</span>
    <span class="n">default_catalog_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;base_filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_phot.csv&quot;</span>
    <span class="n">catalog_name</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span><span class="s2">&quot;Output Catalog Filename&quot;</span><span class="p">,</span> <span class="n">default_catalog_name</span><span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Quick Links&quot;</span><span class="p">)</span>
    <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="k">with</span> <span class="n">col1</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">link_button</span><span class="p">(</span><span class="s2">&quot;GAIA-Archive&quot;</span><span class="p">,</span> <span class="s2">&quot;https://gea.esac.esa.int/archive/&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">link_button</span><span class="p">(</span><span class="s2">&quot;Simbad&quot;</span><span class="p">,</span> <span class="s2">&quot;http://simbad.u-strasbg.fr/simbad/&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">link_button</span><span class="p">(</span><span class="s2">&quot;SkyBoT&quot;</span><span class="p">,</span> <span class="s2">&quot;https://ssp.imcce.fr/webservices/skybot/&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">link_button</span><span class="p">(</span><span class="s2">&quot;VizieR&quot;</span><span class="p">,</span> <span class="s2">&quot;http://vizier.u-strasbg.fr/viz-bin/VizieR&quot;</span><span class="p">)</span>
        
    <span class="k">with</span> <span class="n">col2</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">link_button</span><span class="p">(</span><span class="s2">&quot;Astro-Colibri&quot;</span><span class="p">,</span> <span class="s2">&quot;https://astro-colibri.com/&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">link_button</span><span class="p">(</span><span class="s2">&quot;X-Match&quot;</span><span class="p">,</span> <span class="s2">&quot;http://cdsxmatch.u-strasbg.fr/&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">link_button</span><span class="p">(</span><span class="s2">&quot;AAVSO&quot;</span><span class="p">,</span> <span class="s2">&quot;https://www.aavso.org/vsx/&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">link_button</span><span class="p">(</span><span class="s2">&quot;NED&quot;</span><span class="p">,</span> <span class="s2">&quot;https://ned.ipac.caltech.edu/&quot;</span><span class="p">)</span>


<span class="n">output_dir</span> <span class="o">=</span> <span class="n">ensure_output_directory</span><span class="p">(</span><span class="s2">&quot;pfr_results&quot;</span><span class="p">)</span>
<span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;output_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_dir</span>

<span class="k">if</span> <span class="n">science_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">science_data</span><span class="p">,</span> <span class="n">science_header</span> <span class="o">=</span> <span class="n">load_fits_data</span><span class="p">(</span><span class="n">science_file</span><span class="p">)</span>
    <span class="n">bias_data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_fits_data</span><span class="p">(</span><span class="n">bias_file</span><span class="p">)</span>
    <span class="n">dark_data</span><span class="p">,</span> <span class="n">dark_header</span> <span class="o">=</span> <span class="n">load_fits_data</span><span class="p">(</span><span class="n">dark_file</span><span class="p">)</span>
    <span class="n">flat_data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_fits_data</span><span class="p">(</span><span class="n">flat_file</span><span class="p">)</span>
    
    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">observatory_data</span> <span class="o">=</span> <span class="n">update_observatory_inputs</span><span class="p">(</span><span class="n">science_header</span><span class="p">)</span>

    <span class="n">wcs_obj</span><span class="p">,</span> <span class="n">wcs_error</span> <span class="o">=</span> <span class="n">safe_wcs_create</span><span class="p">(</span><span class="n">science_header</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">wcs_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid WCS found in the FITS header: </span><span class="si">{</span><span class="n">wcs_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">use_astrometry</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">checkbox</span><span class="p">(</span>
            <span class="s2">&quot;Attempt plate solving with astrometry.net?&quot;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Uses the online astrometry.net service to determine WCS coordinates&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">use_astrometry</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">spinner</span><span class="p">(</span>
                    <span class="s2">&quot;Running plate solve with astrometry.net (this may take a while)...&quot;</span>
                <span class="p">):</span>
                    <span class="n">wcs_obj</span><span class="p">,</span> <span class="n">science_header</span><span class="p">,</span> <span class="n">astrometry_msg</span> <span class="o">=</span> <span class="n">solve_with_astrometry_net</span><span class="p">(</span>
                        <span class="n">science_data</span><span class="p">,</span> <span class="n">science_header</span><span class="p">,</span> <span class="n">api_key</span>
                    <span class="p">)</span>

                    <span class="n">log_buffer</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;log_buffer&quot;</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">wcs_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;Astrometry.net plate solving successful!&quot;</span><span class="p">)</span>
                        <span class="n">write_to_log</span><span class="p">(</span>
                            <span class="n">log_buffer</span><span class="p">,</span>
                            <span class="sa">f</span><span class="s2">&quot;Solved plate with astrometry.net: </span><span class="si">{</span><span class="n">astrometry_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="p">)</span>

                        <span class="n">wcs_header_filename</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;base_filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_wcs_header&quot;</span>
                        <span class="p">)</span>
                        <span class="n">wcs_header_file_path</span> <span class="o">=</span> <span class="n">save_header_to_txt</span><span class="p">(</span>
                            <span class="n">science_header</span><span class="p">,</span> <span class="n">wcs_header_filename</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">wcs_header_file_path</span><span class="p">:</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updated WCS header saved&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Astrometry.net plate solving failed: </span><span class="si">{</span><span class="n">astrometry_msg</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="n">write_to_log</span><span class="p">(</span>
                            <span class="n">log_buffer</span><span class="p">,</span>
                            <span class="sa">f</span><span class="s2">&quot;Failed to solve plate: </span><span class="si">{</span><span class="n">astrometry_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">level</span><span class="o">=</span><span class="s2">&quot;ERROR&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Please enter your astrometry.net API key to proceed with plate solving.&quot;</span>
                <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;Valid WCS found in the FITS header.&quot;</span><span class="p">)</span>
        <span class="n">log_buffer</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;log_buffer&quot;</span><span class="p">]</span>
        <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="s2">&quot;Valid WCS found in header&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">science_header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log_buffer</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;log_buffer&quot;</span><span class="p">]</span>

        <span class="n">timestamp_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>

        <span class="n">header_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;base_filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_header&quot;</span>
        <span class="n">header_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">header_filename</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>

        <span class="n">header_file</span> <span class="o">=</span> <span class="n">save_header_to_txt</span><span class="p">(</span><span class="n">science_header</span><span class="p">,</span> <span class="n">header_filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">header_file</span><span class="p">:</span>
            <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Saved header to </span><span class="si">{</span><span class="n">header_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">log_buffer</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;log_buffer&quot;</span><span class="p">]</span>
    <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Loaded science image: </span><span class="si">{</span><span class="n">science_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bias_file</span><span class="p">:</span>
        <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Loaded bias frame: </span><span class="si">{</span><span class="n">bias_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dark_file</span><span class="p">:</span>
        <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Loaded dark frame: </span><span class="si">{</span><span class="n">dark_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">flat_file</span><span class="p">:</span>
        <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Loaded flat field: </span><span class="si">{</span><span class="n">flat_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">science_header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">science_header</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">dark_header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dark_header</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Science Image&quot;</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="s2">&quot;science-image&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">science_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fig_preview</span><span class="p">,</span> <span class="n">ax_preview</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZES</span><span class="p">[</span><span class="s2">&quot;medium&quot;</span><span class="p">])</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">science_data</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">ZScaleInterval</span><span class="p">())</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">ax_preview</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                    <span class="n">science_data</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">norm_error</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ZScale normalization failed: </span><span class="si">{</span><span class="n">norm_error</span><span class="si">}</span><span class="s2">. Using simple normalization.&quot;</span>
                <span class="p">)</span>
                <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">science_data</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">99</span><span class="p">])</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">ax_preview</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                    <span class="n">science_data</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span>
                <span class="p">)</span>

            <span class="n">fig_preview</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_preview</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Pixel Value&quot;</span><span class="p">)</span>
            <span class="n">ax_preview</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">science_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ax_preview</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

            <span class="n">st</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="n">fig_preview</span><span class="p">)</span>

            <span class="n">timestamp_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
            <span class="n">image_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;base_filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_image.png&quot;</span>
            <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">image_filename</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">fig_preview</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
                <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="s2">&quot;Saved image plot&quot;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Image saved&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">save_error</span><span class="p">:</span>
                <span class="n">write_to_log</span><span class="p">(</span>
                    <span class="n">log_buffer</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to save image plot: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">save_error</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">level</span><span class="o">=</span><span class="s2">&quot;ERROR&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving image: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">save_error</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig_preview</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error displaying image: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;No image data available to display. Check if the file was loaded correctly.&quot;</span>
        <span class="p">)</span>

    <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">expander</span><span class="p">(</span><span class="s2">&quot;Science Image Header&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">science_header</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">science_header</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No header information available for science image.&quot;</span><span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Science Image Statistics&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">science_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">stats_col1</span><span class="p">,</span> <span class="n">stats_col2</span><span class="p">,</span> <span class="n">stats_col3</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">stats_col1</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="s2">&quot;Mean&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">science_data</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">stats_col2</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="s2">&quot;Median&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">science_data</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">stats_col3</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="s2">&quot;Std Dev&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">science_data</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">pixel_size_arcsec</span><span class="p">,</span> <span class="n">pixel_scale_source</span> <span class="o">=</span> <span class="n">extract_pixel_scale</span><span class="p">(</span><span class="n">science_header</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span>
            <span class="s2">&quot;Pixel Scale (arcsec/pixel)&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pixel_size_arcsec</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (estimated from header)&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">write_to_log</span><span class="p">(</span>
            <span class="n">log_buffer</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Pixel scale: </span><span class="si">{</span><span class="n">pixel_size_arcsec</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> arcsec/pixel (</span><span class="si">{</span><span class="n">pixel_scale_source</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">mean_fwhm_pixel</span> <span class="o">=</span> <span class="n">seeing</span> <span class="o">/</span> <span class="n">pixel_size_arcsec</span>
        <span class="n">st</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span>
            <span class="s2">&quot;Mean FWHM (pixels)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mean_fwhm_pixel</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (estimated from seeing)&quot;</span>
        <span class="p">)</span>
        <span class="n">write_to_log</span><span class="p">(</span>
            <span class="n">log_buffer</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Seeing FWHM: </span><span class="si">{</span><span class="n">seeing</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> arcsec (</span><span class="si">{</span><span class="n">mean_fwhm_pixel</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> pixels)&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ra_val</span><span class="p">,</span> <span class="n">dec_val</span><span class="p">,</span> <span class="n">coord_source</span> <span class="o">=</span> <span class="n">extract_coordinates</span><span class="p">(</span><span class="n">science_header</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ra_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dec_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target: RA=</span><span class="si">{</span><span class="n">ra_val</span><span class="si">}</span><span class="s2">Â°, DEC=</span><span class="si">{</span><span class="n">dec_val</span><span class="si">}</span><span class="s2">Â°&quot;</span><span class="p">)</span>
            <span class="n">write_to_log</span><span class="p">(</span>
                <span class="n">log_buffer</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Target coordinates: RA=</span><span class="si">{</span><span class="n">ra_val</span><span class="si">}</span><span class="s2">Â°, DEC=</span><span class="si">{</span><span class="n">dec_val</span><span class="si">}</span><span class="s2">Â° (</span><span class="si">{</span><span class="n">coord_source</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ra_missing</span> <span class="o">=</span> <span class="n">dec_missing</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Coordinate issue: </span><span class="si">{</span><span class="n">coord_source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">write_to_log</span><span class="p">(</span>
                <span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Coordinate issue: </span><span class="si">{</span><span class="n">coord_source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;WARNING&quot;</span>
            <span class="p">)</span>
            <span class="n">ra_missing</span> <span class="o">=</span> <span class="n">dec_missing</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s2">&quot;manual_ra&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;manual_ra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;manual_dec&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;manual_dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">ra_missing</span> <span class="ow">or</span> <span class="n">dec_missing</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Target coordinates (RA/DEC) not found in FITS header. Please enter them manually:&quot;</span>
            <span class="p">)</span>

            <span class="n">coord_col1</span><span class="p">,</span> <span class="n">coord_col2</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">coord_col1</span><span class="p">:</span>
                <span class="n">default_ra</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;manual_ra&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="ow">not</span> <span class="n">default_ra</span>
                    <span class="ow">and</span> <span class="s2">&quot;NAXIS1&quot;</span> <span class="ow">in</span> <span class="n">science_header</span>
                    <span class="ow">and</span> <span class="s2">&quot;CRPIX1&quot;</span> <span class="ow">in</span> <span class="n">science_header</span>
                    <span class="ow">and</span> <span class="s2">&quot;CD1_1&quot;</span> <span class="ow">in</span> <span class="n">science_header</span>
                <span class="p">):</span>
                    <span class="n">default_ra</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CRVAL1&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

                <span class="n">manual_ra</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span>
                    <span class="s2">&quot;Right Ascension (degrees)&quot;</span><span class="p">,</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">default_ra</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enter RA in decimal degrees (0-360)&quot;</span><span class="p">,</span>
                    <span class="n">key</span><span class="o">=</span><span class="s2">&quot;ra_input&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;manual_ra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">manual_ra</span>

            <span class="k">with</span> <span class="n">coord_col2</span><span class="p">:</span>
                <span class="n">default_dec</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;manual_dec&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="ow">not</span> <span class="n">default_dec</span>
                    <span class="ow">and</span> <span class="s2">&quot;NAXIS2&quot;</span> <span class="ow">in</span> <span class="n">science_header</span>
                    <span class="ow">and</span> <span class="s2">&quot;CRPIX2&quot;</span> <span class="ow">in</span> <span class="n">science_header</span>
                    <span class="ow">and</span> <span class="s2">&quot;CD2_2&quot;</span> <span class="ow">in</span> <span class="n">science_header</span>
                <span class="p">):</span>
                    <span class="n">default_dec</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CRVAL2&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

                <span class="n">manual_dec</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span>
                    <span class="s2">&quot;Declination (degrees)&quot;</span><span class="p">,</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">default_dec</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enter DEC in decimal degrees (-90 to +90)&quot;</span><span class="p">,</span>
                    <span class="n">key</span><span class="o">=</span><span class="s2">&quot;dec_input&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;manual_dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">manual_dec</span>

            <span class="k">if</span> <span class="n">manual_ra</span> <span class="ow">and</span> <span class="n">manual_dec</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ra_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">manual_ra</span><span class="p">)</span>
                    <span class="n">dec_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">manual_dec</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">ra_val</span> <span class="o">&lt;</span> <span class="mi">360</span><span class="p">):</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;RA must be between 0 and 360 degrees&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mi">90</span> <span class="o">&lt;=</span> <span class="n">dec_val</span> <span class="o">&lt;=</span> <span class="mi">90</span><span class="p">):</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;DEC must be between -90 and +90 degrees&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">science_header</span><span class="p">[</span><span class="s2">&quot;RA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ra_val</span>
                        <span class="n">science_header</span><span class="p">[</span><span class="s2">&quot;DEC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dec_val</span>

                        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;valid_ra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ra_val</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;valid_dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dec_val</span>

                        <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Using manual coordinates: RA=</span><span class="si">{</span><span class="n">ra_val</span><span class="si">}</span><span class="s2">Â°, DEC=</span><span class="si">{</span><span class="n">dec_val</span><span class="si">}</span><span class="s2">Â°&quot;</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;RA and DEC must be valid numbers&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Please enter both RA and DEC coordinates&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ra_key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;RA&quot;</span><span class="p">,</span> <span class="s2">&quot;OBJRA&quot;</span><span class="p">,</span> <span class="s2">&quot;RA---&quot;</span><span class="p">,</span> <span class="s2">&quot;CRVAL1&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">ra_key</span> <span class="ow">in</span> <span class="n">science_header</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;valid_ra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">science_header</span><span class="p">[</span><span class="n">ra_key</span><span class="p">]</span>
                    <span class="k">break</span>

            <span class="k">for</span> <span class="n">dec_key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;DEC&quot;</span><span class="p">,</span> <span class="s2">&quot;OBJDEC&quot;</span><span class="p">,</span> <span class="s2">&quot;DEC---&quot;</span><span class="p">,</span> <span class="s2">&quot;CRVAL2&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">dec_key</span> <span class="ow">in</span> <span class="n">science_header</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;valid_dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">science_header</span><span class="p">[</span><span class="n">dec_key</span><span class="p">]</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="s2">&quot;valid_ra&quot;</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span> <span class="ow">and</span> <span class="s2">&quot;valid_dec&quot;</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
            <span class="n">science_header</span><span class="p">[</span><span class="s2">&quot;RA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;valid_ra&quot;</span><span class="p">]</span>
            <span class="n">science_header</span><span class="p">[</span><span class="s2">&quot;DEC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;valid_dec&quot;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create observatory dictionary using user inputs</span>
            <span class="n">observatory_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">observatory_data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                <span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">observatory_data</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">],</span>
                <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">observatory_data</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">],</span>
                <span class="s2">&quot;elevation&quot;</span><span class="p">:</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">observatory_data</span><span class="p">[</span><span class="s2">&quot;elevation&quot;</span><span class="p">]</span>
            <span class="p">}</span>
            
            <span class="n">air</span> <span class="o">=</span> <span class="n">airmass</span><span class="p">(</span><span class="n">science_header</span><span class="p">,</span> <span class="n">observatory</span><span class="o">=</span><span class="n">observatory_data</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Airmass: </span><span class="si">{</span><span class="n">air</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calculating airmass: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">air</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default airmass: </span><span class="si">{</span><span class="n">air</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">calibration_disabled</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span><span class="n">calibrate_bias</span> <span class="ow">or</span> <span class="n">calibrate_dark</span> <span class="ow">or</span> <span class="n">calibrate_flat</span><span class="p">)</span>
        <span class="n">exposure_time_science</span> <span class="o">=</span> <span class="n">science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;EXPOSURE&quot;</span><span class="p">,</span> <span class="n">science_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;EXPTIME&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">exposure_time_dark</span> <span class="o">=</span> <span class="n">dark_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;EXPOSURE&quot;</span><span class="p">,</span> <span class="n">dark_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;EXPTIME&quot;</span><span class="p">,</span> <span class="n">exposure_time_science</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="s2">&quot;Run Image Calibration&quot;</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="n">calibration_disabled</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">spinner</span><span class="p">(</span><span class="s2">&quot;Calibrating image...&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">calibrated_data</span><span class="p">,</span> <span class="n">calibrated_header</span> <span class="o">=</span> <span class="n">calibrate_image_streamlit</span><span class="p">(</span>
                        <span class="n">science_data</span><span class="p">,</span>
                        <span class="n">science_header</span><span class="p">,</span>
                        <span class="n">bias_data</span><span class="p">,</span>
                        <span class="n">dark_data</span><span class="p">,</span>
                        <span class="n">flat_data</span><span class="p">,</span>
                        <span class="n">exposure_time_science</span><span class="p">,</span>
                        <span class="n">exposure_time_dark</span><span class="p">,</span>
                        <span class="n">calibrate_bias</span><span class="p">,</span>
                        <span class="n">calibrate_dark</span><span class="p">,</span>
                        <span class="n">calibrate_flat</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;calibrated_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calibrated_data</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;calibrated_header&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calibrated_header</span>

                    <span class="k">if</span> <span class="n">calibrated_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Calibrated Science Image&quot;</span><span class="p">)</span>
                        <span class="n">norm_calibrated</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span>
                            <span class="n">calibrated_data</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">ZScaleInterval</span><span class="p">()</span>
                        <span class="p">)</span>
                        <span class="n">fig_calibrated</span><span class="p">,</span> <span class="n">ax_calibrated</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                            <span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZES</span><span class="p">[</span><span class="s2">&quot;medium&quot;</span><span class="p">],</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span>
                        <span class="p">)</span>
                        <span class="n">im_calibrated</span> <span class="o">=</span> <span class="n">ax_calibrated</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                            <span class="n">calibrated_data</span><span class="p">,</span>
                            <span class="n">norm</span><span class="o">=</span><span class="n">norm_calibrated</span><span class="p">,</span>
                            <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
                            <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">fig_calibrated</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
                            <span class="n">im_calibrated</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_calibrated</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;pixel value&quot;</span>
                        <span class="p">)</span>
                        <span class="n">ax_calibrated</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Calibrated Image (zscale)&quot;</span><span class="p">)</span>
                        <span class="n">ax_calibrated</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="n">fig_calibrated</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during calibration: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">zero_point_button_disabled</span> <span class="o">=</span> <span class="n">science_file</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">button</span><span class="p">(</span>
            <span class="s2">&quot;Run Zero Point Calibration&quot;</span><span class="p">,</span>
            <span class="n">disabled</span><span class="o">=</span><span class="n">zero_point_button_disabled</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;run_zp&quot;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">image_to_process</span> <span class="o">=</span> <span class="n">science_data</span>
            <span class="n">header_to_process</span> <span class="o">=</span> <span class="n">science_header</span>

            <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;calibrated_data&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">image_to_process</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;calibrated_data&quot;</span><span class="p">]</span>
                <span class="n">header_to_process</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;calibrated_header&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">image_to_process</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">spinner</span><span class="p">(</span>
                        <span class="s2">&quot;Background Extraction, Find Sources and Perform Photometry...&quot;</span>
                    <span class="p">):</span>
                        <span class="n">phot_table_qtable</span><span class="p">,</span> <span class="n">epsf_table</span><span class="p">,</span> <span class="n">daofind</span><span class="p">,</span> <span class="n">bkg</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">find_sources_and_photometry_streamlit</span><span class="p">(</span>
                                <span class="n">image_to_process</span><span class="p">,</span>
                                <span class="n">header_to_process</span><span class="p">,</span>
                                <span class="n">mean_fwhm_pixel</span><span class="p">,</span>
                                <span class="n">threshold_sigma</span><span class="p">,</span>
                                <span class="n">detection_mask</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">phot_table_qtable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">phot_table_df</span> <span class="o">=</span> <span class="n">phot_table_qtable</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
                                <span class="n">deep</span><span class="o">=</span><span class="kc">True</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No sources detected in the image.&quot;</span><span class="p">)</span>
                            <span class="n">phot_table_df</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="k">if</span> <span class="n">phot_table_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">spinner</span><span class="p">(</span><span class="s2">&quot;Cross-matching with Gaia...&quot;</span><span class="p">):</span>
                            <span class="n">matched_table</span> <span class="o">=</span> <span class="n">cross_match_with_gaia_streamlit</span><span class="p">(</span>
                                <span class="n">phot_table_qtable</span><span class="p">,</span>
                                <span class="n">header_to_process</span><span class="p">,</span>
                                <span class="n">pixel_size_arcsec</span><span class="p">,</span>
                                <span class="n">mean_fwhm_pixel</span><span class="p">,</span>
                                <span class="n">gaia_band</span><span class="p">,</span>
                                <span class="n">gaia_min_mag</span><span class="p">,</span>
                                <span class="n">gaia_max_mag</span><span class="p">,</span>
                            <span class="p">)</span>

                        <span class="k">if</span> <span class="n">matched_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Cross-matched Gaia Catalog (first 10 rows)&quot;</span><span class="p">)</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">matched_table</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

                            <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">spinner</span><span class="p">(</span><span class="s2">&quot;Calculating zero point...&quot;</span><span class="p">):</span>
                                <span class="n">zero_point_value</span><span class="p">,</span> <span class="n">zero_point_std</span><span class="p">,</span> <span class="n">zp_plot</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="n">calculate_zero_point_streamlit</span><span class="p">(</span>
                                        <span class="n">phot_table_qtable</span><span class="p">,</span> <span class="n">matched_table</span><span class="p">,</span> <span class="n">gaia_band</span><span class="p">,</span> <span class="n">air</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>

                                <span class="k">if</span> <span class="n">zero_point_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">st</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="n">zp_plot</span><span class="p">)</span>
                                    <span class="n">write_to_log</span><span class="p">(</span>
                                        <span class="n">log_buffer</span><span class="p">,</span>
                                        <span class="sa">f</span><span class="s2">&quot;Zero point: </span><span class="si">{</span><span class="n">zero_point_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> Â± </span><span class="si">{</span><span class="n">zero_point_std</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                    <span class="p">)</span>
                                    <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Airmass: </span><span class="si">{</span><span class="n">air</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                                    <span class="k">if</span> <span class="s2">&quot;final_phot_table&quot;</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
                                        <span class="n">final_table</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span>
                                            <span class="s2">&quot;final_phot_table&quot;</span>
                                        <span class="p">]</span>

                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="p">(</span>
                                                <span class="s2">&quot;epsf_photometry_result&quot;</span>
                                                <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span>
                                                <span class="ow">and</span> <span class="n">epsf_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                                            <span class="p">):</span>
                                                <span class="n">epsf_df</span> <span class="o">=</span> <span class="p">(</span>
                                                    <span class="n">epsf_table</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
                                                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                                                        <span class="n">epsf_table</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
                                                    <span class="p">)</span>
                                                    <span class="k">else</span> <span class="n">epsf_table</span>
                                                <span class="p">)</span>

                                                <span class="n">epsf_x_col</span> <span class="o">=</span> <span class="p">(</span>
                                                    <span class="s2">&quot;x_fit&quot;</span>
                                                    <span class="k">if</span> <span class="s2">&quot;x_fit&quot;</span> <span class="ow">in</span> <span class="n">epsf_df</span><span class="o">.</span><span class="n">columns</span>
                                                    <span class="k">else</span> <span class="s2">&quot;xcenter&quot;</span>
                                                <span class="p">)</span>
                                                <span class="n">epsf_y_col</span> <span class="o">=</span> <span class="p">(</span>
                                                    <span class="s2">&quot;y_fit&quot;</span>
                                                    <span class="k">if</span> <span class="s2">&quot;y_fit&quot;</span> <span class="ow">in</span> <span class="n">epsf_df</span><span class="o">.</span><span class="n">columns</span>
                                                    <span class="k">else</span> <span class="s2">&quot;ycenter&quot;</span>
                                                <span class="p">)</span>

                                                <span class="n">final_x_col</span> <span class="o">=</span> <span class="p">(</span>
                                                    <span class="s2">&quot;xcenter&quot;</span>
                                                    <span class="k">if</span> <span class="s2">&quot;xcenter&quot;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span>
                                                    <span class="k">else</span> <span class="s2">&quot;x_0&quot;</span>
                                                <span class="p">)</span>
                                                <span class="n">final_y_col</span> <span class="o">=</span> <span class="p">(</span>
                                                    <span class="s2">&quot;ycenter&quot;</span>
                                                    <span class="k">if</span> <span class="s2">&quot;ycenter&quot;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span>
                                                    <span class="k">else</span> <span class="s2">&quot;y_0&quot;</span>
                                                <span class="p">)</span>

                                                <span class="k">if</span> <span class="p">(</span>
                                                    <span class="n">epsf_x_col</span> <span class="ow">in</span> <span class="n">epsf_df</span><span class="o">.</span><span class="n">columns</span>
                                                    <span class="ow">and</span> <span class="n">epsf_y_col</span> <span class="ow">in</span> <span class="n">epsf_df</span><span class="o">.</span><span class="n">columns</span>
                                                <span class="p">):</span>
                                                    <span class="n">epsf_df</span><span class="p">[</span><span class="s2">&quot;match_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                                        <span class="n">epsf_df</span><span class="p">[</span><span class="n">epsf_x_col</span><span class="p">]</span>
                                                        <span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                                                        <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                                                        <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                                                        <span class="o">+</span> <span class="n">epsf_df</span><span class="p">[</span><span class="n">epsf_y_col</span><span class="p">]</span>
                                                        <span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                                                        <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                                                    <span class="p">)</span>

                                                <span class="k">if</span> <span class="p">(</span>
                                                    <span class="n">final_x_col</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span>
                                                    <span class="ow">and</span> <span class="n">final_y_col</span>
                                                    <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span>
                                                <span class="p">):</span>
                                                    <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;match_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                                        <span class="n">final_table</span><span class="p">[</span><span class="n">final_x_col</span><span class="p">]</span>
                                                        <span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                                                        <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                                                        <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                                                        <span class="o">+</span> <span class="n">final_table</span><span class="p">[</span><span class="n">final_y_col</span><span class="p">]</span>
                                                        <span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                                                        <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                                                    <span class="p">)</span>
                                                <span class="k">else</span><span class="p">:</span>
                                                    <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                                        <span class="sa">f</span><span class="s2">&quot;Coordinate columns not found in final table. Available columns: </span><span class="si">{</span><span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                                                    <span class="p">)</span>

                                                <span class="n">epsf_cols</span> <span class="o">=</span> <span class="p">{}</span>
                                                <span class="n">epsf_cols</span><span class="p">[</span><span class="s2">&quot;match_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;match_id&quot;</span>
                                                <span class="n">epsf_cols</span><span class="p">[</span><span class="s2">&quot;flux_fit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;psf_flux_fit&quot;</span>
                                                <span class="n">epsf_cols</span><span class="p">[</span><span class="s2">&quot;flux_unc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;psf_flux_unc&quot;</span>
                                                <span class="n">epsf_cols</span><span class="p">[</span><span class="s2">&quot;instrumental_mag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                                    <span class="s2">&quot;psf_instrumental_mag&quot;</span>
                                                <span class="p">)</span>

                                                <span class="k">if</span> <span class="p">(</span>
                                                    <span class="nb">len</span><span class="p">(</span><span class="n">epsf_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
                                                    <span class="ow">and</span> <span class="s2">&quot;match_id&quot;</span> <span class="ow">in</span> <span class="n">epsf_df</span><span class="o">.</span><span class="n">columns</span>
                                                    <span class="ow">and</span> <span class="s2">&quot;match_id&quot;</span>
                                                    <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span>
                                                <span class="p">):</span>
                                                    <span class="n">epsf_subset</span> <span class="o">=</span> <span class="n">epsf_df</span><span class="p">[</span>
                                                        <span class="p">[</span>
                                                            <span class="n">col</span>
                                                            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">epsf_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                                                            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">epsf_df</span><span class="o">.</span><span class="n">columns</span>
                                                        <span class="p">]</span>
                                                    <span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">epsf_cols</span><span class="p">)</span>

                                                    <span class="n">final_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                                                        <span class="n">final_table</span><span class="p">,</span>
                                                        <span class="n">epsf_subset</span><span class="p">,</span>
                                                        <span class="n">on</span><span class="o">=</span><span class="s2">&quot;match_id&quot;</span><span class="p">,</span>
                                                        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                                                    <span class="p">)</span>

                                                    <span class="k">if</span> <span class="p">(</span>
                                                        <span class="s2">&quot;psf_instrumental_mag&quot;</span>
                                                        <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span>
                                                    <span class="p">):</span>
                                                        <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;psf_calib_mag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                                            <span class="n">final_table</span><span class="p">[</span>
                                                                <span class="s2">&quot;psf_instrumental_mag&quot;</span>
                                                            <span class="p">]</span>
                                                            <span class="o">+</span> <span class="n">zero_point_value</span>
                                                            <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">air</span>
                                                        <span class="p">)</span>
                                                        <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                                                            <span class="s2">&quot;Added PSF photometry results&quot;</span>
                                                        <span class="p">)</span>

                                                    <span class="k">if</span> <span class="p">(</span>
                                                        <span class="s2">&quot;instrumental_mag&quot;</span>
                                                        <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span>
                                                    <span class="p">):</span>
                                                        <span class="k">if</span> <span class="p">(</span>
                                                            <span class="s2">&quot;calib_mag&quot;</span>
                                                            <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span>
                                                        <span class="p">):</span>
                                                            <span class="n">final_table</span><span class="p">[</span>
                                                                <span class="s2">&quot;aperture_instrumental_mag&quot;</span>
                                                            <span class="p">]</span> <span class="o">=</span> <span class="n">final_table</span><span class="p">[</span>
                                                                <span class="s2">&quot;instrumental_mag&quot;</span>
                                                            <span class="p">]</span>
                                                            <span class="n">final_table</span><span class="p">[</span>
                                                                <span class="s2">&quot;aperture_calib_mag&quot;</span>
                                                            <span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                                                <span class="n">final_table</span><span class="p">[</span>
                                                                    <span class="s2">&quot;instrumental_mag&quot;</span>
                                                                <span class="p">]</span>
                                                                <span class="o">+</span> <span class="n">zero_point_value</span>
                                                                <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">air</span>
                                                            <span class="p">)</span>
                                                        <span class="k">else</span><span class="p">:</span>
                                                            <span class="n">final_table</span> <span class="o">=</span> <span class="n">final_table</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                                                                <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                                                                    <span class="s2">&quot;instrumental_mag&quot;</span><span class="p">:</span> <span class="s2">&quot;aperture_instrumental_mag&quot;</span><span class="p">,</span>
                                                                    <span class="s2">&quot;calib_mag&quot;</span><span class="p">:</span> <span class="s2">&quot;aperture_calib_mag&quot;</span><span class="p">,</span>
                                                                <span class="p">}</span>
                                                            <span class="p">)</span>
                                                        <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                                                            <span class="s2">&quot;Added aperture photometry results&quot;</span>
                                                        <span class="p">)</span>

                                                    <span class="n">final_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                                                        <span class="s2">&quot;match_id&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
                                                    <span class="p">)</span>

                                            <span class="n">csv_buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>

                                            <span class="n">cols_to_drop</span> <span class="o">=</span> <span class="p">[]</span>
                                            <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="p">[</span>
                                                <span class="s2">&quot;sky_center.ra&quot;</span><span class="p">,</span>
                                                <span class="s2">&quot;sky_center.dec&quot;</span><span class="p">,</span>
                                            <span class="p">]:</span>
                                                <span class="k">if</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                                                    <span class="n">cols_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>

                                            <span class="k">if</span> <span class="n">cols_to_drop</span><span class="p">:</span>
                                                <span class="n">final_table</span> <span class="o">=</span> <span class="n">final_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                                                    <span class="n">columns</span><span class="o">=</span><span class="n">cols_to_drop</span>
                                                <span class="p">)</span>

                                            <span class="k">if</span> <span class="s2">&quot;match_id&quot;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                                                <span class="n">final_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                                                    <span class="s2">&quot;match_id&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
                                                <span class="p">)</span>

                                            <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;zero_point&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero_point_value</span>
                                            <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;zero_point_std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                                <span class="n">zero_point_std</span>
                                            <span class="p">)</span>
                                            <span class="n">final_table</span><span class="p">[</span><span class="s2">&quot;airmass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">air</span>

                                            <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Final Photometry Catalog&quot;</span><span class="p">)</span>
                                            <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">final_table</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

                                            <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                                                <span class="sa">f</span><span class="s2">&quot;Catalog includes </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">final_table</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources.&quot;</span>
                                            <span class="p">)</span>

                                            <span class="k">if</span> <span class="p">(</span>
                                                <span class="n">final_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                                                <span class="ow">and</span> <span class="s2">&quot;ra&quot;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span>
                                                <span class="ow">and</span> <span class="s2">&quot;dec&quot;</span> <span class="ow">in</span> <span class="n">final_table</span><span class="o">.</span><span class="n">columns</span>
                                            <span class="p">):</span>
                                                <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span>
                                                    <span class="s2">&quot;Cross-matching with Astronomical Catalogs&quot;</span>
                                                <span class="p">)</span>
                                                <span class="n">search_radius</span> <span class="o">=</span> <span class="p">(</span>
                                                    <span class="mi">2</span>
                                                    <span class="o">*</span> <span class="n">mean_fwhm_pixel</span>
                                                    <span class="o">*</span> <span class="n">pixel_size_arcsec</span>
                                                <span class="p">)</span>
                                                <span class="n">final_table</span> <span class="o">=</span> <span class="n">enhance_catalog_with_crossmatches</span><span class="p">(</span>
                                                    <span class="n">final_table</span><span class="p">,</span>
                                                    <span class="n">matched_table</span><span class="p">,</span>
                                                    <span class="n">header_to_process</span><span class="p">,</span>
                                                    <span class="n">pixel_size_arcsec</span><span class="p">,</span>
                                                    <span class="n">search_radius_arcsec</span><span class="o">=</span><span class="n">search_radius</span><span class="p">,</span>
                                                <span class="p">)</span>
                                            <span class="k">elif</span> <span class="n">final_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                                    <span class="s2">&quot;RA/DEC coordinates not available for catalog cross-matching&quot;</span>
                                                <span class="p">)</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                                    <span class="s2">&quot;Final photometry table is None - cannot perform cross-matching&quot;</span>
                                                <span class="p">)</span>

                                            <span class="n">final_table</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_buffer</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                                            <span class="n">csv_data</span> <span class="o">=</span> <span class="n">csv_buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

                                            <span class="n">timestamp_str</span> <span class="o">=</span> <span class="p">(</span>
                                                <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
                                                    <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span>
                                                <span class="p">)</span>
                                            <span class="p">)</span>
                                            <span class="n">base_catalog_name</span> <span class="o">=</span> <span class="n">catalog_name</span>
                                            <span class="k">if</span> <span class="n">base_catalog_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">):</span>
                                                <span class="n">base_catalog_name</span> <span class="o">=</span> <span class="n">base_catalog_name</span><span class="p">[</span>
                                                    <span class="p">:</span><span class="o">-</span><span class="mi">4</span>
                                                <span class="p">]</span>
                                            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_catalog_name</span><span class="si">}</span><span class="s2">.csv&quot;</span>

                                            <span class="n">catalog_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                                <span class="n">output_dir</span><span class="p">,</span> <span class="n">filename</span>
                                            <span class="p">)</span>

                                            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">catalog_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">csv_data</span><span class="p">)</span>
                                            <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Catalog saved to </span><span class="si">{</span><span class="n">catalog_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                                            <span class="n">metadata_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_catalog_name</span><span class="si">}</span><span class="s2">_metadata.txt&quot;</span>
                                            <span class="n">metadata_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">metadata_filename</span><span class="p">)</span>

                                            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;RAPAS Photometry Analysis Metadata</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;================================</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                                    <span class="sa">f</span><span class="s2">&quot;Analysis Date: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                                                <span class="p">)</span>
                                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input File: </span><span class="si">{</span><span class="n">science_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Catalog File: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

                                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                                    <span class="sa">f</span><span class="s2">&quot;Zero Point: </span><span class="si">{</span><span class="n">zero_point_value</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> Â± </span><span class="si">{</span><span class="n">zero_point_std</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                                                <span class="p">)</span>
                                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Airmass: </span><span class="si">{</span><span class="n">air</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pixel Scale: </span><span class="si">{</span><span class="n">pixel_size_arcsec</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> arcsec/pixel</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                                    <span class="sa">f</span><span class="s2">&quot;FWHM (estimated): </span><span class="si">{</span><span class="n">mean_fwhm_pixel</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> pixels (</span><span class="si">{</span><span class="n">seeing</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> arcsec)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                                                <span class="p">)</span>

                                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Detection Parameters:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Threshold: </span><span class="si">{</span><span class="n">threshold_sigma</span><span class="si">}</span><span class="s2"> sigma</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Edge Mask: </span><span class="si">{</span><span class="n">detection_mask</span><span class="si">}</span><span class="s2"> pixels</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                                    <span class="sa">f</span><span class="s2">&quot;  Gaia Magnitude Range: </span><span class="si">{</span><span class="n">gaia_min_mag</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">gaia_max_mag</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                                                <span class="p">)</span>

                                            <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="s2">&quot;Saved catalog metadata&quot;</span><span class="p">)</span>

                                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error preparing download: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                <span class="s2">&quot;Failed to cross-match with Gaia catalog. Check WCS information in image header.&quot;</span>
                            <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during zero point calibration: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

                <span class="n">ra_center</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">dec_center</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="s2">&quot;CRVAL1&quot;</span> <span class="ow">in</span> <span class="n">header_to_process</span> <span class="ow">and</span> <span class="s2">&quot;CRVAL2&quot;</span> <span class="ow">in</span> <span class="n">header_to_process</span><span class="p">:</span>
                    <span class="n">ra_center</span> <span class="o">=</span> <span class="n">header_to_process</span><span class="p">[</span><span class="s2">&quot;CRVAL1&quot;</span><span class="p">]</span>
                    <span class="n">dec_center</span> <span class="o">=</span> <span class="n">header_to_process</span><span class="p">[</span><span class="s2">&quot;CRVAL2&quot;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s2">&quot;RA&quot;</span> <span class="ow">in</span> <span class="n">header_to_process</span> <span class="ow">and</span> <span class="s2">&quot;DEC&quot;</span> <span class="ow">in</span> <span class="n">header_to_process</span><span class="p">:</span>
                    <span class="n">ra_center</span> <span class="o">=</span> <span class="n">header_to_process</span><span class="p">[</span><span class="s2">&quot;RA&quot;</span><span class="p">]</span>
                    <span class="n">dec_center</span> <span class="o">=</span> <span class="n">header_to_process</span><span class="p">[</span><span class="s2">&quot;DEC&quot;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s2">&quot;OBJRA&quot;</span> <span class="ow">in</span> <span class="n">header_to_process</span> <span class="ow">and</span> <span class="s2">&quot;OBJDEC&quot;</span> <span class="ow">in</span> <span class="n">header_to_process</span><span class="p">:</span>
                    <span class="n">ra_center</span> <span class="o">=</span> <span class="n">header_to_process</span><span class="p">[</span><span class="s2">&quot;OBJRA&quot;</span><span class="p">]</span>
                    <span class="n">dec_center</span> <span class="o">=</span> <span class="n">header_to_process</span><span class="p">[</span><span class="s2">&quot;OBJDEC&quot;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">ra_center</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dec_center</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="s2">&quot;final_phot_table&quot;</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span>
                        <span class="ow">and</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;final_phot_table&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="ow">and</span> <span class="ow">not</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;final_phot_table&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">empty</span>
                    <span class="p">):</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Aladin Catalog Viewer&quot;</span><span class="p">)</span>

                        <span class="n">display_catalog_in_aladin</span><span class="p">(</span>
                            <span class="n">final_table</span><span class="o">=</span><span class="n">final_table</span><span class="p">,</span>
                            <span class="n">ra_center</span><span class="o">=</span><span class="n">ra_center</span><span class="p">,</span>
                            <span class="n">dec_center</span><span class="o">=</span><span class="n">dec_center</span><span class="p">,</span>
                            <span class="n">fov</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
                            <span class="n">alt_mag_col</span><span class="o">=</span><span class="s2">&quot;aperture_calib_mag&quot;</span><span class="p">,</span>
                            <span class="n">id_cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;simbad_main_id&quot;</span><span class="p">],</span>
                        <span class="p">)</span>
                    
                    <span class="n">st</span><span class="o">.</span><span class="n">link_button</span><span class="p">(</span>
                        <span class="s2">&quot;ESA Sky Viewer&quot;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;https://sky.esa.int/esasky/?target=</span><span class="si">{</span><span class="n">ra_center</span><span class="si">}</span><span class="s2">%20</span><span class="si">{</span><span class="n">dec_center</span><span class="si">}</span><span class="s2">&amp;hips=DSS2+color&amp;fov=0.5&amp;projection=SIN&amp;cooframe=J2000&amp;sci=true&amp;lang=en&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Open ESA Sky with the same target coordinates&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All Results are stocked in </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">\ folder&quot;</span><span class="p">)</span>
                    <span class="n">provide_download_buttons</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Could not determine coordinates from image header. Cannot display ESASky.&quot;</span>
                    <span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ðŸ‘† Please upload a science image FITS file to start.&quot;</span><span class="p">)</span>


<span class="k">if</span> <span class="s2">&quot;log_buffer&quot;</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span> <span class="ow">and</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;log_buffer&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">log_buffer</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;log_buffer&quot;</span><span class="p">]</span>
    <span class="n">log_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;base_filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.log&quot;</span>
    <span class="n">log_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">log_filename</span><span class="p">)</span>

    <span class="c1"># Log all sidebar parameters</span>
    <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="s2">&quot;Analysis Parameters&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
    <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Seeing: </span><span class="si">{</span><span class="n">seeing</span><span class="si">}</span><span class="s2"> arcsec&quot;</span><span class="p">)</span>
    <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Detection Threshold: </span><span class="si">{</span><span class="n">threshold_sigma</span><span class="si">}</span><span class="s2"> sigma&quot;</span><span class="p">)</span>
    <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Border Mask: </span><span class="si">{</span><span class="n">detection_mask</span><span class="si">}</span><span class="s2"> pixels&quot;</span><span class="p">)</span>
    
    <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="s2">&quot;Observatory Information&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
    <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Observatory Name: </span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">observatory_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Latitude: </span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">observatory_data</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">Â°&quot;</span><span class="p">)</span>
    <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Longitude: </span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">observatory_data</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">Â°&quot;</span><span class="p">)</span>
    <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Elevation: </span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">observatory_data</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> m&quot;</span><span class="p">)</span>
    
    <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="s2">&quot;Gaia Parameters&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
    <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Gaia Band: </span><span class="si">{</span><span class="n">gaia_band</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Gaia Min Magnitude: </span><span class="si">{</span><span class="n">gaia_min_mag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Gaia Max Magnitude: </span><span class="si">{</span><span class="n">gaia_max_mag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="s2">&quot;Calibration Options&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
    <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Apply Bias: </span><span class="si">{</span><span class="n">calibrate_bias</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Apply Dark: </span><span class="si">{</span><span class="n">calibrate_dark</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Apply Flat: </span><span class="si">{</span><span class="n">calibrate_flat</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Finalize and save the log</span>
    <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="s2">&quot;Processing completed&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log_buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="n">write_to_log</span><span class="p">(</span><span class="n">log_buffer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Log saved to </span><span class="si">{</span><span class="n">log_filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Pier-Francesco Rocci.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>